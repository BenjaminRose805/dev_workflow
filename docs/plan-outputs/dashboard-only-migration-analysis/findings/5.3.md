# Task 5.3: Shared Code That Must Be Preserved

## Overview

This document provides a comprehensive inventory of all shared code components that must be preserved to maintain dashboard functionality. Components are categorized by criticality and usage.

## Component Categories

### Legend

| Priority | Meaning |
|----------|---------|
| **CRITICAL** | Dashboard will not function without this component |
| **REQUIRED** | Dashboard features will be degraded without this |
| **SHARED** | Used by multiple interfaces, needed for core functionality |
| **INDIRECT** | Hidden dependency imported by other critical modules |

---

## 1. CRITICAL: API Server

The single entry point for all dashboard communication.

| Component | File Path | LOC | Purpose | Used By |
|-----------|-----------|-----|---------|---------|
| **API Server** | `scripts/api-server.js` | ~1,467 | REST + WebSocket API, file watching, orchestrator control | Dashboard only |

**Functions Exposed:**
- `GET /api/plans` - List all plans
- `GET /api/plans/:name` - Plan details
- `GET /api/plans/:name/status` - Real-time status
- `GET /api/plans/:name/logs` - Log streaming (SSE)
- `POST /api/plans/:name/start` - Start orchestrator
- `POST /api/plans/:name/stop` - Stop orchestrator
- `GET /api/resources` - Resource limits
- `GET /api/worktrees` - Worktree listing
- `WS /ws/plans/:name` - Real-time updates
- `WS /ws/all` - Aggregate updates

**Preservation Reason:** Dashboard is 100% dependent on this API for all data access.

---

## 2. CRITICAL: Core JavaScript Libraries

### 2.1 Plan Status Library

| Component | File Path | LOC | Purpose | Used By |
|-----------|-----------|-----|---------|---------|
| **plan-status.js** | `scripts/lib/plan-status.js` | ~2,538 | Status.json I/O, task management, dependency graph | API Server, CLI, TUI, Orchestrator |

**Functions Used by API Server:**
- `loadStatus(planPath)` - Read plan status
- `getStatusSummary(planPath)` - Progress summary
- `getOutputDir(planPath)` - Output directory path
- `getReadyTasks(status)` - DAG-aware task selection
- `recalculateSummary(status)` - Fix summary drift

**Internal Dependencies:**
- `require('./markdown-parser')` - Title extraction
- `require('./git-queue')` - Commit serialization (lazy-loaded)

**Preservation Reason:** All status data flows through this module. Every API endpoint depends on it.

### 2.2 Worktree Utilities

| Component | File Path | LOC | Purpose | Used By |
|-----------|-----------|-----|---------|---------|
| **worktree-utils.js** | `scripts/lib/worktree-utils.js` | ~2,317 | Git worktree operations, resource management | API Server, CLI, Orchestrator |

**Functions Used by API Server:**
- `getRepoRoot()` - Repository root path
- `listWorktrees()` - Active worktrees
- `checkResourcesGracefully()` - Resource limit checks
- `getResourceConfig()` - Configuration summary
- `getStaleWorktrees()` - Stale worktree detection
- `getAbandonedWorktrees()` - Abandoned detection
- `getWorktreeAge(path)` - Age information
- `loadGitWorkflowConfig()` - Configuration loading

**Preservation Reason:** Dashboard worktree panel and resource monitoring depend on this.

### 2.3 Markdown Parser (Indirect Dependency)

| Component | File Path | LOC | Purpose | Used By |
|-----------|-----------|-----|---------|---------|
| **markdown-parser.js** | `scripts/lib/markdown-parser.js` | ~175 | Parse plan structure from markdown | plan-status.js |

**Functions Used:**
- `getTitle(content)` - Extract H1 title

**Preservation Reason:** Imported by plan-status.js for plan title extraction.

### 2.4 Git Queue (Indirect Dependency)

| Component | File Path | LOC | Purpose | Used By |
|-----------|-----------|-----|---------|---------|
| **git-queue.js** | `scripts/lib/git-queue.js` | ~524 | Serial commit queue for parallel execution | plan-status.js (lazy) |

**Functions Used:**
- `commitWithQueue(message, files)` - Queue a commit
- `getQueueStatus()` - Queue state
- `waitForDrain()` - Wait for queue completion

**Preservation Reason:** Lazy-loaded by plan-status.js for git commit serialization during orchestration.

---

## 3. REQUIRED: Python Orchestrator System

### 3.1 Plan Orchestrator

| Component | File Path | LOC | Purpose | Used By |
|-----------|-----------|-----|---------|---------|
| **plan_orchestrator.py** | `scripts/plan_orchestrator.py` | ~3,000+ | Autonomous plan execution | API Server (spawn), CLI |

**API Server Integration:**
- Spawned via `POST /api/plans/:name/start` with `--daemon` flag
- Writes to `orchestrator-registry.json`
- Updates `status.json` during execution

**Internal Dependencies:**
- `scripts/lib/tui.py` - Rich TUI
- `scripts/lib/claude_runner.py` - Claude Code execution
- `scripts/lib/status_monitor.py` - Status polling
- `scripts/lib/orchestrator_registry.py` - Instance tracking
- `scripts/lib/orchestrator_ipc.py` - IPC communication
- `scripts/lib/event_bus.py` - Event publishing

**Preservation Reason:** Dashboard "Start" button spawns this. Plan execution is impossible without it.

### 3.2 Python Library Dependencies

| Component | File Path | Purpose | Used By |
|-----------|-----------|---------|---------|
| **orchestrator_registry.py** | `scripts/lib/orchestrator_registry.py` | Instance tracking | plan_orchestrator.py |
| **claude_runner.py** | `scripts/lib/claude_runner.py` | Claude Code session | plan_orchestrator.py |
| **status_monitor.py** | `scripts/lib/status_monitor.py` | Status file watching | plan_orchestrator.py |
| **orchestrator_ipc.py** | `scripts/lib/orchestrator_ipc.py` | Inter-process communication | plan_orchestrator.py |
| **event_bus.py** | `scripts/lib/event_bus.py` | Event pub/sub | plan_orchestrator.py |
| **tui.py** | `scripts/lib/tui.py` | Rich terminal UI | plan_orchestrator.py |

**Note:** `tui.py` is technically TUI-only, but it's imported by plan_orchestrator.py. If the TUI is removed entirely, this import must be handled (made optional or stubbed).

**Preservation Reason:** These are all imported by plan_orchestrator.py which is spawned by the API server.

---

## 4. CRITICAL: Configuration Files

### 4.1 Orchestrator Registry

| Component | File Path | Purpose | Used By |
|-----------|-----------|---------|---------|
| **orchestrator-registry.json** | `.claude/orchestrator-registry.json` | Track running orchestrators | API Server, Orchestrator |

**Schema:**
```json
{
  "instances": [
    {
      "id": "string",
      "plan": "plan-name",
      "status": "running|stopped|completed",
      "pid": 12345,
      "started_at": "ISO-8601",
      "mode": "batch|continuous"
    }
  ]
}
```

**Preservation Reason:** API server reads this to show orchestrator status and to stop instances.

### 4.2 Git Workflow Configuration

| Component | File Path | Purpose | Used By |
|-----------|-----------|---------|---------|
| **git-workflow.json** | `.claude/git-workflow.json` | API port, worktree limits, resource config | API Server, worktree-utils.js |

**Relevant Settings:**
```json
{
  "api": {
    "enabled": true,
    "port": 3100,
    "host": "localhost"
  },
  "worktrees": {
    "max_concurrent": 3,
    "stale_days": 14
  },
  "resources": {
    "min_disk_space_mb": 500
  }
}
```

**Preservation Reason:** API server loads port configuration from here.

### 4.3 Current Plan Pointer

| Component | File Path | Purpose | Used By |
|-----------|-----------|---------|---------|
| **current-plan.txt** | `.claude/current-plan.txt` | Active plan path | plan-status.js, CLI |

**Preservation Reason:** Used by plan-status.js `getActivePlanPath()` function.

---

## 5. CRITICAL: Data Files (Format Standards)

### 5.1 Status.json

| Component | Location Pattern | Purpose | Used By |
|-----------|------------------|---------|---------|
| **status.json** | `docs/plan-outputs/<plan>/status.json` | Task status, runs, summary | All |

**Must Preserve Schema:** See findings 2.4 for complete schema definition.

### 5.2 Findings Files

| Component | Location Pattern | Purpose | Used By |
|-----------|------------------|---------|---------|
| **Task findings** | `docs/plan-outputs/<plan>/findings/<task-id>.md` | Task output documents | Dashboard FindingsViewer |

### 5.3 Plan Files

| Component | Location Pattern | Purpose | Used By |
|-----------|------------------|---------|---------|
| **Plan markdown** | `docs/plans/*.md` | Plan definitions | All |

### 5.4 Git Queue Status

| Component | File Path | Purpose | Used By |
|-----------|-----------|---------|---------|
| **Queue status** | `docs/plan-outputs/.git-queue-status.json` | Pending commits | git-queue.js |

---

## 6. SHARED: Status Values and Types

### 6.1 Task Status Values

Used consistently across all systems:

```javascript
const VALID_STATUSES = ['pending', 'in_progress', 'completed', 'failed', 'skipped'];
```

**Defined in:** `scripts/lib/plan-status.js`

### 6.2 Orchestrator Status Values

```javascript
const ORCHESTRATOR_STATUSES = ['running', 'paused', 'stopped', 'completed', 'failed'];
```

**Defined in:** Registry file schema, API responses

---

## 7. Summary: Complete Preservation List

### Files to Preserve (by priority)

#### CRITICAL (Dashboard non-functional without these)

| # | File | Type | LOC |
|---|------|------|-----|
| 1 | `scripts/api-server.js` | JavaScript | 1,467 |
| 2 | `scripts/lib/plan-status.js` | JavaScript | 2,538 |
| 3 | `scripts/lib/worktree-utils.js` | JavaScript | 2,317 |
| 4 | `.claude/orchestrator-registry.json` | JSON | N/A |
| 5 | `docs/plan-outputs/<plan>/status.json` | JSON | N/A |

#### REQUIRED (Features degraded without these)

| # | File | Type | LOC |
|---|------|------|-----|
| 6 | `scripts/plan_orchestrator.py` | Python | ~3,000 |
| 7 | `scripts/lib/markdown-parser.js` | JavaScript | 175 |
| 8 | `scripts/lib/git-queue.js` | JavaScript | 524 |
| 9 | `.claude/git-workflow.json` | JSON | N/A |
| 10 | `.claude/current-plan.txt` | Text | N/A |

#### INDIRECT (Imported by required modules)

| # | File | Type | Used By |
|---|------|------|---------|
| 11 | `scripts/lib/orchestrator_registry.py` | Python | plan_orchestrator.py |
| 12 | `scripts/lib/claude_runner.py` | Python | plan_orchestrator.py |
| 13 | `scripts/lib/status_monitor.py` | Python | plan_orchestrator.py |
| 14 | `scripts/lib/orchestrator_ipc.py` | Python | plan_orchestrator.py |
| 15 | `scripts/lib/event_bus.py` | Python | plan_orchestrator.py |
| 16 | `scripts/lib/tui.py` | Python | plan_orchestrator.py* |

*Note: `tui.py` is only used for terminal output in plan_orchestrator.py. Consider making this import conditional if removing TUI entirely.

### Data Directories to Preserve

| Directory | Purpose |
|-----------|---------|
| `docs/plans/` | Plan markdown files |
| `docs/plan-outputs/<plan>/` | Status files per plan |
| `docs/plan-outputs/<plan>/findings/` | Task findings |
| `.claude/` | Configuration directory |

---

## 8. Hidden Dependencies and Edge Cases

### 8.1 Node.js Module Resolution

`api-server.js` imports:
```javascript
const planStatus = require('./lib/plan-status.js');
const worktreeUtils = require('./lib/worktree-utils.js');
```

`plan-status.js` imports:
```javascript
const { getTitle: getMarkdownTitle } = require('./markdown-parser');
let gitQueue = null; // Lazy-loaded
function getGitQueue() {
  if (!gitQueue) {
    gitQueue = require('./git-queue');
  }
  return gitQueue;
}
```

### 8.2 Python Module Resolution

`plan_orchestrator.py` imports:
```python
from scripts.lib.tui import RichTUIManager, RICH_AVAILABLE
from scripts.lib.claude_runner import StreamingClaudeRunner
from scripts.lib.status_monitor import StatusMonitor
from scripts.lib.orchestrator_registry import (
    OrchestratorRegistry,
    OrchestratorInstance,
    HeartbeatThread,
    DuplicatePlanError,
)
from scripts.lib.orchestrator_ipc import (
    IPCServer,
    IPCClient,
    IPCError,
    get_socket_path,
)
from scripts.lib.event_bus import EventBus, get_event_bus
```

### 8.3 File System Paths Hardcoded

| Path | Used In | Purpose |
|------|---------|---------|
| `docs/plans/` | api-server.js, plan-status.js | Plan file location |
| `docs/plan-outputs/` | plan-status.js | Output directory base |
| `.claude/` | plan-status.js, worktree-utils.js | Config directory |
| `.claude-context/` | worktree-utils.js | Worktree context |

### 8.4 External Process Dependencies

| Process | Spawned By | Purpose |
|---------|------------|---------|
| `python3 plan_orchestrator.py` | api-server.js | Plan execution |
| `node status-cli.js` | plan_orchestrator.py | Status queries |

---

## 9. Preservation Recommendations

### Immediate Actions

1. **Do not delete** any file listed in sections 1-6 above
2. **Lock file modifications** to preserve schemas and interfaces
3. **Document any changes** to shared data structures in both TypeScript types (dashboard) and JavaScript/Python implementations

### If Removing CLI/TUI

1. Keep `scripts/lib/tui.py` but make import optional in `plan_orchestrator.py`:
   ```python
   try:
       from scripts.lib.tui import RichTUIManager
       RICH_AVAILABLE = True
   except ImportError:
       RICH_AVAILABLE = False
   ```

2. Remove CLI-only scripts (see findings 4.2) but preserve library files

### If Simplifying

1. Consider merging `markdown-parser.js` into `plan-status.js` (only `getTitle` is used)
2. Consider making `git-queue.js` optional if auto-commits aren't needed

---

## 10. Dependency Graph Visualization

```
┌──────────────────────────────────────────────────────────────────────┐
│                       ORCHESTRATOR DASHBOARD                          │
│                          (React/Next.js)                              │
└───────────────────────────────┬──────────────────────────────────────┘
                                │ HTTP / WebSocket
                                ▼
┌──────────────────────────────────────────────────────────────────────┐
│                         api-server.js                                 │
│                           (CRITICAL)                                  │
│                                                                       │
│  ┌─────────────────────────┬─────────────────────────┐               │
│  │                         │                         │               │
│  ▼                         ▼                         ▼               │
│ plan-status.js      worktree-utils.js     orchestrator-registry.json │
│   (CRITICAL)            (REQUIRED)               (CRITICAL)          │
│       │                                                               │
│       ▼                                                               │
│ markdown-parser.js                                                    │
│   (INDIRECT)                                                          │
│       │                                                               │
│       ▼ (lazy)                                                        │
│ git-queue.js                                                          │
│   (INDIRECT)                                                          │
└───────────────────────────────┬──────────────────────────────────────┘
                                │ spawn()
                                ▼
┌──────────────────────────────────────────────────────────────────────┐
│                      plan_orchestrator.py                             │
│                          (REQUIRED)                                   │
│                                                                       │
│  ┌────────────┬────────────┬────────────┬────────────┬────────────┐  │
│  │            │            │            │            │            │  │
│  ▼            ▼            ▼            ▼            ▼            ▼  │
│ tui.py  claude_runner  status_monitor  registry_py  ipc.py  event_bus│
│(INDIRECT) (INDIRECT)    (INDIRECT)    (INDIRECT)  (INDIRECT)(INDIRECT)│
└───────────────────────────────┬──────────────────────────────────────┘
                                │ read/write
                                ▼
┌──────────────────────────────────────────────────────────────────────┐
│                       FILE SYSTEM                                     │
│                                                                       │
│  docs/plan-outputs/<plan>/status.json      .claude/git-workflow.json │
│  docs/plan-outputs/<plan>/findings/        .claude/current-plan.txt  │
│  docs/plans/*.md                           .claude/orchestrator-reg..│
└──────────────────────────────────────────────────────────────────────┘
```

---

## 11. Total Code to Preserve

| Category | Files | Lines of Code |
|----------|-------|---------------|
| CRITICAL JS | 3 | ~6,322 |
| REQUIRED JS | 2 | ~699 |
| REQUIRED Python | 1 | ~3,000 |
| INDIRECT Python | 6 | ~3,000 (est.) |
| **TOTAL** | **12** | **~13,000** |

Plus configuration and data files that have no LOC but are essential for operation.
