# Task 2.4: Shared Utilities Between CLI/TUI and Dashboard

## Overview

This document identifies components and concepts shared between the CLI/TUI (dev_workflow) and the dashboard (orchestrator-dashboard), including the API contract that connects them.

## Shared Data Structures

### Type Comparison: TypeScript vs Python/Node.js

| Concept | Dashboard (TypeScript) | CLI (Node.js/Python) |
|---------|------------------------|----------------------|
| Task status | `TaskStatus` type | `VALID_STATUSES` array |
| Orchestrator status | `OrchestratorStatus` type | Registry JSON |
| Task structure | `Task` interface | status.json tasks array |
| Phase structure | `Phase` interface | Parsed from markdown |
| Plan summary | `PlanSummary` interface | `summary` in status.json |
| Plan structure | `Plan` interface | status.json + plan file |
| Activity events | `ActivityEvent` interface | WebSocket events |
| Findings | `Finding` interface | Markdown files |
| Run history | `RunHistory` interface | `runs` in status.json |

### Status Values

Both systems use the same status values:

**Task Status:**
- `pending` - Not started
- `in_progress` - Currently executing
- `completed` - Successfully finished
- `failed` - Execution failed
- `skipped` - Manually skipped

**Orchestrator Status:**
- `running` - Actively executing
- `paused` - Temporarily stopped
- `stopped` - Terminated
- `completed` - All tasks done
- `failed` - Critical failure

## Shared API Contract

The dashboard communicates with CLI/TUI via the `api-server.js` REST API.

### REST Endpoints (Shared)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/api/plans` | GET | List all plans with status |
| `/api/plans/:name` | GET | Get plan details |
| `/api/plans/:name/status` | GET | Get plan status.json data |
| `/api/plans/:name/start` | POST | Start orchestrator |
| `/api/plans/:name/stop` | POST | Stop orchestrator |
| `/api/orchestrators` | GET | List orchestrator instances |
| `/api/orchestrators/:id` | GET | Get orchestrator by ID |
| `/api/orchestrators/:id/pause` | POST | Pause orchestrator |
| `/api/orchestrators/:id/resume` | POST | Resume orchestrator |
| `/api/orchestrators/:id/stop` | POST | Stop orchestrator |
| `/api/orchestrators/:id/tasks` | GET | Get tasks for orchestrator |
| `/api/plans/:name/tasks/:id/skip` | POST | Skip a task |
| `/api/plans/:name/tasks/:id/retry` | POST | Retry a task |
| `/api/plans/:name/findings` | GET | List findings |
| `/api/plans/:name/findings/:id` | GET | Get finding content |
| `/api/activity` | GET | Get activity events |
| `/api/resources` | GET | Get resource status |
| `/api/worktrees` | GET | List worktrees |

### WebSocket Events (Shared)

| Event Type | Description |
|------------|-------------|
| `orchestrator:status` | Orchestrator status change |
| `orchestrator:progress` | Progress update |
| `task:started` | Task execution began |
| `task:completed` | Task finished successfully |
| `task:failed` | Task failed |
| `tool:started` | Tool call began |
| `tool:completed` | Tool call finished |
| `activity:new` | New activity event |

## Shared File Formats

### 1. status.json (Source of Truth)

Location: `docs/plan-outputs/<plan-name>/status.json`

Both CLI and dashboard read/write this file:

```json
{
  "planPath": "docs/plans/my-plan.md",
  "planName": "My Plan Title",
  "createdAt": "2024-01-01T00:00:00Z",
  "lastUpdatedAt": "2024-01-01T01:00:00Z",
  "currentPhase": "Phase 1: Name",
  "tasks": [
    {
      "id": "1.1",
      "phase": "Phase 1: Name",
      "description": "Task description",
      "status": "pending",
      "dependencies": [],
      "dependents": []
    }
  ],
  "summary": {
    "totalTasks": 10,
    "completed": 5,
    "pending": 3,
    "in_progress": 1,
    "failed": 1,
    "skipped": 0
  },
  "runs": [
    {
      "runId": "run-123",
      "startedAt": "2024-01-01T00:00:00Z",
      "completedAt": "2024-01-01T01:00:00Z",
      "tasksCompleted": 5,
      "tasksFailed": 0
    }
  ]
}
```

### 2. Findings Files

Location: `docs/plan-outputs/<plan-name>/findings/<task-id>.md`

Both systems use markdown files for task findings.

### 3. Orchestrator Registry

Location: `.claude/orchestrator-registry.json`

Both systems reference this for orchestrator status:

```json
{
  "instances": [
    {
      "id": "abc123",
      "plan": "my-plan",
      "status": "running",
      "pid": 12345,
      "startedAt": "2024-01-01T00:00:00Z"
    }
  ]
}
```

### 4. Current Plan Pointer

Location: `.claude/current-plan.txt`

Single line containing the active plan path.

## Shared Libraries

### Backend (dev_workflow)

| Library | File | Purpose |
|---------|------|---------|
| Plan Status | `scripts/lib/plan-status.js` | Core status management (78K LOC) |
| Worktree Utils | `scripts/lib/worktree-utils.js` | Git worktree operations |
| Orchestrator Registry | `scripts/lib/orchestrator_registry.py` | Instance management |
| Event Bus | `scripts/lib/event_bus.py` | Event pub/sub |
| Claude Runner | `scripts/lib/claude_runner.py` | Claude session execution |

### Frontend (dashboard)

| Library | File | Purpose |
|---------|------|---------|
| API Client | `src/lib/api/client.ts` | REST API calls |
| API Types | `src/lib/api/types.ts` | TypeScript interfaces |
| WebSocket | `src/lib/api/websocket.ts` | Real-time updates |
| API Hooks | `src/lib/api/hooks.ts` | React Query hooks |

## Shared Concepts

### 1. Dependency Graph

Both systems understand task dependencies:
- CLI: Parses `(depends: X.Y)` syntax in plan files
- TUI: `DependencyGraphPanel` visualizes dependencies
- Dashboard: `DependencyGraph` component (575 LOC)

### 2. Phase Organization

Tasks are grouped by phases (Phase 1, Phase 2, etc.):
- CLI: Parses `## Phase N:` headers from markdown
- TUI: `PhaseProgressPanel` shows phase completion
- Dashboard: `PhaseProgress` component, phase tabs

### 3. Run History

Execution runs are tracked:
- CLI: Stored in `runs` array of status.json
- TUI: `RunHistoryPanel` displays runs
- Dashboard: `RunHistoryTable` component

### 4. Real-time Updates

All systems support real-time status:
- CLI: File watching via `status_monitor.py`
- TUI: Polling panels from status.json
- Dashboard: WebSocket subscriptions

## Utility Functions Used by Both

### Status Operations

| Operation | CLI Implementation | Dashboard API |
|-----------|-------------------|---------------|
| Initialize status | `planStatus.initializePlanStatus()` | `POST /api/plans/:name/status` |
| Mark task started | `planStatus.markTaskStarted()` | `POST /api/plans/:name/tasks/:id/start` |
| Mark task complete | `planStatus.markTaskCompleted()` | `POST /api/plans/:name/tasks/:id/complete` |
| Mark task failed | `planStatus.markTaskFailed()` | `POST /api/plans/:name/tasks/:id/fail` |
| Skip task | `planStatus.markTaskSkipped()` | `POST /api/plans/:name/tasks/:id/skip` |
| Get next tasks | `planStatus.getNextTasks()` | `GET /api/plans/:name/next` |
| Get progress | `planStatus.getProgress()` | Derived from `/api/plans/:name/status` |

### Orchestrator Operations

| Operation | CLI Implementation | Dashboard API |
|-----------|-------------------|---------------|
| List instances | `orchestrator_registry.list_instances()` | `GET /api/orchestrators` |
| Start orchestrator | `plan_orchestrator.py` | `POST /api/orchestrators/start` |
| Stop orchestrator | Registry `stop()` | `POST /api/orchestrators/:id/stop` |
| Pause orchestrator | IPC message | `POST /api/orchestrators/:id/pause` |
| Resume orchestrator | IPC message | `POST /api/orchestrators/:id/resume` |

## Non-Shared (Unique to Each)

### CLI-Only Utilities

| Utility | Purpose |
|---------|---------|
| Template substitution | Variable replacement in plan templates |
| Git branch management | Plan-per-branch workflow |
| Worktree creation | Parallel plan execution |
| Plan parsing | Markdown â†’ task structure |
| Plan validation | Format checking |
| Cache management | Performance optimization |

### TUI-Only Utilities

| Utility | Purpose |
|---------|---------|
| Keyboard handler | Terminal input processing |
| Rich panels | Terminal UI rendering |
| Command palette | Fuzzy command search |
| Error recovery | Auto-recovery from failures |
| Config persistence | User preferences |

### Dashboard-Only Utilities

| Utility | Purpose |
|---------|---------|
| React Query hooks | Data fetching/caching |
| Service worker | PWA offline support |
| Theme provider | Dark/light mode |
| Virtual list | Large list performance |
| Command palette (web) | Keyboard shortcuts |

## Summary: Shared Components

| Component Type | Count | Description |
|----------------|-------|-------------|
| REST Endpoints | 17 | API contract for communication |
| WebSocket Events | 8 | Real-time update channels |
| File Formats | 4 | status.json, findings, registry, pointer |
| Status Values | 5+5 | Task + orchestrator statuses |
| Data Structures | 10+ | Task, Phase, Plan, etc. |

The API server (`api-server.js`) serves as the **bridge** between CLI/TUI and the dashboard, exposing `plan-status.js` and `orchestrator_registry` functionality over HTTP.
