# Task 4.4: API Contracts the Dashboard Relies On

## Overview

This document provides a comprehensive reference for all API contracts between the orchestrator dashboard and the dev_workflow backend. It covers REST endpoints, WebSocket connections, request/response schemas, and error handling.

## API Configuration

### Environment Variables

| Variable | Default | Purpose |
|----------|---------|---------|
| `NEXT_PUBLIC_API_URL` | `http://localhost:3001` | REST API base URL |
| `NEXT_PUBLIC_WS_URL` | `ws://localhost:3001` | WebSocket base URL |

### Server Configuration

The API server reads configuration from `.claude/git-workflow.json`:

```json
{
  "api": {
    "enabled": true,
    "port": 3100,
    "host": "localhost"
  }
}
```

Default port: `3100` (Note: Dashboard defaults to `3001`, configuration mismatch exists)

---

## REST API Endpoints

### 1. Plans Endpoints

#### GET /api/plans

List all plans with status information.

**Query Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| `status` | string | Filter by status: `pending`, `in_progress`, `completed` |
| `worktree` | string | Filter by worktree: `true` or `false` |

**Response (200):**
```json
{
  "data": [
    {
      "name": "my-plan",
      "path": "docs/plans/my-plan.md",
      "title": "My Plan Title",
      "status": "in_progress",
      "progress": {
        "total": 10,
        "completed": 5,
        "pending": 3,
        "failed": 1,
        "percentage": 50
      },
      "currentPhase": "Phase 2: Implementation",
      "worktree": {
        "active": true,
        "path": "/path/to/worktree"
      },
      "orchestrator": {
        "running": true,
        "pid": 12345
      },
      "lastUpdatedAt": "2024-12-27T10:00:00.000Z"
    }
  ],
  "summary": {
    "totalPlans": 5,
    "running": 1,
    "pending": 2,
    "completed": 2
  }
}
```

---

#### GET /api/plans/:name

Get detailed plan information.

**URL Parameters:**
| Parameter | Type | Description |
|-----------|------|-------------|
| `name` | string | Plan name (URL encoded) |

**Response (200):**
```json
{
  "data": {
    "name": "my-plan",
    "path": "docs/plans/my-plan.md",
    "title": "My Plan Title",
    "status": "in_progress",
    "progress": {
      "total": 10,
      "completed": 5,
      "pending": 3,
      "in_progress": 1,
      "failed": 1,
      "skipped": 0,
      "percentage": 50
    },
    "phases": [
      {
        "number": 1,
        "name": "Setup",
        "total": 3,
        "completed": 3,
        "percentage": 100
      },
      {
        "number": 2,
        "name": "Implementation",
        "total": 5,
        "completed": 2,
        "percentage": 40
      }
    ],
    "currentPhase": "Phase 2: Implementation",
    "recentActivity": [
      {
        "timestamp": "2024-12-27T10:30:00.000Z",
        "taskId": "2.1",
        "action": "completed",
        "description": "Implement feature X"
      }
    ],
    "worktree": {
      "active": true,
      "path": "/path/to/worktree",
      "branch": "plan/my-plan"
    },
    "orchestrator": {
      "running": true,
      "pid": 12345,
      "startedAt": "2024-12-27T09:00:00.000Z",
      "mode": "batch"
    },
    "lastUpdatedAt": "2024-12-27T10:30:00.000Z"
  }
}
```

**Error Responses:**
| Status | Code | Description |
|--------|------|-------------|
| 404 | `PLAN_NOT_FOUND` | Plan does not exist |

---

#### GET /api/plans/:name/status

Get real-time plan status (lightweight endpoint for polling).

**Response (200):**
```json
{
  "name": "my-plan",
  "status": "in_progress",
  "progress": {
    "total": 10,
    "completed": 5,
    "percentage": 50
  },
  "currentTask": {
    "id": "2.1",
    "description": "Implement feature X",
    "status": "in_progress",
    "startedAt": "2024-12-27T10:00:00.000Z"
  },
  "orchestrator": {
    "running": true,
    "pid": 12345
  },
  "lastUpdatedAt": "2024-12-27T10:05:00.000Z"
}
```

---

#### POST /api/plans/:name/start

Start orchestrator for a plan.

**Request Body:**
```json
{
  "mode": "batch",
  "tasks": ["1.1", "1.2", "1.3"],
  "autonomous": false,
  "daemon": true
}
```

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `mode` | string | `"batch"` | Execution mode: `batch` or `continuous` |
| `tasks` | string[] | all | Specific task IDs to run |
| `autonomous` | boolean | `false` | Enable autonomous mode |
| `daemon` | boolean | `true` | Run as daemon process |

**Response (200):**
```json
{
  "success": true,
  "message": "Orchestrator started for plan my-plan",
  "orchestrator": {
    "pid": 12345,
    "logFile": "/path/to/orchestrator-my-plan.log",
    "startedAt": "2024-12-27T10:00:00.000Z"
  }
}
```

**Error Responses:**
| Status | Code | Description |
|--------|------|-------------|
| 404 | `PLAN_NOT_FOUND` | Plan file does not exist |
| 409 | `ORCHESTRATOR_ALREADY_RUNNING` | Plan already has running orchestrator |
| 500 | `START_FAILED` | Failed to spawn orchestrator process |

---

#### POST /api/plans/:name/stop

Stop orchestrator for a plan.

**Request Body:**
```json
{
  "force": false,
  "timeout": 30
}
```

| Field | Type | Default | Description |
|-------|------|---------|-------------|
| `force` | boolean | `false` | Use SIGKILL instead of SIGTERM |
| `timeout` | number | `30` | Seconds to wait before force kill |

**Response (200):**
```json
{
  "success": true,
  "message": "Orchestrator stopped for plan my-plan",
  "orchestrator": {
    "pid": 12345,
    "stoppedAt": "2024-12-27T11:00:00.000Z",
    "forced": false
  }
}
```

**Error Responses:**
| Status | Code | Description |
|--------|------|-------------|
| 404 | `ORCHESTRATOR_NOT_RUNNING` | No running orchestrator found |
| 500 | `STOP_FAILED` | Failed to stop orchestrator process |

---

#### GET /api/plans/:name/logs

Stream or fetch orchestrator logs.

**Query Parameters:**
| Parameter | Type | Default | Description |
|-----------|------|---------|-------------|
| `follow` | boolean | `false` | Keep connection open for streaming |
| `lines` | number | `100` | Number of lines to return (from end) |
| `since` | ISO string | - | Only logs after this timestamp |

**Response (200) - Non-streaming:**
```json
{
  "plan": "my-plan",
  "logFile": "/path/to/orchestrator-my-plan.log",
  "lineCount": 50,
  "logs": [
    "[2024-12-27T10:00:00] Starting orchestrator...",
    "[2024-12-27T10:00:01] Processing task 1.1..."
  ]
}
```

**Response (200) - Streaming (SSE):**
```
Content-Type: text/event-stream

data: {"type":"log","content":"[2024-12-27T10:00:00] Starting..."}

data: {"type":"log","content":"[2024-12-27T10:00:01] Processing..."}

data: {"type":"heartbeat","timestamp":"2024-12-27T10:00:30.000Z"}
```

**Error Responses:**
| Status | Code | Description |
|--------|------|-------------|
| 404 | `LOGS_NOT_FOUND` | No log file exists for plan |

---

### 2. Resource Endpoints

#### GET /api/resources

Get resource status and limits.

**Response (200):**
```json
{
  "limits": {
    "concurrentWorktrees": {
      "current": 2,
      "max": 5,
      "canCreate": true
    },
    "diskSpace": {
      "availableMB": 5000,
      "requiredMB": 500,
      "sufficient": true
    }
  },
  "worktrees": {
    "total": 2,
    "stale": 1,
    "abandoned": 0
  },
  "warnings": [],
  "canCreateWorktree": true
}
```

---

#### GET /api/worktrees

List all plan worktrees.

**Response (200):**
```json
{
  "worktrees": [
    {
      "name": "plan-my-plan",
      "path": "/path/to/worktree",
      "branch": "plan/my-plan",
      "planName": "my-plan",
      "status": "active",
      "age": {
        "days": 3,
        "isStale": false
      }
    }
  ],
  "summary": {
    "total": 2,
    "active": 2,
    "stale": 0,
    "abandoned": 0
  }
}
```

---

### 3. Health Endpoint

#### GET /health

Health check endpoint.

**Response (200):**
```json
{
  "status": "ok",
  "timestamp": "2024-12-27T10:00:00.000Z"
}
```

---

### 4. Dashboard Client Expected Endpoints (NOT IMPLEMENTED)

The dashboard client (`client.ts`) expects these endpoints that are NOT implemented in the current API server:

#### Orchestrator Management

| Method | Endpoint | Purpose | Status |
|--------|----------|---------|--------|
| GET | `/api/orchestrators` | List all orchestrators | **NOT IMPLEMENTED** |
| GET | `/api/orchestrators/:id` | Get orchestrator by ID | **NOT IMPLEMENTED** |
| POST | `/api/orchestrators` | Start new orchestrator | **NOT IMPLEMENTED** |
| POST | `/api/orchestrators/:id/pause` | Pause orchestrator | **NOT IMPLEMENTED** |
| POST | `/api/orchestrators/:id/resume` | Resume orchestrator | **NOT IMPLEMENTED** |
| POST | `/api/orchestrators/:id/stop` | Stop orchestrator | **NOT IMPLEMENTED** |

#### Task Management

| Method | Endpoint | Purpose | Status |
|--------|----------|---------|--------|
| GET | `/api/orchestrators/:id/tasks` | Get orchestrator tasks | **NOT IMPLEMENTED** |
| POST | `/api/orchestrators/:id/tasks/:taskId/skip` | Skip a task | **NOT IMPLEMENTED** |
| POST | `/api/orchestrators/:id/tasks/:taskId/retry` | Retry a task | **NOT IMPLEMENTED** |

#### Activity & Findings

| Method | Endpoint | Purpose | Status |
|--------|----------|---------|--------|
| GET | `/api/activity` | List activity events | **NOT IMPLEMENTED** |
| GET | `/api/plans/:name/findings` | List plan findings | **NOT IMPLEMENTED** |
| GET | `/api/plans/:name/findings/:taskId` | Get specific finding | **NOT IMPLEMENTED** |
| GET | `/api/plans/:name/history` | Get run history | **NOT IMPLEMENTED** |

#### Dashboard Summary

| Method | Endpoint | Purpose | Status |
|--------|----------|---------|--------|
| GET | `/api/dashboard/summary` | Dashboard overview data | **NOT IMPLEMENTED** |

---

## WebSocket Contracts

### Connection Endpoints

| Endpoint | Purpose |
|----------|---------|
| `/ws/plans/:name` | Real-time updates for specific plan |
| `/ws/all` | Aggregate updates for all plans |
| `/ws/events` (expected) | Global event stream (dashboard expects this) |
| `/ws/orchestrators/:id` (expected) | Orchestrator-specific stream (dashboard expects this) |

### Message Format

#### Server to Client

**Plan Status Update:**
```json
{
  "type": "status",
  "plan": "my-plan",
  "status": "in_progress",
  "progress": {
    "total": 10,
    "completed": 5,
    "pending": 3,
    "in_progress": 1,
    "failed": 1,
    "percentage": 50
  },
  "currentTask": {
    "id": "2.1",
    "description": "Implement feature X",
    "startedAt": "2024-12-27T10:00:00.000Z"
  },
  "lastUpdatedAt": "2024-12-27T10:05:00.000Z",
  "timestamp": "2024-12-27T10:05:01.000Z"
}
```

**All Plans Update:**
```json
{
  "type": "all-plans",
  "plans": [
    {
      "name": "my-plan",
      "status": "in_progress",
      "progress": {
        "total": 10,
        "completed": 5,
        "percentage": 50
      }
    }
  ],
  "aggregate": {
    "totalPlans": 3,
    "totalTasks": 30,
    "completed": 15,
    "pending": 10,
    "in_progress": 3,
    "failed": 2,
    "percentage": 50
  },
  "timestamp": "2024-12-27T10:05:00.000Z"
}
```

**Heartbeat:**
```json
{
  "type": "heartbeat",
  "timestamp": "2024-12-27T10:05:00.000Z"
}
```

**Error:**
```json
{
  "type": "error",
  "error": "Plan not found: unknown-plan",
  "code": "PLAN_NOT_FOUND"
}
```

### Dashboard Expected WebSocket Events (from types.ts)

```typescript
type WebSocketEventType =
  | "orchestrator:status"    // Status changed
  | "orchestrator:progress"  // Progress updated
  | "task:started"           // Task execution began
  | "task:completed"         // Task finished
  | "task:failed"            // Task failed
  | "tool:started"           // Tool call began
  | "tool:completed"         // Tool call finished
  | "activity:new";          // New activity event
```

**Expected Event Structure:**
```typescript
interface WebSocketEvent<T> {
  type: WebSocketEventType;
  orchestratorId: string;
  timestamp: string;
  data: T;
}
```

---

## Standard Response Formats

### Success Response

```json
{
  "success": true,
  "data": { ... },
  "message": "Optional message"
}
```

### Error Response

```json
{
  "success": false,
  "error": "Error message",
  "code": "ERROR_CODE",
  "details": { ... }
}
```

### Error Codes

| Code | HTTP Status | Description |
|------|-------------|-------------|
| `PLAN_NOT_FOUND` | 404 | Plan does not exist |
| `ORCHESTRATOR_NOT_RUNNING` | 404 | No running orchestrator |
| `ORCHESTRATOR_ALREADY_RUNNING` | 409 | Plan already has active orchestrator |
| `LOGS_NOT_FOUND` | 404 | No log file for plan |
| `NOT_FOUND` | 404 | Unknown route |
| `INTERNAL_ERROR` | 500 | Server error |
| `START_FAILED` | 500 | Failed to start orchestrator |
| `STOP_FAILED` | 500 | Failed to stop orchestrator |

---

## Authentication

**Current Status:** No authentication required.

The API server currently has no authentication mechanism. All endpoints are publicly accessible within the network.

---

## CORS Configuration

All responses include these headers:
```
Access-Control-Allow-Origin: *
Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS
Access-Control-Allow-Headers: Content-Type, Authorization
```

---

## Type Definitions (from Dashboard)

### Task

```typescript
interface Task {
  id: string;
  description: string;
  status: "pending" | "in_progress" | "completed" | "failed" | "skipped";
  phase: number;
  phaseName?: string;
  dependencies?: string[];
  startedAt?: string;
  completedAt?: string;
  error?: string;
  retryCount?: number;
  maxRetries?: number;
  duration?: number;
}
```

### Orchestrator

```typescript
interface Orchestrator {
  id: string;
  planName: string;
  planPath: string;
  status: "running" | "paused" | "stopped" | "completed" | "failed";
  progress: number;
  currentPhase: number;
  currentTask?: string;
  startedAt: string;
  elapsedTime?: number;
  summary: PlanSummary;
  config?: OrchestratorConfig;
}
```

### Plan

```typescript
interface Plan {
  name: string;
  path: string;
  description?: string;
  phases: Phase[];
  summary: PlanSummary;
  createdAt?: string;
  lastRunAt?: string;
}
```

### PlanSummary

```typescript
interface PlanSummary {
  totalTasks: number;
  completed: number;
  pending: number;
  inProgress: number;
  failed: number;
  skipped: number;
}
```

---

## API Contract Gaps Summary

### Mismatch: Dashboard Expectations vs. Actual Implementation

| Category | Dashboard Expects | API Provides | Gap |
|----------|------------------|--------------|-----|
| Orchestrator CRUD | `/api/orchestrators/*` | `/api/plans/:name/start\|stop` | Different URL structure |
| Task Operations | `/api/orchestrators/:id/tasks/*` | Not implemented | No skip/retry support |
| Activity Feed | `/api/activity` | Not implemented | No activity endpoint |
| Findings | `/api/plans/:name/findings/*` | Not implemented | No findings endpoint |
| Run History | `/api/plans/:name/history` | Not implemented | No history endpoint |
| Dashboard Summary | `/api/dashboard/summary` | Not implemented | No summary endpoint |
| WebSocket Events | `orchestrator:*`, `task:*` | `status`, `all-plans` | Different event types |

### Port Mismatch

- Dashboard defaults to: `http://localhost:3001`
- API server defaults to: `http://localhost:3100`

This requires either:
1. Setting `NEXT_PUBLIC_API_URL=http://localhost:3100` for the dashboard
2. Changing API server default port to 3001
3. Configuring both via `.claude/git-workflow.json`

---

## Recommendations

1. **Align Endpoints:** Implement the orchestrator-centric endpoints the dashboard expects, or update dashboard to use plan-centric endpoints
2. **Add Missing Endpoints:** Implement activity, findings, history, and dashboard summary endpoints
3. **Standardize WebSocket Events:** Align WebSocket event types between dashboard expectations and server implementation
4. **Port Configuration:** Resolve the default port mismatch between dashboard and API server
5. **Add Authentication:** Consider adding API key or token-based authentication for production use
