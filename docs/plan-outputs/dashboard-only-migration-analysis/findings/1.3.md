# Task 1.3: Dashboard API Endpoints

## API Configuration

The dashboard connects to an external API server:
- **Base URL**: `process.env.NEXT_PUBLIC_API_URL` (default: `http://localhost:3001`)
- **WebSocket URL**: `process.env.NEXT_PUBLIC_WS_URL` (default: `ws://localhost:3001`)

## REST API Endpoints

### Orchestrator Endpoints

| Method | Endpoint | Purpose | Function |
|--------|----------|---------|----------|
| GET | `/api/orchestrators` | List all orchestrators | `getOrchestrators()` |
| GET | `/api/orchestrators/:id` | Get single orchestrator | `getOrchestrator(id)` |
| POST | `/api/orchestrators` | Start new orchestrator | `startOrchestrator(planPath, config)` |
| POST | `/api/orchestrators/:id/pause` | Pause orchestrator | `pauseOrchestrator(id)` |
| POST | `/api/orchestrators/:id/resume` | Resume orchestrator | `resumeOrchestrator(id)` |
| POST | `/api/orchestrators/:id/stop` | Stop orchestrator | `stopOrchestrator(id)` |

### Plan Endpoints

| Method | Endpoint | Purpose | Function |
|--------|----------|---------|----------|
| GET | `/api/plans` | List all plans | `getPlans()` |
| GET | `/api/plans/:name` | Get plan details | `getPlan(name)` |
| GET | `/api/plans/:name/status` | Get plan status | `getPlanStatus(name)` |
| GET | `/api/plans/:name/findings` | List plan findings | `getFindings(planName)` |
| GET | `/api/plans/:name/findings/:taskId` | Get specific finding | `getFinding(planName, taskId)` |
| GET | `/api/plans/:name/history` | Get run history | `getRunHistory(planName)` |

### Task Endpoints

| Method | Endpoint | Purpose | Function |
|--------|----------|---------|----------|
| GET | `/api/orchestrators/:id/tasks` | Get orchestrator tasks | `getOrchestratorTasks(id)` |
| POST | `/api/orchestrators/:id/tasks/:taskId/skip` | Skip a task | `skipTask(id, taskId, reason)` |
| POST | `/api/orchestrators/:id/tasks/:taskId/retry` | Retry a task | `retryTask(id, taskId)` |

### Activity Endpoints

| Method | Endpoint | Purpose | Function |
|--------|----------|---------|----------|
| GET | `/api/activity` | List activity events | `getActivity(orchestratorId?, page, pageSize)` |

Query parameters:
- `page` (number) - Page number for pagination
- `pageSize` (number) - Items per page
- `orchestratorId` (string, optional) - Filter by orchestrator

### Dashboard Endpoints

| Method | Endpoint | Purpose | Function |
|--------|----------|---------|----------|
| GET | `/api/dashboard/summary` | Dashboard overview data | `getDashboardSummary()` |

### Health Endpoints

| Method | Endpoint | Purpose | Notes |
|--------|----------|---------|-------|
| GET | `/api/health` | Health check | Implemented in Next.js app router |

## WebSocket Endpoints

| Endpoint | Purpose | Events |
|----------|---------|--------|
| `/ws/events` | Global event stream | All orchestrator events |
| `/ws/orchestrators/:id` | Orchestrator-specific stream | Events for single orchestrator |

### WebSocket Event Types

```typescript
type WebSocketEventType =
  | "orchestrator:status"    // Status changed (running/paused/stopped/etc)
  | "orchestrator:progress"  // Progress percentage updated
  | "task:started"           // Task execution began
  | "task:completed"         // Task finished successfully
  | "task:failed"            // Task failed
  | "tool:started"           // Tool call began
  | "tool:completed"         // Tool call finished
  | "activity:new";          // New activity event
```

### WebSocket Event Payloads

```typescript
// Base event structure
interface WebSocketEvent<T> {
  type: WebSocketEventType;
  orchestratorId: string;
  timestamp: string;
  data: T;
}

// Status change
interface OrchestratorStatusEvent {
  status: OrchestratorStatus;
  previousStatus?: OrchestratorStatus;
}

// Progress update
interface OrchestratorProgressEvent {
  progress: number;
  currentPhase: number;
  currentTask?: string;
  summary: PlanSummary;
}

// Task event
interface TaskEvent {
  taskId: string;
  status: TaskStatus;
  error?: string;
}

// Tool event
interface ToolEvent {
  toolCallId: string;
  tool: string;
  status: "running" | "completed" | "failed";
  duration?: number;
}
```

## API Response Types

### Standard Response

```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: string;
}
```

### Paginated Response

```typescript
interface PaginatedResponse<T> {
  items: T[];
  total: number;
  page: number;
  pageSize: number;
  hasMore: boolean;
}
```

## Data Types Expected from API

### Orchestrator

```typescript
interface Orchestrator {
  id: string;
  planName: string;
  planPath: string;
  status: "running" | "paused" | "stopped" | "completed" | "failed";
  progress: number;
  currentPhase: number;
  currentTask?: string;
  startedAt: string;
  elapsedTime?: number;
  summary: PlanSummary;
  config?: OrchestratorConfig;
}
```

### Plan

```typescript
interface Plan {
  name: string;
  path: string;
  description?: string;
  phases: Phase[];
  summary: PlanSummary;
  createdAt?: string;
  lastRunAt?: string;
}
```

### Task

```typescript
interface Task {
  id: string;
  description: string;
  status: "pending" | "in_progress" | "completed" | "failed" | "skipped";
  phase: number;
  phaseName?: string;
  dependencies?: string[];
  startedAt?: string;
  completedAt?: string;
  error?: string;
  retryCount?: number;
  maxRetries?: number;
  duration?: number;
}
```

## Polling Intervals

| Hook | Interval | Purpose |
|------|----------|---------|
| `useOrchestrators()` | 5000ms | Refresh orchestrator list |
| `useOrchestrator(id)` | 2000ms | Refresh single orchestrator |
| `usePlanStatus(name)` | 5000ms | Refresh plan status |
| `useOrchestratorTasks(id)` | 2000ms | Refresh task list |
| `useActivity()` | 3000ms | Refresh activity feed |
| `useDashboardSummary()` | 5000ms | Refresh dashboard stats |

## Error Handling

```typescript
class ApiError extends Error {
  constructor(
    message: string,
    public status: number,  // HTTP status code
    public code?: string    // Custom error code
  ) { ... }
}
```

## API Requirements Summary

The dashboard requires an API server that provides:

1. **23 REST endpoints** across 5 resource types
2. **2 WebSocket endpoints** for real-time updates
3. **8 event types** via WebSocket
4. **Consistent response format** with `success`, `data`, `error` fields
5. **Pagination support** for activity feed
6. **CORS support** for cross-origin requests

## Current Implementation Status

The API server is implemented in the `dev_workflow` project at:
- `scripts/api-server.js` - Main server
- Port 3001 (configurable)
- Runs alongside plan execution

Note: The API server must be running for the dashboard to function.
