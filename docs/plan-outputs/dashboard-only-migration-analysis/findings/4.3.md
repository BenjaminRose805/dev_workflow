# Task 4.3: Data Flow Between Dashboard and Backend Services

## Overview

This document maps the complete data flow architecture between the orchestrator dashboard and dev_workflow backend services, including all communication patterns and data transformations.

## High-Level Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         ORCHESTRATOR DASHBOARD                              │
│                          (Next.js React App)                                │
│                                                                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────────────────┐
│  │ Plans Page  │ │Orchestrator │ │  Activity   │ │ Settings / Config      │
│  │             │ │   Detail    │ │    Feed     │ │                        │
│  └──────┬──────┘ └──────┬──────┘ └──────┬──────┘ └────────────┬───────────┘
│         │               │               │                      │            │
│  ┌──────▼───────────────▼───────────────▼──────────────────────▼──────────┐ │
│  │                      React Query + API Hooks                           │ │
│  │  useOrchestrators() usePlan() useActivity() useDashboardSummary()     │ │
│  └──────────────────────────────────────────────────────────────────────┘ │
│                                    │                                       │
│                                    │ HTTP/WS                               │
└────────────────────────────────────┼───────────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            API SERVER                                        │
│                         (api-server.js)                                     │
│                                                                             │
│  REST Endpoints                   │  WebSocket Endpoints                    │
│  ──────────────                   │  ────────────────────                   │
│  GET  /api/plans                  │  WS /ws/plans/:name                     │
│  GET  /api/plans/:name            │  WS /ws/all                             │
│  GET  /api/plans/:name/status     │                                         │
│  GET  /api/plans/:name/logs       │                                         │
│  POST /api/plans/:name/start      │                                         │
│  POST /api/plans/:name/stop       │                                         │
│  GET  /api/resources              │                                         │
│  GET  /api/worktrees              │                                         │
│                                   │                                         │
└─────────────────┬─────────────────┴─────────────────────────────────────────┘
                  │
                  ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         BACKEND LIBRARIES                                    │
│                                                                             │
│  ┌────────────────────┐  ┌────────────────────┐  ┌────────────────────────┐ │
│  │   plan-status.js   │  │ worktree-utils.js  │  │  orchestrator-registry │ │
│  │                    │  │                    │  │                        │ │
│  │ • loadStatus()     │  │ • listWorktrees()  │  │ • instances[]          │ │
│  │ • markTask*()      │  │ • getRepoRoot()    │  │ • status tracking      │ │
│  │ • getProgress()    │  │ • checkResources() │  │                        │ │
│  └─────────┬──────────┘  └─────────┬──────────┘  └───────────┬────────────┘ │
└────────────┼────────────────────────┼────────────────────────┼──────────────┘
             │                        │                        │
             ▼                        ▼                        ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              FILE SYSTEM                                     │
│                                                                             │
│  docs/plan-outputs/<plan>/         .claude/                 docs/plans/     │
│  ├── status.json                   ├── orchestrator-        ├── plan-a.md   │
│  └── findings/                     │   registry.json        └── plan-b.md   │
│      ├── 1.1.md                    ├── git-workflow.json                    │
│      └── 1.2.md                    └── current-plan.txt                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
             │
             │ (spawned on /api/plans/:name/start)
             ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PLAN ORCHESTRATOR                                    │
│                       (plan_orchestrator.py)                                │
│                                                                             │
│  • Reads plan file                                                          │
│  • Updates status.json                                                      │
│  • Writes to registry                                                       │
│  • Spawns Claude sessions                                                   │
│  • Writes findings                                                          │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

## Detailed Data Flows

### Flow 1: Loading Plans List

```
Dashboard                API Server              plan-status.js        Files
   │                         │                         │                  │
   │ GET /api/plans          │                         │                  │
   │────────────────────────>│                         │                  │
   │                         │ fs.readdirSync()        │                  │
   │                         │─────────────────────────────────────────>  │
   │                         │                         │    docs/plans/   │
   │                         │<─────────────────────────────────────────  │
   │                         │                         │                  │
   │                         │ loadStatus(planPath)    │                  │
   │                         │────────────────────────>│                  │
   │                         │                         │ read status.json │
   │                         │                         │─────────────────>│
   │                         │                         │<─────────────────│
   │                         │<────────────────────────│                  │
   │                         │                         │                  │
   │                         │ check registry.json     │                  │
   │                         │─────────────────────────────────────────>  │
   │                         │<─────────────────────────────────────────  │
   │                         │                         │                  │
   │  { data: plans[] }      │                         │                  │
   │<────────────────────────│                         │                  │
   │                         │                         │                  │
```

**Data Transformations:**
1. File list → Plan names
2. status.json → Summary statistics
3. Registry → Orchestrator running status
4. Combined → Plan list with progress

### Flow 2: Real-time Plan Updates (WebSocket)

```
Dashboard                API Server              File System
   │                         │                         │
   │ WS connect /ws/plans/X  │                         │
   │────────────────────────>│                         │
   │                         │ startPlanWatcher()      │
   │                         │────────────────────────>│
   │                         │ fs.watchFile(status.json)
   │                         │                         │
   │  { type: 'status', ... }│                         │
   │<────────────────────────│                         │
   │                         │                         │
   │         ...time passes...                         │
   │                         │                         │
   │                         │ (file change detected)  │
   │                         │<────────────────────────│
   │                         │                         │
   │                         │ loadStatus()            │
   │                         │────────────────────────>│
   │                         │<────────────────────────│
   │                         │                         │
   │  { type: 'status', ... }│                         │
   │<────────────────────────│                         │
   │                         │                         │
```

**Update Frequency:**
- File watching interval: 1000ms
- WebSocket heartbeat: 30000ms

### Flow 3: Starting Orchestrator

```
Dashboard                API Server              plan_orchestrator.py    Files
   │                         │                         │                    │
   │ POST /api/plans/X/start │                         │                    │
   │ { mode, tasks, ... }    │                         │                    │
   │────────────────────────>│                         │                    │
   │                         │                         │                    │
   │                         │ spawn('python3', [      │                    │
   │                         │   'plan_orchestrator.py',                   │
   │                         │   '--plan', path,       │                    │
   │                         │   '--daemon'            │                    │
   │                         │ ])                      │                    │
   │                         │────────────────────────>│                    │
   │                         │                         │                    │
   │                         │                         │ write registry     │
   │                         │                         │───────────────────>│
   │                         │                         │                    │
   │  { success: true,       │                         │                    │
   │    orchestrator: {...}} │                         │                    │
   │<────────────────────────│                         │                    │
   │                         │                         │                    │
   │                         │                         │ update status.json │
   │                         │                         │───────────────────>│
   │                         │                         │                    │
   │                         │ (file change)           │                    │
   │                         │<────────────────────────────────────────────│
   │                         │                         │                    │
   │  WS: status update      │                         │                    │
   │<────────────────────────│                         │                    │
   │                         │                         │                    │
```

**Spawn Arguments:**
```bash
python3 scripts/plan_orchestrator.py \
  --plan docs/plans/my-plan.md \
  --daemon \
  [--continuous] \
  [--autonomous] \
  [--tasks 1.1,1.2,1.3]
```

### Flow 4: Stopping Orchestrator

```
Dashboard                API Server              Process              Registry
   │                         │                      │                    │
   │ POST /api/plans/X/stop  │                      │                    │
   │ { force: false }        │                      │                    │
   │────────────────────────>│                      │                    │
   │                         │                      │                    │
   │                         │ read registry        │                    │
   │                         │───────────────────────────────────────────>│
   │                         │<───────────────────────────────────────────│
   │                         │                      │                    │
   │                         │ process.kill(pid,    │                    │
   │                         │   'SIGTERM')         │                    │
   │                         │─────────────────────>│                    │
   │                         │                      │ (graceful stop)    │
   │                         │                      │                    │
   │                         │ wait for process     │                    │
   │                         │   to exit            │                    │
   │                         │<─────────────────────│                    │
   │                         │                      │                    │
   │                         │ update registry      │                    │
   │                         │───────────────────────────────────────────>│
   │                         │                      │                    │
   │  { success: true }      │                      │                    │
   │<────────────────────────│                      │                    │
   │                         │                      │                    │
```

### Flow 5: Viewing Task Findings

```
Dashboard                API Server              Files
   │                         │                      │
   │ GET /api/plans/X/       │                      │
   │   findings/1.1          │                      │
   │────────────────────────>│                      │
   │                         │                      │
   │                         │ read findings/1.1.md │
   │                         │─────────────────────>│
   │                         │<─────────────────────│
   │                         │                      │
   │  { content: "# Task..." │                      │
   │    }                    │                      │
   │<────────────────────────│                      │
   │                         │                      │
```

### Flow 6: Log Streaming

```
Dashboard                API Server              Log File
   │                         │                      │
   │ GET /api/plans/X/logs   │                      │
   │   ?follow=true          │                      │
   │────────────────────────>│                      │
   │                         │                      │
   │                         │ readLastLines()      │
   │                         │─────────────────────>│
   │                         │<─────────────────────│
   │                         │                      │
   │  SSE: initial logs      │                      │
   │<────────────────────────│                      │
   │                         │                      │
   │                         │ watchFile()          │
   │                         │─────────────────────>│
   │                         │                      │
   │         ...time passes...                      │
   │                         │                      │
   │                         │ (new content)        │
   │                         │<─────────────────────│
   │                         │                      │
   │  SSE: new log line      │                      │
   │<────────────────────────│                      │
   │                         │                      │
```

**Log Location:** `orchestrator-{planName}.log`

## Data Formats

### status.json (Read by Dashboard)

```json
{
  "planPath": "docs/plans/my-plan.md",
  "planName": "My Plan Title",
  "createdAt": "2024-12-27T10:00:00Z",
  "lastUpdatedAt": "2024-12-27T11:30:00Z",
  "currentPhase": "Phase 2: Implementation",
  "tasks": [
    {
      "id": "1.1",
      "phase": "Phase 1: Setup",
      "description": "Initialize project",
      "status": "completed",
      "dependencies": [],
      "dependents": ["1.2", "1.3"],
      "startedAt": "2024-12-27T10:00:00Z",
      "completedAt": "2024-12-27T10:05:00Z"
    }
  ],
  "summary": {
    "totalTasks": 10,
    "completed": 5,
    "pending": 3,
    "in_progress": 1,
    "failed": 1,
    "skipped": 0
  },
  "runs": [
    {
      "runId": "run-abc123",
      "startedAt": "2024-12-27T10:00:00Z",
      "completedAt": "2024-12-27T11:00:00Z",
      "tasksCompleted": 5,
      "tasksFailed": 0
    }
  ]
}
```

### orchestrator-registry.json (Read by API Server)

```json
{
  "instances": [
    {
      "id": "orch-12345",
      "plan": "my-plan",
      "status": "running",
      "pid": 54321,
      "started_at": "2024-12-27T10:00:00Z",
      "mode": "batch"
    }
  ]
}
```

### WebSocket Message Format

```json
{
  "type": "status",
  "plan": "my-plan",
  "status": "in_progress",
  "progress": {
    "total": 10,
    "completed": 5,
    "pending": 3,
    "in_progress": 1,
    "failed": 1,
    "percentage": 50
  },
  "currentTask": {
    "id": "2.1",
    "description": "Implement feature X",
    "startedAt": "2024-12-27T11:00:00Z"
  },
  "lastUpdatedAt": "2024-12-27T11:05:00Z",
  "timestamp": "2024-12-27T11:05:01Z"
}
```

## Communication Patterns Summary

| Pattern | Protocol | Direction | Purpose |
|---------|----------|-----------|---------|
| **REST GET** | HTTP | Dashboard → API | Fetch data |
| **REST POST** | HTTP | Dashboard → API | Actions (start/stop) |
| **WebSocket** | WS | API → Dashboard | Real-time updates |
| **SSE** | HTTP | API → Dashboard | Log streaming |
| **File Watch** | FS | Files → API | Status change detection |
| **Process Spawn** | OS | API → Orchestrator | Start execution |
| **Process Signal** | OS | API → Orchestrator | Stop execution |

## Latency Analysis

| Operation | Typical Latency | Bottleneck |
|-----------|-----------------|------------|
| Plan list fetch | 50-200ms | File system reads |
| Status update (WS) | 1000-2000ms | File watch interval |
| Start orchestrator | 500-1000ms | Process spawn |
| Stop orchestrator | 100-30000ms | Graceful shutdown |
| Log streaming | ~1000ms | File watch interval |

## Error Handling

| Error Scenario | API Response | Dashboard Behavior |
|----------------|--------------|-------------------|
| Plan not found | 404 PLAN_NOT_FOUND | Show error toast |
| Orchestrator running | 409 ALREADY_RUNNING | Disable start button |
| No orchestrator | 404 NOT_RUNNING | Disable stop button |
| File read error | 500 INTERNAL_ERROR | Show error toast |
| Process spawn fail | 500 START_FAILED | Show error toast |
| WebSocket disconnect | Connection lost | Reconnect with backoff |

## Performance Optimizations

1. **Caching:** React Query caches API responses
2. **Polling:** Fallback when WebSocket unavailable
3. **Batching:** Multiple status updates combined
4. **Lazy Loading:** Findings loaded on demand
5. **Virtual Lists:** Large task lists virtualized
