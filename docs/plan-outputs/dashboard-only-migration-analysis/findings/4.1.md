# Task 4.1: dev_workflow Components the Dashboard Requires

## Overview

This document identifies all dev_workflow components that the dashboard depends on to function. These components MUST be preserved in any migration scenario.

## Required Component Categories

### 1. API Server (CRITICAL)

The dashboard is entirely dependent on the API server for data access.

| Component | File | Purpose | Dashboard Dependency |
|-----------|------|---------|---------------------|
| **API Server** | `scripts/api-server.js` | REST + WebSocket API | **CRITICAL** - Dashboard non-functional without it |

**Lines of Code:** ~1,450 LOC

**Features Used by Dashboard:**
- Plan listing (`GET /api/plans`)
- Plan details (`GET /api/plans/:name`)
- Plan status (`GET /api/plans/:name/status`)
- Orchestrator start (`POST /api/plans/:name/start`)
- Orchestrator stop (`POST /api/plans/:name/stop`)
- Orchestrator logs (`GET /api/plans/:name/logs`)
- Resource status (`GET /api/resources`)
- Worktree listing (`GET /api/worktrees`)
- WebSocket plan updates (`/ws/plans/:name`)
- WebSocket aggregate updates (`/ws/all`)

### 2. Status Management Library (CRITICAL)

All status tracking flows through this library.

| Component | File | Purpose | Dashboard Dependency |
|-----------|------|---------|---------------------|
| **Plan Status Library** | `scripts/lib/plan-status.js` | Status.json read/write | **CRITICAL** - All status data comes from here |

**Functions Used by API Server:**
```javascript
planStatus.loadStatus(planPath)      // Read plan status
planStatus.markTaskStarted(...)      // (indirect via orchestrator)
planStatus.markTaskCompleted(...)    // (indirect via orchestrator)
planStatus.markTaskFailed(...)       // (indirect via orchestrator)
planStatus.markTaskSkipped(...)      // (indirect via orchestrator)
```

**Data Provided:**
- Task list with statuses
- Phase progress
- Run history
- Summary statistics
- Dependency information

### 3. Worktree Utilities (REQUIRED)

Used for worktree status and resource monitoring.

| Component | File | Purpose | Dashboard Dependency |
|-----------|------|---------|---------------------|
| **Worktree Utils** | `scripts/lib/worktree-utils.js` | Git worktree operations | **REQUIRED** - Worktree panel, resource checks |

**Functions Used by API Server:**
```javascript
worktreeUtils.getRepoRoot()           // Find repository root
worktreeUtils.listWorktrees()         // List active worktrees
worktreeUtils.checkResourcesGracefully() // Resource limits
worktreeUtils.getResourceConfig()     // Resource configuration
worktreeUtils.getStaleWorktrees()     // Stale worktree detection
worktreeUtils.getAbandonedWorktrees() // Abandoned worktree detection
worktreeUtils.getWorktreeAge()        // Worktree age info
worktreeUtils.loadGitWorkflowConfig() // Git workflow config
```

### 4. Orchestrator Registry (REQUIRED)

Tracks running orchestrator instances.

| Component | File | Purpose | Dashboard Dependency |
|-----------|------|---------|---------------------|
| **Registry File** | `.claude/orchestrator-registry.json` | Instance tracking | **REQUIRED** - Orchestrator status display |

**Data Used:**
```json
{
  "instances": [
    {
      "id": "abc123",
      "plan": "my-plan",
      "status": "running",
      "pid": 12345,
      "started_at": "2024-01-01T00:00:00Z",
      "mode": "batch"
    }
  ]
}
```

### 5. Plan Orchestrator (REQUIRED)

Executes plans when started from dashboard.

| Component | File | Purpose | Dashboard Dependency |
|-----------|------|---------|---------------------|
| **Plan Orchestrator** | `scripts/plan_orchestrator.py` | Plan execution | **REQUIRED** - Execution on "Start" button |

**Dashboard Interaction:**
- API server spawns `plan_orchestrator.py` with `--daemon` flag
- Orchestrator writes to registry, status.json
- Dashboard reads updates via API/WebSocket

### 6. Status.json File Format (CRITICAL)

Standard format for plan status data.

| Component | Location | Purpose | Dashboard Dependency |
|-----------|----------|---------|---------------------|
| **Status File** | `docs/plan-outputs/<plan>/status.json` | Task/run data | **CRITICAL** - All task data |

**Schema:**
```json
{
  "planPath": "docs/plans/my-plan.md",
  "planName": "My Plan Title",
  "createdAt": "2024-01-01T00:00:00Z",
  "lastUpdatedAt": "2024-01-01T01:00:00Z",
  "currentPhase": "Phase 1: Name",
  "tasks": [],
  "summary": {},
  "runs": []
}
```

### 7. Findings Files (REQUIRED)

Task output/analysis files.

| Component | Location | Purpose | Dashboard Dependency |
|-----------|----------|---------|---------------------|
| **Findings Directory** | `docs/plan-outputs/<plan>/findings/` | Task outputs | **REQUIRED** - FindingsViewer component |

**File Format:** Markdown files named `<task-id>.md`

### 8. Plan Files (REQUIRED)

Source plan markdown files.

| Component | Location | Purpose | Dashboard Dependency |
|-----------|----------|---------|---------------------|
| **Plan Files** | `docs/plans/*.md` | Plan definitions | **REQUIRED** - Plan listing, phase extraction |

### 9. Configuration Files (OPTIONAL)

Git workflow and API configuration.

| Component | Location | Purpose | Dashboard Dependency |
|-----------|----------|---------|---------------------|
| **Git Workflow Config** | `.claude/git-workflow.json` | Workflow settings | **OPTIONAL** - API port, worktree limits |
| **Current Plan Pointer** | `.claude/current-plan.txt` | Active plan | **OPTIONAL** - Not directly used |

## Component Dependency Graph

```
Dashboard (React App)
       │
       ▼
┌──────────────────────────────────────────────────────┐
│                  API Server                          │
│               (api-server.js)                        │
│                    │                                 │
│    ┌───────────────┼───────────────┐                 │
│    │               │               │                 │
│    ▼               ▼               ▼                 │
│ plan-status.js  worktree-utils.js  orchestrator-    │
│                                   registry.json      │
│    │               │                                 │
│    ▼               ▼                                 │
│ status.json    git worktree                         │
│ findings/       commands                             │
└──────────────────────────────────────────────────────┘
       │
       ▼
┌──────────────────────────────────────────────────────┐
│              plan_orchestrator.py                    │
│                    │                                 │
│                    ▼                                 │
│         Claude Code (claude command)                 │
└──────────────────────────────────────────────────────┘
```

## Required Components Summary

| Priority | Component | File(s) | ~LOC | Notes |
|----------|-----------|---------|------|-------|
| **CRITICAL** | API Server | `api-server.js` | 1,450 | Dashboard entry point |
| **CRITICAL** | Plan Status | `lib/plan-status.js` | ~5,000 | All status operations |
| **CRITICAL** | Status Files | `status.json` | N/A | Data storage |
| **REQUIRED** | Worktree Utils | `lib/worktree-utils.js` | ~2,000 | Worktree operations |
| **REQUIRED** | Orchestrator | `plan_orchestrator.py` | ~3,000 | Plan execution |
| **REQUIRED** | Registry | `orchestrator-registry.json` | N/A | Instance tracking |
| **REQUIRED** | Findings | `findings/*.md` | N/A | Task outputs |
| **REQUIRED** | Plan Files | `docs/plans/*.md` | N/A | Plan definitions |
| **OPTIONAL** | Git Config | `git-workflow.json` | N/A | Configuration |

**Total Required LOC:** ~11,500 lines across 4 main files

## Component Preservation Strategy

### For Dashboard-Only Operation:

1. **MUST KEEP:**
   - `scripts/api-server.js` (+ dependencies)
   - `scripts/lib/plan-status.js`
   - `scripts/lib/worktree-utils.js`
   - `scripts/plan_orchestrator.py`

2. **MUST MAINTAIN:**
   - Status.json file format
   - Findings directory structure
   - Orchestrator registry format
   - Plan file locations

3. **CAN BE REMOVED:**
   - TUI components (if not needed)
   - Most CLI scripts (if not needed)
   - Plan skills (if dashboard adds features)

## Implications for Migration

If the goal is to remove CLI/TUI while keeping dashboard functional:

- **Cannot remove:** Core libraries that API server depends on
- **Can remove:** CLI commands that only humans use
- **Can remove:** TUI panels and keyboard handlers
- **Should enhance:** API server to add missing features (plan creation, etc.)
