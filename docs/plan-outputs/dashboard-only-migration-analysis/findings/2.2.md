# Task 2.2: TUI Components and Their Functions

## Overview

The TUI (Terminal User Interface) is located in `scripts/tui/` and provides a Rich-based interactive terminal interface for the plan orchestrator. It consists of 11 Python modules totaling ~20,000 lines of code.

## Component Architecture

```
scripts/tui/
├── __init__.py          (83 LOC) - Package exports
├── panels.py         (2,303 LOC) - Display panels
├── keyboard.py         (641 LOC) - Input handling
├── command_palette.py  (465 LOC) - Command discovery
├── task_picker.py      (485 LOC) - Task selection modal
├── task_actions.py     (429 LOC) - Task action handlers
├── command_runner.py   (772 LOC) - Command execution
├── overlays.py         (526 LOC) - Modal overlays
├── findings_browser.py (500 LOC) - Findings viewer
├── error_handler.py    (537 LOC) - Error recovery
└── config.py           (372 LOC) - Persistence
```

## Detailed Component Analysis

### 1. KeyboardHandler (`keyboard.py`)

**Purpose:** Non-blocking keyboard input handling with mode support.

| Class | Purpose |
|-------|---------|
| `KeyboardHandler` | Threaded stdin reader, key event queue, action dispatcher |
| `KeyEvent` | Dataclass representing a keyboard event with modifiers |
| `InputMode` | Enum: NORMAL, COMMAND, SEARCH, INSERT |

**Features:**
- Terminal raw mode for immediate key capture
- Vim-style key mappings (j/k for up/down)
- Escape sequence parsing for special keys
- Mode-based handler routing
- Navigation callbacks for TUI integration

**Key Bindings:**
- `j/k` or `↑/↓`: Navigate
- `Tab`: Switch panel
- `:`: Command palette mode
- `/`: Search mode
- `?`: Toggle help
- `Escape`: Exit mode

### 2. Panels (`panels.py`) - Largest Module

**Purpose:** Visual display components for plan status and task information.

| Class | Lines | Purpose |
|-------|-------|---------|
| `PhaseProgressPanel` | ~200 | Phase-by-phase progress bars |
| `UpcomingPanel` | ~200 | Next recommended tasks with blockers |
| `RunHistoryPanel` | ~200 | Execution run history |
| `DependencyGraphPanel` | ~300 | Task dependency visualization |
| `SubtaskTreePanel` | ~400 | Hierarchical subtask view |
| `ArtifactBrowserPanel` | ~300 | Findings/artifact file browser |
| `AgentTrackerPanel` | ~300 | Parallel agent status display |

**Data Classes:**
- `PhaseInfo`: Phase completion data
- `UpcomingTask`: Task with dependency/blocker info
- `RunInfo`: Execution run metadata
- `DependencyNode`: Node in dependency graph
- `SubtaskNode`: Node in subtask tree
- `Artifact`: Finding file metadata

### 3. CommandPaletteModal (`command_palette.py`)

**Purpose:** Command discovery and execution interface (like VS Code's Ctrl+P).

| Feature | Description |
|---------|-------------|
| Command Discovery | Scans `.claude/commands/plan/*.md` for commands |
| Fuzzy Search | Prefix, substring, and character matching with scoring |
| Tab Completion | Completes to longest common prefix |
| Execution | Invokes command with optional arguments |

**Workflow:**
1. Press `:` to open palette
2. Type to filter commands
3. Use ↑/↓ to navigate
4. Press Enter to execute
5. Press Escape to cancel

### 4. TaskPickerModal (`task_picker.py`)

**Purpose:** Interactive task selection with multi-select support.

| Feature | Description |
|---------|-------------|
| Task Loading | Fetches from status.json via status-cli.js |
| Status Display | Icons for pending/in_progress/failed/blocked |
| Multi-Select | Space key to toggle multiple tasks |
| Search | Type to filter by ID or description |
| Blocker Display | Shows blocking task IDs |

**Task Status Icons:**
- `◆` In progress (yellow)
- `✗` Failed (red)
- `⊘` Blocked (dim)
- `✓` Verify task (magenta)
- `○` Pending (white)

### 5. TaskActionHandler (`task_actions.py`)

**Purpose:** Handles keyboard actions on selected tasks.

| Key | Action | Implementation |
|-----|--------|----------------|
| `e` | Explain | Invokes `/plan:explain` |
| `i` | Implement | Invokes `/plan:implement` |
| `v` | Verify | Invokes `/plan:verify` |
| `s` | Skip | Calls `status-cli.js mark-skipped` |
| `f` | Findings | Opens findings file browser |
| `d` | Dependencies | Calls `status-cli.js check` |

### 6. CommandRunner (`command_runner.py`)

**Purpose:** Executes plan commands with real-time output streaming.

| Class | Purpose |
|-------|---------|
| `CommandRunner` | Main runner with state tracking |
| `CommandOutputStreamer` | Higher-level TUI integration |
| `AgentTracker` | Tracks parallel agent spawn/completion |
| `CommandState` | Enum: IDLE, STARTING, RUNNING, COMPLETED, FAILED, CANCELLED |
| `StreamEvent` | Event from command stream |
| `AgentInfo` | Parallel agent metadata |

**Features:**
- Background thread execution
- Tool call tracking
- Agent spawn detection (Task tool)
- Fan-in status (waiting for N/M agents)
- Duration tracking

### 7. OverlayManager (`overlays.py`)

**Purpose:** Modal overlay management system.

| Class | Purpose |
|-------|---------|
| `HelpOverlay` | Keybinding reference display |
| `OverlayManager` | Overlay stack and visibility control |
| `OverlayType` | Enum: HELP, COMMAND_PALETTE, TASK_PICKER, FINDINGS, ERROR |
| `KeyBinding` | Keybinding definition with category |

**Default Keybindings Displayed:**
- Navigation: j/k/↑/↓, Tab, g/G, Home/End
- Mode: ?, :, /, Esc
- Task Actions: e, i, v, s, f, d
- Panel Toggles: 1-5, F
- General: q, r

### 8. ErrorHandler (`error_handler.py`)

**Purpose:** Graceful error handling and automatic recovery.

| Class | Purpose |
|-------|---------|
| `ErrorHandler` | Main handler with context manager and decorators |
| `ErrorRecovery` | Recovery strategies by error category |
| `ErrorNotifier` | Display errors in TUI without crashing |
| `TUIError` | Error dataclass with severity/category |
| `ErrorSeverity` | Enum: INFO, WARNING, ERROR, CRITICAL |
| `ErrorCategory` | Enum: FILE_NOT_FOUND, PERMISSION_DENIED, JSON_PARSE_ERROR, etc. |

**Recovery Strategies:**
- FILE_NOT_FOUND: Create missing directories
- JSON_PARSE_ERROR: Backup corrupt file
- CONFIG_ERROR: Reset to defaults
- RENDER_ERROR: Skip to next refresh

### 9. ConfigManager (`config.py`)

**Purpose:** TUI configuration persistence.

| Setting | Type | Default |
|---------|------|---------|
| `panel_visibility` | Dict | All panels visible except subtask_tree |
| `use_vim_keys` | bool | True |
| `auto_hide_panels` | bool | True |
| `refresh_rate` | int | 4 Hz |
| `compact_threshold` | int | 24 rows |
| `search_history` | List | Empty |

**Config Location:** `~/.config/claude-code/tui-panels.json`

## Component Interactions

```
                    ┌─────────────────┐
                    │ KeyboardHandler │
                    └────────┬────────┘
                             │ events
                    ┌────────▼────────┐
                    │  OverlayManager │
                    └────────┬────────┘
            ┌───────────────┼───────────────┐
            │               │               │
     ┌──────▼──────┐ ┌──────▼──────┐ ┌──────▼──────┐
     │CommandPalette│ │ TaskPicker │ │  HelpOverlay │
     └──────┬──────┘ └──────┬──────┘ └─────────────┘
            │               │
            └───────┬───────┘
                    │
            ┌───────▼───────┐
            │ TaskActionHandler
            └───────┬───────┘
                    │
            ┌───────▼───────┐
            │ CommandRunner │
            └───────┬───────┘
                    │
            ┌───────▼───────┐
            │ AgentTracker  │
            └───────────────┘
```

## TUI Feature Summary

| Feature Category | Components Used |
|------------------|-----------------|
| **Display** | panels.py (7 panel types) |
| **Input** | keyboard.py (mode-based input) |
| **Commands** | command_palette.py, command_runner.py |
| **Task Selection** | task_picker.py (multi-select modal) |
| **Task Actions** | task_actions.py (e/i/v/s/f/d keys) |
| **Overlays** | overlays.py (help, modals) |
| **Findings** | findings_browser.py, panels.py (ArtifactBrowserPanel) |
| **Error Handling** | error_handler.py (recovery strategies) |
| **Configuration** | config.py (persistence to JSON) |
| **Agent Tracking** | command_runner.py (AgentTracker) |

## Dashboard Comparison Notes

Features the TUI has that the dashboard lacks:
1. **Direct command execution** - TUI can invoke plan:implement directly
2. **Keyboard-first navigation** - vim-style bindings, command palette
3. **Agent tracking** - Real-time parallel agent status display
4. **Subtask tree view** - Hierarchical X.Y.Z task visualization
5. **Run history panel** - Per-execution run tracking in TUI layout
6. **Error recovery** - Automatic recovery strategies for common errors
7. **Configuration persistence** - User preferences saved locally
