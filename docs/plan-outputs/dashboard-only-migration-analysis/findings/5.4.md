# Task 5.4: Cleanup Effort Estimation and Risk Analysis

## Overview

This document provides a detailed assessment of the effort required and risks involved in removing CLI/TUI components to achieve a dashboard-only architecture. It includes file counts, lines of code, complexity ratings, and mitigation strategies.

## Effort Estimation

### Files to Remove (CLI/TUI Only)

| Category | Files | Lines of Code | Notes |
|----------|-------|---------------|-------|
| **TUI Directory** | 11 | 7,100 | `scripts/tui/*.py` - Complete removal safe |
| **CLI Wrapper Scripts** | 14 | 7,866 | Wrappers around lib functions |
| **Plan Skills** | 20 | 11,256 | `.claude/commands/plan/*.md` |
| **Common Commands** | 3 | 2,803 | `.claude/commands/plan/_common/*.md` |
| **Templates** | 14 | ~2,000 | `.claude/templates/` (markdown) |
| **Test Scripts** | 15 | 5,615 | `scripts/tests/*.js, *.py` |
| **lib/tui.py** | 1 | 2,425 | TUI manager for orchestrator |
| **lib/multi_plan_tui.py** | 1 | 1,345 | Multi-plan TUI (unused by dashboard) |
| **TOTAL REMOVABLE** | **79** | **~40,410** | |

### Files to Modify

| File | Lines | Required Changes | Complexity |
|------|-------|------------------|------------|
| `plan_orchestrator.py` | 1,631 | Remove TUI imports, use `--no-tui` by default | Medium |
| `api-server.js` | 1,466 | Ensure `--no-tui` flag passed when spawning orchestrator | Low |
| `.claude/CLAUDE.md` | - | Remove CLI/TUI documentation references | Low |
| `package.json` | - | Remove CLI-related scripts | Low |
| **TOTAL TO MODIFY** | **~3,200** | | |

### Files to Keep (Dashboard Required)

| File | Lines | Purpose |
|------|-------|---------|
| `api-server.js` | 1,466 | REST/WebSocket API |
| `plan_orchestrator.py` | 1,631 | Execution engine |
| `lib/plan-status.js` | 2,537 | Status management |
| `lib/worktree-utils.js` | 2,316 | Git worktree operations |
| `lib/claude_runner.py` | 279 | Claude session runner |
| `lib/orchestrator_registry.py` | 494 | Instance tracking |
| `lib/orchestrator_ipc.py` | 424 | Inter-process communication |
| `lib/status_monitor.py` | 195 | Status file monitoring |
| `lib/event_bus.py` | 340 | Event distribution |
| `lib/git-queue.js` | 523 | Git operation queuing |
| `lib/plan-output-utils.js` | 1,230 | Output file utilities |
| Other lib utilities | ~3,000 | Various helper functions |
| **TOTAL TO KEEP** | **~14,435** | |

### Summary

| Metric | Value |
|--------|-------|
| **Files to Remove** | 79 files |
| **Files to Modify** | 4-5 files |
| **Files to Keep** | ~15-20 files |
| **Lines to Remove** | ~40,000 LOC |
| **Lines to Modify** | ~100-200 LOC |
| **Lines to Keep** | ~14,500 LOC |
| **Net Codebase Reduction** | ~73% of scripts/ directory |

### Complexity Rating: **MEDIUM**

**Rationale:**
- Most removals are clean deletions with no dependencies
- TUI is optional via `--no-tui` flag (already implemented)
- No database migrations or schema changes
- No external API changes
- Dashboard continues to work with existing API server

## Risk Analysis

### 1. Breaking Changes Risk: **LOW-MEDIUM**

| Risk | Likelihood | Impact | Description |
|------|------------|--------|-------------|
| API server still works | N/A | N/A | No changes needed to API endpoints |
| Orchestrator still works | Low | High | Needs `--no-tui` flag but already supported |
| Dashboard functionality | Low | Low | No direct dependency on CLI/TUI |
| Claude Code users affected | **High** | **High** | Cannot use `/plan:*` skills |

**Details:**
- Dashboard itself has no breaking changes
- Users relying on `/plan:create`, `/plan:implement`, etc. will lose functionality
- Git auto-commit feature disappears (currently only in CLI skills)

### 2. Data Loss Risk: **VERY LOW**

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| status.json corruption | Very Low | High | Read-only from dashboard, orchestrator handles writes |
| findings/ loss | Very Low | Medium | Unaffected by cleanup |
| Plan files loss | Very Low | High | Plans are user-created, not touched |
| Git history loss | None | N/A | Git operations unaffected |

**Details:**
- Cleanup only removes code, not data
- All file formats remain unchanged
- No migration scripts needed

### 3. Regression Risk: **LOW-MEDIUM**

| Area | Risk Level | Description |
|------|------------|-------------|
| Orchestrator execution | Low | Well-tested daemon mode already exists |
| Status updates | Low | lib/plan-status.js unchanged |
| WebSocket streaming | Low | api-server.js unchanged |
| Worktree operations | Low | lib/worktree-utils.js unchanged |
| Plan parsing | Medium | Some edge cases may exist in removed scan-plans.js |

**Details:**
- Core libraries are well-tested and unchanged
- Main risk is discovering hidden dependencies during cleanup

### 4. Dependency Chain Risks: **MEDIUM**

| Dependency | Risk | Impact |
|------------|------|--------|
| `plan_orchestrator.py` → `lib/tui.py` | Medium | Optional import, has fallback |
| `lib/worktree-utils.js` → `lib/git-queue.js` | Low | Both retained |
| `lib/plan-status.js` → `lib/markdown-parser.js` | Low | Both retained |
| Various scripts → `lib/plan-status.js` | Low | Removing scripts, keeping lib |

**Critical Chain:**
```
Dashboard → API Server → plan-status.js → status.json ✓
Dashboard → API Server → worktree-utils.js → git commands ✓
Dashboard → API Server → plan_orchestrator.py → claude_runner.py → Claude ✓
```

All critical chains preserved.

### 5. Hidden Dependency Risk: **MEDIUM**

Potential undiscovered dependencies:

| Scenario | Detection Method | Mitigation |
|----------|------------------|------------|
| Shared utility imports | `grep -r "require\|import"` on removed files | Run before deletion |
| Global state pollution | Full test suite | Run integration tests |
| Environment variable assumptions | Audit removed scripts | Document ENV vars |
| File path assumptions | Search for hardcoded paths | Update paths if found |

## Mitigation Strategies

### For Breaking Changes Risk

1. **Provide migration path for CLI users**
   - Document that `/plan:*` skills are removed
   - Point users to dashboard for monitoring
   - Consider keeping `/plan:create` if templates are valuable

2. **Add critical CLI features to dashboard**
   - Plan creation wizard (CRITICAL gap - task 3.4)
   - Git auto-commit via API server enhancement
   - Explain/verify buttons on task rows

3. **Staged rollout**
   - Deploy to staging first
   - Get user feedback before removing CLI
   - Maintain CLI in separate branch for rollback

### For Regression Risk

1. **Comprehensive testing before cleanup**
   ```bash
   # Test orchestrator with --no-tui
   python scripts/plan_orchestrator.py --plan test-plan.md --no-tui --daemon

   # Test API server endpoints
   curl http://localhost:3000/api/plans
   curl http://localhost:3000/api/plans/test-plan/status

   # Test WebSocket connections
   wscat -c ws://localhost:3000/ws/all
   ```

2. **Automated test coverage**
   - Keep test scripts until cleanup validated
   - Run full test suite after each phase
   - Add integration tests for critical paths

3. **Incremental deletion**
   - Remove one category at a time
   - Validate functionality between phases
   - Git commit after each successful phase

### For Dependency Chain Risk

1. **Dependency audit script**
   ```bash
   # Check for imports of files being removed
   for file in $(find scripts/tui -name "*.py"); do
     echo "Checking references to: $file"
     grep -r "$(basename $file .py)" scripts/ --include="*.py" --include="*.js"
   done
   ```

2. **Keep lib/tui.py initially**
   - plan_orchestrator.py imports it
   - Has graceful fallback if RICH_AVAILABLE is False
   - Can remove later after confirming `--no-tui` works

3. **Document retained dependencies**
   - Create dependency graph of kept files
   - Ensure no circular dependencies
   - Update imports after cleanup

### For Hidden Dependency Risk

1. **Pre-cleanup audit checklist**
   - [ ] Search for imports of removed files
   - [ ] Search for function calls to removed modules
   - [ ] Check for shared configuration files
   - [ ] Verify environment variable requirements
   - [ ] Test all API endpoints

2. **Rollback plan**
   - Create git tag before cleanup
   - Document exact revert commands
   - Test revert procedure

## Recommended Cleanup Order/Phases

### Phase 1: Safe Deletions (Low Risk)
**Files:** 25 | **LOC:** ~7,600 | **Duration:** 1-2 hours

Remove files with zero dependencies:
1. `scripts/tests/` directory (15 files, 5,615 LOC)
2. `scripts/generate_api_types.py` (419 LOC)
3. `scripts/run_api_server.py` (254 LOC) - server runs directly
4. `scripts/cache-clear.js` (215 LOC)
5. `scripts/cache-stats.js` (356 LOC)
6. `scripts/check-file-status.js` (416 LOC)

**Validation:**
- Start API server
- Verify dashboard loads
- Start/stop orchestrator

### Phase 2: CLI Wrapper Scripts (Low Risk)
**Files:** 10 | **LOC:** ~6,000 | **Duration:** 1-2 hours

Remove CLI wrappers that have lib equivalents:
1. `scripts/status-cli.js` (3,799 LOC) - wrapper for lib/plan-status.js
2. `scripts/worktree-cli.js` (493 LOC) - wrapper for lib/worktree-utils.js
3. `scripts/switch_plan.py` (352 LOC)
4. `scripts/multi_plan_monitor.py` (292 LOC)
5. `scripts/scan-plans.js` (155 LOC) - API has own implementation
6. `scripts/parse-plan-structure.js` (120 LOC)
7. `scripts/validate-plan-format.js` (335 LOC)
8. `scripts/substitute-variables.js` (439 LOC)
9. `scripts/migrate-completed-plan.js` (221 LOC)

**Validation:**
- API endpoints still work
- Dashboard shows plans correctly
- Orchestrator starts/stops correctly

### Phase 3: TUI Components (Medium Risk)
**Files:** 13 | **LOC:** ~10,870 | **Duration:** 2-3 hours

Remove TUI-specific code:
1. `scripts/tui/` directory (11 files, 7,100 LOC)
2. `scripts/lib/multi_plan_tui.py` (1,345 LOC)
3. `scripts/lib/tui.py` (2,425 LOC) - **Requires orchestrator update**

**Pre-requisite:**
- Modify `api-server.js` to pass `--no-tui` when spawning orchestrator
- Verify orchestrator works without TUI

**Validation:**
- Start orchestrator via dashboard
- Monitor task execution
- Check activity feed updates

### Phase 4: Plan Skills (Medium Risk - User Impact)
**Files:** 23 | **LOC:** ~14,059 | **Duration:** 2-3 hours

**WARNING:** This removes user-facing Claude Code functionality

Remove plan skills:
1. `.claude/commands/plan/` (20 files, 11,256 LOC)
2. `.claude/commands/plan/_common/` (3 files, 2,803 LOC)

**Pre-requisite:**
- Document alternative workflows
- Communicate change to users
- Consider keeping `/plan:create` for templates

**Validation:**
- Dashboard still works
- Users cannot invoke removed skills (expected)
- Document workarounds

### Phase 5: Templates (Low Risk - User Impact)
**Files:** 14 | **LOC:** ~2,000 | **Duration:** 30 minutes

Remove template files:
1. `.claude/templates/` directory

**Note:** Only remove if dashboard adds plan creation feature

**Validation:**
- No runtime impact
- Users lose template-based plan creation

## Summary Effort Table

| Phase | Files | LOC | Risk | Duration | Dependencies |
|-------|-------|-----|------|----------|--------------|
| Phase 1: Safe Deletions | 25 | 7,600 | Low | 1-2h | None |
| Phase 2: CLI Wrappers | 10 | 6,000 | Low | 1-2h | None |
| Phase 3: TUI Components | 13 | 10,870 | Medium | 2-3h | Orchestrator update |
| Phase 4: Plan Skills | 23 | 14,059 | Medium | 2-3h | User communication |
| Phase 5: Templates | 14 | 2,000 | Low | 30m | Dashboard plan creation |
| **TOTAL** | **85** | **~40,500** | **Medium** | **~8-12h** | |

## Conclusion

The cleanup is **feasible with moderate effort** and **manageable risk**. Key considerations:

1. **Technical risk is low** - Most code is safely removable with clear boundaries
2. **User impact is high** - CLI users lose significant functionality
3. **Recommended approach:**
   - Implement CRITICAL dashboard features first (plan creation, git auto-commit)
   - Then proceed with phased cleanup
   - Maintain rollback capability throughout

4. **Not recommended:** Removing Plan Skills (Phase 4) without adding dashboard alternatives
5. **Quick wins:** Phases 1-2 provide ~60% of cleanup value with minimal risk
