# Task 5.4: Design /plan:complete Command (Merge Workflow)

## Command Overview

**Name:** `/plan:complete`

**Purpose:** Merge a completed plan branch into main using the configured merge strategy (default: squash merge), with verification, archive creation, and cleanup.

**Philosophy:** Plans are atomic units of work. Completion represents the culmination of all tasks, verified and ready for integration.

---

## 1. Pre-Completion Checks

### 1.1 Task Completion Status

All tasks must be marked completed (or bypassed with `--force`):

```javascript
const incomplete = status.tasks.filter(t =>
  t.status === 'pending' || t.status === 'in_progress'
);

if (incomplete.length > 0 && !options.force) {
  throw new Error(`Cannot complete: ${incomplete.length} incomplete tasks`);
}
```

### 1.2 Branch Verification

Must be on a plan branch (`plan/{plan-name}`):

```bash
CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)

if [[ ! "$CURRENT_BRANCH" =~ ^plan/ ]]; then
  echo "Error: Not on a plan branch"
  exit 1
fi
```

### 1.3 Working Directory Clean

No uncommitted changes allowed:

```bash
if [[ -n $(git status --porcelain) ]]; then
  echo "Error: Uncommitted changes detected"
  exit 1
fi
```

### 1.4 Already Merged Check

Prevent double merge:

```bash
git checkout main
MERGE_BASE=$(git merge-base main plan/$PLAN_NAME)
PLAN_HEAD=$(git rev-parse plan/$PLAN_NAME)

if [[ "$MERGE_BASE" == "$PLAN_HEAD" ]]; then
  echo "Error: Plan already merged"
  exit 1
fi
```

---

## 2. Verification Gate (Optional)

### 2.1 Test Execution

```bash
npm test

if [[ $? -ne 0 ]]; then
  echo "Error: Tests failed"
  echo "Fix tests or use --skip-verify"
  exit 1
fi
```

### 2.2 Build Verification

```bash
npm run build

if [[ $? -ne 0 ]]; then
  echo "Error: Build failed"
  exit 1
fi
```

### 2.3 Skip Flag

```bash
/plan:complete --skip-verify
```

---

## 3. Archive Creation

### 3.1 Archive Tag

**Format:** `archive/plan-{plan-name}`

```bash
TAG_NAME="archive/plan-$PLAN_NAME"

git tag -a "$TAG_NAME" -m "Plan: $PLAN_NAME

Status: completed
Tasks: $TASK_COUNT
Duration: $DURATION

Archive preserves granular task-level commit history.

Recovery:
  git log $TAG_NAME
  git checkout -b recovered-$PLAN_NAME $TAG_NAME

Generated by: /plan:complete"
```

### 3.2 Push Archive Tag (Optional)

```bash
git push origin $TAG_NAME
```

---

## 4. Merge Workflow

### 4.1 Switch to Main

```bash
git checkout main
```

### 4.2 Pull Latest (If Remote)

```bash
if git remote | grep -q 'origin'; then
  git pull origin main
fi
```

### 4.3 Conflict Detection (Pre-Merge)

```bash
MERGE_BASE=$(git merge-base HEAD plan/$PLAN_NAME)
git merge-tree $MERGE_BASE HEAD plan/$PLAN_NAME > /tmp/merge-preview

if grep -q "<<<<<" /tmp/merge-preview; then
  echo "CONFLICT DETECTED"
  exit 1
fi
```

### 4.4 Squash Merge (Default)

```bash
git merge --squash plan/$PLAN_NAME

git commit -m "plan: Complete $PLAN_NAME ($TASK_COUNT tasks)

Completed $TASK_COUNT tasks across $PHASES phases.

Tasks:
$TASK_SUMMARY

Archive: archive/plan-$PLAN_NAME
Strategy: squash

Generated with Claude Code
Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>"
```

### 4.5 Merge Commit (Alternative)

```bash
/plan:complete --merge commit

git merge --no-ff plan/$PLAN_NAME -m "..."
```

---

## 5. Cleanup

### 5.1 Delete Local Branch

```bash
git branch -D plan/$PLAN_NAME
```

### 5.2 Delete Remote Branch

```bash
git push origin --delete plan/$PLAN_NAME
```

### 5.3 Update status.json

```json
{
  "planState": "merged",
  "mergedAt": "2025-12-24T12:00:00Z",
  "mergeStrategy": "squash",
  "mergeCommit": "abc123de",
  "archiveTag": "archive/plan-implement-auth",
  "branchDeleted": true
}
```

### 5.4 Push to Remote

```bash
git push origin main
```

---

## 6. Rollback Capability

### 6.1 Pre-Merge Backup Tag

```bash
BACKUP_TAG="backup/complete-$PLAN_NAME-$(date +%s)"
git tag "$BACKUP_TAG" plan/$PLAN_NAME
```

### 6.2 Conflict Recovery

```
MERGE CONFLICT - RECOVERY STEPS

1. RESOLVE AND RETRY
   git checkout plan/$PLAN_NAME
   git merge main
   # Resolve conflicts
   git commit
   /plan:complete

2. REBASE ONTO MAIN
   git checkout plan/$PLAN_NAME
   git rebase main
   /plan:complete

Backup: backup/complete-$PLAN_NAME-...
```

### 6.3 Abort Command

```bash
/plan:complete --abort

git merge --abort
git checkout plan/$PLAN_NAME
```

---

## 7. Command Interface

### Basic Usage

```bash
/plan:complete              # Default: squash
```

### Merge Strategy Options

```bash
/plan:complete --merge squash   # Squash (default)
/plan:complete --merge commit   # Preserve task commits
```

### Verification Options

```bash
/plan:complete --skip-verify    # Skip tests/build
/plan:complete --verify         # Force verification
```

### Cleanup Options

```bash
/plan:complete --keep-branch    # Don't delete branch
/plan:complete --no-push        # Don't push to remote
```

### Safety Options

```bash
/plan:complete --force          # Skip task completion check
/plan:complete --dry-run        # Preview without executing
/plan:complete --abort          # Cancel in-progress merge
```

### Combined Examples

```bash
# Emergency hotfix
/plan:complete --force --skip-verify

# Conservative merge
/plan:complete --verify --merge commit --no-push

# Preview
/plan:complete --dry-run
```

---

## 8. Output Format

### Success Flow

```
════════════════════════════════════════
            PLAN COMPLETION
════════════════════════════════════════

Plan: implement-auth
Branch: plan/implement-auth
Strategy: squash merge

PRE-COMPLETION CHECKS
✓ All tasks completed (25/25)
✓ On plan branch
✓ Working directory clean
✓ Not yet merged

VERIFICATION GATE
✓ Tests passed (142/142)
✓ Build succeeded

ARCHIVE CREATION
✓ Archive tag: archive/plan-implement-auth

MERGE TO MAIN
✓ Switched to main
✓ Squash merge completed
✓ Merge commit: abc123de

CLEANUP
✓ Local branch deleted
✓ Remote branch deleted
✓ Pushed to origin/main

════════════════════════════════════════
         COMPLETION SUCCESSFUL
════════════════════════════════════════
```

### Dry-Run Output

```
DRY RUN MODE - No changes will be made

Would perform:
  ✓ Pre-completion checks
  ✓ Create archive tag
  ✓ Squash merge
  ✓ Delete branches
  ✓ Push to remote

To execute: /plan:complete
```

---

## 9. Configuration

### Configuration File

```json
{
  "merge_triggers": {
    "plan_completion": {
      "default_strategy": "squash",
      "require_verification": true,
      "verification": {
        "run_tests": true,
        "test_command": "npm test"
      },
      "archive": {
        "create_tag": true,
        "push_to_remote": true
      },
      "cleanup": {
        "delete_local_branch": true,
        "delete_remote_branch": true,
        "auto_push": true
      }
    }
  }
}
```

---

## 10. Error Handling

### Common Errors

| Error | Recovery |
|-------|----------|
| Incomplete tasks | Complete tasks or --force |
| Not on plan branch | Use /plan:set |
| Uncommitted changes | Commit or stash |
| Tests failed | Fix tests or --skip-verify |
| Merge conflict | Resolve manually |
| Push failed | Push manually later |

---

## 11. Integration

### Command Flow

```
/plan:create → /plan:implement → /plan:verify → /plan:complete
                     ↓                ↓               ↓
                 (commits)       (validation)      (merge!)
```

### Status.json States

**Before:** `"planState": "active"`
**After:** `"planState": "merged"`

---

## 12. Success Criteria

```bash
# Merge commit on main
git log main --oneline -1
# → "plan: Complete implement-auth (25 tasks)"

# Archive tag exists
git tag -l "archive/plan-*"
# → archive/plan-implement-auth

# Plan branch deleted
git branch -l "plan/*"
# → (empty or other plans)

# Status.json updated
jq '.planState' status.json
# → "merged"
```

---

## 13. Summary

**Key Design Principles:**

1. **Safety first** - Backup tags, conflict detection, abort capability
2. **Flexibility** - Multiple merge strategies, skip flags
3. **Transparency** - Clear output, dry-run mode
4. **Recovery** - Every failure has documented recovery path
5. **Integration** - Works with existing plan commands

**Default Workflow:**
1. Verify all tasks complete
2. Run tests and build
3. Create archive tag
4. Squash merge to main
5. Delete plan branch
6. Push to remote

**Total command file: ~400 lines** (similar to /plan:implement)
