# Task 7.5: Implementation Plan Outline

## Overview

This document outlines the implementation plan for integrating the recommended git workflow (Hybrid A: Branch-Per-Plan + Commit-Per-Task + Squash Merge) into the plan orchestration system. The plan is structured in four phases, prioritizing safety and core functionality.

---

## Implementation Summary

| Phase | Focus | Duration | Priority |
|-------|-------|----------|----------|
| Phase 1 | Core Branching | 1-2 weeks | CRITICAL |
| Phase 2 | Automated Completion | 1-2 weeks | HIGH |
| Phase 3 | Safety & Rollback | 1-2 weeks | HIGH |
| Phase 4 | Advanced Features | 2-3 weeks | MEDIUM |

**Total Estimated Effort:** 5-9 weeks

---

## Phase 1: Core Branching (MVP)

### Objective
Enable basic branch-per-plan workflow with commit-per-task enforcement.

### Tasks

#### 1.1 Branch Management in /plan:set
- **File:** `.claude/commands/plan/set.md`
- **Changes:**
  - On plan selection, check if `plan/{plan-name}` branch exists
  - If not, create branch from current HEAD: `git checkout -b plan/{plan-name}`
  - If exists, switch to it: `git checkout plan/{plan-name}`
  - Handle uncommitted changes (warn, offer stash/commit)
  - Record branch name in status.json

**Acceptance Criteria:**
- [ ] `/plan:set my-plan` creates branch `plan/my-plan`
- [ ] Subsequent `/plan:set my-plan` switches to existing branch
- [ ] Uncommitted changes trigger warning before switch
- [ ] Branch name recorded in status.json

#### 1.2 Enforce Commits in /plan:implement
- **File:** `.claude/commands/plan/implement.md`
- **Changes:**
  - After task completion, automatically execute git add/commit
  - Use message format: `task {id}: {description}`
  - Include plan/phase metadata in commit body
  - Record commit SHA in status.json
  - Skip commit if no file changes (analysis-only tasks)

**Acceptance Criteria:**
- [ ] Every task creates exactly one commit
- [ ] Commit message follows spec format
- [ ] SHA recorded in status.json
- [ ] Analysis tasks skip commit gracefully

#### 1.3 Branch Validation
- **New File:** `.claude/lib/git-utils.md` (or integrate into existing utils)
- **Functions:**
  - `getCurrentBranch()`: Return current branch name
  - `isOnPlanBranch()`: Check if on `plan/*` branch
  - `validateBranchState()`: Verify clean state, correct branch
  - `getPlanBranchName(planName)`: Generate `plan/{plan-name}` format

**Acceptance Criteria:**
- [ ] Utility functions work correctly
- [ ] `/plan:implement` validates branch before execution
- [ ] Clear error if on wrong branch

#### 1.4 Status Display Updates
- **File:** `.claude/commands/plan/status.md`
- **Changes:**
  - Display current git branch
  - Show uncommitted changes count
  - Display commit count for current plan
  - Show last commit SHA and timestamp

**Acceptance Criteria:**
- [ ] `/plan:status` shows git branch info
- [ ] Uncommitted changes clearly visible
- [ ] Useful for debugging state issues

### Phase 1 Deliverables
- Branch creation/switching in `/plan:set`
- Per-task commits in `/plan:implement`
- Git utility functions
- Enhanced status display

---

## Phase 2: Automated Completion

### Objective
Implement `/plan:complete` command with squash merge workflow.

### Tasks

#### 2.1 Create /plan:complete Command
- **New File:** `.claude/commands/plan/complete.md`
- **Workflow:**
  1. Verify all tasks completed (check status.json)
  2. Commit any uncommitted changes
  3. Create archive tag: `git tag archive/plan-{name}`
  4. Switch to main: `git checkout main`
  5. Squash merge: `git merge --squash plan/{name}`
  6. Create merge commit with summary message
  7. Delete plan branch: `git branch -D plan/{name}`
  8. Update status.json with completion

**Acceptance Criteria:**
- [ ] `/plan:complete` executes full workflow
- [ ] Archive tag preserves granular history
- [ ] Single commit on main with plan summary
- [ ] Branch deleted after successful merge

#### 2.2 Archive Tag Management
- **Changes:**
  - Generate archive tag before merge
  - Include timestamp in tag name (optional): `archive/plan-{name}-{date}`
  - Clean up phase tags after completion
  - Document how to access archived history

**Acceptance Criteria:**
- [ ] Archive tag created automatically
- [ ] `git log archive/plan-{name}` shows task commits
- [ ] Phase tags optionally cleaned up

#### 2.3 Merge Commit Message Generation
- **Format:**
```
Plan: {plan-name} (squashed)

Completed {task-count} tasks across {phase-count} phases
Duration: {total-duration}

Phases:
- Phase 1: {phase-1-name} ({phase-1-task-count} tasks)
- Phase 2: {phase-2-name} ({phase-2-task-count} tasks)
...

Granular history: git log archive/plan-{name}
Outputs: docs/plan-outputs/{plan-name}/

ü§ñ Generated with [Claude Code](https://claude.com/claude-code)

Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

**Acceptance Criteria:**
- [ ] Summary message includes all metadata
- [ ] Links to archive tag for granular access
- [ ] Links to outputs directory

#### 2.4 Merge Strategy Options
- **Flag:** `--merge squash|commit`
- **Behavior:**
  - `squash` (default): `git merge --squash`
  - `commit`: `git merge --no-ff`

**Acceptance Criteria:**
- [ ] Default is squash merge
- [ ] `--merge commit` uses merge commit instead
- [ ] Both strategies work correctly

### Phase 2 Deliverables
- `/plan:complete` command
- Archive tagging
- Merge commit message generation
- Merge strategy options

---

## Phase 3: Safety & Rollback

### Objective
Implement rollback commands and safety mechanisms.

### Tasks

#### 3.1 Create /plan:rollback Command
- **New File:** `.claude/commands/plan/rollback.md`
- **Subcommands:**
  - `task {id}`: Revert single task commit
  - `phase {N}`: Revert phase commits (range)
  - `plan`: Abandon entire plan or revert merge

**Implementation:**
```bash
# Task rollback
/plan:rollback task 1.3
‚Üí git log --grep="task 1.3:" --format="%H" -1
‚Üí git revert <sha> --no-edit
‚Üí Update status.json (mark task as pending or rolled_back)

# Phase rollback
/plan:rollback phase 2
‚Üí Find phase commit range
‚Üí git revert <start>..<end>
‚Üí Update status.json

# Plan rollback (before merge)
/plan:rollback plan
‚Üí git checkout main
‚Üí git branch -D plan/{name}
‚Üí Update status.json

# Plan rollback (after merge)
/plan:rollback plan --merged
‚Üí Find merge commit
‚Üí git revert <merge-sha>
‚Üí Update status.json
```

**Acceptance Criteria:**
- [ ] `/plan:rollback task X` reverts single task
- [ ] `/plan:rollback phase N` reverts entire phase
- [ ] `/plan:rollback plan` handles both merged and unmerged
- [ ] Status.json updated correctly

#### 3.2 Create /plan:abandon Command
- **New File:** `.claude/commands/plan/abandon.md`
- **Workflow:**
  1. Confirm with user (unless `--force`)
  2. Optionally create backup tag: `backup/plan-{name}-{timestamp}`
  3. Switch to main
  4. Delete plan branch
  5. Update status.json

**Acceptance Criteria:**
- [ ] Confirmation prompt before deletion
- [ ] Optional backup tag
- [ ] Clean state after abandon

#### 3.3 Pre-Commit Hook
- **New File:** `.githooks/pre-commit` (template)
- **Behavior:**
  - Warn if committing directly to main
  - Block if orchestrator expects plan branch
  - Allow override with `--no-verify`

**Acceptance Criteria:**
- [ ] Hook template provided
- [ ] Warning when on main branch
- [ ] Documentation for setup

#### 3.4 Branch Validation Before Operations
- **Changes to multiple commands:**
  - `/plan:implement`: Verify on correct plan branch
  - `/plan:batch`: Verify on correct plan branch
  - `/plan:complete`: Verify on plan branch (switch if needed)

**Acceptance Criteria:**
- [ ] Operations fail with clear error if wrong branch
- [ ] Auto-switch where safe

#### 3.5 Uncommitted Changes Handling
- **Standard behavior when switching branches:**
  1. Detect uncommitted changes
  2. Present options: Commit, Stash, Cancel
  3. Execute chosen action
  4. Proceed with switch

**Acceptance Criteria:**
- [ ] Uncommitted changes never silently lost
- [ ] User-friendly prompts
- [ ] Stash creation/application works

### Phase 3 Deliverables
- `/plan:rollback` command (task, phase, plan)
- `/plan:abandon` command
- Pre-commit hook template
- Branch validation in all commands
- Uncommitted changes handling

---

## Phase 4: Advanced Features

### Objective
Implement advanced features for team workflows and edge cases.

### Tasks

#### 4.1 PR Creation Integration
- **Enhancement to /plan:complete:**
  - Add `--pr` flag to create GitHub PR instead of merging
  - Use `gh pr create` with generated description
  - Support draft PRs: `--pr --draft`

**Implementation:**
```bash
/plan:complete --pr
‚Üí Push branch: git push -u origin plan/{name}
‚Üí gh pr create --title "Plan: {name}" --body "..."
‚Üí Output PR URL
```

**Acceptance Criteria:**
- [ ] `--pr` creates pull request
- [ ] PR description includes plan summary
- [ ] Link to outputs and findings

#### 4.2 Remote Sync
- **Configuration:**
  - `sync_remote: true/false`
- **Behavior when enabled:**
  - Push plan branch after creation
  - Push after each task commit
  - Handle remote conflicts

**Acceptance Criteria:**
- [ ] Remote sync configurable
- [ ] Automatic push when enabled
- [ ] Conflict handling documented

#### 4.3 Phase Tags
- **Automatic tagging at phase boundaries:**
  - After VERIFY task completes: `git tag plan/{name}/phase-{N}`
  - Optional: push tags to remote

**Acceptance Criteria:**
- [ ] Phase tags created automatically
- [ ] Tags visible in status output
- [ ] Used for phase-level rollback

#### 4.4 Branch Cleanup Command
- **New subcommand:** `/plan:cleanup`
- **Behavior:**
  - List stale plan branches (>30 days old, no recent commits)
  - Option to delete with confirmation
  - Option to archive before delete

**Acceptance Criteria:**
- [ ] Lists stale branches with age
- [ ] Bulk delete with confirmation
- [ ] Archive option preserves history

#### 4.5 Conflict Detection
- **Pre-merge check:**
  - Before `/plan:complete`, check for conflicts with main
  - If conflicts detected, warn user and offer options:
    - Rebase plan branch on main
    - Resolve conflicts manually
    - Abort completion

**Acceptance Criteria:**
- [ ] Conflict detection before merge
- [ ] Clear reporting of conflicting files
- [ ] Options for resolution

#### 4.6 Configuration System
- **Config file:** `.claude/git-workflow.json`
- **Options:**
```json
{
  "strategy": "branch-per-plan",
  "branch_prefix": "plan/",
  "auto_commit": true,
  "merge_strategy": "squash",
  "archive_branches": true,
  "archive_retention_days": 90,
  "sync_remote": false,
  "phase_tags": true,
  "enforce_branch": true
}
```

**Acceptance Criteria:**
- [ ] Config file parsed on startup
- [ ] All options configurable
- [ ] Defaults documented

### Phase 4 Deliverables
- PR creation integration
- Remote sync option
- Phase tags
- Branch cleanup command
- Conflict detection
- Configuration system

---

## Dependency Graph

```
Phase 1 (Core)
‚îú‚îÄ‚îÄ 1.1 Branch Management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îú‚îÄ‚îÄ 1.2 Commit Enforcement ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚ñ∂ Phase 2 (Completion)
‚îú‚îÄ‚îÄ 1.3 Branch Validation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§    ‚îú‚îÄ‚îÄ 2.1 /plan:complete
‚îî‚îÄ‚îÄ 1.4 Status Display ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îú‚îÄ‚îÄ 2.2 Archive Tags
                                    ‚îú‚îÄ‚îÄ 2.3 Merge Messages
                                    ‚îî‚îÄ‚îÄ 2.4 Merge Options
                                              ‚îÇ
                                              ‚ñº
                               Phase 3 (Safety)
                               ‚îú‚îÄ‚îÄ 3.1 /plan:rollback
                               ‚îú‚îÄ‚îÄ 3.2 /plan:abandon
                               ‚îú‚îÄ‚îÄ 3.3 Pre-commit Hook
                               ‚îú‚îÄ‚îÄ 3.4 Branch Validation
                               ‚îî‚îÄ‚îÄ 3.5 Uncommitted Handling
                                              ‚îÇ
                                              ‚ñº
                               Phase 4 (Advanced)
                               ‚îú‚îÄ‚îÄ 4.1 PR Creation
                               ‚îú‚îÄ‚îÄ 4.2 Remote Sync
                               ‚îú‚îÄ‚îÄ 4.3 Phase Tags
                               ‚îú‚îÄ‚îÄ 4.4 Cleanup Command
                               ‚îú‚îÄ‚îÄ 4.5 Conflict Detection
                               ‚îî‚îÄ‚îÄ 4.6 Configuration
```

---

## Risk Assessment

### High Risk
| Risk | Mitigation |
|------|------------|
| Data loss during branch operations | Archive tags before destructive ops |
| Merge conflicts blocking completion | Pre-merge conflict detection |
| User commits to wrong branch | Pre-commit hook, validation |

### Medium Risk
| Risk | Mitigation |
|------|------------|
| Orphaned branches accumulating | Cleanup command, age warnings |
| Status.json out of sync with git | Validation, auto-repair |
| Learning curve for users | Clear documentation, error messages |

### Low Risk
| Risk | Mitigation |
|------|------------|
| Performance overhead of commits | Minimal (1-2s per task) |
| Tag proliferation | Retention policy, cleanup |

---

## Success Metrics

### Phase 1 Complete When:
- [ ] Every `/plan:implement` creates a commit
- [ ] Every `/plan:set` creates/switches to plan branch
- [ ] Status shows git state correctly

### Phase 2 Complete When:
- [ ] `/plan:complete` works end-to-end
- [ ] Main branch shows squashed commits
- [ ] Archive tags provide granular access

### Phase 3 Complete When:
- [ ] All rollback levels work (task, phase, plan)
- [ ] No data loss in any scenario
- [ ] Uncommitted changes protected

### Phase 4 Complete When:
- [ ] PR workflow integrated
- [ ] Configuration system works
- [ ] Cleanup and maintenance tools available

---

## Next Steps

1. **Prioritize Phase 1** - Core branching is foundation for everything else
2. **Create implementation plan** from this outline
3. **Implement incrementally** - Each phase builds on previous
4. **Test thoroughly** - Git operations must be reliable
5. **Document as you go** - Update command docs with git behavior

---

## Appendix: File Change Summary

### New Files
- `.claude/commands/plan/complete.md`
- `.claude/commands/plan/rollback.md`
- `.claude/commands/plan/abandon.md`
- `.claude/commands/plan/cleanup.md`
- `.claude/lib/git-utils.md` (or integrate)
- `.githooks/pre-commit` (template)
- `.claude/git-workflow.json` (config)

### Modified Files
- `.claude/commands/plan/set.md` - Add branching
- `.claude/commands/plan/implement.md` - Enforce commits
- `.claude/commands/plan/batch.md` - Branch awareness
- `.claude/commands/plan/status.md` - Git state display
- `scripts/status-cli.js` - Git info in output

### Documentation
- Update README with git workflow
- Add troubleshooting guide for git issues
- Document configuration options
- Add visual diagrams to docs
