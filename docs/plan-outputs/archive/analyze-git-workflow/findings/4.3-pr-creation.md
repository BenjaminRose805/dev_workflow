# Task 4.3: PR Creation for Team Workflows

## Overview

This analysis examines Pull Request (PR) creation workflows for the plan orchestration system, covering when to create PRs, automation mechanisms, templates, review workflows, and GitHub Actions integration.

---

## 1. When to Create PRs

### User Scenario Matrix

| User Type | PR Required? | Trigger | Purpose |
|-----------|--------------|---------|---------|
| Solo Developer | Optional | Manual `--pr` flag | Self-documentation |
| Team Developer | Required | Auto on `/plan:complete` | Code review |
| OSS Contributor | Required | Auto on `/plan:complete` | Maintainer approval |

### Decision Tree

```
[Main branch protected?]
  YES â†’ Create PR (Required)
  NO  â†“

[Team project? (CODEOWNERS exists)]
  YES â†’ Create PR (Recommended)
  NO  â†“

[Fork workflow?]
  YES â†’ Create PR (Required)
  NO  â†“

[User preference]
  auto_create_pr: always â†’ Create PR
  auto_create_pr: prompt â†’ Ask user
  auto_create_pr: never  â†’ Skip (direct merge)
```

---

## 2. PR Creation Automation

### Commands

```bash
# Auto PR on completion
/plan:complete           # Creates PR if required
/plan:complete --pr      # Force PR creation
/plan:complete --no-pr   # Skip PR (if allowed)

# Create draft PR early
/plan:pr --draft         # For early feedback

# Mark ready for review
/plan:pr --ready         # Converts draft to ready
```

### Auto-Generated Title

```javascript
// Pattern detection from plan name
implement-* â†’ "feat: {description}"
refactor-*  â†’ "refactor: {description}"
fix-*       â†’ "fix: {description}"
docs-*      â†’ "docs: {description}"
analyze-*   â†’ "analysis: {description}"
```

**Examples:**
- `implement-authentication` â†’ `feat: Authentication`
- `fix-memory-leak` â†’ `fix: Memory leak`

---

## 3. PR Body Template

### Structure

```markdown
## Summary
{Auto-generated from plan overview}

## Changes

### Tasks Completed ({count})

**Phase 1: {name}** ({task-count} tasks)
- âœ“ Task 1.1: {description}
- âœ“ Task 1.2: {description}

**Phase 2: {name}** ({task-count} tasks)
- âœ“ Task 2.1: {description}

## Artifacts & Outputs

**Findings Generated:**
- [1.1-{name}.md](link)
- [2.1-{name}.md](link)

## Metrics

- **Duration:** {hours}h {minutes}m
- **Tasks completed:** {completed}/{total}
- **Files changed:** {count} (+{insertions}/-{deletions})

---

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
```

### Custom Templates

Projects can override with `.github/PLAN_PR_TEMPLATE.md`:

```markdown
## Plan Summary
{{ planOverview }}

## Implementation Details
{{ phases | format: detailed }}

## Custom Section
{Project-specific content}
```

---

## 4. Review Workflow

### Draft vs Ready

| State | Behavior |
|-------|----------|
| Draft | CI runs, no reviewers notified |
| Ready | Reviewers assigned, notifications sent |

**Recommendation:** Create as draft by default, mark ready after verification.

### Reviewer Assignment

**Priority order:**
1. From plan metadata: `reviewers: [@alice, @bob]`
2. From CODEOWNERS (matched to changed files)
3. From team configuration
4. Round-robin across team

### Auto-Merge Conditions

```json
{
  "auto_merge_conditions": {
    "required_approvals": 2,
    "all_checks_pass": true,
    "no_changes_requested": true,
    "up_to_date_with_base": true,
    "no_conflicts": true
  }
}
```

---

## 5. GitHub Actions Integration

### CI Trigger on PR

```yaml
name: Plan PR Validation

on:
  pull_request:
    branches: [main]

jobs:
  validate-plan:
    steps:
      - name: Validate plan status
        run: |
          STATUS=$(jq -r '.status' status.json)
          if [ "$STATUS" != "completed" ]; then
            echo "::warning::Plan status is '$STATUS'"
          fi

      - name: Run tests
        run: npm test

      - name: Check coverage
        run: npm test -- --coverage
```

### Required Status Checks

Configure in branch protection:
- `validate-plan` - Plan status validation
- `test` - All tests pass
- `coverage` - Coverage meets threshold
- `lint` - Code style checks

---

## 6. Configuration

### Full Schema

```json
{
  "git_workflow": {
    "require_pr": "auto",
    "auto_create_pr": "always",
    "pr_default_state": "draft",
    "pr_title_format": "auto",
    "pr_use_codeowners": true,
    "merge_method": "squash",
    "auto_merge": false,
    "delete_branch_on_merge": true
  }
}
```

### Profiles

**Solo Developer:**
```json
{
  "require_pr": "never",
  "auto_create_pr": "prompt"
}
```

**Team Developer:**
```json
{
  "require_pr": "always",
  "auto_create_pr": "always",
  "pr_default_state": "draft"
}
```

**OSS Contributor:**
```json
{
  "require_pr": "always",
  "fork_workflow": true,
  "pr_title_format": "conventional"
}
```

---

## 7. Edge Cases

### Merge Conflicts

- Detect before PR creation using `git merge-tree`
- Block merge in GitHub if conflicts exist
- Guide user through resolution

### Failed Status Checks

- PR created even with failing checks
- Merge blocked by branch protection
- Comment added with failure details

### Stale PRs

- Warning at 30 days inactive
- Auto-close at 37 days
- Exempt labels: `in-progress`, `blocked`

---

## Summary

| User Type | PR Creation | Review | Merge |
|-----------|-------------|--------|-------|
| Solo | Optional (`--pr`) | Self-review | Manual |
| Team | Automatic | CODEOWNERS | After approval |
| OSS | Automatic | Maintainer | After approval |

**Key Recommendations:**
1. Create draft PRs by default (safer)
2. Use CODEOWNERS for reviewer assignment
3. Auto-generate PR body from plan context
4. Enable auto-merge after approval for teams
5. Block merge until all checks pass
