# Task 4.4: Rollback Procedures Design

## Overview

This design specifies comprehensive rollback procedures for the plan orchestration git workflow, integrating with branch-per-plan and commit-per-task strategies. Three rollback levels are defined: task, phase, and plan.

---

## 1. Rollback Decision Tree

```
Need to undo work?
│
├─ Single task wrong?
│  ├─ Latest commit + not pushed → git reset --soft HEAD~1
│  └─ Older or pushed → git revert <task-commit>
│
├─ Entire phase failed?
│  ├─ Using phase branches → git branch -D plan/name/phase-N
│  └─ Flat plan branch → git reset --hard phase-start-tag
│
└─ Abandon entire plan?
   ├─ Not merged → git branch -D plan/name (with archive tag)
   └─ Merged to main → git revert <merge-commit>
```

---

## 2. Task-Level Rollback

### Command Interface

```bash
# Standard rollback
/plan:rollback task 1.2

# Rollback with automatic retry
/plan:rollback task 1.2 --retry

# Rollback dependent tasks too
/plan:rollback task 1.2 --cascade

# Force (skip dependency checks)
/plan:rollback task 1.2 --force

# Mark as skipped instead
/plan:rollback task 1.2 --skip --reason "Blocked by external issue"
```

### Rollback Methods

| Method | When to Use | Command |
|--------|-------------|---------|
| Reset soft | Latest commit, not pushed | `git reset --soft HEAD~1` |
| Revert | Older commit or pushed | `git revert <sha> --no-edit` |
| Reset hard | Force mode only | `git reset --hard <sha>` |

### Implementation Flow

1. **Safety checks**: Verify task exists, has commit, check dependencies
2. **Create backup**: `git tag rollback-backup-{timestamp}`
3. **Execute rollback**: Based on method
4. **Update status.json**: Mark task as pending or skipped
5. **Optional retry**: Re-execute task if `--retry` flag

### Dependency Handling

```javascript
// If task 1.2 has dependents (1.3, 1.4)
const dependents = findDependentTasks('1.2');
if (dependents.length > 0 && !options.cascade) {
  throw new Error('Cannot rollback: dependent tasks exist. Use --cascade');
}

// With cascade, rollback in reverse order
for (const task of [...dependents, '1.2'].reverse()) {
  await rollbackTask(task);
}
```

---

## 3. Phase-Level Rollback

### Command Interface

```bash
# Rollback entire phase
/plan:rollback phase 2

# Create backup branch first
/plan:rollback phase 2 --backup

# Rollback only failed tasks
/plan:rollback phase 2 --partial

# Rollback and restart immediately
/plan:rollback phase 2 --restart
```

### Implementation

```bash
# Find phase boundary
PHASE_START=$(git tag -l "phase-2-start")

# Method A: If using phase tags
git reset --hard $PHASE_START

# Method B: Revert commit range (safe)
git revert ${PHASE_START}..HEAD --no-edit

# Update all phase tasks to pending
for task in $(jq -r '.tasks[] | select(.phase == "Phase 2") | .id' status.json); do
  # Set status = pending, remove commit
done
```

### Partial Phase Rollback

```javascript
// Rollback only failed tasks, keep successful ones
const failedTasks = phaseTasks.filter(t => t.status === 'failed');
for (const task of failedTasks) {
  await rollbackTask(task.id);
}
```

---

## 4. Plan-Level Rollback

### Command Interface

```bash
# Abandon plan (interactive)
/plan:abandon

# Abandon with reason
/plan:abandon --reason "Requirements changed"

# Abandon and delete (no archive)
/plan:abandon --delete --confirm

# Rollback merged plan from main
/plan:rollback plan --from-main
```

### Pre-Merge Abandonment

```bash
# 1. Create archive tag
git tag -a "archive/plan-my-feature" plan/my-feature -m "
Plan: my-feature
Status: abandoned
Reason: Requirements changed
Recovery: git checkout archive/plan-my-feature
"

# 2. Switch to main
git checkout main

# 3. Delete plan branch
git branch -D plan/my-feature
git push origin --delete plan/my-feature

# 4. Update status.json
{
  "planState": "abandoned",
  "abandonment": {
    "abandonedAt": "2025-12-24T12:00:00Z",
    "reason": "Requirements changed",
    "archiveTag": "archive/plan-my-feature"
  }
}
```

### Post-Merge Rollback

```bash
# Find merge commit
MERGE=$(git log --merges --grep="plan.*my-feature" -1 --format="%H")

# Revert merge (specify parent)
git revert -m 1 $MERGE --no-edit

# Creates new commit that undoes entire plan
```

---

## 5. Retry Workflows

### Automatic Retry with Backoff

```javascript
async function retryWithBackoff(taskId, maxRetries = 3) {
  for (let attempt = 1; attempt <= maxRetries; attempt++) {
    try {
      await implementTask(taskId);
      return true;
    } catch (error) {
      await rollbackTask(taskId, { force: true });
      const delay = 1000 * Math.pow(2, attempt - 1); // 1s, 2s, 4s
      await sleep(delay);
    }
  }
  return false;
}
```

### Interactive Retry

```
Task 1.2 failed. Options:
  [R] Retry immediately
  [E] Edit instructions and retry
  [S] Skip this task
  [A] Abandon plan

Your choice:
```

---

## 6. Pre-Rollback Safety

### Safety Checks

```javascript
async function performSafetyChecks(targetId) {
  const checks = [
    { name: 'Git repository', check: isGitRepository },
    { name: 'Clean working directory', check: isWorkingDirClean },
    { name: 'Correct branch', check: isOnCorrectBranch },
    { name: 'Target exists', check: targetExists },
    { name: 'Not detached HEAD', check: notDetachedHead }
  ];

  for (const { name, check } of checks) {
    if (!await check()) {
      throw new Error(`Safety check failed: ${name}`);
    }
  }
}
```

### Backup Creation

```bash
# Always create backup before destructive operations
git tag "backup/rollback-{type}-{id}-{timestamp}"

# Metadata for recovery
{
  "tag": "backup/rollback-task-1.2-1735012345",
  "type": "task",
  "target": "1.2",
  "createdAt": "2025-12-24T12:00:00Z",
  "branch": "plan/my-feature",
  "commit": "abc123",
  "expiresAt": "2025-12-31T12:00:00Z"
}
```

---

## 7. Status Tracking

### Enhanced status.json Schema

```json
{
  "tasks": [{
    "id": "1.2",
    "status": "completed",
    "commit": "abc123",
    "rollbackHistory": [{
      "rolledBackAt": "2025-12-24T15:30:00Z",
      "method": "revert",
      "previousStatus": "failed",
      "previousCommit": "old123",
      "reason": "Generated incorrect output",
      "retrySucceeded": true
    }],
    "retryCount": 1
  }]
}
```

---

## 8. Command Summary

| Command | Purpose | Git Operation |
|---------|---------|---------------|
| `/plan:rollback task 1.2` | Undo single task | `git revert <sha>` |
| `/plan:rollback task 1.2 --retry` | Undo and retry | revert + re-execute |
| `/plan:rollback phase 2` | Undo entire phase | reset or revert range |
| `/plan:abandon` | Discard plan | archive tag + delete branch |
| `/plan:rollback plan --from-main` | Undo merged plan | revert merge commit |

---

## 9. Error Recovery

### Common Failures

| Error | Cause | Recovery |
|-------|-------|----------|
| Merge conflict | Later tasks modified same files | Manually resolve, `git revert --continue` |
| Commit not found | Task has no commit | Cannot rollback, mark as pending |
| Detached HEAD | User checked out commit | `git checkout <branch>` |

### Conflict Resolution

```bash
# If revert causes conflict
git status                    # See conflicting files
# Edit files to resolve
git add .
git revert --continue         # Complete revert

# Or abort
git revert --abort
```

---

## Summary

### Rollback Capability by Level

| Level | Method | Risk | Reversible |
|-------|--------|------|------------|
| Task | git revert | Low | Yes (forward history) |
| Phase | git reset/revert | Medium | Via backup tag |
| Plan | Branch delete | High | Via archive tag |

### Key Design Principles

1. **Non-destructive by default**: Use revert over reset
2. **Always backup first**: Create tag before destructive operations
3. **Track history**: Store rollback events in status.json
4. **Provide recovery paths**: Clear instructions for failed rollbacks
5. **Support both automated and interactive workflows**
