# Task 2.5: Branch Lifecycle Management Analysis

## Executive Summary

Branch lifecycle management is a critical component of the git workflow for the plan orchestration system. This analysis defines **when branches are created, how they are protected, when they are cleaned up**, and how to handle edge cases in the lifecycle.

**Key Findings:**
- **Current state:** All work happens on `master` branch with no branch isolation
- **Recommended:** Branch-per-plan strategy with automatic creation on `/plan:set` or `/plan:create`
- **Cleanup:** Archive branches via tags before deletion to preserve granular commit history
- **Retention:** Keep archive tags for 90 days (development) to indefinitely (production/audit)
- **Protection:** Main branch requires protection for team workflows; plan branches remain unprotected for flexibility

---

## 1. Branch Creation

### 1.1 Creation Triggers

#### Trigger 1: `/plan:create` - New Plan Creation

**When:** User creates a new plan from a template

**Behavior:**
```bash
/plan:create analysis my-feature-analysis

# Automatic git operations:
git checkout main
git checkout -b plan/my-feature-analysis
git add docs/plans/my-feature-analysis.md docs/plan-outputs/my-feature-analysis/
git commit -m "plan: Initialize my-feature-analysis"
```

#### Trigger 2: `/plan:set` - Switch to Existing Plan

**When:** User switches active plan (either new or resuming previous)

**Behavior:**
```bash
/plan:set implement-authentication

# If uncommitted changes detected:
# -> Prompt user: Commit, Stash, or Cancel

# If branch exists:
git checkout plan/implement-authentication

# If branch doesn't exist:
git checkout main
git checkout -b plan/implement-authentication
```

### 1.2 Branch Naming Convention

**Format:** `plan/{plan-name}`

**Validation Rules:**
- Lowercase with hyphens
- Alphanumeric characters only
- Maximum 240 characters (reserve 15 for "plan/" prefix)
- No spaces or special characters

### 1.3 Automatic vs Manual Branch Creation

| Aspect | Automatic | Manual |
|--------|-----------|--------|
| **Trigger** | `/plan:create`, `/plan:set` | User runs `git checkout -b` |
| **Integration** | Updates status tracking | User must manually update |
| **Safety Checks** | Validates clean state | User responsible |
| **Convention** | Enforces naming | User may use wrong name |

**Decision:** Enforce automatic branch creation in orchestrator commands.

### 1.4 Branch Creation Edge Cases

**Case 1: Plan Already Has Branch**
```bash
Error: Branch 'plan/my-plan' already exists

Actions:
  - Choose a different plan name
  - Delete the existing branch: git branch -D plan/my-plan
  - Resume the existing plan: /plan:set my-plan
```

**Case 2: Creating Plan While on Another Plan Branch**
- Check for uncommitted changes
- Offer to commit or stash
- Return to main branch
- Create new plan branch from main

**Case 3: Main Branch Diverged**
```
Warning: Main branch has diverged (15 commits ahead)

Consider rebasing your plan branch before merge.
```

---

## 2. Branch Protection

### 2.1 Main Branch Protection (Team Workflows)

**Recommended Rules:**

| Rule | Setting | Rationale |
|------|---------|-----------|
| Require PR for merge | ✓ Enabled | No direct commits to main |
| Require approvals | 1-2 reviewers | Code review for quality |
| Require status checks | ✓ All checks pass | CI/CD must succeed |
| Require up-to-date branch | ✓ Enabled | Prevent stale merges |
| Allow force push | ✗ NEVER | Prevent history rewriting |
| Allow deletion | ✗ NEVER | Prevent accidental deletion |

### 2.2 Plan Branch Protection

**Recommendation:** Plan branches should **NOT** be protected

**Rationale:**
- Plan branches are working branches for individual developers
- Need flexibility to rebase, amend commits, force push
- Developers need freedom to experiment and iterate

### 2.3 Required Checks and Reviews

**Solo Developer Workflow:**
- No protection required
- Self-review before merge

**Team Developer Workflow:**
- PR required for main
- 1+ reviewer approval
- CI status checks pass
- Squash merge on approval

---

## 3. Branch Cleanup

### 3.1 When to Delete Branches

#### Event 1: Plan Successful Completion

```bash
/plan:complete

# 1. Verify all tasks completed
# 2. Create archive tag BEFORE deletion
git tag archive/plan-my-feature plan/my-feature
git push origin archive/plan-my-feature

# 3. Merge to main (squash)
git checkout main
git merge --squash plan/my-feature
git commit -m "plan: Complete my-feature (25 tasks)"

# 4. Delete branch
git branch -D plan/my-feature
git push origin --delete plan/my-feature
```

#### Event 2: Plan Abandonment

```bash
/plan:abandon my-feature --reason "Requirements changed"

# Options:
# [A] Archive and delete - Create tag, delete branch
# [K] Keep branch - Don't delete, may resume later
# [D] Delete immediately - No archive
```

#### Event 3: Stale Branch Cleanup

**Definition:** Branch with no activity for >30 days (configurable)

**Automated Actions:**
1. **60 days:** Send notification to developer
2. **75 days:** Escalate notification
3. **90 days:** Auto-archive and delete

### 3.2 Archive Tag Creation

**Purpose:** Preserve granular commit history after branch deletion

**Tag Naming Convention:**

| Scenario | Tag Name |
|----------|----------|
| Successful completion | `archive/plan-{name}` |
| Abandoned plan | `archive/abandoned-{name}` |
| Stale branch cleanup | `archive/stale-{name}` |

**Tag Creation with Metadata:**
```bash
git tag -a archive/plan-implement-auth -m "Plan: implement-auth

Status: completed
Completed: 2025-12-24T22:30:00Z
Tasks: 25 (5 phases)
Duration: 2h 15m 34s
Merged: main@abc123

Access: git log archive/plan-implement-auth"
```

### 3.3 Retention Policies

| Project Type | Archive Tag Retention |
|--------------|---------------------|
| Personal/Learning | 30-90 days |
| Open Source (active) | 1 year |
| Commercial (dev) | 1 year |
| Commercial (prod) | 3-5 years |
| Financial/Healthcare | 7-10 years or indefinite |
| Government/Defense | Indefinite |

### 3.4 Cleanup Automation

**Daily Cron Job:**
```yaml
# .github/workflows/cleanup-stale-branches.yml
name: Cleanup Stale Branches

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC

jobs:
  cleanup:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Cleanup stale branches
        run: node scripts/cleanup-stale-branches.js
```

---

## 4. Edge Cases and Recovery

### 4.1 Long-Running Plans

**Strategies:**

1. **Periodic Rebase:**
```bash
git checkout plan/large-refactor
git fetch origin
git rebase origin/main
```

2. **Phase-Based Merges:**
```bash
# After each phase, merge to main
git checkout main
git merge --squash plan/large-refactor
git commit -m "plan(large-refactor): Complete Phase 1"
```

3. **Sync Branches:**
```bash
git checkout plan/large-refactor
git merge main -m "sync: Merge main into plan branch"
```

**Recommendation:** Rebase for solo, merge for team.

### 4.2 Stale Branches

**Detection:**
```bash
git for-each-ref --sort=-committerdate --format='%(refname:short) %(committerdate:relative)' refs/heads/plan/ | grep -E '(months?|years?) ago'
```

**Automated Actions:**
1. Notify at 60 days
2. Escalate at 75 days
3. Auto-cleanup at 90 days (with archive)

### 4.3 Multiple Developers on Related Plans

**Solutions:**

1. **Temporary Branch Dependency:**
```bash
# Developer B branches from A's plan
git checkout plan/implement-auth
git checkout -b plan/add-permissions
```

2. **Shared Base Branch:**
```bash
git checkout -b base/auth-and-permissions
# Both developers branch from base
```

### 4.4 Recovery from Deleted Branches

**Option 1: Reflog (Local, 90 days)**
```bash
git reflog | grep 'plan/my-feature'
git checkout -b plan/my-feature <commit-sha>
```

**Option 2: Remote Tracking**
```bash
git checkout -b plan/my-feature origin/plan/my-feature
```

**Option 3: Git Fsck (Nuclear Option)**
```bash
git fsck --lost-found
git branch plan/my-feature-recovered <dangling-commit>
```

**Prevention:** Always archive before delete.

---

## 5. Branch Lifecycle State Diagram

```
                         ╔═══════════════╗
                         ║  NO BRANCH    ║
                         ╚═══════════════╝
                                │
                    /plan:create or /plan:set
                                │
                                ↓
                         ╔═══════════════╗
                         ║    ACTIVE     ║
                         ║  PLAN BRANCH  ║
                         ╚═══════════════╝
                                │
                  ┌─────────────┼─────────────┐
                  │             │             │
             Task commits   /plan:set    Long-running
                  │        (switch)         │
                  ↓             │            │
          ┌────────────┐  ┌──────────┐ Periodic sync
          │ Committed  │  │ Stashed  │      │
          │   tasks    │  │   work   │      ↓
          └────────────┘  └──────────┘ ┌──────────┐
                  │             │       │ Rebase/  │
                  │             │       │  Merge   │
                  ↓             │       └──────────┘
          ╔═══════════════╗    │            │
          ║  ALL TASKS    ║    │            │
          ║   COMPLETE    ║    │            │
          ╚═══════════════╝    │            │
                  │            │            │
          /plan:complete       │            │
                  ↓            │            │
        ╔══════════════════╗   │            │
        ║ CREATE ARCHIVE   ║   │            │
        ║      TAG         ║   │            │
        ╚══════════════════╝   │            │
                  │            │            │
                  ↓            │            │
          ╔═══════════════╗    │            │
          ║ MERGED TO     ║    │            │
          ║     MAIN      ║    │            │
          ╚═══════════════╝    │            │
                  │            │            │
                  ↓            │            │
          ╔═══════════════╗    │            │
          ║   BRANCH      ║    │            │
          ║   DELETED     ║    │            │
          ╚═══════════════╝    │            │
                               │            │
                           /plan:abandon    │
                               │       No activity
                               ↓       (60+ days)
                        ╔═══════════╗      │
                        ║  ARCHIVE  ║      ↓
                        ║ & DELETE  ║ ╔═══════════╗
                        ╚═══════════╝ ║ AUTO-STALE║
                                      ║  CLEANUP  ║
                                      ╚═══════════╝
```

---

## 6. Git Command Examples

### 6.1 Branch Creation

```bash
# Create plan branch
git checkout main
git pull origin main
git checkout -b plan/implement-auth
```

### 6.2 Per-Task Commits

```bash
git add -A
git commit -m "task 1.1: Create authentication middleware

Plan: implement-auth
Phase: Phase 1: Core Implementation
Duration: 34s
Status: completed"
```

### 6.3 Archive Tag Creation

```bash
git tag -a archive/plan-implement-auth -m "Plan: implement-auth

Status: completed
Completed: 2025-12-24T22:30:00Z
Tasks: 25 (5 phases)

Access: git log archive/plan-implement-auth"
```

### 6.4 Merge and Cleanup

```bash
# Squash merge to main
git checkout main
git merge --squash plan/implement-auth
git commit -m "plan: Implement authentication (25 tasks)"

# Cleanup
git branch -D plan/implement-auth
git push origin --delete plan/implement-auth
```

### 6.5 Recovery

```bash
# From reflog
git reflog | grep plan/lost-branch
git checkout -b plan/lost-branch <commit-sha>

# From archive tag
git log archive/plan-old-feature
git checkout archive/plan-old-feature -- src/file.ts
```

---

## 7. Automation Recommendations

### 7.1 Automated Branch Creation

**In `/plan:create`:**
```javascript
async function createPlan(planName, template) {
  await gitCreatePlanBranch(planName);
  // Initial commit with plan metadata
}
```

### 7.2 Automated Commit After Task

**In `/plan:implement`:**
```javascript
async function implementTask(taskId) {
  // Task execution
  await gitCommitTask(taskId, description, duration);
}
```

### 7.3 Automated Archive and Cleanup

**In `/plan:complete`:**
```javascript
async function completePlan(planName) {
  await verifyAllTasksComplete(planName);
  await createArchiveTag(planName);
  await mergePlanToMain(planName);
  await deletePlanBranch(planName);
}
```

### 7.4 Stale Branch Detection

**Scheduled script:**
```javascript
// Find branches >90 days old
// Notify developers at 60 days
// Auto-cleanup at 90 days with archive
```

---

## 8. Retention Policy Recommendations

### By Plan Status

| Plan Status | Retention |
|-------------|-----------|
| Completed & Merged | 1 year (default) |
| Abandoned (useful) | 6 months |
| Abandoned (failed) | 30 days |
| Stale (auto-cleaned) | 90 days |
| Audit-critical | Indefinite |

### Configuration Example

```yaml
# .claude/git-workflow-config.yml
branch_lifecycle:
  retention_policies:
    default:
      archive_tags: 365
      abandoned_tags: 180
      stale_tags: 90
    by_plan_type:
      feature: 365
      bugfix: 180
      experiment: 30
  stale_detection:
    warning_threshold: 60
    cleanup_threshold: 90
```

---

## 9. Risk Assessment and Safeguards

### Identified Risks

| Risk | Severity | Mitigation |
|------|----------|------------|
| Accidental branch deletion | High | Mandatory archive before delete |
| Missing archive tag | High | Validation before delete |
| Stale branch accumulation | Low | Automated cleanup |
| Merge conflicts on long plans | Medium | Periodic sync |
| Force push to main | Critical | Branch protection |

### Safeguards

1. **Mandatory Archive Before Delete:**
```javascript
async function deleteBranch(branchName) {
  if (!archiveTagExists(branchName)) {
    throw new Error('Create archive tag first');
  }
  await exec(`git branch -D ${branchName}`);
}
```

2. **Dry-Run Mode:**
```bash
/plan:cleanup --dry-run
# Preview what would be deleted
```

3. **Confirmation for High-Risk Actions:**
```
Proceed with cleanup? [y/N]:
```

4. **Audit Log:**
```javascript
await logBranchOperation('delete', branchName, { reason, archiveTag });
```

---

## 10. Summary and Recommendations

### Key Recommendations

1. **Branch Creation:**
   - Automatic on `/plan:create` and `/plan:set`
   - Always branch from main
   - Enforce naming convention: `plan/{plan-name}`
   - Handle uncommitted changes with prompts

2. **Branch Protection:**
   - Main branch: Protected (require PR, reviews, status checks)
   - Plan branches: Unprotected (allow flexibility)

3. **Branch Cleanup:**
   - Successful completion: Archive tag → merge → delete
   - Abandonment: Archive tag → delete (with confirmation)
   - Stale branches: Notify at 60 days → cleanup at 90 days
   - Always create archive tag before deletion

4. **Archive Tag Retention:**
   - Default: 1 year for completed plans
   - Configurable by project type
   - Indefinite for audit requirements

5. **Safeguards:**
   - Mandatory archive before delete
   - Dry-run mode for destructive operations
   - Interactive confirmation for high-risk actions
   - Audit logging for all branch operations
   - Extended reflog retention (180 days)

### Implementation Checklist

- [ ] Automatic branch creation in `/plan:create` and `/plan:set`
- [ ] Uncommitted changes detection and handling
- [ ] `/plan:complete` with archive tag creation
- [ ] `/plan:abandon` with cleanup options
- [ ] Stale branch detection script (scheduled)
- [ ] Configure retention policies
- [ ] Implement archive tag cleanup script
- [ ] Add branch operation audit logging
- [ ] Create recovery procedures documentation
- [ ] Add safeguards (archive validation before delete)
- [ ] Configure main branch protection (for team workflows)

### Success Metrics

- **Zero data loss:** No plan work lost due to branch deletion
- **Clean history:** Main branch has 1 commit per completed plan
- **Fast recovery:** Granular history accessible via tags in <10 seconds
- **Low overhead:** Branch lifecycle operations add <5% to plan execution time
- **Audit compliance:** 100% of branch operations logged
- **Stale branch reduction:** <5 stale branches at any time
