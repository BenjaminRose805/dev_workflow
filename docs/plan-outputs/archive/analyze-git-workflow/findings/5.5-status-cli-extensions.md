# Task 5.5: Status-CLI Extensions for Git State Tracking

## Executive Summary

The status-cli.js tool requires **13 new commands** and **schema extensions** to fully support git workflow tracking. Key integration points are `/plan:set` (branch creation), `/plan:implement` (commit recording), and `/plan:complete` (merge tracking).

**Estimated Total Effort:** 12-17 days for complete implementation.

---

## 1. Schema Extensions for status.json

### 1.1 Plan-Level Git Metadata

Add to root level:

```json
{
  "git": {
    "branchName": "plan/implement-authentication",
    "branchCreatedAt": "2025-12-24T10:00:00Z",
    "branchMergedAt": null,
    "mergeStrategy": "squash",
    "baseBranch": "main",
    "baseCommit": "abc1234567890def",
    "currentCommit": "def9876543210abc",
    "isDirty": false,
    "unstagedChanges": 0,
    "uncommittedFiles": []
  }
}
```

### 1.2 Per-Task Git Tracking

Add to each task:

```json
{
  "id": "1.1",
  "status": "completed",
  "git": {
    "commitSha": "a1b2c3d4e5f6",
    "commitTimestamp": "2025-12-24T10:05:00Z",
    "commitMessage": "task 1.1: Create authentication middleware",
    "rollbackHistory": [],
    "filesChanged": 5,
    "insertions": 127,
    "deletions": 3
  }
}
```

### 1.3 Per-Phase Git Checkpoints (Optional)

```json
{
  "phases": [
    {
      "id": "phase-1",
      "name": "Phase 1: Core Implementation",
      "startCommit": "abc1234",
      "endCommit": "def5678",
      "checkpointTag": "plan/my-plan/phase-1-complete"
    }
  ]
}
```

---

## 2. New CLI Commands

### 2.1 Git State Inspection

#### `git-status` - Show git state for current plan

```bash
node scripts/status-cli.js git-status [--verbose]
```

**Output:**
```json
{
  "planBranch": "plan/implement-auth",
  "baseBranch": "main",
  "commitsSinceBranch": 12,
  "uncommittedChanges": { "count": 3, "files": [...] },
  "divergenceFromMain": { "ahead": 12, "behind": 3 },
  "lastTaskCommit": { "taskId": "1.5", "sha": "def5678" }
}
```

#### `branch-info` - Show branch metadata

```bash
node scripts/status-cli.js branch-info
```

**Output:**
```json
{
  "branchName": "plan/implement-auth",
  "createdAt": "2025-12-24T10:00:00Z",
  "commits": 12,
  "mergeReady": true,
  "conflicts": []
}
```

### 2.2 Commit Recording

#### `record-commit <task-id> <sha>` - Store commit SHA

```bash
node scripts/status-cli.js record-commit 1.1 a1b2c3d4e5f6
```

#### `record-auto-commit <task-id>` - Auto-detect latest commit

```bash
node scripts/status-cli.js record-auto-commit 1.1
```

#### `get-commit <task-id>` - Retrieve commit SHA

```bash
node scripts/status-cli.js get-commit 1.1
```

**Output:**
```json
{
  "taskId": "1.1",
  "commitSha": "a1b2c3d4e5f6",
  "commitMessage": "task 1.1: Create auth middleware"
}
```

### 2.3 Rollback Support

#### `find-commit <task-id>` - Lookup commit for task

```bash
node scripts/status-cli.js find-commit 1.1
```

**Output:**
```json
{
  "taskId": "1.1",
  "commitSha": "a1b2c3d4e5f6",
  "canRevert": true,
  "hasConflicts": false,
  "subsequentTasks": ["1.2", "1.3", "1.4"]
}
```

#### `rollback-task <task-id>` - Generate/execute revert

```bash
node scripts/status-cli.js rollback-task 1.1 [--execute] [--reason "..."]
```

**Dry-run output:**
```json
{
  "taskId": "1.1",
  "action": "revert",
  "command": "git revert a1b2c3d4e5f6 --no-edit",
  "willExecute": false
}
```

**Execute output:**
```json
{
  "success": true,
  "revertCommitSha": "rev1234",
  "taskStatusUpdated": "pending"
}
```

#### `history <task-id>` - Show task commits

```bash
node scripts/status-cli.js history 1.1 [--format=json]
```

### 2.4 Branch Management

#### `create-branch <plan-name>` - Create plan branch

```bash
node scripts/status-cli.js create-branch my-plan [--from=main] [--checkout]
```

#### `merge-check` - Validate merge readiness

```bash
node scripts/status-cli.js merge-check [--base=main]
```

**Output:**
```json
{
  "ready": false,
  "blockers": [
    "3 uncommitted changes",
    "2 tasks still pending"
  ],
  "conflicts": []
}
```

---

## 3. Enhanced Existing Commands

### 3.1 `mark-complete` Enhancement

**New options:**
```bash
node scripts/status-cli.js mark-complete 1.1 \
  --notes "..." \
  --commit-sha a1b2c3d4e5f6 \
  --auto-commit
```

**Implementation:**
```javascript
if (options['auto-commit']) {
  const sha = execSync('git log -1 --format=%H').toString().trim();
  const message = execSync('git log -1 --format=%s').toString().trim();
  extras.git = { commitSha: sha, commitMessage: message };
}
```

### 3.2 `status` Enhancement

**Include git info:**
```json
{
  "total": 15,
  "completed": 8,
  "git": {
    "branch": "plan/my-plan",
    "divergence": { "ahead": 9, "behind": 2 },
    "uncommitted": 0,
    "lastCommit": { "taskId": "2.1", "sha": "abc1234" }
  }
}
```

### 3.3 `progress` Enhancement

```
Plan: My Plan
Branch: plan/my-plan (9 ahead, 2 behind main)
Progress: [████████████░░░░░░░░░░░░░░░] 53%

  ✓ Completed: 8 (with commits: 8)
  ◯ Pending: 6

Git Status: Clean
Last Commit: task 2.1 (abc1234) - 5 minutes ago
```

### 3.4 `validate` Enhancement

**Add git consistency checks:**
```json
{
  "issues": [
    "Task 1.1 completed but no commit SHA",
    "Task 1.3 commit SHA not in git history"
  ],
  "gitChecks": {
    "branchExists": true,
    "allTasksHaveCommits": false
  }
}
```

---

## 4. Integration Workflow

### /plan:set Integration

```bash
node scripts/status-cli.js git-status
node scripts/status-cli.js create-branch my-plan --checkout
node scripts/status-cli.js update-git-metadata --branch "plan/my-plan"
```

### /plan:implement Integration

```bash
git add -A && git commit -m "task 1.1: ..."
node scripts/status-cli.js mark-complete 1.1 --auto-commit
```

### /plan:complete Integration

```bash
node scripts/status-cli.js merge-check
node scripts/status-cli.js record-merge --strategy "squash"
```

---

## 5. Schema Migration

### Backwards Compatibility

All git fields optional. Existing status.json works without git metadata.

### Migration Command

```bash
node scripts/status-cli.js migrate-git [--detect-commits]
```

**Actions:**
1. Adds empty `git` object to plan level
2. Detects current branch
3. Maps git commits to tasks (if --detect-commits)
4. Preserves existing data

---

## 6. Implementation Priority

### Phase 1: Core Tracking - 2-3 days (HIGH)

1. `record-commit <task-id> <sha>`
2. `get-commit <task-id>`
3. Enhanced `mark-complete --auto-commit`
4. Enhanced `status` with git info

### Phase 2: Branch Management - 3-4 days (MEDIUM)

5. `git-status`
6. `branch-info`
7. `create-branch`
8. `merge-check`

### Phase 3: Rollback - 2-3 days (MEDIUM-HIGH)

9. `find-commit <task-id>`
10. `rollback-task <task-id>`
11. `history <task-id>`

### Phase 4: Migration & Validation - 1-2 days (LOW)

12. `migrate-git`
13. Enhanced `validate`

---

## 7. Effort Summary

| Phase | Commands | Effort |
|-------|----------|--------|
| Phase 1: Core | 4 | 2-3 days |
| Phase 2: Branch | 4 | 3-4 days |
| Phase 3: Rollback | 3 | 2-3 days |
| Phase 4: Migration | 2 | 1-2 days |
| Schema + Testing | - | 3-4 days |
| **Total** | **13** | **12-17 days** |

---

## 8. Key Design Decisions

### Storage Location

**Decision:** Store git metadata in status.json (not separate file)

**Rationale:** Atomic updates, single source of truth

### Commit Detection

**Decision:** Explicit via `--auto-commit` flag

**Rationale:** Clear when tracking happens, avoids false positives

### Rollback Strategy

**Decision:** Use `git revert` (not `git reset`)

**Rationale:** Safe for shared branches, preserves history

### Branch Naming

**Decision:** Enforce `plan/<plan-name>` convention

**Rationale:** Consistent namespace, easy cleanup

---

## 9. Summary

The status-cli.js extensions enable:

- **Task-level commit tracking** - SHA stored per task
- **Branch management** - Create, switch, check readiness
- **Rollback support** - Find and revert specific tasks
- **Merge validation** - Check conflicts before /plan:complete
- **Progress enhancement** - Git info in status display

**Total: 13 new commands, ~12-17 days implementation**
