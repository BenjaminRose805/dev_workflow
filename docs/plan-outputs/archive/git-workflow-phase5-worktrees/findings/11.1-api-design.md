# REST API Design for Plan Management

## Overview

This document defines the REST API endpoints for managing plan execution via an HTTP server. The API enables integration with web frontends (like NextJS dashboards), external tools, and automation workflows.

## Base URL

```
http://localhost:3100/api
```

Port is configurable via `.claude/git-workflow.json`:

```json
{
  "api": {
    "enabled": true,
    "port": 3100,
    "auth_required": false,
    "cors_origins": ["http://localhost:3000"]
  }
}
```

## Authentication (Optional)

When `auth_required: true`, all endpoints require an API key:

```http
Authorization: Bearer <api-key>
```

API keys are stored in `.claude/api-keys.json` (gitignored).

## Endpoints Summary

| Method | Endpoint | Description |
|--------|----------|-------------|
| GET | `/api/plans` | List all plans with status |
| GET | `/api/plans/:name` | Get detailed plan status |
| POST | `/api/plans/:name/start` | Start orchestrator for plan |
| POST | `/api/plans/:name/stop` | Stop running orchestrator |
| GET | `/api/plans/:name/status` | Get real-time plan status |
| GET | `/api/plans/:name/logs` | Stream orchestrator logs |
| GET | `/api/plans/:name/tasks` | List all tasks in plan |
| POST | `/api/plans/:name/tasks/:taskId/start` | Mark task as started |
| POST | `/api/plans/:name/tasks/:taskId/complete` | Mark task as completed |
| POST | `/api/plans/:name/tasks/:taskId/fail` | Mark task as failed |
| GET | `/api/worktrees` | List all worktrees |
| POST | `/api/worktrees/:name` | Create new worktree |
| DELETE | `/api/worktrees/:name` | Remove worktree |
| GET | `/api/resources` | Get resource status |
| WS | `/ws/plans/:name` | Real-time updates WebSocket |

---

## Detailed Endpoint Specifications

### GET /api/plans

List all available plans with their current status.

**Query Parameters:**
- `status` (optional): Filter by status (`pending`, `in_progress`, `completed`, `failed`)
- `worktree` (optional): Filter by worktree presence (`true`, `false`)

**Response:**
```json
{
  "plans": [
    {
      "name": "git-workflow-phase5-worktrees",
      "path": "docs/plans/git-workflow-phase5-worktrees.md",
      "title": "Git Workflow Phase 5 - Worktrees",
      "status": "in_progress",
      "progress": {
        "total": 84,
        "completed": 62,
        "pending": 22,
        "failed": 0,
        "percentage": 74
      },
      "currentPhase": "Phase 11: API for External Integration",
      "worktree": {
        "active": true,
        "path": "/path/to/worktrees/plan-git-workflow-phase5-worktrees"
      },
      "orchestrator": {
        "running": true,
        "pid": 12345,
        "startedAt": "2024-12-26T10:00:00Z"
      },
      "lastUpdatedAt": "2024-12-26T17:00:00Z"
    }
  ],
  "summary": {
    "totalPlans": 5,
    "running": 1,
    "pending": 2,
    "completed": 2
  }
}
```

### GET /api/plans/:name

Get detailed status for a specific plan.

**URL Parameters:**
- `name`: Plan name (without `.md` extension)

**Response:**
```json
{
  "name": "git-workflow-phase5-worktrees",
  "path": "docs/plans/git-workflow-phase5-worktrees.md",
  "title": "Git Workflow Phase 5 - Worktrees",
  "status": "in_progress",
  "progress": {
    "total": 84,
    "completed": 62,
    "pending": 22,
    "in_progress": 0,
    "failed": 0,
    "skipped": 0,
    "percentage": 74
  },
  "phases": [
    {
      "number": 1,
      "name": "Worktree Management Command",
      "total": 7,
      "completed": 7,
      "percentage": 100
    }
  ],
  "currentPhase": "Phase 11: API for External Integration",
  "recentActivity": [
    {
      "timestamp": "2024-12-26T17:01:58Z",
      "taskId": "10.6",
      "action": "completed",
      "description": "Handle resource exhaustion gracefully"
    }
  ],
  "worktree": {
    "active": true,
    "path": "/path/to/worktrees/plan-git-workflow-phase5-worktrees",
    "branch": "plan/git-workflow-phase5-worktrees"
  },
  "orchestrator": {
    "running": true,
    "pid": 12345,
    "startedAt": "2024-12-26T10:00:00Z",
    "mode": "continuous"
  },
  "git": {
    "branch": "plan/git-workflow-phase5-worktrees",
    "uncommittedCount": 0,
    "commitCount": 16
  },
  "lastUpdatedAt": "2024-12-26T17:01:58Z"
}
```

### POST /api/plans/:name/start

Start the orchestrator for a plan.

**URL Parameters:**
- `name`: Plan name

**Request Body:**
```json
{
  "mode": "batch",           // "batch" | "continuous" (default: "batch")
  "tasks": ["11.1", "11.2"], // Optional: specific tasks to run
  "autonomous": true,        // Skip interactive prompts
  "worktree": true,          // Create/use worktree
  "daemon": true             // Run in background
}
```

**Response:**
```json
{
  "success": true,
  "message": "Orchestrator started for plan git-workflow-phase5-worktrees",
  "orchestrator": {
    "pid": 12345,
    "logFile": "orchestrator-git-workflow-phase5-worktrees.log",
    "startedAt": "2024-12-26T17:05:00Z"
  }
}
```

**Error Response:**
```json
{
  "success": false,
  "error": "Plan already has running orchestrator",
  "details": {
    "existingPid": 12340
  }
}
```

### POST /api/plans/:name/stop

Stop a running orchestrator for a plan.

**URL Parameters:**
- `name`: Plan name

**Request Body:**
```json
{
  "force": false,  // Force stop (SIGKILL vs SIGTERM)
  "timeout": 30    // Seconds to wait before force stop
}
```

**Response:**
```json
{
  "success": true,
  "message": "Orchestrator stopped for plan git-workflow-phase5-worktrees",
  "orchestrator": {
    "pid": 12345,
    "stoppedAt": "2024-12-26T17:10:00Z",
    "exitCode": 0
  }
}
```

### GET /api/plans/:name/status

Get real-time status for a plan (lighter than full GET).

**Response:**
```json
{
  "name": "git-workflow-phase5-worktrees",
  "status": "in_progress",
  "progress": {
    "total": 84,
    "completed": 63,
    "percentage": 75
  },
  "currentTask": {
    "id": "11.2",
    "description": "Implement /api/plans",
    "status": "in_progress",
    "startedAt": "2024-12-26T17:05:00Z"
  },
  "orchestrator": {
    "running": true,
    "pid": 12345
  },
  "lastUpdatedAt": "2024-12-26T17:05:30Z"
}
```

### GET /api/plans/:name/logs

Stream orchestrator logs.

**Query Parameters:**
- `tail` (optional): Number of lines from end (default: 100)
- `stream` (optional): Enable Server-Sent Events streaming (`true`)

**Response (non-streaming):**
```json
{
  "logs": [
    {
      "timestamp": "2024-12-26T17:05:00Z",
      "level": "info",
      "message": "Starting orchestrator for git-workflow-phase5-worktrees"
    }
  ],
  "totalLines": 150
}
```

**Response (streaming - SSE):**
```
event: log
data: {"timestamp":"2024-12-26T17:05:00Z","level":"info","message":"Task 11.1 started"}

event: log
data: {"timestamp":"2024-12-26T17:05:30Z","level":"info","message":"Task 11.1 completed"}
```

### GET /api/plans/:name/tasks

List all tasks in a plan.

**Query Parameters:**
- `status` (optional): Filter by status
- `phase` (optional): Filter by phase number

**Response:**
```json
{
  "tasks": [
    {
      "id": "11.1",
      "phase": "Phase 11: API for External Integration",
      "description": "Design REST API endpoints for plan management",
      "status": "completed",
      "completedAt": "2024-12-26T17:01:58Z"
    },
    {
      "id": "11.2",
      "phase": "Phase 11: API for External Integration",
      "description": "Implement /api/plans - list all plans with status",
      "status": "in_progress",
      "startedAt": "2024-12-26T17:05:00Z"
    }
  ],
  "summary": {
    "total": 84,
    "completed": 62,
    "pending": 22
  }
}
```

### POST /api/plans/:name/tasks/:taskId/start

Mark a task as started (in_progress).

**Response:**
```json
{
  "success": true,
  "task": {
    "id": "11.2",
    "status": "in_progress",
    "startedAt": "2024-12-26T17:05:00Z"
  }
}
```

### POST /api/plans/:name/tasks/:taskId/complete

Mark a task as completed.

**Request Body:**
```json
{
  "notes": "Optional completion notes"
}
```

**Response:**
```json
{
  "success": true,
  "task": {
    "id": "11.2",
    "status": "completed",
    "completedAt": "2024-12-26T17:30:00Z",
    "notes": "Implemented list endpoint with pagination"
  }
}
```

### POST /api/plans/:name/tasks/:taskId/fail

Mark a task as failed.

**Request Body:**
```json
{
  "error": "Error description"
}
```

**Response:**
```json
{
  "success": true,
  "task": {
    "id": "11.2",
    "status": "failed",
    "failedAt": "2024-12-26T17:30:00Z",
    "error": "Build error in api-server.js"
  }
}
```

---

## Worktree Endpoints

### GET /api/worktrees

List all active worktrees.

**Response:**
```json
{
  "worktrees": [
    {
      "name": "plan-git-workflow-phase5-worktrees",
      "path": "/path/to/worktrees/plan-git-workflow-phase5-worktrees",
      "branch": "plan/git-workflow-phase5-worktrees",
      "planName": "git-workflow-phase5-worktrees",
      "status": "active",
      "age": {
        "days": 2,
        "isStale": false
      }
    }
  ],
  "summary": {
    "total": 1,
    "active": 1,
    "stale": 0,
    "abandoned": 0
  }
}
```

### POST /api/worktrees/:name

Create a new worktree for a plan.

**Request Body:**
```json
{
  "planPath": "docs/plans/my-plan.md",
  "attach": false
}
```

**Response:**
```json
{
  "success": true,
  "worktree": {
    "path": "/path/to/worktrees/plan-my-plan",
    "branch": "plan/my-plan",
    "created": true
  }
}
```

### DELETE /api/worktrees/:name

Remove a worktree.

**Query Parameters:**
- `force` (optional): Force removal with uncommitted changes

**Response:**
```json
{
  "success": true,
  "message": "Worktree removed: plan-my-plan"
}
```

---

## Resource Endpoints

### GET /api/resources

Get resource status and limits.

**Response:**
```json
{
  "limits": {
    "concurrentWorktrees": {
      "current": 1,
      "max": 3,
      "canCreate": true
    },
    "diskSpace": {
      "availableMB": 50000,
      "requiredMB": 500,
      "sufficient": true
    }
  },
  "worktrees": {
    "total": 1,
    "stale": 0,
    "abandoned": 0
  },
  "warnings": []
}
```

---

## WebSocket API

### WS /ws/plans/:name

Real-time updates for a plan via WebSocket.

**Connection:**
```javascript
const ws = new WebSocket('ws://localhost:3100/ws/plans/git-workflow-phase5-worktrees');
```

**Message Types:**

#### Task Update
```json
{
  "type": "task_update",
  "data": {
    "taskId": "11.2",
    "status": "completed",
    "timestamp": "2024-12-26T17:30:00Z"
  }
}
```

#### Progress Update
```json
{
  "type": "progress_update",
  "data": {
    "completed": 63,
    "total": 84,
    "percentage": 75
  }
}
```

#### Orchestrator Status
```json
{
  "type": "orchestrator_status",
  "data": {
    "running": true,
    "pid": 12345,
    "currentTask": "11.3"
  }
}
```

#### Log Entry
```json
{
  "type": "log",
  "data": {
    "level": "info",
    "message": "Task 11.2 completed",
    "timestamp": "2024-12-26T17:30:00Z"
  }
}
```

---

## Error Responses

All endpoints return consistent error responses:

```json
{
  "success": false,
  "error": "Error message",
  "code": "ERROR_CODE",
  "details": {}
}
```

**Common Error Codes:**
- `PLAN_NOT_FOUND` - Plan does not exist
- `TASK_NOT_FOUND` - Task ID not found
- `ORCHESTRATOR_ALREADY_RUNNING` - Plan already has running orchestrator
- `ORCHESTRATOR_NOT_RUNNING` - No orchestrator to stop
- `RESOURCE_EXHAUSTED` - Resource limits exceeded
- `WORKTREE_EXISTS` - Worktree already exists
- `WORKTREE_NOT_FOUND` - Worktree not found
- `AUTH_REQUIRED` - Missing/invalid authentication
- `INVALID_REQUEST` - Malformed request body

---

## Implementation Notes

### Server Technology
- Express.js for HTTP server
- ws library for WebSocket
- CORS enabled for frontend integration

### File Structure
```
scripts/
  api-server.js         # Main API server
  lib/
    api/
      routes.js         # Route definitions
      handlers.js       # Request handlers
      middleware.js     # Auth, CORS, logging
      websocket.js      # WebSocket handler
```

### Integration with Existing Code
- Uses `scripts/lib/plan-status.js` for status operations
- Uses `scripts/lib/worktree-utils.js` for worktree operations
- Uses `scripts/lib/orchestrator_registry.py` for orchestrator management
- Monitors status.json for real-time updates

### Configuration
```json
{
  "api": {
    "enabled": true,
    "port": 3100,
    "host": "localhost",
    "auth_required": false,
    "cors_origins": ["http://localhost:3000"],
    "log_requests": true
  }
}
```
