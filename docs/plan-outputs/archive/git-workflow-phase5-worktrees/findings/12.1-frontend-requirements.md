# Frontend Requirements and Architecture

## Overview

This document defines the requirements and architecture for a NextJS-based frontend dashboard for plan management. The frontend integrates with the REST API server (`scripts/api-server.js`) and provides real-time monitoring of plan execution.

## Technology Stack

| Component | Technology | Rationale |
|-----------|------------|-----------|
| Framework | NextJS 14+ (App Router) | Server components, streaming, built-in API routes |
| State Management | React Query / SWR | Server state caching, real-time updates |
| Styling | Tailwind CSS | Rapid prototyping, utility-first |
| WebSocket | Native WebSocket API | No additional dependencies |
| Charts | Recharts or Chart.js | Lightweight, React-compatible |
| UI Components | shadcn/ui or Radix | Accessible, unstyled primitives |

## Core Requirements

### Functional Requirements

1. **Plan List View**
   - Display all available plans with status indicators
   - Show progress bars for each plan
   - Filter by status (pending, in_progress, completed, failed)
   - Search plans by name
   - Sort by name, progress, last updated

2. **Plan Detail View**
   - Full plan information with phase breakdown
   - Task list with status icons
   - Progress visualization (bar/donut chart)
   - Recent activity feed
   - Orchestrator status (running/stopped)
   - Worktree information

3. **Real-time Updates**
   - WebSocket connection for live status updates
   - Automatic reconnection on disconnect
   - Optimistic UI updates
   - Visual indicators for live data

4. **Orchestrator Control**
   - Start orchestrator (batch/continuous mode)
   - Stop orchestrator (graceful/force)
   - View orchestrator logs (streaming)
   - Task selection for batch runs

5. **Worktree Management**
   - List active worktrees
   - Create new worktree for plan
   - Remove worktree (with confirmation)
   - View worktree status (stale/abandoned warnings)

6. **Resource Monitoring**
   - Display current resource usage
   - Show concurrent worktree limits
   - Disk space indicators
   - Stale worktree alerts

### Non-Functional Requirements

1. **Performance**
   - First contentful paint < 1.5s
   - Time to interactive < 3s
   - WebSocket latency < 100ms
   - Support 20+ concurrent plans

2. **Responsiveness**
   - Desktop-first design (1024px+)
   - Tablet support (768px+)
   - Mobile readable (320px+)

3. **Accessibility**
   - WCAG 2.1 Level AA compliance
   - Keyboard navigation
   - Screen reader support
   - High contrast mode

4. **Reliability**
   - Graceful degradation when API unavailable
   - Offline indicator
   - Error boundaries for component isolation
   - Automatic retry with exponential backoff

## Architecture

### Application Structure

```
app/
├── layout.tsx                 # Root layout with providers
├── page.tsx                   # Dashboard home (plan list)
├── plans/
│   ├── page.tsx               # Plans list with filters
│   └── [name]/
│       ├── page.tsx           # Plan detail view
│       ├── logs/
│       │   └── page.tsx       # Log viewer
│       └── tasks/
│           └── page.tsx       # Task list
├── worktrees/
│   └── page.tsx               # Worktree management
├── resources/
│   └── page.tsx               # Resource monitoring
└── api/                       # NextJS API routes (proxy)
    └── [...path]/
        └── route.ts           # Proxy to backend API

components/
├── ui/                        # Base UI components
│   ├── button.tsx
│   ├── card.tsx
│   ├── progress.tsx
│   ├── badge.tsx
│   └── dialog.tsx
├── plans/
│   ├── plan-card.tsx          # Plan summary card
│   ├── plan-list.tsx          # Plan grid/list view
│   ├── plan-detail.tsx        # Full plan view
│   ├── phase-accordion.tsx    # Collapsible phase
│   ├── task-item.tsx          # Individual task
│   ├── progress-chart.tsx     # Visual progress
│   └── activity-feed.tsx      # Recent activity
├── orchestrator/
│   ├── orchestrator-status.tsx
│   ├── start-dialog.tsx
│   ├── stop-dialog.tsx
│   └── log-viewer.tsx
├── worktrees/
│   ├── worktree-list.tsx
│   ├── worktree-card.tsx
│   └── create-dialog.tsx
└── shared/
    ├── header.tsx
    ├── sidebar.tsx
    ├── status-indicator.tsx
    └── connection-status.tsx

lib/
├── api/
│   ├── client.ts              # API client wrapper
│   ├── types.ts               # TypeScript types
│   └── hooks.ts               # React Query hooks
├── websocket/
│   ├── client.ts              # WebSocket client
│   ├── provider.tsx           # React context
│   └── hooks.ts               # useWebSocket hooks
└── utils/
    ├── formatters.ts          # Date, number formatters
    └── constants.ts           # App constants
```

### Data Flow

```
                    ┌─────────────────────────────────────────┐
                    │           NextJS Frontend               │
                    │  ┌────────────────────────────────────┐ │
                    │  │        React Components            │ │
                    │  │  ┌──────────────────────────────┐  │ │
                    │  │  │    React Query / SWR         │  │ │
                    │  │  │    (Cache + State)           │  │ │
                    │  │  └──────────┬───────────────────┘  │ │
                    │  └─────────────┼──────────────────────┘ │
                    │                │                        │
                    │  ┌─────────────┴──────────────────────┐ │
                    │  │       WebSocket Provider          │ │
                    │  │       (Real-time Updates)         │ │
                    │  └─────────────┬──────────────────────┘ │
                    └────────────────┼────────────────────────┘
                                     │
                    ┌────────────────┴────────────────────────┐
                    │                                         │
              ┌─────┴─────┐                          ┌────────┴────────┐
              │  HTTP     │                          │   WebSocket     │
              │  REST     │                          │   Connection    │
              └─────┬─────┘                          └────────┬────────┘
                    │                                         │
                    └──────────────────┬──────────────────────┘
                                       │
                    ┌──────────────────┴──────────────────────┐
                    │         API Server (api-server.js)       │
                    │                                          │
                    │  ┌────────────────────────────────────┐  │
                    │  │  REST Endpoints    │  WebSocket    │  │
                    │  │  /api/plans/*      │  /ws/plans/*  │  │
                    │  └────────────────────────────────────┘  │
                    │                  │                       │
                    │  ┌───────────────┴───────────────────┐   │
                    │  │   plan-status.js  │  worktree-utils.js│
                    │  └───────────────────────────────────┘   │
                    └──────────────────────────────────────────┘
                                       │
                    ┌──────────────────┴──────────────────────┐
                    │              File System                 │
                    │  docs/plan-outputs/*/status.json        │
                    │  docs/plans/*.md                        │
                    │  .claude/orchestrator-registry.json     │
                    └──────────────────────────────────────────┘
```

### State Management Strategy

1. **Server State (React Query)**
   - Plan list and details
   - Worktree data
   - Resource status
   - Automatic refetching on focus
   - Stale-while-revalidate pattern

2. **Real-time State (WebSocket Context)**
   - Live progress updates
   - Task status changes
   - Orchestrator events
   - Merge with cached data

3. **UI State (React State/Zustand)**
   - Selected plan
   - Filter/sort preferences
   - Modal open/close states
   - Sidebar collapsed state

### API Integration Pattern

```typescript
// lib/api/client.ts
const API_BASE = process.env.NEXT_PUBLIC_API_URL || 'http://localhost:3100';

export async function fetchPlans(options?: { status?: string }) {
  const params = new URLSearchParams();
  if (options?.status) params.set('status', options.status);

  const response = await fetch(`${API_BASE}/api/plans?${params}`);
  if (!response.ok) throw new ApiError(response);
  return response.json();
}

// lib/api/hooks.ts
export function usePlans(options?: { status?: string }) {
  return useQuery({
    queryKey: ['plans', options],
    queryFn: () => fetchPlans(options),
    staleTime: 30_000,
    refetchInterval: 60_000,
  });
}
```

### WebSocket Integration

```typescript
// lib/websocket/provider.tsx
export function WebSocketProvider({ children }: { children: React.ReactNode }) {
  const [socket, setSocket] = useState<WebSocket | null>(null);
  const queryClient = useQueryClient();

  useEffect(() => {
    const ws = new WebSocket('ws://localhost:3100/ws/all');

    ws.onmessage = (event) => {
      const data = JSON.parse(event.data);

      if (data.type === 'status') {
        // Update specific plan in cache
        queryClient.setQueryData(['plans', data.plan], (old) => ({
          ...old,
          ...data.progress,
        }));
      }
    };

    setSocket(ws);
    return () => ws.close();
  }, []);

  return (
    <WebSocketContext.Provider value={socket}>
      {children}
    </WebSocketContext.Provider>
  );
}
```

## UI/UX Design Guidelines

### Color Scheme

| Element | Color | Usage |
|---------|-------|-------|
| Primary | Blue (#2563EB) | Actions, links, focus |
| Success | Green (#16A34A) | Completed, success |
| Warning | Yellow (#CA8A04) | Warnings, stale |
| Error | Red (#DC2626) | Failed, errors |
| Pending | Gray (#6B7280) | Pending, inactive |
| In Progress | Blue (#3B82F6) | Running, active |

### Status Indicators

| Status | Icon | Color | Description |
|--------|------|-------|-------------|
| Pending | Circle outline | Gray | Not started |
| In Progress | Spinning circle | Blue | Currently running |
| Completed | Checkmark | Green | Successfully finished |
| Failed | X mark | Red | Failed with error |
| Skipped | Dash | Gray | Intentionally skipped |

### Layout Patterns

1. **Dashboard Layout**
   - Fixed header with search
   - Collapsible sidebar navigation
   - Main content area with responsive grid
   - Footer with connection status

2. **List Views**
   - Card grid on larger screens
   - Single column on mobile
   - Sticky headers for long lists

3. **Detail Views**
   - Two-column layout (main + sidebar)
   - Collapsible sections
   - Sticky action bar

## Security Considerations

1. **API Proxy**
   - Route frontend requests through NextJS API routes
   - Avoid exposing backend URL to client
   - Enable in production with authentication

2. **Authentication (Future)**
   - Support Bearer token in API requests
   - Store token in httpOnly cookie
   - CSRF protection for mutations

3. **Input Validation**
   - Sanitize user inputs
   - Validate plan names
   - Limit request sizes

## Deployment Options

### Option 1: Standalone NextJS App
```bash
# Build and start
npm run build
npm start
```

### Option 2: Docker Container
```dockerfile
FROM node:20-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build
CMD ["npm", "start"]
```

### Option 3: Static Export
```bash
# For simple deployments
npm run build
npm run export
# Deploy out/ directory
```

## Development Workflow

1. **Start backend API**
   ```bash
   node scripts/api-server.js
   ```

2. **Start frontend dev server**
   ```bash
   cd frontend
   npm run dev
   ```

3. **Access dashboard**
   ```
   http://localhost:3000
   ```

## Future Enhancements

1. **Phase 2: Multi-tenant Support**
   - User authentication
   - Role-based permissions
   - Audit logging

2. **Phase 3: Advanced Analytics**
   - Historical progress charts
   - Time-to-completion estimates
   - Task duration analytics

3. **Phase 4: Notifications**
   - Email/Slack notifications
   - Browser push notifications
   - Webhook integrations
