# Component Structure for Plan Dashboard

## Overview

This document defines the React component structure for the NextJS frontend dashboard. Components are organized by feature domain with a focus on reusability and composition.

## Component Hierarchy

```
app/
├── layout.tsx                     # Root layout
│   └── <Providers>                # Query, WebSocket, Theme providers
│       └── <Shell>                # App shell with header/sidebar
│           └── {children}         # Page content
│
└── plans/[name]/page.tsx          # Plan detail page
    └── <PlanDetail>
        ├── <PlanHeader>
        ├── <ProgressOverview>
        ├── <PhaseList>
        │   └── <PhaseAccordion>
        │       └── <TaskList>
        │           └── <TaskItem>
        ├── <ActivityFeed>
        └── <OrchestratorPanel>
```

## Core Components

### Layout Components

#### Shell
The main application shell with navigation.

```typescript
// components/layout/shell.tsx

interface ShellProps {
  children: React.ReactNode;
}

export function Shell({ children }: ShellProps) {
  return (
    <div className="min-h-screen bg-background">
      <Header />
      <div className="flex">
        <Sidebar />
        <main className="flex-1 p-6">
          {children}
        </main>
      </div>
    </div>
  );
}
```

#### Header
Top navigation with search and connection status.

```typescript
// components/layout/header.tsx

interface HeaderProps {
  onSearch?: (query: string) => void;
}

export function Header({ onSearch }: HeaderProps) {
  return (
    <header className="sticky top-0 z-50 border-b bg-background/95 backdrop-blur">
      <div className="flex h-14 items-center px-4 gap-4">
        <Logo />
        <SearchInput onSearch={onSearch} />
        <Spacer />
        <ConnectionStatus />
        <ThemeToggle />
      </div>
    </header>
  );
}
```

#### Sidebar
Navigation sidebar with plan list.

```typescript
// components/layout/sidebar.tsx

interface SidebarProps {
  collapsed?: boolean;
  onToggle?: () => void;
}

export function Sidebar({ collapsed, onToggle }: SidebarProps) {
  const { data: plans } = usePlans();

  return (
    <aside className={cn(
      "border-r bg-muted/40 transition-all",
      collapsed ? "w-16" : "w-64"
    )}>
      <nav className="space-y-2 p-4">
        <NavItem icon={<LayoutDashboard />} href="/">Dashboard</NavItem>
        <NavItem icon={<FileText />} href="/plans">Plans</NavItem>
        <NavItem icon={<GitBranch />} href="/worktrees">Worktrees</NavItem>
        <NavItem icon={<Activity />} href="/resources">Resources</NavItem>
      </nav>

      <Separator />

      <PlanQuickList plans={plans} collapsed={collapsed} />
    </aside>
  );
}
```

### Plan Components

#### PlanCard
Summary card for plan list view.

```typescript
// components/plans/plan-card.tsx

interface PlanCardProps {
  plan: PlanSummary;
  onClick?: () => void;
}

export function PlanCard({ plan, onClick }: PlanCardProps) {
  return (
    <Card className="cursor-pointer hover:border-primary" onClick={onClick}>
      <CardHeader className="pb-2">
        <div className="flex items-center justify-between">
          <CardTitle className="text-lg">{plan.title}</CardTitle>
          <StatusBadge status={plan.status} />
        </div>
      </CardHeader>
      <CardContent>
        <ProgressBar value={plan.progress.percentage} className="mb-2" />
        <div className="flex justify-between text-sm text-muted-foreground">
          <span>{plan.progress.completed}/{plan.progress.total} tasks</span>
          <span>{plan.progress.percentage}%</span>
        </div>
        {plan.orchestrator?.running && (
          <div className="mt-2 flex items-center gap-1 text-sm text-blue-500">
            <Loader2 className="h-3 w-3 animate-spin" />
            <span>Running</span>
          </div>
        )}
      </CardContent>
    </Card>
  );
}
```

#### PlanList
Grid/list view of plans with filtering.

```typescript
// components/plans/plan-list.tsx

interface PlanListProps {
  plans: PlanSummary[];
  view?: 'grid' | 'list';
  onSelect?: (plan: PlanSummary) => void;
}

export function PlanList({ plans, view = 'grid', onSelect }: PlanListProps) {
  return (
    <div className={cn(
      view === 'grid'
        ? "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
        : "space-y-2"
    )}>
      {plans.map(plan => (
        <PlanCard
          key={plan.name}
          plan={plan}
          onClick={() => onSelect?.(plan)}
        />
      ))}
    </div>
  );
}
```

#### PlanDetail
Full plan view with all details.

```typescript
// components/plans/plan-detail.tsx

interface PlanDetailProps {
  planName: string;
}

export function PlanDetail({ planName }: PlanDetailProps) {
  const { data: plan, isLoading } = usePlan(planName);
  const { status: wsStatus } = usePlanWebSocket(planName);

  // Merge REST data with WebSocket updates
  const currentPlan = useMemo(() => ({
    ...plan,
    ...(wsStatus && { progress: wsStatus.progress }),
  }), [plan, wsStatus]);

  if (isLoading) return <PlanDetailSkeleton />;
  if (!plan) return <PlanNotFound name={planName} />;

  return (
    <div className="space-y-6">
      <PlanHeader plan={currentPlan} />

      <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <div className="lg:col-span-2 space-y-6">
          <ProgressOverview plan={currentPlan} />
          <PhaseList phases={currentPlan.phases} tasks={currentPlan.tasks} />
        </div>

        <aside className="space-y-6">
          <OrchestratorPanel
            plan={currentPlan}
            orchestrator={currentPlan.orchestrator}
          />
          <ActivityFeed activities={currentPlan.recentActivity} />
          {currentPlan.worktree && (
            <WorktreeInfo worktree={currentPlan.worktree} />
          )}
        </aside>
      </div>
    </div>
  );
}
```

#### PlanHeader
Title and action buttons for plan.

```typescript
// components/plans/plan-header.tsx

interface PlanHeaderProps {
  plan: PlanDetail;
}

export function PlanHeader({ plan }: PlanHeaderProps) {
  return (
    <div className="flex items-start justify-between">
      <div>
        <div className="flex items-center gap-2">
          <h1 className="text-2xl font-bold">{plan.title}</h1>
          <StatusBadge status={plan.status} />
        </div>
        <p className="text-muted-foreground">{plan.path}</p>
        {plan.currentPhase && (
          <p className="text-sm text-muted-foreground mt-1">
            Current: {plan.currentPhase}
          </p>
        )}
      </div>

      <div className="flex gap-2">
        {plan.orchestrator?.running ? (
          <StopButton planName={plan.name} />
        ) : (
          <StartButton planName={plan.name} />
        )}
        <DropdownMenu>
          <DropdownMenuTrigger asChild>
            <Button variant="outline" size="icon">
              <MoreVertical className="h-4 w-4" />
            </Button>
          </DropdownMenuTrigger>
          <DropdownMenuContent>
            <DropdownMenuItem>View Logs</DropdownMenuItem>
            <DropdownMenuItem>Create Worktree</DropdownMenuItem>
            <DropdownMenuSeparator />
            <DropdownMenuItem className="text-destructive">
              Mark Complete
            </DropdownMenuItem>
          </DropdownMenuContent>
        </DropdownMenu>
      </div>
    </div>
  );
}
```

### Progress Components

#### ProgressOverview
Visual progress summary with chart.

```typescript
// components/plans/progress-overview.tsx

interface ProgressOverviewProps {
  plan: PlanDetail;
}

export function ProgressOverview({ plan }: ProgressOverviewProps) {
  const { progress } = plan;

  return (
    <Card>
      <CardHeader>
        <CardTitle>Progress</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="flex items-center gap-8">
          <DonutChart
            data={[
              { name: 'Completed', value: progress.completed, color: '#16a34a' },
              { name: 'In Progress', value: progress.in_progress, color: '#3b82f6' },
              { name: 'Failed', value: progress.failed, color: '#dc2626' },
              { name: 'Pending', value: progress.pending, color: '#6b7280' },
            ]}
            centerLabel={`${progress.percentage}%`}
          />

          <div className="grid grid-cols-2 gap-4">
            <StatCard
              label="Completed"
              value={progress.completed}
              icon={<CheckCircle className="text-green-500" />}
            />
            <StatCard
              label="In Progress"
              value={progress.in_progress}
              icon={<Loader2 className="text-blue-500 animate-spin" />}
            />
            <StatCard
              label="Failed"
              value={progress.failed}
              icon={<XCircle className="text-red-500" />}
            />
            <StatCard
              label="Pending"
              value={progress.pending}
              icon={<Circle className="text-gray-400" />}
            />
          </div>
        </div>
      </CardContent>
    </Card>
  );
}
```

#### ProgressBar
Animated progress bar component.

```typescript
// components/ui/progress-bar.tsx

interface ProgressBarProps {
  value: number;
  showLabel?: boolean;
  size?: 'sm' | 'md' | 'lg';
  className?: string;
}

export function ProgressBar({
  value,
  showLabel = false,
  size = 'md',
  className
}: ProgressBarProps) {
  const heights = { sm: 'h-1', md: 'h-2', lg: 'h-3' };

  return (
    <div className={cn("relative", className)}>
      <div className={cn(
        "w-full bg-secondary rounded-full overflow-hidden",
        heights[size]
      )}>
        <div
          className="h-full bg-primary transition-all duration-500 ease-out"
          style={{ width: `${Math.min(100, Math.max(0, value))}%` }}
        />
      </div>
      {showLabel && (
        <span className="absolute right-0 -top-6 text-sm text-muted-foreground">
          {value}%
        </span>
      )}
    </div>
  );
}
```

### Task Components

#### PhaseList
List of phases with accordions.

```typescript
// components/plans/phase-list.tsx

interface PhaseListProps {
  phases: Phase[];
  tasks: Task[];
}

export function PhaseList({ phases, tasks }: PhaseListProps) {
  const [expandedPhases, setExpandedPhases] = useState<string[]>([]);

  return (
    <Card>
      <CardHeader>
        <CardTitle>Phases</CardTitle>
      </CardHeader>
      <CardContent className="p-0">
        <Accordion
          type="multiple"
          value={expandedPhases}
          onValueChange={setExpandedPhases}
        >
          {phases.map(phase => (
            <PhaseAccordion
              key={phase.number}
              phase={phase}
              tasks={tasks.filter(t =>
                t.phase.includes(`Phase ${phase.number}`)
              )}
            />
          ))}
        </Accordion>
      </CardContent>
    </Card>
  );
}
```

#### PhaseAccordion
Expandable phase section.

```typescript
// components/plans/phase-accordion.tsx

interface PhaseAccordionProps {
  phase: Phase;
  tasks: Task[];
}

export function PhaseAccordion({ phase, tasks }: PhaseAccordionProps) {
  return (
    <AccordionItem value={`phase-${phase.number}`}>
      <AccordionTrigger className="px-4">
        <div className="flex items-center justify-between w-full pr-4">
          <div className="flex items-center gap-2">
            <span className="font-medium">Phase {phase.number}</span>
            <span className="text-muted-foreground">{phase.name}</span>
          </div>
          <div className="flex items-center gap-4">
            <span className="text-sm text-muted-foreground">
              {phase.completed}/{phase.total}
            </span>
            <ProgressBar value={phase.percentage} className="w-24" />
          </div>
        </div>
      </AccordionTrigger>
      <AccordionContent>
        <TaskList tasks={tasks} />
      </AccordionContent>
    </AccordionItem>
  );
}
```

#### TaskItem
Individual task row.

```typescript
// components/plans/task-item.tsx

interface TaskItemProps {
  task: Task;
  onAction?: (action: 'start' | 'complete' | 'fail') => void;
}

export function TaskItem({ task, onAction }: TaskItemProps) {
  return (
    <div className={cn(
      "flex items-center gap-3 px-4 py-2 hover:bg-muted/50",
      task.status === 'in_progress' && "bg-blue-50 dark:bg-blue-950/20"
    )}>
      <TaskStatusIcon status={task.status} />

      <div className="flex-1 min-w-0">
        <div className="flex items-center gap-2">
          <span className="font-mono text-sm text-muted-foreground">
            {task.id}
          </span>
          <span className={cn(
            "truncate",
            task.status === 'completed' && "text-muted-foreground"
          )}>
            {task.description}
          </span>
        </div>
        {task.status === 'in_progress' && task.startedAt && (
          <span className="text-xs text-muted-foreground">
            Started {formatRelativeTime(task.startedAt)}
          </span>
        )}
      </div>

      {task.status === 'pending' && (
        <Button
          variant="ghost"
          size="sm"
          onClick={() => onAction?.('start')}
        >
          <Play className="h-3 w-3" />
        </Button>
      )}
    </div>
  );
}
```

#### TaskStatusIcon
Icon indicating task status.

```typescript
// components/plans/task-status-icon.tsx

interface TaskStatusIconProps {
  status: TaskStatus;
  className?: string;
}

const statusConfig = {
  pending: { icon: Circle, color: 'text-gray-400' },
  in_progress: { icon: Loader2, color: 'text-blue-500', animate: true },
  completed: { icon: CheckCircle, color: 'text-green-500' },
  failed: { icon: XCircle, color: 'text-red-500' },
  skipped: { icon: MinusCircle, color: 'text-gray-400' },
};

export function TaskStatusIcon({ status, className }: TaskStatusIconProps) {
  const config = statusConfig[status];
  const Icon = config.icon;

  return (
    <Icon className={cn(
      "h-4 w-4",
      config.color,
      config.animate && "animate-spin",
      className
    )} />
  );
}
```

### Orchestrator Components

#### OrchestratorPanel
Control panel for orchestrator.

```typescript
// components/orchestrator/orchestrator-panel.tsx

interface OrchestratorPanelProps {
  plan: PlanDetail;
  orchestrator: OrchestratorInfo | null;
}

export function OrchestratorPanel({ plan, orchestrator }: OrchestratorPanelProps) {
  const [showStartDialog, setShowStartDialog] = useState(false);
  const [showStopDialog, setShowStopDialog] = useState(false);

  return (
    <Card>
      <CardHeader>
        <CardTitle className="flex items-center justify-between">
          Orchestrator
          <OrchestratorStatusBadge running={orchestrator?.running} />
        </CardTitle>
      </CardHeader>
      <CardContent className="space-y-4">
        {orchestrator?.running ? (
          <>
            <div className="space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-muted-foreground">PID</span>
                <span className="font-mono">{orchestrator.pid}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Mode</span>
                <span>{orchestrator.mode}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Started</span>
                <span>{formatRelativeTime(orchestrator.startedAt)}</span>
              </div>
              {orchestrator.currentTask && (
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Current Task</span>
                  <span className="font-mono">{orchestrator.currentTask}</span>
                </div>
              )}
            </div>

            <div className="flex gap-2">
              <Button
                variant="outline"
                size="sm"
                className="flex-1"
                asChild
              >
                <Link href={`/plans/${plan.name}/logs`}>
                  <Terminal className="h-4 w-4 mr-2" />
                  View Logs
                </Link>
              </Button>
              <Button
                variant="destructive"
                size="sm"
                onClick={() => setShowStopDialog(true)}
              >
                <Square className="h-4 w-4 mr-2" />
                Stop
              </Button>
            </div>
          </>
        ) : (
          <Button
            className="w-full"
            onClick={() => setShowStartDialog(true)}
          >
            <Play className="h-4 w-4 mr-2" />
            Start Orchestrator
          </Button>
        )}
      </CardContent>

      <StartDialog
        open={showStartDialog}
        onOpenChange={setShowStartDialog}
        planName={plan.name}
        pendingTasks={plan.tasks.filter(t => t.status === 'pending')}
      />

      <StopDialog
        open={showStopDialog}
        onOpenChange={setShowStopDialog}
        planName={plan.name}
        orchestrator={orchestrator}
      />
    </Card>
  );
}
```

#### StartDialog
Dialog for starting orchestrator.

```typescript
// components/orchestrator/start-dialog.tsx

interface StartDialogProps {
  open: boolean;
  onOpenChange: (open: boolean) => void;
  planName: string;
  pendingTasks: Task[];
}

export function StartDialog({
  open,
  onOpenChange,
  planName,
  pendingTasks
}: StartDialogProps) {
  const [mode, setMode] = useState<'batch' | 'continuous'>('batch');
  const [selectedTasks, setSelectedTasks] = useState<string[]>([]);
  const [autonomous, setAutonomous] = useState(true);

  const startMutation = useStartOrchestrator();

  const handleStart = async () => {
    await startMutation.mutateAsync({
      name: planName,
      mode,
      tasks: mode === 'batch' ? selectedTasks : undefined,
      autonomous,
    });
    onOpenChange(false);
  };

  return (
    <Dialog open={open} onOpenChange={onOpenChange}>
      <DialogContent>
        <DialogHeader>
          <DialogTitle>Start Orchestrator</DialogTitle>
          <DialogDescription>
            Configure how the orchestrator should run for this plan.
          </DialogDescription>
        </DialogHeader>

        <div className="space-y-4 py-4">
          <div className="space-y-2">
            <Label>Mode</Label>
            <RadioGroup value={mode} onValueChange={setMode}>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="batch" id="batch" />
                <Label htmlFor="batch">Batch (run selected tasks)</Label>
              </div>
              <div className="flex items-center space-x-2">
                <RadioGroupItem value="continuous" id="continuous" />
                <Label htmlFor="continuous">Continuous (run until complete)</Label>
              </div>
            </RadioGroup>
          </div>

          {mode === 'batch' && (
            <div className="space-y-2">
              <Label>Tasks to Run</Label>
              <TaskSelector
                tasks={pendingTasks}
                selected={selectedTasks}
                onSelect={setSelectedTasks}
              />
            </div>
          )}

          <div className="flex items-center space-x-2">
            <Switch
              id="autonomous"
              checked={autonomous}
              onCheckedChange={setAutonomous}
            />
            <Label htmlFor="autonomous">Autonomous mode (no prompts)</Label>
          </div>
        </div>

        <DialogFooter>
          <Button variant="outline" onClick={() => onOpenChange(false)}>
            Cancel
          </Button>
          <Button
            onClick={handleStart}
            disabled={mode === 'batch' && selectedTasks.length === 0}
          >
            Start
          </Button>
        </DialogFooter>
      </DialogContent>
    </Dialog>
  );
}
```

### Activity Components

#### ActivityFeed
Recent activity timeline.

```typescript
// components/plans/activity-feed.tsx

interface ActivityFeedProps {
  activities: Activity[];
  maxItems?: number;
}

export function ActivityFeed({ activities, maxItems = 10 }: ActivityFeedProps) {
  const displayActivities = activities.slice(0, maxItems);

  return (
    <Card>
      <CardHeader>
        <CardTitle>Recent Activity</CardTitle>
      </CardHeader>
      <CardContent>
        <div className="space-y-3">
          {displayActivities.map((activity, i) => (
            <ActivityItem key={i} activity={activity} />
          ))}
          {displayActivities.length === 0 && (
            <p className="text-sm text-muted-foreground text-center py-4">
              No activity yet
            </p>
          )}
        </div>
      </CardContent>
    </Card>
  );
}
```

#### ActivityItem
Single activity entry.

```typescript
// components/plans/activity-item.tsx

interface ActivityItemProps {
  activity: Activity;
}

export function ActivityItem({ activity }: ActivityItemProps) {
  return (
    <div className="flex items-start gap-3">
      <TaskStatusIcon status={activity.action} className="mt-0.5" />
      <div className="flex-1 min-w-0">
        <p className="text-sm">
          <span className="font-mono text-muted-foreground">
            {activity.taskId}
          </span>
          {' '}
          <span className="truncate">{activity.description}</span>
        </p>
        <p className="text-xs text-muted-foreground">
          {formatRelativeTime(activity.timestamp)}
        </p>
      </div>
    </div>
  );
}
```

### Shared Components

#### StatusBadge
Badge showing plan/task status.

```typescript
// components/shared/status-badge.tsx

interface StatusBadgeProps {
  status: PlanStatus | TaskStatus;
}

const statusVariants = {
  pending: { label: 'Pending', variant: 'secondary' },
  in_progress: { label: 'Running', variant: 'default' },
  completed: { label: 'Completed', variant: 'success' },
  failed: { label: 'Failed', variant: 'destructive' },
  skipped: { label: 'Skipped', variant: 'outline' },
};

export function StatusBadge({ status }: StatusBadgeProps) {
  const config = statusVariants[status];

  return (
    <Badge variant={config.variant}>
      {config.label}
    </Badge>
  );
}
```

#### ConnectionStatus
WebSocket connection indicator.

```typescript
// components/shared/connection-status.tsx

export function ConnectionStatus() {
  const { connected } = useWebSocketStatus();

  return (
    <div className="flex items-center gap-2">
      <div className={cn(
        "h-2 w-2 rounded-full",
        connected ? "bg-green-500" : "bg-red-500"
      )} />
      <span className="text-sm text-muted-foreground">
        {connected ? 'Connected' : 'Disconnected'}
      </span>
    </div>
  );
}
```

## Component Dependencies

```
Shell
├── Header
│   ├── Logo
│   ├── SearchInput
│   ├── ConnectionStatus
│   └── ThemeToggle
└── Sidebar
    ├── NavItem
    └── PlanQuickList
        └── PlanQuickItem

PlanList
└── PlanCard
    ├── StatusBadge
    └── ProgressBar

PlanDetail
├── PlanHeader
│   ├── StatusBadge
│   ├── StartButton
│   └── StopButton
├── ProgressOverview
│   ├── DonutChart
│   └── StatCard
├── PhaseList
│   └── PhaseAccordion
│       ├── ProgressBar
│       └── TaskList
│           └── TaskItem
│               └── TaskStatusIcon
├── ActivityFeed
│   └── ActivityItem
│       └── TaskStatusIcon
└── OrchestratorPanel
    ├── OrchestratorStatusBadge
    ├── StartDialog
    │   ├── TaskSelector
    │   └── form controls
    └── StopDialog
```

## Styling Conventions

1. **Use Tailwind utility classes** for styling
2. **Use `cn()` helper** for conditional classes
3. **Keep components small** and focused
4. **Extract repeated patterns** into shared components
5. **Use semantic color tokens** (primary, muted, destructive)

## Testing Strategy

1. **Unit tests** for utility functions
2. **Component tests** with React Testing Library
3. **Integration tests** for data fetching hooks
4. **E2E tests** for critical user flows
