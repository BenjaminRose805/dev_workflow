# Agent C2 Findings: .claude Templates

## Summary

Analysis of 14 template files across 4 categories identified **3 DRY violations** (duplicated constraints and functions), **1 potential bug** (conditional syntax mismatch), **2 inconsistencies** in naming conventions, and **0 unused templates**. The most significant issues are the repeated "YOU MUST NEVER" constraint sections across agent templates and duplicate `getStatusSymbol()` function definitions across output templates. All identified issues are low-severity but present opportunities for refactoring and improved maintainability.

## DRY Violations

### Duplicated "YOU MUST NEVER" Constraint Sections
- **Location:**
  - `.claude/templates/agents/architecture-analysis.md:7-11`
  - `.claude/templates/agents/verify-agent.md:7-11`
  - `.claude/templates/agents/analysis-agent.md:7-10`
  - `.claude/templates/agents/research-agent.md:7-10`
- **Description:** All 4 agent templates contain identical "YOU MUST NEVER" constraint blocks that could be abstracted into a shared include or a parent template. The constraints listed (no file modifications, no command execution, no Edit/Write tools) are identical across all agents.
- **Impact:** When constraints need to be updated, 4 separate files must be maintained. Increases risk of inconsistency if updates are missed.
- **Recommendation:** Extract the "YOU MUST NEVER" section into `.claude/templates/shared/constraints.md` or similar, then reference it in all agent templates with a note like "See shared/constraints.md for critical constraints."

### Duplicated getStatusSymbol() Function Definition
- **Location:**
  - `.claude/templates/shared/status-symbols.md:109-119`
  - `.claude/templates/output/progress-display.md:189-197`
  - `.claude/templates/output/tree-view.md:227-234`
- **Description:** The `getStatusSymbol()` function is defined in 3 separate template files with identical or nearly identical logic. The shared version returns Unicode symbols for status strings (pending, in_progress, completed, failed, skipped, warning). Only tree-view.md has a slightly different signature (optional parameter).
- **Impact:** If status symbols need to change, multiple files must be updated. The variation in tree-view.md's signature could lead to confusion.
- **Recommendation:** Define the function once in `shared/status-symbols.md` and reference it in implementation notes for other templates. The tree-view variant should document its specific use case clearly or be unified with the shared version.

### Duplicated Progress Bar Rendering Logic
- **Location:**
  - `.claude/templates/output/progress-display.md:183-187` - `createProgressBar()` function
  - `.claude/templates/output/execution-summary.md` - No explicit function, but progress bar pattern shown in examples
- **Description:** Progress bar rendering logic appears in progress-display.md as a helper function but the pattern is referenced (though not explicitly coded) in execution-summary.md examples.
- **Impact:** Low impact since only one file has the actual implementation, but the pattern should be consistent if used elsewhere.
- **Recommendation:** Document the `createProgressBar()` function in `shared/` and reference it from both output templates.

## Bugs & Issues

### Invalid Handlebars Conditional Syntax
- **Location:** `.claude/templates/questions/execution-confirm.md:111` (and other locations)
- **Severity:** Low
- **Description:** Line 111 uses `{{#if (gte attemptNumber maxAttempts)}}` - a Handlebars custom helper syntax that is not standard. The standard syntax would be `{{#if attemptNumber}}` for truthiness checks or requires a properly defined custom helper. Error Recovery template uses similar patterns that may not work in standard Handlebars implementations.
- **Issue Found:** In error-recovery.md line 111: `{{#if (gte attemptNumber maxAttempts)}}` - the `gte` (greater-than-or-equal) helper is referenced but not defined anywhere in the templates. This will fail in standard Handlebars.
- **Recommendation:** Either:
  1. Document which Handlebars dialect is being used (e.g., Handlebars.js with custom helpers)
  2. Replace with standard syntax: `{{#if attemptNumber}} {{#if (gte attemptNumber maxAttempts)}}` â†’ document assumption about custom helpers
  3. Update templates to use only standard Handlebars syntax

## Inconsistencies

### Template Variable Naming Convention Inconsistency
- **Files:**
  - `.claude/templates/questions/error-recovery.md` (uses `errorType`, `failedItem`, `errorMessage`)
  - `.claude/templates/output/error-report.md` (uses `error_type`, `title`, `message`)
- **Description:** Error-related templates use different naming conventions - error-recovery.md uses camelCase (`errorType`, `failedItem`) while error-report.md uses snake_case (`error_type`) for similar concepts. Additionally, error-recovery.md uses `failedItem` while error-report.md uses `title` for the error summary.
- **Recommendation:** Standardize on camelCase for all template variables (used by 10 of 14 templates) and create a unified error template variable schema:
  - `{{errorType}}` (not `error_type`)
  - `{{itemName}}` or `{{failedItem}}` (consistent terminology)
  - `{{errorMessage}}` (not `message`)

### Status Symbol Terminology Inconsistency
- **Files:**
  - `.claude/templates/output/progress-display.md:22-23` (uses `in_progress` in status)
  - `.claude/templates/shared/status-symbols.md:14` (uses `In Progress` in descriptions)
  - `.claude/templates/output/tree-view.md:21` (uses `in_progress` in type definition)
- **Description:** Status values are represented inconsistently - sometimes as `in_progress` (snake_case), sometimes as `In Progress` (title case) in documentation.
- **Recommendation:** Standardize status value names in code: always use lowercase snake_case (`pending`, `in_progress`, `completed`, `failed`, `skipped`, `warning`) and document this clearly in a schema section at the top of status-symbols.md.

### Progress Item Structure Definition Inconsistency
- **Files:**
  - `.claude/templates/output/progress-display.md:19-25` (defines ProgressItem interface)
  - `.claude/templates/output/tree-view.md:17-28` (defines TreeItem interface, overlapping concepts)
- **Description:** Both templates define item structures but with different field names and purposes. Progress-display uses `id`, `name`, `status`, `duration`, `message`. Tree-view uses `name`, `type`, `path`, `status`, `children`, `metadata`. The overlap on `status` field creates potential confusion about which structure to use when.
- **Recommendation:** Create a unified item structure definition in `.claude/templates/shared/item-structures.md` with clear usage guidance for each context (progress items vs. tree items vs. result items).

## Unused/Orphaned

### No Unused Templates Found
- **Status:** All 14 templates are referenced or designed to be used by CLI commands or agents
- **Assessment:**
  - Agent templates (4 files) are used by the planning system
  - Shared templates (2 files) provide utilities for other templates
  - Question templates (4 files) support user interaction and decision points
  - Output templates (4 files) format results from operations
- **Recommendation:** No action needed - all templates serve clear purposes

## Additional Observations

### Documentation & Cross-References
- **Positive:** Most templates include "See Also" sections at the bottom with cross-references
- **Note:** The cross-references are consistent and helpful for navigation
- **Example:** box-styles.md properly references status-symbols.md and progress-display.md

### Code Block Quality
- **Observation:** Helper functions in templates are well-documented with TypeScript interfaces and JSDoc comments
- **Minor Issue:** Code blocks use TypeScript syntax but some templates don't specify language in markdown fences (e.g., `.claude/templates/questions/error-recovery.md:257` uses bare `function` without ```typescript markers)
- **Recommendation:** Add language identifiers to all code blocks for consistency

### Schema Specification Completeness
- **Observation:** Architecture-analysis.md has the most comprehensive schema specification (lines 224-252)
- **Recommendation:** Consider creating a `.claude/templates/shared/json-schema-specs.md` that documents all JSON output schemas once for reuse

## Priority Recommendations

1. **HIGH:** Extract and deduplicate "YOU MUST NEVER" constraints to shared location (fixes 4 instances in agents/)
2. **HIGH:** Document or fix Handlebars custom helper usage (`gte` helper) in error-recovery.md
3. **MEDIUM:** Standardize template variable naming to camelCase across all templates
4. **MEDIUM:** Consolidate `getStatusSymbol()` function to single source of truth in shared/
5. **LOW:** Create unified item structure definitions in shared/ templates directory

## Files Affected by Recommendations

Summary of changes needed:
- **Create:** `.claude/templates/shared/constraints.md` (new)
- **Modify:** `.claude/templates/agents/*.md` (4 files - reference constraints)
- **Modify:** `.claude/templates/output/progress-display.md` and `tree-view.md` (consolidate getStatusSymbol)
- **Modify:** `.claude/templates/questions/error-recovery.md` and `.claude/templates/output/error-report.md` (standardize naming)
- **Optional:** Create `.claude/templates/shared/item-structures.md` (new)
