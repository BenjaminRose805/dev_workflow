# Agent C1 Findings: .claude Commands

## Summary

The plan commands system exhibits significant code duplication across 11 of 12 files, with critical DRY (Don't Repeat Yourself) violations accounting for ~800+ lines of duplicated content. The most impactful issues are:

1. **"Load Active Plan" section** - Duplicated in 7 files (batch.md, explain.md, implement.md, migrate.md, set.md, split.md, verify.md)
2. **"Parse Arguments (1.5)" section** - Duplicated in 5 files with identical regex patterns and validation logic
3. **Status.json integration** - Referenced in 68 instances across 10 files with repeated initialization/tracking patterns
4. **Progress formatting** - Duplicated progress bar, symbols, and display code in 3+ files
5. **"Source of truth" documentation** - Repeated in 6 files about status.json vs markdown

## DRY Violations

### Violation 1: "Load Active Plan" Section (7 files)

- **Location:**
  - `batch.md:7-17`
  - `explain.md:7-17`
  - `implement.md:9-18`
  - `migrate.md:9-15`
  - `set.md:1` (referenced, not full duplicate)
  - `split.md:9-13`
  - `verify.md:9-17`

- **Description:** Nearly identical "Load Active Plan" section appears in 7 files. Core content from lines 7-13 is repeated verbatim:
  ```
  Read `.claude/current-plan.txt` to get the active plan path.

  **If no active plan:**
  - Inform the user: "No active plan set. Use /plan:set to choose a plan first."
  - Stop execution
  ```

- **Recommendation:** Extract into a shared template/include file `.claude/commands/plan/_load-plan.md` or create a reusable instruction block referenced by all 7 commands.

---

### Violation 2: "Parse Arguments (1.5)" Section (5 files)

- **Location:**
  - `batch.md:19-89` (71 lines)
  - `explain.md:19-88` (70 lines)
  - `implement.md:20-90` (71 lines)
  - `split.md:15-60` (46 lines)
  - `verify.md:19-88` (70 lines)

- **Description:** Identical argument parsing pattern repeated across 5 files with:
  - Same regex patterns: `/^p(hase)?:\d+$/i`, `/^[\d.]+([\s,]+[\d.]+)*$/`
  - Same logic structure: empty args ‚Üí interactive selection
  - Same validation rules and error messages
  - Same example usage section
  - Minor variations only in task context (implement vs verify)

- **Recommendation:** Extract into `.claude/commands/plan/_argument-parsing.md` with a single template covering:
  - Argument format table
  - Parsing logic pseudocode
  - Validation rules
  - Examples (parameterized by action type)

---

### Violation 3: Status.json Integration Pattern (9 files)

- **Location:** status.json references appear in:
  - `archive.md:166` - "Migrated plans will have `migrated: true` in status.json"
  - `batch.md:16-17, 327-329` - Initialization and completion tracking
  - `create.md:113-134` - Status file creation
  - `explain.md:94-112` - "status.json is the authoritative source of truth"
  - `implement.md:16-18, 361-387` - Initialization and marking complete
  - `migrate.md:113-149` - Status initialization and tracking
  - `set.md:23-48` - Initialization workflow
  - `status.md:24-60` - Primary source documentation
  - `verify.md:92-114` - "Use status.json as primary source"

- **Description:** Repeated explanations of:
  - Why status.json is the "authoritative source of truth" (appears verbatim in 6 files)
  - How to call `initializePlanStatus()`, `markTaskCompleted()`, `getStatus()`
  - Output directory structure (`docs/plan-outputs/{plan-name}/`)
  - Three-subdirectory pattern: `status.json`, `findings/`, `timestamps/`

- **Recommendation:** Create `.claude/commands/plan/_status-tracking.md` containing:
  - Unified explanation of status.json architecture
  - Common API calls and their usage
  - Directory structure diagram
  - Error handling patterns
  - Cross-reference from all 9 files

---

### Violation 4: Progress Formatting and Symbols (6 files)

- **Location:**
  - `batch.md:224-408` - `progress-display` and `execution-summary` templates
  - `explain.md:190-241` - Task status display with symbols
  - `implement.md:389-427` - Progress formatting and symbols
  - `set.md:89-120` - Progress bar display
  - `status.md:78-186` - Full progress display with breakdown
  - `verify.md:369-395` - Verification report formatting

- **Description:** Identical progress formatting components:
  - Status symbols: `‚úì`, `‚óØ`, `‚ü≥`, `‚úó`, `‚äò` defined multiple times
  - Progress bar template: `[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 60%` repeated
  - Phase breakdown format repeated
  - Task count display (e.g., "18/30 complete (12 remaining)")
  - Color coding scheme (Green/Yellow/Gray/Red) defined twice

- **Recommendation:** Extract to `.claude/templates/shared/progress-symbols.md` (already exists per references) and create standard progress display component with parameterized configuration.

---

### Violation 5: Markdown Checkbox vs status.json Documentation (6 files)

- **Location:**
  - `explain.md:94-95`
  - `implement.md:96-99`
  - `status.md:38-40`
  - `verify.md:94-101`
  - `migrate.md:40-47`
  - `batch.md:99` (implicit reference)

- **Description:** Near-identical documentation stating:
  ```
  Important: status.json is THE/the authoritative source for task completion status.
  Markdown checkboxes (`- [ ]` / `- [x]`) are reference documentation only.
  NEVER modify markdown checkboxes during execution.
  ```

- **Recommendation:** Create `.claude/commands/plan/_important-notes.md` with standard disclaimers about:
  - status.json as source of truth
  - Markdown preservation
  - Checkbox non-modification policy

---

### Violation 6: Template Variable Detection Pattern (2 files)

- **Location:**
  - `implement.md:114-165` (52 lines)
  - `create.md:17-68` (implied pattern)

- **Description:** `implement.md` contains detailed template variable substitution logic that mirrors the variable handling in `create.md`:
  - Regex for `\{\{([a-z_]+)\}\}`
  - Variable detection in task descriptions
  - User prompting for values
  - Common variables table

- **Recommendation:** Extract to `.claude/commands/plan/_template-variables.md` with reusable sections for:
  - Variable detection and substitution
  - Common variable definitions table
  - User prompting workflow

---

## Bugs & Issues

### Issue 1: Undefined Function References in status.json Integration

- **Location:**
  - `batch.md:16` - `initializePlanStatus(planPath)` called but never defined
  - `implement.md:16` - Same undefined function
  - `verify.md:16` - Same undefined function
  - `explain.md:16` - Same undefined function

- **Severity:** Medium

- **Description:** Multiple commands reference `initializePlanStatus(planPath)` as a function, but this appears to never be defined. Alternative functions mentioned include:
  - `createOutputDir()` and `loadStatus()` (migrate.md:125-126)
  - `initializeStatus()` (set.md:35, create.md:127)

  Inconsistent naming suggests either missing documentation or outdated references.

- **Recommendation:** Audit the actual status-manager API and standardize function names across all commands. Create a single reference document listing:
  - `initializePlanStatus(planPath)` - what it actually does
  - `createOutputDir(planPath)` - directory creation
  - `initializeStatus(planPath, planName, tasks)` - full initialization
  - `getStatus(planPath, shouldInit)` - status retrieval
  - Clarify which combinations are needed per command

---

### Issue 2: Template Variable Substitution Never Completes in implement.md

- **Location:** `implement.md:114-165`

- **Severity:** High

- **Description:** Section 2.1 "Handle Template Variables" describes detecting unsubstituted variables but never explains what happens if the user doesn't provide values. The flow:
  1. Detects variables
  2. Prompts user
  3. Says "Use Edit tool to replace all `{{variable}}`" (line 144)
  4. Then... continues to step 3 "Present Tasks"

  But the plan may still contain `{{target_path}}` in task descriptions, making tasks un-implementable.

- **Recommendation:** Either:
  - Require all template variables be substituted before proceeding to step 3
  - Skip any tasks containing unsubstituted variables with clear messaging
  - Provide values for common variables automatically (e.g., date = today, test_framework = vitest)

---

### Issue 3: Inconsistent Error Message Format

- **Location:** Multiple files with different error messaging patterns:
  - `batch.md:12` - "No active plan set. Use /plan:set to choose a plan first."
  - `explain.md:12` - Same message (good)
  - `set.md:12-15` - Different format with more detail
  - `migrate.md:12-15` - Different format again

- **Severity:** Low

- **Description:** Error messages for "no active plan" vary in wording and formatting across commands, reducing consistency.

- **Recommendation:** Standardize to single error message format. Define in `_important-notes.md` or `_load-plan.md`.

---

### Issue 4: Archive.md References Non-Existent Script

- **Location:** `archive.md:12`

- **Severity:** Medium

- **Description:** References `node scripts/scan-completed-plans.js` but this script location/name is never defined elsewhere. Set.md references `node scripts/scan-plans.js` (different name).

- **Recommendation:** Verify script names and create unified documentation for available scripts at `.claude/SCRIPTS.md` or similar, with:
  - Script name
  - Purpose
  - Input/output format
  - Which commands use it

---

### Issue 5: Missing Phase Parser Function Reference

- **Location:** `batch.md:99`, `migrate.md:40-47`

- **Severity:** Low

- **Description:** Code references `parsePhases(content)` and `getTitle(content)` from `scripts/lib/markdown-parser.js` but these are only documented in `migrate.md`. Other files that parse markdown don't mention where these utilities come from.

- **Recommendation:** Add `.claude/commands/plan/_markdown-utilities.md` documenting:
  - `parsePhases(content)`
  - `getTitle(content)`
  - Where to import them
  - Expected output format

---

## Inconsistencies

### Inconsistency 1: Argument Parsing Section Numbering

- **Files:** `batch.md`, `explain.md`, `implement.md`, `split.md`, `verify.md`

- **Description:** All files use `### 1.5. Parse Arguments` but only some have a `### 1. Load Active Plan` and `### 1.1` through `1.4` sections. This creates:
  - `batch.md`: Goes 1 ‚Üí 1.5 ‚Üí 2
  - `implement.md`: Goes 1 ‚Üí 1.5 ‚Üí 2
  - `set.md`: Goes 1 ‚Üí 3.1 ‚Üí 3
  - Non-sequential numbering looks like a typo

- **Recommendation:** Standardize section numbering. Either:
  - Use 1, 2, 2.1, 2.2, 3 (sequential)
  - Keep 1.5 but ensure all files have consistent sub-sections
  - Document why 1.5 is used (hint: probably a copy-paste artifact)

---

### Inconsistency 2: Progress Bar Display Format

- **Files:** `batch.md:202-206` vs `set.md:104-108` vs `status.md:90`

- **Description:** Progress bars use different widths and styles:
  - `set.md`: `[‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 40%` (20 chars)
  - `status.md`: `‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë 60%` (20 chars, no brackets)
  - `batch.md:202`: Using `execution-summary template` (undefined)

- **Recommendation:** Define a single progress bar standard in shared template file with:
  - Character set (‚ñà and ‚ñë)
  - Width in characters
  - Percentage display location
  - Example for 0%, 25%, 50%, 75%, 100%

---

### Inconsistency 3: Status Symbols Definition

- **Files:** All 12 files reference symbols but define them inconsistently

- **Description:** Status symbols appear as:
  - `batch.md:226-231`: `‚óØ` (pending), `‚ü≥` (in progress), `‚úì` (completed), `‚úó` (failed), `‚äò` (skipped)
  - `explain.md:134-139`: Same symbols but different descriptions
  - `verify.md:170`: References "semantic status indicators" (‚úÖ, ‚è≥, üö´, üóëÔ∏è) which differ from execution symbols
  - No single source of truth for which command uses which set

- **Recommendation:** Document in `.claude/templates/shared/status-symbols.md`:
  - **Execution Status**: ‚óØ, ‚ü≥, ‚úì, ‚úó, ‚äò (for plan progress)
  - **Verification Status**: ‚úÖ, ‚è≥, üö´, üóëÔ∏è (for verify command)
  - Clear explanation of when each set is used

---

### Inconsistency 4: AskUserQuestion vs Task Tool Usage

- **Files:** `batch.md:105`, `explain.md:116`, `implement.md:167`, `verify.md:120` (AskUserQuestion)
- **Files:** `orchestrate.md:64`, `batch.md:289` (Task tool)

- **Description:** Commands use different tools for agent spawning:
  - `AskUserQuestion` for user interaction (interactive selection)
  - `Task` tool for parallel agents
  - Orchestrate.md explicitly says "DO NOT use Skill() invocations" but implement/batch use Skill references

- **Recommendation:** Create `.claude/commands/plan/_tool-selection.md` documenting:
  - When to use AskUserQuestion
  - When to use Task tool
  - When to use Skill invocations
  - Examples for each

---

### Inconsistency 5: Output Directory Naming

- **Files:** Multiple files reference output directory path structure

- **Description:** Different variations seen:
  - `batch.md:100`: `docs/plan-outputs/{plan-name}/`
  - `implement.md`: Same
  - `set.md:43`: Same
  - `verify.md`: Same
  - But `{plan-name}` definition varies: sometimes filename without .md, sometimes plan title

- **Recommendation:** Standardize definition: Is it:
  - Filename without .md extension? (`test-suite-implementation`)
  - Plan title slugified? (`test-suite-implementation-plan`)
  - Need to document this centrally

---

## Unused/Orphaned

### Unused Element 1: Execution-Confirm Template

- **Location:** `batch.md:159`

- **Description:** References `.claude/templates/questions/execution-confirm.md` template but:
  - Never imported or included in any command
  - Configuration parameters described (title, strategy, groups, etc.) but template not verified to exist
  - Other commands use simpler inline formatting instead

- **Recommendation:** Either:
  - Verify template exists and use it consistently
  - Remove reference and use inline formatting (like other commands)
  - Create missing template if it should exist

---

### Unused Element 2: Plan Runner Script

- **Location:** `orchestrate.md:24-50`

- **Description:** References `./scripts/plan-runner.sh` with commands like:
  - `./scripts/plan-runner.sh status`
  - `./scripts/plan-runner.sh next 5`

  But no other command references this script, and it may not exist.

- **Recommendation:** Verify script exists and is maintained. If not, either:
  - Create the script to support autonomous execution
  - Replace with JavaScript equivalents using status-cli.js
  - Archive orchestrate.md as "future feature"

---

### Unused Element 3: Template Variable Handling

- **Location:** `implement.md:114-165`

- **Description:** Detailed template variable substitution section, but:
  - Only implement.md has this section
  - create.md creates plans from templates but simpler variable handling (lines 43-73)
  - No indication this feature is actively used

- **Recommendation:** Either:
  - Implement feature consistently across create + implement
  - Remove template variable support if not used
  - Document why only implement.md has this handling

---

## Recommendations for Refactoring

### High Priority (Large DRY Impact)

1. **Extract "Load Active Plan" block** ‚Üí `.claude/commands/plan/_common/load-plan.md`
   - Impact: Removes 50+ lines of duplication
   - Effort: Low
   - Files affected: 7

2. **Extract "Parse Arguments" section** ‚Üí `.claude/commands/plan/_common/argument-parsing.md`
   - Impact: Removes 300+ lines of duplication
   - Effort: Low-Medium
   - Files affected: 5

3. **Consolidate Status.json Documentation** ‚Üí `.claude/commands/plan/_common/status-tracking.md`
   - Impact: Removes 100+ lines + improves clarity
   - Effort: Medium
   - Files affected: 9

4. **Standardize Progress Display** ‚Üí Update `.claude/templates/shared/progress-symbols.md` and status-symbols.md
   - Impact: Removes 50+ lines
   - Effort: Low
   - Files affected: 6

### Medium Priority (Consistency & Clarity)

5. **Fix undefined function references** (Issue 1)
   - Create `.claude/commands/plan/_common/api-reference.md`
   - Effort: Medium

6. **Standardize error messages** (Issue 3)
   - Effort: Low
   - Impact: Improved user experience

7. **Document available scripts** (Issue 4)
   - Create `.claude/SCRIPTS.md`
   - Effort: Low

### Low Priority (Polish)

8. **Fix section numbering** (Inconsistency 1)
   - Effort: Low
   - Impact: Reduces confusion

9. **Verify template references** (Unused 1)
   - Effort: Low
   - Impact: Prevents runtime errors

---

## Summary Statistics

| Category | Count |
|----------|-------|
| Total Files Analyzed | 12 |
| Files with DRY Violations | 11 |
| Estimated Duplicate Lines | 800+ |
| Number of Distinct Violations | 6 |
| Number of Bugs/Issues | 5 |
| Number of Inconsistencies | 5 |
| Number of Unused Elements | 3 |

**Recommended Extraction Files:**
```
.claude/commands/plan/_common/
‚îú‚îÄ‚îÄ load-plan.md              (for "Load Active Plan" duplication)
‚îú‚îÄ‚îÄ argument-parsing.md       (for argument parsing logic)
‚îú‚îÄ‚îÄ status-tracking.md        (for status.json integration)
‚îú‚îÄ‚îÄ template-variables.md     (for template handling)
‚îú‚îÄ‚îÄ api-reference.md          (for function documentation)
‚îî‚îÄ‚îÄ error-messages.md         (for consistent error text)
```

**Estimated Effort to Resolve:**
- High Priority: 6-8 hours
- Medium Priority: 3-4 hours
- Low Priority: 1-2 hours
- **Total: 10-14 hours**

**Potential Code Reduction:** ~400-500 lines (40-50% reduction in plan command documentation)
