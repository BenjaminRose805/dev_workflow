{
  "planPath": "docs/plans/fix-orchestrator-bugs.md",
  "planName": "Implementation Plan: Fix Orchestrator Bugs",
  "createdAt": "2025-12-23T03:00:00.000Z",
  "lastUpdatedAt": "2025-12-24T04:08:55.391Z",
  "currentPhase": "Phase 1: Fix Critical Race Conditions",
  "tasks": [
    {
      "id": "1.1",
      "phase": "Phase 1: Fix Critical Race Conditions",
      "description": "Add file locking to plan-output-utils.js",
      "status": "completed",
      "completedAt": "2025-12-24T02:41:12.418Z",
      "notes": "Added file locking with proper-lockfile package. Implemented loadStatusWithLock, saveStatusWithLock, and updateTaskStatusWithLock functions with exponential backoff retry logic."
    },
    {
      "id": "1.2",
      "phase": "Phase 1: Fix Critical Race Conditions",
      "description": "Create atomic write function for status.json",
      "status": "completed",
      "completedAt": "2025-12-24T02:44:26.326Z",
      "notes": "Added writeFileAtomic and writeFileAtomicAsync functions to file-utils.js. Updated saveStatus and saveStatusWithLock in plan-output-utils.js to use atomic writes, preventing corruption from partial writes."
    },
    {
      "id": "1.3",
      "phase": "Phase 1: Fix Critical Race Conditions",
      "description": "Add lock timeout and stale lock detection",
      "status": "completed",
      "completedAt": "2025-12-24T02:47:17.184Z",
      "notes": "Added lock timeout (10s) and stale lock detection (60s). Implemented isLockStale(), cleanStaleLock(), isLocked() functions. Updated acquireLock() with Promise.race timeout pattern."
    },
    {
      "id": "1.4",
      "phase": "Phase 1: Fix Critical Race Conditions",
      "description": "Add transaction-like batch updates",
      "status": "completed",
      "completedAt": "2025-12-24T02:50:26.971Z",
      "notes": "Added batchUpdateTasks(planPath, updates[]) function for transaction-like batch updates. Single lock acquisition and atomic write for multiple task status changes. Returns detailed result with updated/failed lists and errors."
    },
    {
      "id": "2.1",
      "phase": "Phase 2: Fix Status Summary Tracking",
      "description": "Fix summary key mapping in updateTaskStatus",
      "status": "completed",
      "startedAt": "2025-12-24T02:49:42.706Z",
      "completedAt": "2025-12-24T02:57:26.843Z",
      "duration": 464137,
      "notes": "Fixed summary key mapping by using ensureSummaryKeys() before updating summary. Added explicit check for valid keys."
    },
    {
      "id": "2.2",
      "phase": "Phase 2: Fix Status Summary Tracking",
      "description": "Add summary recalculation function",
      "status": "completed",
      "startedAt": "2025-12-24T02:49:42.706Z",
      "completedAt": "2025-12-24T02:57:26.845Z",
      "duration": 464139,
      "notes": "Added recalculateSummary(status) function that counts tasks by status. Returns accurate summary calculated from actual task array."
    },
    {
      "id": "2.3",
      "phase": "Phase 2: Fix Status Summary Tracking",
      "description": "Fix initial summary when tasks parsed from markdown",
      "status": "completed",
      "completedAt": "2025-12-24T02:57:26.845Z",
      "notes": "Updated initializeStatus() to use createEmptySummary() which includes in_progress key initialized to 0."
    },
    {
      "id": "2.4",
      "phase": "Phase 2: Fix Status Summary Tracking",
      "description": "Add summary validation on load",
      "status": "completed",
      "completedAt": "2025-12-24T02:57:26.846Z",
      "notes": "Added validateSummary(status, autoFix) function and integrated it into loadStatus() to detect and auto-fix summary drift on load."
    },
    {
      "id": "3.1",
      "phase": "Phase 3: Fix Python Streaming Parser",
      "description": "Fix event timing in StreamingClaudeRunner",
      "status": "completed",
      "completedAt": "2025-12-24T03:02:06.769Z",
      "notes": "Fixed event timing: on_tool_start now fires at content_block_start (not content_block_stop). Tool name and ID captured immediately when tool begins."
    },
    {
      "id": "3.2",
      "phase": "Phase 3: Fix Python Streaming Parser",
      "description": "Implement proper on_tool_end handling",
      "status": "completed",
      "completedAt": "2025-12-24T03:02:06.770Z",
      "notes": "Implemented on_tool_end: Fires at content_block_stop with tool_name, tool_id, and duration. Parses accumulated JSON input for details."
    },
    {
      "id": "3.3",
      "phase": "Phase 3: Fix Python Streaming Parser",
      "description": "Connect on_tool_end callback in orchestrator",
      "status": "completed",
      "completedAt": "2025-12-24T03:02:06.771Z",
      "notes": "Connected _on_tool_end callback in PlanOrchestrator. Passes on_tool_end to StreamingClaudeRunner initialization. TUI complete_activity called with duration."
    },
    {
      "id": "3.4",
      "phase": "Phase 3: Fix Python Streaming Parser",
      "description": "Add tool execution duration tracking",
      "status": "completed",
      "completedAt": "2025-12-24T03:02:06.771Z",
      "notes": "Added duration tracking: _tool_start_times dict stores start timestamp. Duration calculated at content_block_stop. Activity displays duration in TUI (ms/s/m format)."
    },
    {
      "id": "4.1",
      "phase": "Phase 4: Create Status Manager CLI",
      "description": "Create scripts/status-cli.js with subcommands",
      "status": "completed",
      "completedAt": "2025-12-24T03:06:48.023Z",
      "notes": "Created scripts/status-cli.js with status, mark-started, mark-complete, mark-failed, mark-skipped commands. All output JSON, proper error handling."
    },
    {
      "id": "4.2",
      "phase": "Phase 4: Create Status Manager CLI",
      "description": "Add findings management commands",
      "status": "completed",
      "completedAt": "2025-12-24T03:06:48.024Z",
      "notes": "Added write-findings (--file, --stdin, --content) and read-findings commands. Findings stored in docs/plan-outputs/<plan>/findings/<task-id>.md"
    },
    {
      "id": "4.3",
      "phase": "Phase 4: Create Status Manager CLI",
      "description": "Add run management commands",
      "status": "completed",
      "completedAt": "2025-12-24T03:06:48.025Z",
      "notes": "Added start-run (outputs runId) and complete-run <run-id> --completed N --failed N commands for tracking execution runs."
    },
    {
      "id": "4.4",
      "phase": "Phase 4: Create Status Manager CLI",
      "description": "Add convenience commands",
      "status": "completed",
      "completedAt": "2025-12-24T03:06:48.025Z",
      "notes": "Added next [count] for recommended tasks, progress for formatted progress bar, validate for status.json validation and repair."
    },
    {
      "id": "5.1",
      "phase": "Phase 5: Fix TUI Display Accuracy",
      "description": "Fix In Progress panel data source",
      "status": "completed",
      "completedAt": "2025-12-24T03:11:06.111Z",
      "notes": "Fixed In Progress panel to use actual in_progress tasks from status.json instead of getNextTasks(). Updated _on_status_update to filter tasks by status."
    },
    {
      "id": "5.2",
      "phase": "Phase 5: Fix TUI Display Accuracy",
      "description": "Improve status monitor responsiveness",
      "status": "completed",
      "completedAt": "2025-12-24T03:11:06.113Z",
      "notes": "Reduced poll interval from 2s to 500ms. Added inotify support (Linux) for event-driven updates. Falls back to polling if inotify unavailable."
    },
    {
      "id": "5.3",
      "phase": "Phase 5: Fix TUI Display Accuracy",
      "description": "Add heartbeat indicator",
      "status": "completed",
      "completedAt": "2025-12-24T03:11:06.113Z",
      "notes": "Added heartbeat indicator with spinner animation. Shows \"Claude working\" with animated spinner during sessions, idle time when waiting."
    },
    {
      "id": "5.4",
      "phase": "Phase 5: Fix TUI Display Accuracy",
      "description": "Fix progress bar calculation",
      "status": "completed",
      "completedAt": "2025-12-24T03:11:06.113Z",
      "notes": "Fixed progress bar calculation to handle 0 total tasks. Progress now calculated from summary counts. Added in_progress_count tracking."
    },
    {
      "id": "6.1",
      "phase": "Phase 6: Simplify Orchestrator Prompt",
      "description": "Rewrite _build_prompt() to use status-cli",
      "status": "completed",
      "completedAt": "2025-12-24T03:18:14.557Z",
      "notes": "Replaced inline JavaScript with status-cli.js commands: mark-started, mark-complete, mark-failed. Prompt is now ~313 tokens (well under 2000 limit)."
    },
    {
      "id": "6.2",
      "phase": "Phase 6: Simplify Orchestrator Prompt",
      "description": "Add explicit task implementation instructions",
      "status": "completed",
      "completedAt": "2025-12-24T03:18:14.559Z",
      "notes": "Added 4-step implementation instructions: mark started, read plan, implement, mark complete. Clear examples with bash code blocks."
    },
    {
      "id": "6.3",
      "phase": "Phase 6: Simplify Orchestrator Prompt",
      "description": "Add error recovery instructions",
      "status": "completed",
      "completedAt": "2025-12-24T03:18:14.560Z",
      "notes": "Added \"If a Task Fails\" section with mark-failed command. Instructions to continue to next task after failure."
    },
    {
      "id": "6.4",
      "phase": "Phase 6: Simplify Orchestrator Prompt",
      "description": "Remove skill invocation references",
      "status": "completed",
      "completedAt": "2025-12-24T03:18:14.560Z",
      "notes": "Removed all /plan:orchestrate and Skill references. Rules section explicitly says \"do NOT use slash commands or skills\"."
    },
    {
      "id": "7.1",
      "phase": "Phase 7: Fix Task Source of Truth",
      "description": "Document authoritative source clearly",
      "status": "completed",
      "startedAt": "2025-12-24T03:24:57.173Z",
      "completedAt": "2025-12-24T03:29:36.225Z",
      "duration": 279052,
      "notes": "Added comprehensive source-of-truth documentation to plan-output-utils.js header, added _comment field to status.json in initializeStatus, updated status-cli.js header with source-of-truth guidance."
    },
    {
      "id": "7.2",
      "phase": "Phase 7: Fix Task Source of Truth",
      "description": "Add sync validation command",
      "status": "completed",
      "startedAt": "2025-12-24T03:29:43.649Z",
      "completedAt": "2025-12-24T03:30:53.981Z",
      "duration": 70332,
      "notes": "Added sync-check command to status-cli.js. Compares markdown checkboxes vs status.json without modifying either. Reports discrepancies with clear guidance that status.json is authoritative."
    },
    {
      "id": "7.3",
      "phase": "Phase 7: Fix Task Source of Truth",
      "description": "Remove checkbox references from commands",
      "status": "completed",
      "startedAt": "2025-12-24T03:31:02.375Z",
      "completedAt": "2025-12-24T03:37:16.738Z",
      "duration": 374363,
      "notes": "Updated implement.md, explain.md, verify.md, set.md, and status.md to clarify that status.json is the source of truth and markdown checkboxes are not modified. Added clear guidance that checkbox state should be ignored for execution state."
    },
    {
      "id": "7.4",
      "phase": "Phase 7: Fix Task Source of Truth",
      "description": "Add task discovery from status.json",
      "status": "completed",
      "startedAt": "2025-12-24T03:37:23.913Z",
      "completedAt": "2025-12-24T03:40:12.239Z",
      "duration": 168326,
      "notes": "Added loadTasks() function that reads from status.json first and falls back to markdown only if status.json is missing. Updated main execution to use this function. Added source indicator to status output showing whether data came from status.json or markdown fallback."
    },
    {
      "id": "8.1",
      "phase": "Phase 8: Add Retry and Recovery Logic",
      "description": "Add retry tracking to task status",
      "status": "completed",
      "startedAt": "2025-12-24T03:44:16.619Z",
      "completedAt": "2025-12-24T03:45:28.198Z",
      "duration": 71579,
      "notes": "Added retry tracking fields (retryCount, lastError, lastErrorAt) to task status. Implemented incrementRetryCount(), resetRetryCount(), getRetryableTasks(), getExhaustedTasks() functions. MAX_RETRIES=2 configured."
    },
    {
      "id": "8.2",
      "phase": "Phase 8: Add Retry and Recovery Logic",
      "description": "Implement retry logic in Python orchestrator",
      "status": "completed",
      "startedAt": "2025-12-24T03:45:36.854Z",
      "completedAt": "2025-12-24T03:47:03.527Z",
      "duration": 86673,
      "notes": "Added retry logic to Python orchestrator: get_retryable_tasks(), increment_retry(), reset_task_for_retry(), detect_stuck_tasks(). Main loop now checks for stuck tasks, attempts retries before declaring blocked. Added CLI commands: retryable, exhausted, increment-retry, detect-stuck."
    },
    {
      "id": "8.3",
      "phase": "Phase 8: Add Retry and Recovery Logic",
      "description": "Add stuck task detection",
      "status": "completed",
      "completedAt": "2025-12-24T03:45:28.661Z",
      "notes": "Added stuck task detection with 30-minute threshold. Implemented detectAndMarkStuckTasks() that auto-marks stuck tasks as failed, and getStuckTasks() for read-only checking. Added stuckDetected flag to task status."
    },
    {
      "id": "8.4",
      "phase": "Phase 8: Add Retry and Recovery Logic",
      "description": "Add recovery from corrupt status.json",
      "status": "completed",
      "startedAt": "2025-12-24T03:47:10.035Z",
      "completedAt": "2025-12-24T03:48:34.118Z",
      "duration": 84083,
      "notes": "Added backup/recovery system: createBackup() before each write, restoreFromBackup() on parse errors, rebuildStatusFromMarkdown() as last resort. Backup file stored as status.json.bak. Recovery cascades: try backup first, then rebuild from markdown (all tasks reset to pending)."
    },
    {
      "id": "9.1",
      "phase": "Phase 9: Testing & Validation",
      "description": "Create unit tests for status-cli commands",
      "status": "completed",
      "startedAt": "2025-12-24T03:50:08.766Z",
      "completedAt": "2025-12-24T03:53:36.133Z",
      "duration": 207367,
      "notes": "Created scripts/tests/test-status-cli.js with 46 unit tests covering all status-cli commands. Tests include status, mark-started/complete/failed/skipped, next, progress, validate, sync-check, retryable, detect-stuck, run management, findings management, and error handling."
    },
    {
      "id": "9.2",
      "phase": "Phase 9: Testing & Validation",
      "description": "Create integration test for parallel updates",
      "status": "completed",
      "startedAt": "2025-12-24T03:53:43.026Z",
      "completedAt": "2025-12-24T03:54:53.899Z",
      "duration": 70873,
      "notes": "Created scripts/tests/test-parallel-updates.js. Test spawns 10 parallel processes with 3 updates each (30 total). All updates succeeded with no data loss. Summary correctly tracks actual task counts. File locking prevents race conditions."
    },
    {
      "id": "9.3",
      "phase": "Phase 9: Testing & Validation",
      "description": "Test Python orchestrator end-to-end",
      "status": "completed",
      "startedAt": "2025-12-24T03:55:01.573Z",
      "completedAt": "2025-12-24T03:56:45.086Z",
      "duration": 103513,
      "notes": "Created scripts/tests/test-orchestrator-e2e.py with 6 tests: plan loading, task selection, status updates, progress tracking, completion detection, and orchestrator dry-run. All tests pass."
    },
    {
      "id": "9.4",
      "phase": "Phase 9: Testing & Validation",
      "description": "Test recovery scenarios",
      "status": "completed",
      "startedAt": "2025-12-24T03:56:52.409Z",
      "completedAt": "2025-12-24T03:58:18.033Z",
      "duration": 85624,
      "notes": "Created scripts/tests/test-recovery.js with 17 tests covering: backup creation, recovery from corrupt file, rebuild from markdown, stuck task detection, and retry tracking. All tests pass."
    },
    {
      "id": "10.1",
      "phase": "Phase 10: Documentation & Cleanup",
      "description": "Update orchestrator README",
      "status": "completed",
      "startedAt": "2025-12-24T03:59:29.367Z",
      "completedAt": "2025-12-24T04:01:52.972Z",
      "duration": 143605,
      "notes": "Created comprehensive docs/ORCHESTRATOR.md with status-cli commands, status.json format, source of truth explanation, and troubleshooting guide"
    },
    {
      "id": "10.2",
      "phase": "Phase 10: Documentation & Cleanup",
      "description": "Update command documentation",
      "status": "completed",
      "startedAt": "2025-12-24T04:01:53.488Z",
      "completedAt": "2025-12-24T04:05:20.097Z",
      "duration": 206609,
      "notes": "Updated orchestrate.md, set.md, create.md, migrate.md to use status-cli.js commands instead of inline JavaScript. Replaced references to non-existent status-manager.js with plan-output-utils.js"
    },
    {
      "id": "10.3",
      "phase": "Phase 10: Documentation & Cleanup",
      "description": "Add architecture diagram",
      "status": "completed",
      "startedAt": "2025-12-24T04:05:20.632Z",
      "completedAt": "2025-12-24T04:07:10.107Z",
      "duration": 109475,
      "notes": "Created comprehensive architecture documentation at docs/architecture/orchestrator-system.md with ASCII diagrams showing system overview, data flow, concurrent write protection, recovery flow, and status.json schema"
    },
    {
      "id": "10.4",
      "phase": "Phase 10: Documentation & Cleanup",
      "description": "Remove deprecated code",
      "status": "completed",
      "startedAt": "2025-12-24T04:07:10.639Z",
      "completedAt": "2025-12-24T04:08:55.391Z",
      "duration": 104752,
      "notes": "Added deprecation notices to scan-results.js and updated index.js to show [DEPRECATED] tag. Kept file for backwards compatibility rather than removing."
    }
  ],
  "runs": [
    {
      "runId": "run-1766545578111",
      "startedAt": "2025-12-24T03:06:18.111Z",
      "tasksCompleted": 0,
      "tasksFailed": 0
    }
  ],
  "summary": {
    "totalTasks": 40,
    "completed": 40,
    "pending": 0,
    "in_progress": 0,
    "failed": 0,
    "skipped": 0
  }
}