# Integration Tests: Uncommitted Changes Scenarios

**Tested:** 2024-12-25
**Task:** 9.6

## Summary

All uncommitted changes protection tests PASSED.

## Test Results

### Test 1: Modified File Detection

| Test | Result |
|------|--------|
| Detect modified file with `git status --porcelain` | PASS |
| Status shows ` M filename` prefix | PASS |
| Count returns 1 for single modified file | PASS |

**Output:**
```
 M test-file.txt
```

---

### Test 2: Stash Creation

| Test | Result |
|------|--------|
| Create stash with custom message | PASS |
| Stash appears in `git stash list` | PASS |
| Working directory is clean after stash | PASS |

**Command:**
```bash
git stash push -m "plan/test-uncommitted switch WIP"
```

---

### Test 3: Stash Message Format Verification

| Test | Result |
|------|--------|
| Message format `plan/{name} {operation} WIP` | PASS |
| Retrievable via `git stash list -1 --format="%s"` | PASS |

**Output:**
```
On plan/test-uncommitted: plan/test-uncommitted switch WIP
```

**Note:** Git prepends "On {branch}:" to stash messages. Pattern matching should use contains check, not exact match.

---

### Test 4: Branch Switch While Clean

| Test | Result |
|------|--------|
| Switch to master without issues | PASS |
| `git checkout` works when clean | PASS |

---

### Test 5: Stash Application After Switch

| Test | Result |
|------|--------|
| `git stash pop` restores changes | PASS |
| Modified content restored correctly | PASS |
| Stash removed from list after pop | PASS |

**Output:**
```
Initial content
Modified content
```

---

### Test 6: Stash With Untracked Files

| Test | Result |
|------|--------|
| `-u` flag includes untracked files | PASS |
| Untracked files removed from working directory | PASS |
| Stash contains both tracked and untracked | PASS |

**Command:**
```bash
git stash push -u -m "plan/test-uncommitted WIP with untracked"
```

---

### Test 7: Restore Untracked Files From Stash

| Test | Result |
|------|--------|
| Untracked files restored by `git stash pop` | PASS |
| File contents preserved | PASS |

---

### Test 8: Commit Option Instead of Stash

| Test | Result |
|------|--------|
| Commit changes with WIP message | PASS |
| All files staged with `git add -A` | PASS |
| Commit message includes plan context | PASS |

**Commit message format:**
```
[test-uncommitted] WIP: Save changes before switch
```

---

### Test 9: Stash Verification Function

| Test | Result |
|------|--------|
| Retrieve latest stash message | PASS |
| Contains expected message substring | PASS |

**Verification pattern:**
```bash
LATEST_MSG=$(git stash list -1 --format="%s")
# Check if "$LATEST_MSG" contains expected message
```

---

### Test 10: Clean Working Directory Detection

| Test | Result |
|------|--------|
| `git status --porcelain | wc -l` returns 0 when clean | PASS |
| No false positives for clean state | PASS |

---

### Test 11: Stash Conflict Scenario (Setup)

| Test | Result |
|------|--------|
| Create conflicting changes on different branches | PASS |
| Stash preserves plan branch changes | PASS |

---

### Test 12: Abandon Workflow Stash

| Test | Result |
|------|--------|
| Stash created before switching away | PASS |
| Switch to master succeeds | PASS |
| Stash preserved after switch | PASS |

**Message format:**
```
plan/test-uncommitted abandon WIP
```

---

### Test 13: Stash Persists After Branch Delete

| Test | Result |
|------|--------|
| Delete plan branch | PASS |
| Stash still in list | PASS |
| `git stash show` works | PASS |

**Key Finding:** Stashes are stored globally, not per-branch. Deleting the branch does NOT delete the stash.

---

### Test 14: Stash Conflict Handling

| Test | Result |
|------|--------|
| Stash pop detects conflicts | PASS |
| Conflict markers in file | PASS |
| Stash preserved on conflict | PASS |
| Manual resolution possible | PASS |

**Conflict output:**
```
<<<<<<< Updated upstream
Master conflict content
=======
Modified content
More changes
Plan conflict content
Abandon work
>>>>>>> Stashed changes
```

**Recovery workflow:**
1. Resolve conflicts manually
2. `git add <files>`
3. `git stash drop`

---

### Test 15: Empty Stash List Detection

| Test | Result |
|------|--------|
| Empty stash returns count 0 | PASS |
| Can check before attempting pop | PASS |

---

## Commands Reference

### Detection Commands

| Command | Purpose |
|---------|---------|
| `git status --porcelain` | Machine-readable status (empty = clean) |
| `git status --porcelain \| wc -l` | Count of changed files |
| `git status --short` | Human-readable short status |

### Stash Commands

| Command | Purpose |
|---------|---------|
| `git stash push -m "message"` | Create stash with message |
| `git stash push -u -m "message"` | Include untracked files |
| `git stash list` | List all stashes |
| `git stash list -1 --format="%s"` | Get latest stash message |
| `git stash show` | Show latest stash diff |
| `git stash pop` | Apply and remove latest |
| `git stash drop` | Remove latest stash |

### Stash Message Format

```
plan/{plan-name} {operation} WIP
```

Operations: `switch`, `complete`, `abandon`

---

## Key Findings

1. **Stash message includes branch prefix:** Git prepends "On {branch}:" to stash messages. Use substring matching.

2. **Stashes are global:** Stashes persist even after the originating branch is deleted.

3. **Conflict handling required:** When stash pop conflicts, the stash is preserved. User must resolve and manually drop.

4. **Untracked files need `-u` flag:** Without `-u`, untracked files are left in working directory.

5. **Clean detection is reliable:** `git status --porcelain` returns empty string when truly clean.

6. **Commit alternative works:** For `/plan:complete`, committing is better than stashing since changes should be in the merge.

7. **Autonomous mode safety:** Auto-stash is the safest default because:
   - Commits might fail (hooks, conflicts)
   - Cancel would block automation
   - Stash is always recoverable

---

## Test Environment

- Repository: Temporary test repo at `/tmp/test-uncommitted-changes`
- Branches tested: master, plan/test-uncommitted
- Git version: 2.25.1+
