# Task 3.5: Mapping Conflict Detection to TUI Visualization

## Summary

This analysis maps the file conflict detection data fields to concrete TUI visualization opportunities within the existing Rich-based TUI architecture (`scripts/lib/tui.py`). The current TUI has no conflict visualization; this document proposes additions that integrate with the existing layout structure.

## Current TUI Architecture

### Layout Structure

```
┌─────────────────────────────────────────┐
│ HEADER (5 lines)                         │
│   Plan name, phase, iteration            │
├─────────────────────────────────────────┤
│ PROGRESS (3 lines)                       │
│   Progress bar, percentage, stats        │
├─────────────────────────────────────────┤
│ ACTIVITY (10 lines)                      │
│   Recent tool calls with timestamps      │
├────────────────────┬────────────────────┤
│ IN PROGRESS (8)    │ COMPLETIONS (8)    │
│   Current tasks    │   Recent done      │
├────────────────────┴────────────────────┤
│ FOOTER (2 lines)                         │
│   Status message, tool counts            │
└─────────────────────────────────────────┘
```

### Key Components

| Component | Class | Location | Purpose |
|-----------|-------|----------|---------|
| Activity tracking | `ActivityTracker` | `tui.py:50-164` | Track tool calls |
| TUI management | `RichTUIManager` | `tui.py:170-462` | Layout & rendering |
| Progress display | `_render_progress()` | `tui.py:246-292` | Bar & stats |
| Task display | `_render_tasks_in_progress()` | `tui.py:331-344` | Current tasks |
| Completions | `_render_completions()` | `tui.py:346-359` | Recent done |

## Conflict Data Available

From `status-cli.js next` output (documented in task 3.4):

### Per-Task Fields

| Field | Type | Description |
|-------|------|-------------|
| `fileConflict` | `boolean` | Task has conflicts |
| `conflictsWith` | `string[]` | IDs of conflicting tasks |
| `conflictingFiles` | `string[]` | Files causing conflict |

### Top-Level Fields

| Field | Type | Description |
|-------|------|-------------|
| `fileConflicts` | `array` | `[{ file, taskIds }]` |
| `blockedTaskCount` | `number` | Dependency-blocked count |

## Proposed TUI Enhancements

### Enhancement 1: Conflict Badge on In-Progress Tasks

**Current:**
```python
def _render_tasks_in_progress(self) -> Panel:
    for task in self.tasks_in_progress[:4]:
        task_id = task.get('id', '?')
        desc = task.get('description', '')
        table.add_row(f"{task_id}: {desc}")
```

**Proposed:**
```python
def _render_tasks_in_progress(self) -> Panel:
    for task in self.tasks_in_progress[:4]:
        task_id = task.get('id', '?')
        desc = task.get('description', '')

        # Add conflict badge
        conflict_badge = ""
        if task.get('fileConflict'):
            conflicts = task.get('conflictsWith', [])
            if conflicts:
                conflict_badge = f" ⚠ conflicts: {', '.join(conflicts)}"

        table.add_row(
            Text(f"{task_id}: {desc}{conflict_badge}",
                 style="yellow" if not task.get('fileConflict') else "red")
        )
```

**Visual Result:**
```
┌────────────────────────────────────────┐
│ IN PROGRESS                            │
├────────────────────────────────────────┤
│ 2.1: Update API endpoint ⚠ conflicts: 2.2 │
│ 2.3: Create utility helpers            │
└────────────────────────────────────────┘
```

### Enhancement 2: Conflict Summary in Progress Panel

**Location:** `_render_progress()` (line ~288)

**Proposed Addition:**
```python
def _render_progress(self) -> Panel:
    # ... existing progress bar code ...

    # Add conflict indicator
    if self.conflict_count > 0:
        progress_text.append(
            f"  |  Conflicts: {self.conflict_count}",
            style="red"
        )
```

**Visual Result:**
```
[████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░] 20%  ⠹ Claude working
10/50 tasks  |  Elapsed: 00:05:32  |  Working: 2  |  Pending: 38  |  Conflicts: 1
```

### Enhancement 3: Conflict Detail Panel (New Section)

**Proposed Layout Change:**
```python
def _create_layout(self) -> Layout:
    layout = Layout()
    layout.split(
        Layout(name="header", size=5),
        Layout(name="progress", size=3),
        Layout(name="activity", size=8),      # Reduced from 10
        Layout(name="tasks", size=6),         # Reduced from 8
        Layout(name="conflicts", size=4),     # NEW SECTION
        Layout(name="footer", size=2)
    )
    # ...
```

**New Render Method:**
```python
def _render_conflicts(self) -> Panel:
    """Render the file conflicts panel."""
    if not self.file_conflicts:
        return Panel(
            Text("[dim]No file conflicts[/dim]"),
            title="Conflicts",
            border_style="dim"
        )

    table = Table(show_header=False, box=None, expand=True)
    table.add_column("File", style="white", overflow="ellipsis", no_wrap=True)
    table.add_column("Tasks", style="yellow", no_wrap=True)

    for conflict in self.file_conflicts[:3]:
        file_path = conflict.get('file', 'unknown')
        task_ids = ', '.join(conflict.get('taskIds', []))
        table.add_row(f"⚠ {file_path}", task_ids)

    return Panel(table, title="File Conflicts", border_style="red")
```

**Visual Result:**
```
┌────────────────────────────────────────┐
│ FILE CONFLICTS                          │
├────────────────────────────────────────┤
│ ⚠ src/api.ts                  2.1, 2.2 │
│ ⚠ scripts/status-cli.js   3.1, 3.2, 3.3│
└────────────────────────────────────────┘
```

### Enhancement 4: Conflict Warning in Footer

**Location:** `_render_footer()` (line ~361)

**Proposed Addition:**
```python
def _render_footer(self) -> Panel:
    stats = self.activity_tracker.stats
    footer_text = Text()
    footer_text.append(f"STATUS: ", style="dim")
    footer_text.append(f"{self.status_message}", style="cyan")

    # Add conflict warning if active
    if self.has_active_conflicts:
        footer_text.append(
            f"  ⚠ Sequential execution required",
            style="red"
        )

    # ... existing stats ...
```

**Visual Result:**
```
STATUS: Executing task 2.1...  ⚠ Sequential execution required  |  Tools: 42  |  Agents: 3
```

### Enhancement 5: Conflict Tooltip on Hover (Rich Optional)

If Rich's console supports mouse events in the future:

```python
def _render_task_with_tooltip(self, task: Dict) -> Text:
    text = Text()
    text.append(f"{task['id']}: {task['description']}")

    if task.get('fileConflict'):
        files = task.get('conflictingFiles', [])
        tooltip = f"Conflicting files: {', '.join(files)}"
        text.append(
            " ⓘ",
            style="blue",
            # Future: metadata for tooltip
        )

    return text
```

## Data Flow Integration

### New Class Properties

```python
class RichTUIManager:
    def __init__(self, plan_name: str):
        # ... existing init ...

        # Conflict tracking (NEW)
        self.file_conflicts: List[Dict] = []
        self.conflict_count: int = 0
        self.has_active_conflicts: bool = False
```

### New Update Method

```python
def update_conflicts(self, conflicts: List[Dict]):
    """Update file conflict information from next command output."""
    self.file_conflicts = conflicts
    self.conflict_count = len(conflicts)
    self.has_active_conflicts = self.conflict_count > 0
    self.refresh()
```

### Integration Point in Orchestrator

In `plan_orchestrator.py` after calling `status-cli.js next`:

```python
# Parse next output
next_output = json.loads(result.stdout)

# Extract conflicts for TUI
file_conflicts = next_output.get('fileConflicts', [])
if tui_manager:
    tui_manager.update_conflicts(file_conflicts)

# Update tasks with conflict info
tasks = next_output.get('tasks', [])
tui_manager.update_tasks(
    in_progress=[t for t in tasks if t.get('status') == 'in_progress'],
    completions=[]
)
```

## Visual Design Recommendations

### Color Coding

| Element | Style | Hex |
|---------|-------|-----|
| Conflict badge | `red` | `#FF0000` |
| Conflict file | `white` on `red` | - |
| Warning icon | `yellow` | `#FFFF00` |
| Sequential msg | `red` | `#FF0000` |
| No conflicts | `dim` | `#808080` |

### Icons

| Icon | Unicode | Meaning |
|------|---------|---------|
| ⚠ | U+26A0 | Warning/conflict |
| ⓘ | U+24D8 | Info/tooltip |
| ✗ | U+2717 | Failed/blocked |
| ✓ | U+2713 | Success/resolved |
| → | U+2192 | Sequential arrow |

### Animation Considerations

For live display, conflict panel should:
- Flash briefly when new conflict detected
- Show steady state after acknowledgment
- Dim resolved conflicts (tasks completed)

```python
# Optional: Blink on new conflict
if self.new_conflict_detected:
    style = "bold red" if int(time.time()) % 2 == 0 else "red"
    self.new_conflict_detected = False
```

## Implementation Priority

### Phase 1: Quick Wins (Low Effort)

1. **Conflict badge on tasks** - 15 lines of code change
2. **Conflict count in progress bar** - 5 lines
3. **Footer warning** - 5 lines

### Phase 2: Medium Effort

4. **Conflict detail panel** - New layout section, ~50 lines
5. **Update method in TUI manager** - 10 lines
6. **Integration in orchestrator** - 20 lines

### Phase 3: Nice to Have

7. **Conflict resolution tracking** - Track when conflicts resolve
8. **Conflict history** - Show past conflicts
9. **Conflict graph visualization** - Rich grid/table

## Example Complete Display

```
┌───────────────────────────────────────────────────────────────┐
│ PLAN ORCHESTRATOR                                              │
│ Plan: implement-authentication                                 │
│ Phase: Phase 2: API Layer  |  Iteration: 5/50                 │
├───────────────────────────────────────────────────────────────┤
│ [████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░] 28%  ⠹ Claude   │
│ 14/50 tasks  |  Elapsed: 00:12:45  |  Working: 2  |  ⚠ 1      │
├───────────────────────────────────────────────────────────────┤
│ CURRENT ACTIVITY                                               │
│ [10:15:32] [OK] Read: scripts/lib/plan-status.js        1.2s  │
│ [10:15:34] ... Edit: scripts/status-cli.js              ...   │
│ [10:15:35] ... Grep: fileConflict                       ...   │
├──────────────────────────────┬────────────────────────────────┤
│ IN PROGRESS                  │ RECENT COMPLETIONS             │
│ 2.1: Update API ⚠ 2.2       │ [OK] 1.4: Create types         │
│ 2.3: Add middleware          │ [OK] 1.3: Add schemas          │
├──────────────────────────────┴────────────────────────────────┤
│ FILE CONFLICTS                                                 │
│ ⚠ src/api.ts                                        2.1, 2.2  │
│ Recommendation: Run 2.1 → 2.2 sequentially                    │
├───────────────────────────────────────────────────────────────┤
│ STATUS: Executing 2.1...  ⚠ Sequential  |  Tools: 156  |  A:8 │
└───────────────────────────────────────────────────────────────┘
```

## Summary: Data-to-Display Mapping

| Data Field | TUI Location | Visual Element |
|------------|--------------|----------------|
| `task.fileConflict` | In Progress panel | Red text style + badge |
| `task.conflictsWith` | In Progress panel | Comma-separated IDs |
| `task.conflictingFiles` | Conflict panel | File paths |
| `output.fileConflicts` | Conflict panel | Table rows |
| `len(fileConflicts)` | Progress bar | Count badge |
| Any conflicts | Footer | Warning message |
| Sequential required | Footer | Execution note |
