# Task 6.4: Multi-Session Orchestration Analysis

## Summary

This analysis documents how multiple orchestrator instances coordinate and the current capabilities/limitations for running multiple plans simultaneously.

## Orchestrator Registry System

### Registry Location
**File:** `.claude/orchestrator-registry.json`

### Instance Data Structure
From `orchestrator_registry.py:48-61`:
```python
@dataclass
class OrchestratorInstance:
    id: str                         # Unique ID: orch-{timestamp}
    pid: int                        # Process ID
    plan_path: str                  # Path to plan file
    worktree_path: Optional[str]    # Worktree directory (None if main repo)
    started_at: str                 # ISO timestamp
    last_heartbeat: str             # ISO timestamp of last heartbeat
    status: str                     # running | stopping | stopped | crashed
    socket_path: Optional[str]      # Unix socket for IPC
    port: Optional[int]             # TCP port for IPC (Windows fallback)
```

### Registry Configuration
```python
REGISTRY_FILE = ".claude/orchestrator-registry.json"
LOCK_TIMEOUT = 5         # seconds
STALE_THRESHOLD = 60     # seconds - instances without heartbeat are stale
HEARTBEAT_INTERVAL = 10  # seconds between heartbeats
```

## Multi-Orchestrator Coordination

### Duplicate Plan Prevention
From `orchestrator_registry.py:209-229`:
```python
def register(self, instance: OrchestratorInstance):
    # Check for duplicate plan
    for existing in data["instances"]:
        inst = OrchestratorInstance.from_dict(existing)
        if inst.plan_path == instance.plan_path and inst.status == "running":
            if inst.is_alive() and not inst.is_stale():
                raise DuplicatePlanError(
                    f"Plan '{instance.plan_path}' is already running "
                    f"(instance: {inst.id}, PID: {inst.pid})"
                )
```

**Key behavior:**
- Same plan cannot have multiple orchestrators
- Different plans can run simultaneously (with worktrees)
- Stale instances are cleaned up and allow re-registration

### Heartbeat System
From `orchestrator_registry.py:454-495`:
```python
class HeartbeatThread:
    """Background thread that updates heartbeat periodically."""

    def __init__(self, registry, instance_id, interval=HEARTBEAT_INTERVAL):
        self.interval = interval  # Default: 10 seconds

    def _run(self):
        while not self._stop:
            try:
                self.registry.update_heartbeat(self.instance_id)
            except Exception:
                pass  # Silently handle errors
            time.sleep(0.1)  # Sleep in small increments
```

### IPC (Inter-Process Communication)
From `plan_orchestrator.py:640-694`:

**Commands supported:**
- `status` - Get instance status, progress, iteration count
- `shutdown` - Request graceful shutdown
- `pause` - Pause execution
- `resume` - Resume execution

**IPC Handler:**
```python
def _handle_ipc_command(self, command: str, payload: Dict) -> Dict:
    if command == "status":
        return {
            "instance_id": self.instance.id,
            "progress": status.percentage,
            "iteration": self.iteration,
            "paused": self._paused,
        }
    elif command == "shutdown":
        self._shutdown_requested = True
        return {"ack": True, "message": "Shutdown initiated"}
    elif command == "pause":
        self._paused = True
        return {"ack": True}
    elif command == "resume":
        self._paused = False
        return {"ack": True}
```

## Cross-Plan Coordination

### Current Limitations

| Aspect | Behavior |
|--------|----------|
| Same plan | Only one orchestrator allowed |
| Different plans | Can run concurrently (with worktrees) |
| Git operations | Must serialize (git-queue) |
| File modifications | Potential conflicts if no worktrees |
| Resource limits | Not enforced (planned in Phase 9) |

### Resource Contention Risks

1. **Git Index Lock**
   - Multiple plans may compete for `.git/index.lock`
   - Mitigated by git-queue serialization

2. **File System**
   - Without worktrees, plans share working directory
   - Conflicting file modifications possible

3. **Claude API Limits**
   - No coordination for API rate limits
   - Each orchestrator operates independently

4. **Memory/CPU**
   - No resource allocation between orchestrators
   - Each spawns its own Claude sessions

## Management Commands

From `plan_orchestrator.py:1085-1225`:

### List Instances
```bash
python scripts/plan_orchestrator.py --list
```
Output:
```
Registered Orchestrators
════════════════════════════════════════════════════════════════════
  ● orch-1703649123456
      Plan: feature-auth
      PID: 12345 (alive), heartbeat: fresh

  ○ orch-1703649200000
      Plan: api-refactor [worktrees/plan-api-refactor]
      PID: 12346 (alive), heartbeat: fresh
```

### Stop Instance
```bash
python scripts/plan_orchestrator.py --stop orch-1703649123456 [--force]
```

### Shutdown All
```bash
python scripts/plan_orchestrator.py --shutdown-all [--force]
```

### Get Instance Status
```bash
python scripts/plan_orchestrator.py --status orch-1703649123456
```

## Daemon Mode

From `plan_orchestrator.py:1046-1083`:

```bash
python scripts/plan_orchestrator.py --daemon
```

**Behavior:**
- Double-fork to detach from terminal
- Redirects stdout/stderr to log file
- Background process continues execution
- Register with orchestrator registry

## TUI Visualization Opportunities

### 1. Multi-Orchestrator Status Panel
```
┌─ Running Orchestrators ─────────────────────────────────┐
│ ID                    Plan              Status    Iter  │
│ ───────────────────────────────────────────────────────│
│ ● orch-1703649123456  feature-auth      running   12/50 │
│ ● orch-1703649200000  api-refactor      running   5/50  │
│ ○ orch-1703649300000  perf-opt          paused    3/50  │
└─────────────────────────────────────────────────────────┘
```

### 2. Orchestrator Control Panel
```
┌─ Orchestrator Controls ─────────────────────────────────┐
│ Selected: orch-1703649123456 (feature-auth)            │
│                                                         │
│ [⏸ Pause]  [▶ Resume]  [⏹ Stop]  [⏹ Force Stop]       │
│                                                         │
│ Session timeout: 600s                                  │
│ Batch size: 5 tasks                                    │
│ Max iterations: 50                                     │
└─────────────────────────────────────────────────────────┘
```

### 3. Cross-Plan Event Stream
```
┌─ Event Stream ──────────────────────────────────────────┐
│ 10:32:15 [feature-auth] ✓ Task 1.5 completed           │
│ 10:32:10 [api-refactor] ⏳ Task 2.1 started            │
│ 10:31:55 [feature-auth] ⏳ Task 1.5 started            │
│ 10:31:45 [api-refactor] ✓ Task 2.0 completed           │
│ 10:31:30 [perf-opt]     ⏸ Paused by user               │
└─────────────────────────────────────────────────────────┘
```

### 4. Resource Coordination Warning
```
┌─ Resource Warning ──────────────────────────────────────┐
│ ⚠ 3 orchestrators running (max: 3)                     │
│                                                         │
│ Waiting for slot:                                      │
│   - docs/plans/new-feature.md                          │
│                                                         │
│ [Launch anyway] [Queue for later]                      │
└─────────────────────────────────────────────────────────┘
```

## Integration Data Sources

For TUI to monitor multi-session orchestration:

| Source | Data | Update Frequency |
|--------|------|-----------------|
| `.claude/orchestrator-registry.json` | Instance list, status | On change + heartbeat |
| `docs/plan-outputs/*/status.json` | Task progress | Per task completion |
| IPC socket | Real-time commands | On demand |
| Log files | Execution details | Continuous |

## Key Implementation References

| File | Location | Purpose |
|------|----------|---------|
| `orchestrator_registry.py:36-60` | `OrchestratorInstance` | Instance data structure |
| `orchestrator_registry.py:111-416` | `OrchestratorRegistry` | Registry operations |
| `orchestrator_registry.py:454-495` | `HeartbeatThread` | Liveness tracking |
| `plan_orchestrator.py:586-708` | IPC commands | Remote control |
| `plan_orchestrator.py:1085-1225` | Management commands | CLI interface |
