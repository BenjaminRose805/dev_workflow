# Task 1.2: Git Workflow Phase 2 Findings Review - Completion Workflow

## Summary

Review of `docs/plan-outputs/git-workflow-phase2-completion/findings/` and `/plan:complete` command for completion workflow features applicable to TUI expansion.

## Completion Workflow Operations

### 1. Complete Workflow Steps (7.1)

| Step | Operation | TUI Opportunity |
|------|-----------|-----------------|
| Verify tasks completed | Check `summary.pending === 0` | Completion eligibility badge |
| Verify on plan branch | Compare current vs expected | Branch indicator with ✓/✗ |
| Check merge conflicts | Dry-run merge test | Conflict warning panel |
| Commit uncommitted changes | Auto-commit before archive | Pending changes alert |
| Create archive tag | `archive/plan-{name}` | Archive history panel |
| Switch to main | `git checkout main` | Current context indicator |
| Perform merge | squash/commit/ff | Merge strategy selector |
| Delete plan branch | `git branch -D` | Branch cleanup confirmation |
| Update status.json | Add `completedAt`, `mergedAt`, etc. | Completion metadata display |

### 2. Uncommitted Changes Handling (7.2)

| Feature | Behavior | TUI Opportunity |
|---------|----------|-----------------|
| Detection | `git status --porcelain` | File status tree view |
| Auto-commit message | `[plan-name] Final changes before completion` | Message preview |
| File count | Shows N files in commit | Badge with count |
| Attribution | Includes Claude Code footer | View commit details |

**TUI Panel: Pre-Completion Status**
```
┌─ Pre-Completion Check ─────────────────────────┐
│ Tasks: 15/15 ✓                                  │
│ Branch: plan/my-feature ✓                       │
│ Uncommitted: 2 files                            │
│   • src/utils.ts (modified)                     │
│   • test.ts (untracked)                         │
│ Conflicts: None ✓                               │
│                                                 │
│ [View Changes] [Complete Plan]                  │
└─────────────────────────────────────────────────┘
```

### 3. Archive Tag Access (7.3)

| Capability | Command | TUI Opportunity |
|------------|---------|-----------------|
| View tag details | `git show archive/plan-{name}` | Archive metadata panel |
| List individual commits | `git log archive/plan-{name}` | Commit history list |
| Compare with main | `git log main..archive/plan-{name}` | Diff view |
| Restore branch | `git checkout -b restored-X archive/plan-X` | Restore button |
| Cherry-pick | `git cherry-pick archive/...` | Task-level actions |

**TUI Panel: Archive Browser**
```
┌─ Archive: plan-my-feature ──────────────────────┐
│ Created: Dec 25, 2025 4:30 PM                   │
│ Commits: 12 individual task commits             │
│ Compare: git log main..archive/plan-my-feature  │
│                                                 │
│ Task Commits:                                   │
│ ├─ abc1234 [plan] task 1.1: Setup auth          │
│ ├─ def5678 [plan] task 1.2: Add middleware      │
│ ├─ ...                                          │
│ └─ xyz9999 [plan] task 3.5: Final tests         │
│                                                 │
│ [Restore Branch] [View Commit] [Cherry-Pick]    │
└─────────────────────────────────────────────────┘
```

### 4. Merge Strategy Options (7.4)

| Strategy | Behavior | Use Case | TUI Display |
|----------|----------|----------|-------------|
| `squash` (default) | Single commit | Clean history | "Squash merge (default)" |
| `commit` | Merge commit + individual | Preserve merge point | "Merge commit" |
| `ff` | Fast-forward | Linear history | "Fast-forward" |

**TUI Selector: Merge Strategy**
```
┌─ Merge Strategy ────────────────────────────────┐
│ ○ Squash merge (Recommended)                    │
│   Creates single commit with all changes        │
│   Archive tag preserves individual commits      │
│                                                 │
│ ○ Merge commit                                  │
│   Preserves full branch history in main         │
│   Individual commits visible in history         │
│                                                 │
│ ○ Fast-forward                                  │
│   Linear history if no divergence               │
│   ⚠ Fails if main has diverged                 │
└─────────────────────────────────────────────────┘
```

### 5. Merge Commit Message Format (7.5)

**Metadata in squash commit:**
- Header: `Complete: {plan-name}`
- Plan title, task count, phase count
- Duration (calculated from timestamps)
- Phase summary with task counts
- Archive tag reference with usage instructions
- Outputs directory link
- Claude Code attribution

**TUI Panel: Commit Preview**
```
┌─ Merge Commit Preview ──────────────────────────┐
│ Complete: my-feature-plan                       │
│                                                 │
│ Plan: Implementation Plan: My Feature           │
│ Tasks: 15/15 | Phases: 4                        │
│ Duration: 2 days                                │
│                                                 │
│ Phases:                                         │
│   - Phase 0: Preparation (2 tasks)              │
│   - Phase 1: Core Implementation (8 tasks)      │
│   - Phase 2: Testing (3 tasks)                  │
│   - Phase 3: Documentation (2 tasks)            │
│                                                 │
│ Archive: archive/plan-my-feature-plan           │
│ Outputs: docs/plan-outputs/my-feature-plan/     │
└─────────────────────────────────────────────────┘
```

### 6. PR Workflow (--pr flag)

| Step | Operation | TUI Opportunity |
|------|-----------|-----------------|
| Check gh CLI | `gh auth status` | GitHub auth indicator |
| Push to remote | `git push -u origin plan/...` | Push progress indicator |
| Generate PR body | Task checklist, phase summary | PR preview panel |
| Create PR | `gh pr create` | PR link display |
| Draft option | `--draft` | Draft toggle |

**TUI Panel: PR Creation**
```
┌─ Create Pull Request ───────────────────────────┐
│ Title: Complete: my-feature-plan                │
│ Base: main  ←  Head: plan/my-feature-plan       │
│                                                 │
│ ☐ Create as draft                               │
│                                                 │
│ [Preview PR Body] [Create PR] [Cancel]          │
└─────────────────────────────────────────────────┘
```

### 7. Conflict Resolution Options

| Option | Behavior | TUI Action |
|--------|----------|------------|
| Rebase onto main | Replay commits | Rebase button + progress |
| Manual resolve | Stop and guide user | Conflict editor link |
| Abort completion | Cancel plan completion | Return to plan view |

**TUI Panel: Conflict Resolution**
```
┌─ Merge Conflicts Detected ──────────────────────┐
│ ⚠ 3 files have conflicts with main              │
│                                                 │
│ Conflicting files:                              │
│   • src/lib/auth.ts                             │
│   • src/routes/api.ts                           │
│   • tests/auth.test.ts                          │
│                                                 │
│ ○ Rebase onto main (Recommended)                │
│ ○ Manual resolve                                │
│ ○ Abort completion                              │
│                                                 │
│ [Proceed]                                       │
└─────────────────────────────────────────────────┘
```

### 8. Worktree Context Handling

| Feature | Behavior | TUI Opportunity |
|---------|----------|-----------------|
| Detect worktree | `detectWorktreeContext()` | Worktree badge |
| Merge from main repo | Change to `$REPO_ROOT` | Context indicator |
| Remove worktree | `git worktree remove` | Cleanup status |
| Update aggregate status | `status-cli.js all-plans` | Dashboard refresh |
| Dependent worktrees | Detect need for rebase | Rebase recommendations |

### 9. Status.json Completion Fields

```json
{
  "completedAt": "2024-12-25T16:00:00Z",
  "mergedAt": "2024-12-25T16:00:00Z",
  "mergeCommit": "abc123def456...",
  "archiveTag": "archive/plan-my-plan",
  "prCreated": true,  // if --pr was used
  "prUrl": "https://github.com/..."
}
```

## TUI Feature Mapping Summary

| Completion Feature | TUI Component Type | Priority |
|-------------------|-------------------|----------|
| Pre-completion checklist | Status panel | HIGH |
| Uncommitted changes alert | Warning banner | HIGH |
| Merge strategy selector | Radio group | MEDIUM |
| Conflict resolution dialog | Modal with options | HIGH |
| Archive browser | History panel | MEDIUM |
| PR creation flow | Modal with preview | MEDIUM |
| Worktree context indicator | Badge/icon | LOW |
| Dependent worktrees list | Table view | LOW |

## Recommended TUI Panel: Completion Dashboard

```
┌─ Complete Plan: my-feature-plan ────────────────┐
│                                                 │
│ ┌─ Pre-Check ────────────────────────────────┐  │
│ │ ✓ All tasks completed (15/15)              │  │
│ │ ✓ On plan branch                           │  │
│ │ ✓ No conflicts with main                   │  │
│ │ ⚠ 2 uncommitted files                      │  │
│ └────────────────────────────────────────────┘  │
│                                                 │
│ ┌─ Options ──────────────────────────────────┐  │
│ │ Strategy: [Squash ▼]                       │  │
│ │ ☐ Create archive tag                       │  │
│ │ ☐ Create PR instead of local merge         │  │
│ └────────────────────────────────────────────┘  │
│                                                 │
│ ┌─ Commit Preview ───────────────────────────┐  │
│ │ Complete: my-feature-plan                  │  │
│ │ Tasks: 15/15 | Phases: 4 | Duration: 2d    │  │
│ └────────────────────────────────────────────┘  │
│                                                 │
│             [Complete Plan] [Cancel]            │
└─────────────────────────────────────────────────┘
```
