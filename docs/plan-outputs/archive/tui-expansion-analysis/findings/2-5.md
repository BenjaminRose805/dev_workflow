# Task 2.5: Annotation System to TUI Display Mapping

## Summary

This document maps each annotation type from the execution constraint system to specific TUI display opportunities. It identifies where constraint data is already available, what visual elements would be most effective, and proposes concrete integration points with the existing TUI architecture.

## Current TUI Architecture

**Location:** `scripts/lib/tui.py`

**Current Layout Structure:**
```
┌─────────────────────────────────────────────────┐
│ Header (5 rows)                                 │ ← Plan name, Phase, Iteration
├─────────────────────────────────────────────────┤
│ Progress (3 rows)                               │ ← Progress bar, task counts
├─────────────────────────────────────────────────┤
│ Activity (10 rows)                              │ ← Tool calls, timestamps
├────────────────────────┬────────────────────────┤
│ In Progress (4 rows)   │ Recent Completions     │ ← Task lists
├────────────────────────┴────────────────────────┤
│ Footer (2 rows)                                 │ ← Status, stats
└─────────────────────────────────────────────────┘
```

**Key Components:**
- `RichTUIManager` - Main TUI controller
- `ActivityTracker` - Tracks tool calls
- Uses Rich library: `Panel`, `Table`, `Text`, `Layout`

## Annotation-to-TUI Mapping

### 1. `[SEQUENTIAL]` Task Constraints

**Data Available:**
- `task.sequential: boolean`
- `task.sequentialGroup: string` (e.g., "3.1-3.4")
- `task.sequentialReason: string`

**TUI Display Opportunities:**

| Location | Display Element | Implementation |
|----------|----------------|----------------|
| In Progress Panel | Chain icon `⛓` before task ID | `Text("⛓ 3.1:", style="yellow")` |
| In Progress Panel | Group indicator `[3.1-3.4]` | Suffix after description |
| Header/Phase | Constraint count badge | "2 sequential groups" |
| Task Selection | Dimmed held-back tasks | `style="dim strikethrough"` |
| Tooltip/Detail | Reason text | On hover or key press |

**Proposed Implementation:**

```python
def _render_task_with_constraints(self, task: Dict) -> Text:
    text = Text()

    # Add sequential indicator
    if task.get('sequential'):
        text.append("⛓ ", style="cyan")

    text.append(f"{task.get('id')}: ", style="yellow")
    text.append(task.get('description', ''), style="white")

    # Add group badge
    if task.get('sequentialGroup'):
        text.append(f" [{task.get('sequentialGroup')}]", style="dim cyan")

    return text
```

**Integration Point:**
- `RichTUIManager._render_tasks_in_progress()` at line 331
- Add constraint rendering before adding row to table

### 2. `[PARALLEL]` Phase Constraints

**Data Available:**
- `next` command output: `parallelPhases: [{phases: [1,2,3], reason}]`
- `task.parallelPhase: boolean`
- `crossPhaseExecution: boolean`

**TUI Display Opportunities:**

| Location | Display Element | Implementation |
|----------|----------------|----------------|
| Header | Parallel mode indicator | "⟷ Parallel Phases: 1-3" |
| Phase Progress | Swimlane layout | Side-by-side phase bars |
| Task List | Phase badge | `[P2]` prefix for phase 2 |
| Progress Bar | Multi-bar mode | One bar per parallel phase |
| Footer | Parallelism stats | "3 phases executing in parallel" |

**Proposed Implementation:**

```python
def _render_parallel_phases_header(self) -> Text:
    if not self.parallel_phases:
        return Text()

    text = Text()
    text.append("⟷ ", style="bold cyan")
    text.append("Parallel Phases: ", style="dim")

    for group in self.parallel_phases:
        phases_str = ", ".join(str(p) for p in group.get('phases', []))
        text.append(f"[{phases_str}] ", style="cyan")

    return text
```

**New Layout Option - Swimlane View:**
```
┌────────────────────────────────────────────────┐
│ Parallel Execution: Phases 1-3                 │
├──────────────┬──────────────┬──────────────────┤
│ Phase 1      │ Phase 2      │ Phase 3          │
│ ████████░░   │ ██████░░░░   │ ████░░░░░░       │
│ 1.1 [DONE]   │ 2.1 [RUN]    │ 3.1 [WAIT]       │
│ 1.2 [RUN]    │ 2.2 [WAIT]   │ 3.2 [WAIT]       │
└──────────────┴──────────────┴──────────────────┘
```

**Integration Point:**
- Add `set_parallel_phases(groups)` method to `RichTUIManager`
- Modify `_render_header()` to include parallel indicator

### 3. `(non-blocking)` VERIFY Annotations

**Data Available:**
- Parsed from plan via `parseExecutionNotes().nonBlockingVerify`
- Phase numbers where VERIFY is non-blocking

**TUI Display Opportunities:**

| Location | Display Element | Implementation |
|----------|----------------|----------------|
| Phase Progress | Dotted border for VERIFY bar | `border_style="dim"` |
| VERIFY Task | Non-blocking badge | `(optional)` suffix |
| Task List | Lighter styling | Dimmed compared to required tasks |

**Proposed Implementation:**

```python
def _render_phase_bar(self, phase: Dict) -> Panel:
    # Normal phase
    border_style = "green" if phase.get('completed') else "yellow"

    # Non-blocking VERIFY phase
    if phase.get('nonBlocking'):
        border_style = "dim blue"
        # Add indicator
        title = f"VERIFY {phase['number']} (optional)"
    else:
        title = f"Phase {phase['number']}"

    return Panel(progress_bar, title=title, border_style=border_style)
```

### 4. `pipeline-start` Triggers

**Data Available:**
- Parsed from plan via `parseExecutionNotes().pipelineStart`
- `{phase: N, triggerTaskId: "X.Y"}`
- `task.pipelineTriggered: boolean`

**TUI Display Opportunities:**

| Location | Display Element | Implementation |
|----------|----------------|----------------|
| Phase Header | Trigger indicator | "Phase 2 (starts when 1.3 ✓)" |
| Task List | Trigger arrow | "1.3 →→ [P2 start]" |
| Dependency View | Cross-phase connector | Line from 1.3 to Phase 2 |

**Proposed Implementation:**

```python
def _render_pipeline_trigger(self, trigger: Dict) -> Text:
    text = Text()
    text.append(f"Task {trigger['triggerTaskId']}", style="yellow")
    text.append(" →→ ", style="cyan bold")
    text.append(f"Phase {trigger['phase']}", style="green")
    return text
```

### 5. File Conflicts (Implicit Constraints)

**Data Available:**
- `task.hasFileConflicts: boolean`
- `task.conflictsWith: string[]`
- `fileConflicts: [{file, taskIds}]` in next output

**TUI Display Opportunities:**

| Location | Display Element | Implementation |
|----------|----------------|----------------|
| Task List | Warning icon | `⚠` before conflicting tasks |
| Detail Panel | Conflict list | "Conflicts with: 3.2, 3.3" |
| File View | Shared file indicator | Files touched by multiple tasks |

**Proposed Implementation:**

```python
def _render_conflict_indicator(self, task: Dict) -> Text:
    if not task.get('hasFileConflicts'):
        return Text()

    conflicts = task.get('conflictsWith', [])
    text = Text()
    text.append("⚠ ", style="bold red")
    if conflicts:
        text.append(f"[conflicts: {', '.join(conflicts)}]", style="dim red")
    return text
```

## New Panel Proposals

### 1. Constraint Summary Panel

**Purpose:** Show all active execution constraints at a glance

**Data Sources:**
- `parseExecutionNotes()` for annotations
- `detectFileConflicts()` for implicit constraints
- `getReadyTasks()` for blocked/ready status

**Layout:**
```
┌──────────────────────────────────────────┐
│ EXECUTION CONSTRAINTS                     │
├──────────────────────────────────────────┤
│ Sequential Groups:                        │
│   ⛓ 3.1-3.4: all modify same file        │
│   ⛓ 5.2-5.4: database migration          │
├──────────────────────────────────────────┤
│ Parallel Phases:                          │
│   ⟷ 1-3: independent modules             │
├──────────────────────────────────────────┤
│ File Conflicts:                           │
│   ⚠ src/api.ts: 3.1, 3.2 (sequential)    │
│   ⚠ config.json: 2.1, 4.1 (different ph) │
└──────────────────────────────────────────┘
```

### 2. Why Waiting Panel

**Purpose:** Explain why ready tasks can't start yet

**Data Sources:**
- `getBlockedTasks()` for blocked tasks
- Orchestrator `_filter_sequential_tasks()` for held-back tasks
- `task.blockedBy` for dependency info

**Layout:**
```
┌──────────────────────────────────────────┐
│ WHY WAITING                               │
├──────────────────────────────────────────┤
│ 3.2 - Held back (sequential with 3.1)    │
│       ⛓ 3.1 must complete first          │
│       Group: 3.1-3.4                      │
│                                           │
│ 4.1 - Blocked by dependencies             │
│       ○ 2.1 (in_progress)                │
│       ○ 2.2 (pending)                    │
└──────────────────────────────────────────┘
```

### 3. Execution Preview Panel

**Purpose:** Show planned execution order before starting

**Data Sources:**
- Orchestrator `_build_prompt()` execution groups
- Task selection with constraint filtering

**Layout:**
```
┌──────────────────────────────────────────┐
│ EXECUTION PREVIEW                         │
├──────────────────────────────────────────┤
│ Batch 1 (Parallel):                       │
│   ├── 1.1 Create types                    │
│   ├── 1.2 Create schema                   │
│   └── 1.3 Create utils                    │
│                                           │
│ Batch 2 (Sequential 3.1-3.4):             │
│   └── 3.1 Merge ORCHESTRATOR.md           │
│   └── 3.2 Merge ARCHITECTURE.md           │
│   └── 3.3 Create redirect                 │
│   └── 3.4 Remove duplicate                │
└──────────────────────────────────────────┘
```

## Data Integration Requirements

### New Data Fields for TUI

| Field | Source | Description |
|-------|--------|-------------|
| `parallelPhases` | `next` command | Current parallel phase groups |
| `sequentialGroups` | status.json | Active sequential constraints |
| `heldBackTasks` | Orchestrator | Tasks filtered by sequential |
| `pipelineTriggers` | Plan parsing | Active pipeline-start triggers |
| `fileConflicts` | `next` command | Detected file conflicts |

### New Methods for RichTUIManager

```python
def set_constraints(self, constraints: Dict):
    """Update active constraint display."""
    self.sequential_groups = constraints.get('sequentialGroups', [])
    self.parallel_phases = constraints.get('parallelPhases', [])
    self.file_conflicts = constraints.get('fileConflicts', [])
    self.refresh()

def set_blocked_tasks(self, blocked: List[Dict]):
    """Update blocked task display."""
    self.blocked_tasks = blocked
    self.refresh()

def set_execution_preview(self, preview: List[Dict]):
    """Update execution preview display."""
    self.execution_preview = preview
    self.refresh()
```

## Integration with Existing TUI Plan

The `tui-integration-implementation.md` plan already includes:
- **Gap B1 (Inline Blockers Display):** Task 2.4 - adds `[Blocked by: X.Y]` indicator
- **Phase Progress Bars:** Task 2.1 - could include constraint badges

**Recommended Additions to Existing Plan:**

| Existing Task | Constraint Integration |
|---------------|----------------------|
| 2.1 Phase Progress | Add parallel phase indicator |
| 2.4 Blockers Display | Extend for sequential constraints |
| 3.3 Status Dashboard | Add constraint summary section |
| 4.5 Activity Log | Log constraint decisions |

**New Tasks to Add:**

1. **Constraint Summary Panel** (new task ~2.7)
2. **Why Waiting Panel** (new task ~2.8)
3. **Execution Preview Panel** (new task ~3.5)
4. **Constraint Editing Controls** (new task ~4.7)

## Priority Matrix

| Feature | Value | Effort | Priority |
|---------|-------|--------|----------|
| Sequential icon on tasks | HIGH | LOW | P0 |
| Parallel phase indicator in header | HIGH | LOW | P0 |
| File conflict warning | HIGH | MEDIUM | P1 |
| Constraint Summary Panel | MEDIUM | MEDIUM | P1 |
| Why Waiting Panel | HIGH | MEDIUM | P1 |
| Swimlane layout for parallel | MEDIUM | HIGH | P2 |
| Execution Preview Panel | MEDIUM | MEDIUM | P2 |
| Pipeline-start visualization | LOW | MEDIUM | P3 |
| Constraint editor | LOW | HIGH | P3 |

## Implementation Recommendations

### Quick Wins (Can implement immediately):
1. Add `⛓` icon to sequential tasks in existing panel
2. Add `[PARALLEL]` badge to header when active
3. Add `⚠` for file conflicts in task list

### Medium Effort:
1. Create Constraint Summary Panel
2. Extend blockers display for sequential groups
3. Add held-back task explanation

### Architectural Changes:
1. Swimlane layout for parallel phases
2. Real-time constraint editing
3. Cross-phase dependency graph
