# Task 5.1: Git Commit Queue Implementation Analysis

**Analysis Plan:** TUI Expansion Analysis
**Task Number:** 5.1
**Date:** 2025-12-26
**Scope:** Analyze git commit queue for TUI integration opportunities

---

## Executive Summary

The git commit queue is a critical infrastructure component that serializes git commit operations during parallel task execution. It prevents merge conflicts when multiple tasks complete simultaneously.

**Key Statistics:**
- Lock timeout: 60 seconds
- Processing delay: 100ms between commits
- Status file: `docs/plan-outputs/.git-queue-status.json`
- Atomic writes: Yes (temp + rename pattern)

---

## 1. Queue Architecture

### Component Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Git Commit Queue System                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚        In-Memory Queue State (commitQueue[])         â”‚   â”‚
â”‚  â”‚  â€¢ Holds pending commit items with promises          â”‚   â”‚
â”‚  â”‚  â€¢ Fast access for ready-to-process items            â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      Processing Lock (isProcessing, lockAcquiredAt)  â”‚   â”‚
â”‚  â”‚  â€¢ Single-threaded mutex for commit operations       â”‚   â”‚
â”‚  â”‚  â€¢ 60-second timeout for stale lock recovery         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â†“                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚      Persistent Status File (.git-queue-status.json) â”‚   â”‚
â”‚  â”‚  â€¢ Survives process crashes                          â”‚   â”‚
â”‚  â”‚  â€¢ Monitored by external tools (TUI, orchestrator)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Queue Item Structure

```javascript
{
  id: "commit-1703628328120-a1b2c3d",
  message: "feat: implement new feature",
  files: ["src/feature.js"],
  queuedAt: "2025-12-26T14:25:28.120Z",
  options: { noQueue: false },
  resolve: Promise.resolve,
  reject: Promise.reject
}
```

---

## 2. Queue Processing Algorithm (FIFO)

### Processing Flow

```
commitWithQueue(message, files, options)
        â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   options.noQueue === true?   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â†™                   â†˜
  YES (Direct)         NO (Queued)
      â†“                      â†“
createCommit()         queueCommit()
  directly            Add to queue[]
                           â†“
               processQueue() called
                           â†“
               Stage files â†’ Commit â†’ Update status
                           â†“
               100ms delay â†’ Next item
```

### Processing Characteristics

| Aspect | Value |
|--------|-------|
| Queue Type | FIFO (first-queued processed first) |
| Parallelism | Single-threaded |
| Inter-commit Delay | 100ms |
| Lock Timeout | 60 seconds |

---

## 3. Lock Mechanism

### Lock Behavior

```javascript
// Acquire lock
isProcessing = true;
lockAcquiredAt = new Date().toISOString();

// Check for stale lock
const lockAge = Date.now() - new Date(lockAcquiredAt).getTime();
if (lockAge > 60000) {  // 60 seconds
  console.warn('Git queue lock timed out, releasing...');
  isProcessing = false;
  lockAcquiredAt = null;
}

// Release lock
isProcessing = false;
lockAcquiredAt = null;
```

### Timeout Recovery

- Detects orphaned locks (>60s old)
- Automatically clears stale locks
- Does NOT auto-retry failed commit

---

## 4. Status File Persistence

### File Location

`docs/plan-outputs/.git-queue-status.json`

### Status Format

```json
{
  "pending": [
    {
      "id": "commit-1703628328120-a1b2c3d",
      "message": "feat: implement new feature",
      "files": ["src/feature.js"],
      "queuedAt": "2025-12-26T14:25:28.120Z",
      "position": 0
    }
  ],
  "lastCommitAt": "2025-12-26T14:25:25.000Z",
  "lastCommitHash": "abc123def456",
  "totalCommits": 42,
  "failedCommits": 2,
  "isProcessing": false,
  "lockAcquiredAt": null,
  "pendingCount": 2,
  "lastError": null
}
```

### Atomic Write Pattern

```javascript
// Write to temp, then rename (atomic on POSIX)
const tempPath = statusPath + '.tmp.' + process.pid;
fs.writeFileSync(tempPath, JSON.stringify(status, null, 2));
fs.renameSync(tempPath, statusPath);
```

---

## 5. Crash Recovery

### Recovery Strategy

```javascript
function recoverFromCrash() {
  const status = readQueueStatus();

  // Check 1: Orphaned pending commits
  if (status.pending.length > 0 && commitQueue.length === 0) {
    // Clear pending (commits were never made)
    status.pending = [];
    status.isProcessing = false;
    writeQueueStatus(status);
  }

  // Check 2: Stale lock (>60s old)
  if (status.isProcessing && lockAge > 60000) {
    status.isProcessing = false;
    status.lockAcquiredAt = null;
    writeQueueStatus(status);
  }
}
```

### Recovery Scenarios

| Scenario | Detection | Recovery |
|----------|-----------|----------|
| Crash with pending items | `pending.length > 0 && memory empty` | Clear pending |
| Crash while processing | `isProcessing && lockAge > 60s` | Clear lock |
| Stale lock | `lockAcquiredAt > 60s old` | Auto-clear |

---

## 6. API Reference for TUI Integration

### Main Functions

| Function | Purpose | Returns |
|----------|---------|---------|
| `commitWithQueue(msg, files, opts)` | Queue a commit | Promise<{success, hash, error, queued}> |
| `commitDirect(msg, files)` | Bypass queue | Promise<{success, hash, error}> |
| `getQueueStatus()` | Get current status | Status object |
| `waitForDrain()` | Wait for empty queue | Promise<void> |
| `clearQueue(reject)` | Clear queue | void |
| `recoverFromCrash()` | Manual recovery | number (recovered count) |

### getQueueStatus() Output

```javascript
{
  pendingCount: 2,           // Items waiting
  isProcessing: true,        // Currently processing?
  lockAcquiredAt: "...",     // Lock timestamp
  pending: [...],            // Pending items
  lastCommitAt: "...",       // Last successful commit
  lastCommitHash: "abc123",  // Git hash
  totalCommits: 42,          // Session total
  failedCommits: 2,          // Session failures
  lastError: null            // Last error message
}
```

---

## 7. Queue Status Fields for TUI Display

### Real-Time Status Fields

| Field | Type | TUI Display Use |
|-------|------|-----------------|
| `pendingCount` | number | Queue length indicator |
| `isProcessing` | boolean | Activity spinner |
| `pending[].message` | string | Queue preview |
| `lastCommitAt` | ISO string | "Last commit X ago" |
| `lastCommitHash` | string | Git hash badge |
| `totalCommits` | number | Session counter |
| `failedCommits` | number | Error counter |
| `lastError` | string | Error message |

### Computed Indicators

```javascript
const queueBusy = status.isProcessing && status.pendingCount > 0;
const lockStale = lockAgeMs > 60000;
const successRate = ((totalCommits - failedCommits) / totalCommits * 100);
```

---

## 8. TUI Visualization Opportunities

### 8.1 Git Queue Status Panel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GIT QUEUE                         Idle                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Queue Status: 2 pending, Last commit 45s ago             â”‚
â”‚  â”œâ”€â”€ 1st: feat: implement async handler (src/async.js)   â”‚
â”‚  â””â”€â”€ 2nd: test: add async tests (test/async.test.js)     â”‚
â”‚                                                            â”‚
â”‚  Performance:                                              â”‚
â”‚  â€¢ Total commits: 42                                       â”‚
â”‚  â€¢ Success rate: 95.2% (failed: 2)                         â”‚
â”‚                                                            â”‚
â”‚  Status: Processing next commit... [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] 35%       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 8.2 Minimal Indicator (Status Bar)

```
Queue: 2 pending | Last: abc1234 (45s) | Rate: 95.2%
```

Or with icons:
```
ðŸ”„ Queue: 2 | âœ“ 42 commits | âš  2 failed
```

### 8.3 Error/Recovery Panel

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ GIT QUEUE ERROR                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âš  Last commit failed:                                        â”‚
â”‚   "feat: implement async handler"                            â”‚
â”‚                                                              â”‚
â”‚ Error: merge conflict in src/async.js                        â”‚
â”‚                                                              â”‚
â”‚ Queue status: STALLED (processing lock held >60s)           â”‚
â”‚                                                              â”‚
â”‚ Actions:                                                     â”‚
â”‚   [Reset lock] [Clear queue] [Inspect files] [Manual fix]   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. Implementation Recommendations for TUI

### 9.1 Status File Monitoring

```python
# Poll status file every 500ms
def update_queue_status():
    status_path = 'docs/plan-outputs/.git-queue-status.json'
    try:
        with open(status_path, 'r') as f:
            self.queue_status = json.load(f)
    except (FileNotFoundError, json.JSONDecodeError):
        self.queue_status = None
```

### 9.2 Polling Intervals

| State | Interval |
|-------|----------|
| Idle | 1000ms |
| Active queue | 200ms |
| Error state | 500ms |

### 9.3 Error Detection

```python
def check_queue_errors(self, queue_status):
    # Check for stale lock
    if lock_age_ms > 60000:
        return {'type': 'STALE_LOCK', 'message': 'Lock is stale'}

    # Check for recent failures
    if queue_status.get('lastError'):
        return {'type': 'COMMIT_ERROR', 'message': queue_status['lastError']}

    return None
```

---

## 10. Integration Checklist for TUI

### Phase 1: Basic Integration
- [ ] Read `.git-queue-status.json` periodically
- [ ] Display queue length in status bar
- [ ] Show "processing" indicator
- [ ] Display last commit hash and time

### Phase 2: Queue Details
- [ ] Add queue detail panel
- [ ] Show commit messages and files
- [ ] Display position in queue
- [ ] Show time queued for each item

### Phase 3: Error Handling
- [ ] Detect and display `lastError`
- [ ] Warn when lock appears stale
- [ ] Show failed/success counts
- [ ] Display recovery options

### Phase 4: Advanced Features
- [ ] Performance metrics (throughput, success rate)
- [ ] Lock status visualization
- [ ] Recovery action buttons

---

## 11. Summary

### Architecture Overview

| Component | Purpose |
|-----------|---------|
| `commitQueue[]` | In-memory FIFO queue |
| `isProcessing` | Mutex for serial processing |
| Status file | Persistent state for TUI/recovery |
| Atomic writes | Safe persistence |
| Lock timeout | Crash recovery |

### TUI Integration Points

| Feature | Data Source | Implementation |
|---------|-------------|----------------|
| Queue length | `pendingCount` | Status badge |
| Activity | `isProcessing` | Spinner |
| Queue preview | `pending[]` | Detail panel |
| Errors | `lastError` | Alert panel |
| Recovery | `recoverFromCrash()` | Action buttons |

### Key Strengths
1. Simple, understandable FIFO algorithm
2. Crash-safe via atomic writes
3. Observable via persistent status file
4. Rich API for programmatic access

**The queue is ready for TUI integration** - monitor JSON status file, display metrics, and provide recovery actions.
