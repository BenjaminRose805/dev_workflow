# Task 10.3: Task Constraint Panel Design

**Date:** 2025-12-26
**Purpose:** Design TUI panel explaining why tasks are sequential
**Scope:** File conflicts, annotations, dependency chains, constraint overrides

---

## Executive Summary

The Task Constraint Panel is a **high-value, medium-effort** expansion that explains execution order decisions. This design specifies a panel that shows why tasks cannot run in parallel, visualizes dependency chains, and provides optional override controls for advanced users.

**Estimated Effort:** 16-24 hours (Medium)
**Priority:** P1 (High Value - aids debugging and user trust)

---

## 1. Panel Overview

### 1.1 Purpose

Answer the user question: "Why can't these tasks run together?"

Provide visibility into:
- Why specific tasks are sequential (file conflicts, annotations, dependencies)
- Visual dependency chain from blocking task to blocked tasks
- Estimated time impact of sequential execution
- Optional override controls for power users

### 1.2 Data Sources

| Data | Source | Update Frequency |
|------|--------|------------------|
| File conflicts | `cmdNext()` output | Per iteration |
| Sequential annotations | Plan file parsing | Startup |
| Execution notes | Plan file `**Execution Note:**` blocks | Startup |
| Task dependencies | status.json `dependencies` field | 500ms |
| Blocking relationships | `cmdNext()` `blockedBy` field | Per iteration |
| Task durations | status.json historical data | On demand |

---

## 2. Visual Design

### 2.1 Default View (Integrated in Dashboard)

When constraints exist, show summary:

```
â”Œâ”€ Task Constraints â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  âš  4 tasks held back due to constraints                               â”‚
â”‚                                                                        â”‚
â”‚  Sequential:  3.3, 3.4 (waiting for 3.1)                              â”‚
â”‚  File conflict: 5.3 (tui.py in use by 5.1)                            â”‚
â”‚  Dependency: 6.1 (waiting for 5.2)                                    â”‚
â”‚                                                                        â”‚
â”‚  [c] Details  [o] Override                                            â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Expanded Constraint Detail View

Full explanation panel (toggle with `c` key):

```
â”Œâ”€ Task Constraint Details â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  â”Œâ”€ Sequential Chain: Phase 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Annotation: [SEQUENTIAL] in **Execution Note:**                 â”‚  â”‚
â”‚  â”‚  Reason: "All modify orchestrator-system.md"                     â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Chain:                                                          â”‚  â”‚
â”‚  â”‚    â³ 3.1 Merge ORCHESTRATOR.md                                  â”‚  â”‚
â”‚  â”‚      â”‚   Started: 5:23 ago                                       â”‚  â”‚
â”‚  â”‚      â†“                                                           â”‚  â”‚
â”‚  â”‚    â¸ 3.3 Create redirect file                                   â”‚  â”‚
â”‚  â”‚      â”‚   Waiting since: 5:23                                     â”‚  â”‚
â”‚  â”‚      â†“                                                           â”‚  â”‚
â”‚  â”‚    â¸ 3.4 Remove duplicate section                               â”‚  â”‚
â”‚  â”‚          Estimated wait: +8 min                                  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Impact: 2 tasks delayed, ~8 min total                           â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ File Conflict: tui.py â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Detection: Automatic (file reference extraction)                â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Conflicting Tasks:                                              â”‚  â”‚
â”‚  â”‚    â³ 5.1 Add parallelism indicator                              â”‚  â”‚
â”‚  â”‚          â”‚ Running, modifying tui.py                             â”‚  â”‚
â”‚  â”‚    â¸ 5.3 Update layout                                          â”‚  â”‚
â”‚  â”‚          Held: Waiting for 5.1 to complete                       â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  [o] Override: Allow parallel (âš  risk of conflicts)             â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ Dependency Chain â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Task 6.1 depends on 5.2:                                        â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚    â—¯ 5.2 Create auth middleware (pending)                        â”‚  â”‚
â”‚  â”‚      â†“                                                           â”‚  â”‚
â”‚  â”‚    ðŸš« 6.1 Integrate auth in routes (blocked)                     â”‚  â”‚
â”‚  â”‚          Reason: Uses AuthMiddleware from 5.2                    â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Unblock: Complete 5.2 first or remove dependency                â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  [â†‘/â†“] Navigate  [o] Override selected  [Esc] Close                   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Constraint Categories

#### Category 1: Sequential Annotation

```
â”Œâ”€ Sequential Annotation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  Source: Plan file Phase 3                                              â”‚
â”‚  Annotation: **Execution Note:** Tasks 3.1-3.4 are [SEQUENTIAL]         â”‚
â”‚  Reason: "All modify orchestrator-system.md"                            â”‚
â”‚                                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚    â³ 3.1 â”€â”€â”€â†’ â¸ 3.2 â”€â”€â”€â†’ â¸ 3.3 â”€â”€â”€â†’ â¸ 3.4                   â”‚    â”‚
â”‚  â”‚   (running)  (waiting)  (waiting)  (waiting)                   â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  Status: Enforced by orchestrator (annotation-based)                    â”‚
â”‚  Override: Not recommended - explicit annotation                        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Category 2: File Conflict (Auto-detected)

```
â”Œâ”€ File Conflict (Auto-detected) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  File: scripts/lib/tui.py                                               â”‚
â”‚  Detection Method: File reference extraction from task descriptions    â”‚
â”‚                                                                         â”‚
â”‚  Conflicting Tasks:                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  â³ 5.1 "Add parallelism indicator to tui.py"                  â”‚    â”‚
â”‚  â”‚       â†“ (must complete first)                                   â”‚    â”‚
â”‚  â”‚  â¸ 5.3 "Update tui.py layout structure"                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  Reason: Concurrent modification would cause merge conflicts            â”‚
â”‚                                                                         â”‚
â”‚  Override Options:                                                      â”‚
â”‚  â— [Safe] Wait for 5.1 (current)                                       â”‚
â”‚  â—‹ [Risky] Run parallel (may need manual merge)                        â”‚
â”‚  â—‹ [Ignore] Disable conflict detection for this file                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Category 3: Explicit Dependency

```
â”Œâ”€ Explicit Dependency â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  Task: 6.1 Integrate auth in routes                                     â”‚
â”‚  Syntax: (depends: 5.2)                                                 â”‚
â”‚                                                                         â”‚
â”‚  Dependency Chain:                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â”‚    â—¯ 5.2 Create auth middleware                                 â”‚    â”‚
â”‚  â”‚      â”‚   Status: pending (not started)                          â”‚    â”‚
â”‚  â”‚      â”‚   Est. completion: ~15 min                               â”‚    â”‚
â”‚  â”‚      â†“                                                          â”‚    â”‚
â”‚  â”‚    ðŸš« 6.1 Integrate auth in routes                              â”‚    â”‚
â”‚  â”‚          Status: blocked                                        â”‚    â”‚
â”‚  â”‚          Reason: Uses AuthMiddleware type from 5.2              â”‚    â”‚
â”‚  â”‚                                                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â”‚  Actions:                                                               â”‚
â”‚  [i] Implement 5.2 now  [s] Skip 5.2  [f] Force 6.1 anyway (âš )        â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 Override Confirmation Modal

When user selects override:

```
â”Œâ”€ âš  Override Constraint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  You are about to override a file conflict constraint.                  â”‚
â”‚                                                                         â”‚
â”‚  Constraint: tui.py - sequential due to file conflict                   â”‚
â”‚  Action: Allow 5.3 to run parallel with 5.1                            â”‚
â”‚                                                                         â”‚
â”‚  âš  Warning:                                                            â”‚
â”‚  â€¢ Both tasks modify tui.py                                             â”‚
â”‚  â€¢ May result in merge conflicts                                        â”‚
â”‚  â€¢ Manual resolution may be required                                    â”‚
â”‚                                                                         â”‚
â”‚  This override is:                                                      â”‚
â”‚  â—‹ One-time (this iteration only)                                       â”‚
â”‚  â— Permanent (saved to plan)                                            â”‚
â”‚                                                                         â”‚
â”‚  [Enter] Confirm override  [Esc] Cancel                                 â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Implementation Specification

### 3.1 New Python Classes

#### TaskConstraintPanel

```python
from dataclasses import dataclass
from typing import List, Optional, Dict
from enum import Enum

class ConstraintType(Enum):
    SEQUENTIAL_ANNOTATION = "sequential_annotation"
    FILE_CONFLICT = "file_conflict"
    EXPLICIT_DEPENDENCY = "explicit_dependency"
    PHASE_ORDER = "phase_order"

@dataclass
class Constraint:
    type: ConstraintType
    blocking_task: str
    blocked_tasks: List[str]
    reason: str
    source: Optional[str] = None  # Annotation text, file path, etc.
    can_override: bool = False
    override_risk: str = "unknown"  # "low", "medium", "high"

class TaskConstraintPanel:
    """Task constraint explanation panel for TUI."""

    def __init__(self, config: Optional[Dict] = None):
        self.config = config or {}
        self.expanded = False
        self.constraints: List[Constraint] = []
        self.selected_index = 0

    def refresh(self) -> None:
        """Refresh constraint data from multiple sources."""
        self.constraints = []
        self._load_sequential_annotations()
        self._load_file_conflicts()
        self._load_dependencies()
        self._sort_constraints()

    def _load_sequential_annotations(self) -> None:
        """Parse plan file for [SEQUENTIAL] annotations."""
        plan_path = self._get_plan_path()
        if not plan_path or not os.path.exists(plan_path):
            return

        with open(plan_path) as f:
            content = f.read()

        # Find execution notes with SEQUENTIAL
        import re
        pattern = r'\*\*Execution Note:\*\*\s*Tasks?\s*([\d.]+)[-â€“]([\d.]+)\s*are?\s*\[SEQUENTIAL\][^\n]*([^\n]*)'
        for match in re.finditer(pattern, content):
            start_id, end_id, reason = match.groups()
            task_ids = self._expand_task_range(start_id, end_id)
            if len(task_ids) > 1:
                self.constraints.append(Constraint(
                    type=ConstraintType.SEQUENTIAL_ANNOTATION,
                    blocking_task=task_ids[0],
                    blocked_tasks=task_ids[1:],
                    reason=reason.strip() if reason else "Marked [SEQUENTIAL] in plan",
                    source=f"Tasks {start_id}-{end_id}",
                    can_override=False,
                    override_risk="high"
                ))

    def _load_file_conflicts(self) -> None:
        """Get file conflicts from cmdNext output."""
        result = subprocess.run(
            ['node', 'scripts/status-cli.js', 'next', '10', '--json'],
            capture_output=True, text=True
        )
        if result.returncode != 0:
            return

        data = json.loads(result.stdout)
        for conflict in data.get('fileConflicts', []):
            task_ids = conflict.get('taskIds', [])
            if len(task_ids) > 1:
                # Find which is running
                running = None
                waiting = []
                for tid in task_ids:
                    task = next((t for t in data.get('tasks', []) if t['id'] == tid), None)
                    if task and task.get('status') == 'in_progress':
                        running = tid
                    else:
                        waiting.append(tid)

                if running:
                    self.constraints.append(Constraint(
                        type=ConstraintType.FILE_CONFLICT,
                        blocking_task=running,
                        blocked_tasks=waiting,
                        reason=f"Both tasks modify {conflict.get('file', 'same file')}",
                        source=conflict.get('file'),
                        can_override=True,
                        override_risk="medium"
                    ))

    def _load_dependencies(self) -> None:
        """Load explicit task dependencies."""
        status = self._load_status()
        for task in status.get('tasks', []):
            deps = task.get('dependencies', [])
            if deps:
                # Check if any dependency is not completed
                unmet = []
                for dep_id in deps:
                    dep_task = next((t for t in status['tasks'] if t['id'] == dep_id), None)
                    if dep_task and dep_task.get('status') not in ('completed', 'skipped'):
                        unmet.append(dep_id)

                if unmet:
                    self.constraints.append(Constraint(
                        type=ConstraintType.EXPLICIT_DEPENDENCY,
                        blocking_task=unmet[0],
                        blocked_tasks=[task['id']],
                        reason=f"Depends on {', '.join(unmet)}",
                        source=f"(depends: {', '.join(deps)})",
                        can_override=True,
                        override_risk="high"
                    ))

    def _sort_constraints(self) -> None:
        """Sort constraints by impact (more blocked tasks first)."""
        self.constraints.sort(key=lambda c: -len(c.blocked_tasks))

    def render_summary(self) -> Text:
        """Render one-line summary."""
        if not self.constraints:
            return Text("No constraints active", style="dim green")

        total_blocked = sum(len(c.blocked_tasks) for c in self.constraints)
        text = Text()
        text.append(f"âš  {total_blocked} tasks held back", style="yellow")
        text.append("  â”‚  ", style="dim")

        # Summarize by type
        by_type = {}
        for c in self.constraints:
            by_type.setdefault(c.type, []).append(c)

        parts = []
        if ConstraintType.SEQUENTIAL_ANNOTATION in by_type:
            count = len(by_type[ConstraintType.SEQUENTIAL_ANNOTATION])
            parts.append(f"{count} sequential")
        if ConstraintType.FILE_CONFLICT in by_type:
            count = len(by_type[ConstraintType.FILE_CONFLICT])
            parts.append(f"{count} conflict{'s' if count > 1 else ''}")
        if ConstraintType.EXPLICIT_DEPENDENCY in by_type:
            count = len(by_type[ConstraintType.EXPLICIT_DEPENDENCY])
            parts.append(f"{count} blocked")

        text.append(", ".join(parts), style="dim")

        return text

    def render_expanded(self) -> Panel:
        """Render full constraint detail panel."""
        if not self.constraints:
            return Panel(
                Text("No constraints active - all tasks can run in parallel", style="green"),
                title="Task Constraints",
                border_style="green"
            )

        content = Table(show_header=False, box=None, expand=True, padding=(0, 1))
        content.add_column()

        for i, constraint in enumerate(self.constraints):
            is_selected = i == self.selected_index
            panel = self._render_constraint(constraint, is_selected)
            content.add_row(panel)
            content.add_row("")

        # Controls
        controls = Text()
        controls.append("[â†‘/â†“] Navigate  ", style="dim cyan")
        controls.append("[o] Override  ", style="dim cyan")
        controls.append("[d] Details  ", style="dim cyan")
        controls.append("[c] Collapse", style="dim cyan")
        content.add_row(controls)

        return Panel(
            content,
            title=f"Task Constraints ({len(self.constraints)})",
            border_style="yellow"
        )

    def _render_constraint(self, constraint: Constraint, selected: bool = False) -> Panel:
        """Render a single constraint card."""
        table = Table(show_header=False, box=None, expand=True)
        table.add_column("Key", width=15, style="dim")
        table.add_column("Value")

        # Type
        type_icons = {
            ConstraintType.SEQUENTIAL_ANNOTATION: "â›“",
            ConstraintType.FILE_CONFLICT: "âš ",
            ConstraintType.EXPLICIT_DEPENDENCY: "ðŸš«",
            ConstraintType.PHASE_ORDER: "ðŸ“‹"
        }
        icon = type_icons.get(constraint.type, "?")
        type_name = constraint.type.value.replace("_", " ").title()
        table.add_row("Type:", Text(f"{icon} {type_name}"))

        # Blocking task
        table.add_row("Blocking:", Text(f"â³ {constraint.blocking_task}", style="yellow"))

        # Blocked tasks
        blocked_str = ", ".join(constraint.blocked_tasks)
        table.add_row("Waiting:", Text(f"â¸ {blocked_str}", style="dim"))

        # Reason
        table.add_row("Reason:", Text(constraint.reason))

        # Override option
        if constraint.can_override:
            risk_style = {
                "low": "green",
                "medium": "yellow",
                "high": "red"
            }.get(constraint.override_risk, "dim")
            table.add_row(
                "Override:",
                Text(f"Available (risk: {constraint.override_risk})", style=risk_style)
            )
        else:
            table.add_row("Override:", Text("Not available", style="dim"))

        border_style = "cyan" if selected else "dim"
        title = f"â— Constraint {constraint.blocking_task}" if selected else ""
        return Panel(table, title=title, border_style=border_style)

    def handle_key(self, key: str) -> bool:
        """Handle keyboard navigation and actions."""
        if key in ('j', 'down'):
            self.selected_index = min(self.selected_index + 1, len(self.constraints) - 1)
            return True
        elif key in ('k', 'up'):
            self.selected_index = max(self.selected_index - 1, 0)
            return True
        elif key == 'o':
            return self._show_override_modal()
        elif key == 'c':
            self.expanded = False
            return True
        return False

    def _show_override_modal(self) -> bool:
        """Show override confirmation modal."""
        if not self.constraints:
            return False
        constraint = self.constraints[self.selected_index]
        if not constraint.can_override:
            return False
        # Modal logic would go here
        return True

    def toggle(self) -> None:
        """Toggle expanded/collapsed state."""
        self.expanded = not self.expanded
        if self.expanded:
            self.refresh()
```

### 3.2 Keyboard Mappings

| Key | Context | Action |
|-----|---------|--------|
| `c` | Global | Toggle constraint panel |
| `â†‘/k` | Panel expanded | Previous constraint |
| `â†“/j` | Panel expanded | Next constraint |
| `o` | Constraint selected | Show override modal |
| `d` | Constraint selected | Show full details |
| `Enter` | On blocked task | Jump to task |

---

## 4. Data Contract

### 4.1 Constraint Data Object

```typescript
interface TaskConstraint {
  id: string;  // Unique constraint ID
  type: 'sequential_annotation' | 'file_conflict' | 'explicit_dependency' | 'phase_order';
  blockingTask: {
    id: string;
    description: string;
    status: 'in_progress' | 'pending';
    startedAt?: string;
    estimatedCompletion?: string;
  };
  blockedTasks: Array<{
    id: string;
    description: string;
    waitingSince?: string;
    estimatedDelay?: number;  // seconds
  }>;
  reason: string;
  source: {
    type: 'annotation' | 'file' | 'dependency' | 'phase';
    location?: string;  // file path, annotation text, etc.
  };
  override: {
    allowed: boolean;
    risk: 'low' | 'medium' | 'high';
    warning?: string;
    permanentOption: boolean;
  };
}

interface ConstraintSummary {
  totalBlocked: number;
  constraints: TaskConstraint[];
  byType: {
    sequential: number;
    fileConflict: number;
    dependency: number;
    phase: number;
  };
  estimatedImpact: {
    totalDelayMinutes: number;
    criticalPath: string[];
  };
}
```

---

## 5. Effort Estimate

### 5.1 Implementation Breakdown

| Component | Effort | Priority |
|-----------|--------|----------|
| TaskConstraintPanel class | 4 hours | P0 |
| Constraint loading (3 types) | 4 hours | P0 |
| Summary view render | 2 hours | P0 |
| Expanded view render | 3 hours | P0 |
| Constraint card render | 2 hours | P0 |
| Keyboard navigation | 1 hour | P0 |
| **Subtotal Core:** | **16 hours** | - |
| Override modal | 3 hours | P1 |
| Permanent override persistence | 2 hours | P2 |
| Impact estimation | 3 hours | P2 |
| **Subtotal Enhanced:** | **8 hours** | - |
| **Total:** | **24 hours** | - |

### 5.2 Recommended Implementation

**MVP (Core):** 16 hours
- Load constraints from 3 sources
- Summary line with counts
- Expanded view with constraint cards
- Keyboard navigation between constraints

**Full Feature:** 24 hours
- All MVP features
- Override confirmation modal
- Permanent override option
- Time impact estimation

---

## 6. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Constraint data stale | MEDIUM | LOW | Refresh on expand |
| Override causes conflicts | MEDIUM | HIGH | Clear warnings, easy rollback |
| Too many constraints | LOW | MEDIUM | Collapse/filter |
| Missing constraint sources | LOW | LOW | Graceful fallback |

---

## 7. Success Criteria

### 7.1 Functional Requirements

- [ ] Shows all active constraints with blocking/blocked tasks
- [ ] Categorizes by type (annotation, file conflict, dependency)
- [ ] Shows reason for each constraint
- [ ] Keyboard navigation between constraints
- [ ] Override option for applicable constraints
- [ ] Clear warning for override risks

### 7.2 Quality Requirements

- [ ] Constraint detection complete (all 3 sources)
- [ ] Renders in <100ms
- [ ] Handles 10+ constraints without overflow
- [ ] Clear visual hierarchy

### 7.3 Integration Requirements

- [ ] Data available from existing sources
- [ ] Fits in TUI layout
- [ ] No new CLI commands needed

---

## 8. Related Documents

- Task 3.5: Conflict detection TUI mapping
- Task 4.5: Dependency system TUI mapping
- Task 9.3: Parallel/sequential gaps
- Task 10.2: Parallel Execution Dashboard

---

**End of Design**
