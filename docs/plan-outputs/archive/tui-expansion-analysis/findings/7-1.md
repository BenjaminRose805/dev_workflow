# Task 7.1: Batch Size Configuration Analysis

## Summary

This analysis documents how batch size is configured and used in the orchestrator to control how many tasks are attempted per Claude session.

## Configuration

### Default Values
From `plan_orchestrator.py:76-81`:
```python
DEFAULT_MAX_ITERATIONS = 50
DEFAULT_TIMEOUT = 600  # 10 minutes per session
DEFAULT_BATCH_SIZE = 5
```

### Command Line Arguments
From `plan_orchestrator.py:1254-1260`:
```python
parser.add_argument(
    "--batch-size",
    type=int,
    default=DEFAULT_BATCH_SIZE,
    help=f"Tasks per iteration hint (default: {DEFAULT_BATCH_SIZE})",
)
```

### Orchestrator Constructor
From `plan_orchestrator.py:126-145`:
```python
def __init__(
    self,
    plan_path: Optional[str] = None,
    worktree_path: Optional[str] = None,
    max_iterations: int = DEFAULT_MAX_ITERATIONS,
    timeout: int = DEFAULT_TIMEOUT,
    batch_size: int = DEFAULT_BATCH_SIZE,
    dry_run: bool = False,
    verbose: bool = False,
    use_tui: bool = True,
):
    self.batch_size = batch_size
```

## Batch Size Usage

### 1. Task Retrieval
From `plan_orchestrator.py:281-319`:
```python
def get_next_tasks(self, count: int = 5) -> list:
    """Get next recommended tasks via status-cli.js.

    Returns a list of task objects, each containing:
    - id: Task ID (e.g., "3.1")
    - description: Task description
    - phase: Phase number
    - status: Task status
    - reason: Why this task was selected
    - sequential: True if task is in a sequential group (optional)
    - sequentialGroup: Range like "3.1-3.4" if sequential (optional)
    - sequentialReason: Reason for sequential constraint (optional)
    """
    result = subprocess.run(
        ["node", STATUS_CLI_JS, "next", str(count)],
        capture_output=True,
        text=True,
        timeout=30,
        cwd=self.working_dir,
    )
```

### 2. Sequential Filtering
From `plan_orchestrator.py:321-367`:
```python
def _filter_sequential_tasks(self, tasks: list) -> list:
    """Filter tasks to respect sequential constraints.

    If multiple tasks share the same sequentialGroup, only include
    the first one (by task ID order). This ensures tasks marked
    [SEQUENTIAL] run one at a time.
    """
    seen_groups = set()
    filtered = []
    held_back = []

    for task in tasks:
        seq_group = task.get("sequentialGroup")
        if seq_group:
            if seq_group in seen_groups:
                held_back.append(task)
                continue
            seen_groups.add(seq_group)
        filtered.append(task)

    return filtered
```

### 3. Main Loop Usage
From `plan_orchestrator.py:900-917`:
```python
# Get next tasks for context
next_tasks = self.get_next_tasks(self.batch_size)

# Filter out tasks that would violate sequential constraints
filtered_tasks = self._filter_sequential_tasks(next_tasks)
if len(filtered_tasks) < len(next_tasks):
    self.logger.info(
        f"Filtered {len(next_tasks)} tasks to {len(filtered_tasks)} "
        f"(respecting sequential constraints)"
    )

task_ids = [t.get("id", "?") for t in filtered_tasks]
```

### 4. Prompt Building
From `plan_orchestrator.py:974-1015`:
```python
def _build_prompt(self, status: PlanStatus, next_tasks: list) -> str:
    """Build the prompt for Claude Code.

    Uses command invocation with --autonomous flag...
    """
    # Build task ID list for command args (batch appropriately)
    task_ids = " ".join(t.get('id', '') for t in next_tasks)

    prompt = f"""Execute these tasks from the plan:

{task_list}

Plan: {status.plan_path}
Progress: {status.percentage}% ({status.completed}/{status.total} tasks)

Run: /plan:implement {task_ids} --autonomous
"""
```

## Batch Size Behavior

### Effective Batch Size

The actual number of tasks executed per iteration may be less than `batch_size` due to:

1. **Sequential Constraints**
   - Tasks marked `[SEQUENTIAL]` filter down to 1 per group
   - Example: batch_size=5, but 3 tasks are sequential → only 3 tasks sent

2. **Dependency Constraints**
   - Only tasks with satisfied dependencies are returned
   - Example: 5 tasks requested, but only 2 are ready

3. **Phase Boundaries**
   - `status-cli.js next` respects phase ordering (with tiebreaker)
   - Cross-phase execution enabled by default

4. **File Conflicts**
   - Tasks modifying same files treated as sequential
   - May reduce effective parallelism

### Batch Size Flow

```
┌─────────────────────────────────────────────────────────────────┐
│ get_next_tasks(batch_size)                                      │
│     ↓                                                           │
│ status-cli.js returns up to N tasks                             │
│     ↓                                                           │
│ _filter_sequential_tasks() removes duplicates from same group   │
│     ↓                                                           │
│ Actual task list (may be < batch_size)                          │
│     ↓                                                           │
│ Claude session processes filtered tasks                         │
└─────────────────────────────────────────────────────────────────┘
```

## Configuration Recommendations

### Small Batches (1-3)
- **Use when:** Sequential tasks, complex tasks, debugging
- **Benefits:** Easier to track, fewer conflicts
- **Drawbacks:** More iterations, slower overall

### Medium Batches (4-6)
- **Use when:** Mixed parallel/sequential work
- **Benefits:** Good balance of speed and control
- **Drawbacks:** May hit timeout for complex batches

### Large Batches (7-10)
- **Use when:** Many independent simple tasks
- **Benefits:** Faster completion
- **Drawbacks:** Risk of timeout, harder to debug

## TUI Visualization Opportunities

### 1. Batch Size Control
```
┌─ Batch Configuration ───────────────────────────────────┐
│ Current batch size: [5] ◄─────────────────────────────► │
│                      1     3     5     7     10         │
│                                                         │
│ Effective batch: 3 tasks (2 filtered by [SEQUENTIAL])  │
│                                                         │
│ Recommendation: Medium (4-6) for current plan          │
│   Reason: Mix of parallel and sequential tasks         │
└─────────────────────────────────────────────────────────┘
```

### 2. Batch Composition Panel
```
┌─ Current Batch ─────────────────────────────────────────┐
│ Requested: 5 tasks | Effective: 3 tasks                │
│                                                         │
│ ⏳ 3.1 [SEQUENTIAL] Merge ORCHESTRATOR.md content      │
│    Held back:                                          │
│      • 3.2, 3.3, 3.4 (same sequential group)           │
│                                                         │
│ ⏳ 4.1 Analyze phase-based ordering                    │
│ ⏳ 5.1 Analyze git commit queue                        │
│                                                         │
│ Filtered: 2 tasks | Held: 2 tasks | Blocked: 0 tasks   │
└─────────────────────────────────────────────────────────┘
```

### 3. Batch History
```
┌─ Batch History ─────────────────────────────────────────┐
│ Iter  Requested  Effective  Completed  Failed  Time    │
│ ────────────────────────────────────────────────────── │
│  12      5          3           3        0      4:32   │
│  11      5          5           4        1      5:15   │
│  10      5          2           2        0      2:48   │
│   9      5          5           5        0      3:55   │
│                                                         │
│ Average effective: 3.8 tasks/batch                     │
│ Success rate: 93%                                      │
└─────────────────────────────────────────────────────────┘
```

### 4. Dynamic Batch Size Adjustment
```
┌─ Adaptive Batching ─────────────────────────────────────┐
│ Mode: [●Auto] [○Manual]                                │
│                                                         │
│ Strategy: Maximize throughput while avoiding timeouts  │
│                                                         │
│ Current adjustment:                                    │
│   Base: 5 → Adjusted: 4                                │
│   Reason: Last batch hit timeout (85% of limit)        │
│                                                         │
│ History: 5→5→4→4→3→4→5→5→4 (trending stable)          │
└─────────────────────────────────────────────────────────┘
```

## Integration Points

### Configuration File
Future enhancement could add to `.claude/git-workflow.json`:
```json
{
  "orchestrator": {
    "default_batch_size": 5,
    "adaptive_batching": true,
    "min_batch_size": 1,
    "max_batch_size": 10,
    "timeout_threshold": 0.8
  }
}
```

### TUI Data Requirements

| Data | Source | Update Frequency |
|------|--------|-----------------|
| Current batch size | Orchestrator state | Static |
| Effective batch | `_filter_sequential_tasks()` | Per iteration |
| Batch history | status.json runs | Per iteration |
| Task filtering | Sequential/conflict data | Per iteration |

## Key Implementation References

| File | Location | Purpose |
|------|----------|---------|
| `plan_orchestrator.py:76-81` | Constants | Default values |
| `plan_orchestrator.py:126-145` | `__init__` | Configuration |
| `plan_orchestrator.py:281-319` | `get_next_tasks()` | Task retrieval |
| `plan_orchestrator.py:321-367` | `_filter_sequential_tasks()` | Sequential filtering |
| `plan_orchestrator.py:900-917` | Main loop | Batch usage |
| `plan_orchestrator.py:1254-1260` | CLI args | User configuration |
