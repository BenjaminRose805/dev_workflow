# Task 1.3: Git Operations Currently Available via CLI

## Summary

Analysis of `scripts/status-cli.js` and related plan commands to identify git operations currently exposed via CLI.

## Git Operations in status-cli.js

### 1. Core Git Info Function (`getGitInfo()`)

**Location:** `scripts/status-cli.js:150-227`

| Field | Git Command | Description |
|-------|-------------|-------------|
| `branch` | `git branch --show-current` | Current branch name |
| `uncommittedCount` | `git status --porcelain \| wc -l` | Number of uncommitted files |
| `commitCount` | `git rev-list --count HEAD ^{base}` | Commits ahead of master/main |
| `lastCommit.sha` | `git log -1 --format="%h"` | Abbreviated SHA |
| `lastCommit.message` | `git log -1 --format="%s"` | Commit message |

### 2. CLI Commands with Git Integration

| Command | Git Features | Output |
|---------|--------------|--------|
| `progress` | Branch, uncommitted, commits, last commit | Text/JSON/Markers |
| `progress --format=json` | Full git object in JSON | `{ git: {...} }` |
| `progress --format=markers` | Progress markers with git info | `[PROGRESS] git...` |
| `rebase-check` | Branch rebase status | Which branches need rebase |
| `merge-order` | Merge analysis | Recommended merge order |
| `worktree-context` | Worktree detection | Worktree path/branch info |
| `worktree-conflict` | Conflict analysis | Detailed conflict report |
| `stale-worktrees` | Worktree age check | List of stale worktrees |
| `cleanup-worktrees` | Worktree removal | Cleanup status |

### 3. Git Info in Progress Output

**Text format (`progress`):**
```
Branch: plan/my-plan
Uncommitted: 2 file(s)
Commits: 5 ahead of base branch
Last: abc1234 [plan] task 1.1: Description...
```

**JSON format (`progress --format=json`):**
```json
{
  "git": {
    "branch": "plan/my-plan",
    "uncommittedCount": 2,
    "commitCount": 5,
    "lastCommit": {
      "sha": "abc1234",
      "message": "[plan] task 1.1: Description"
    }
  }
}
```

**Markers format (`progress --format=markers`):**
```
[PROGRESS] git branch=plan/my-plan uncommitted=2 commits=5
[PROGRESS] git last_commit=abc1234
```

### 4. Worktree-Related Commands

| Command | Purpose | Output |
|---------|---------|--------|
| `worktree-context` | Detect if in worktree | JSON with path/branch |
| `rebase-check` | Check branches need rebase | List of behind branches |
| `merge-order` | Optimal merge sequence | Ordered branch list |
| `worktree-conflict` | Analyze worktree conflicts | Conflict report |
| `stale-worktrees` | Find inactive worktrees | Stale worktree list |
| `cleanup-worktrees` | Remove stale worktrees | Cleanup results |
| `check-limits` | Check resource limits | Resource availability |
| `resources` | Resource management status | Resource report |

### 5. Git Queue Tracking

**Git Queue Status (if available):**
```
Git Queue: N commit(s) pending
  ⟳ Processing commit...
```

JSON format:
```json
{
  "gitQueue": {
    "pendingCount": 2,
    "isProcessing": true
  }
}
```

## Git Operations in Plan Commands

### /plan:set (set.md)

| Operation | Command | When |
|-----------|---------|------|
| Check git availability | `git --version` | Start |
| Get current branch | `git branch --show-current` | Branch validation |
| Create plan branch | `git checkout -b plan/{name}` | New plan |
| Switch to plan branch | `git checkout plan/{name}` | Existing plan |
| Check uncommitted changes | `git status --porcelain` | Before switch |
| Auto-stash changes | `git stash push -m "..."` | If uncommitted |

### /plan:implement (implement.md)

| Operation | Command | When |
|-----------|---------|------|
| Check git availability | `git --version` | Step 1.1 |
| Get current branch | `git branch --show-current` | Step 1.1 |
| Validate plan branch | Compare with `plan/{name}` | Step 1.1 |
| Auto-switch branch | `git checkout plan/{name}` | Wrong plan branch |
| Stage all changes | `git add -A` | After task |
| Create task commit | `git commit -m "[plan] task..."` | After task |
| Push to remote | `git push` | If sync_remote |

### /plan:complete (complete.md)

| Operation | Command | When |
|-----------|---------|------|
| Verify plan branch | `git branch --show-current` | Step 3 |
| Dry-run merge | `git merge --no-commit --no-ff main` | Step 4 |
| Abort dry-run | `git merge --abort` | After conflict check |
| Commit uncommitted | `git add -A && git commit` | Step 5 |
| Create archive tag | `git tag -a archive/plan-{name}` | Step 6 |
| Switch to main | `git checkout main` | Step 7 |
| Squash merge | `git merge --squash plan/{name}` | Step 8 |
| Merge commit | `git merge --no-ff plan/{name}` | Alt step 8 |
| Fast-forward | `git merge --ff-only plan/{name}` | Alt step 8 |
| Create merge commit | `git commit -m "Complete: ..."` | Step 10 |
| Delete plan branch | `git branch -D plan/{name}` | Step 11 |
| Push branch | `git push -u origin plan/{name}` | PR workflow |
| Create PR | `gh pr create` | PR workflow |

## Git-Related Configuration

### .claude/git-workflow.json

| Setting | Description | Default |
|---------|-------------|---------|
| `strategy` | `branch-per-plan` or `branch-per-phase` | `branch-per-plan` |
| `branch_prefix` | Branch naming prefix | `plan/` |
| `auto_commit` | Auto-commit after tasks | `true` |
| `merge_strategy` | `squash`, `commit`, or `ff` | `squash` |
| `archive_branches` | Create archive tags | `true` |
| `archive_retention_days` | Days before archive cleanup | `90` |
| `sync_remote` | Push after commits | `false` |
| `phase_tags` | Create phase completion tags | `true` |
| `enforce_branch` | Require plan branch | `true` |

## TUI Integration Points

### Data Sources for TUI

| Data | Source | Refresh Rate |
|------|--------|--------------|
| Branch name | `getGitInfo().branch` | On panel load |
| Uncommitted count | `getGitInfo().uncommittedCount` | On file change |
| Commit count | `getGitInfo().commitCount` | After commit |
| Last commit | `getGitInfo().lastCommit` | After commit |
| Git queue | `getQueueStatus()` | Real-time |
| Worktree list | `listWorktrees()` | On demand |

### CLI Commands TUI Can Invoke

| TUI Action | CLI Command |
|------------|-------------|
| Show progress | `node scripts/status-cli.js progress --format=json` |
| Check next tasks | `node scripts/status-cli.js next` |
| Get all plans | `node scripts/status-cli.js all-plans --json` |
| Check worktree | `node scripts/status-cli.js worktree-context` |
| Rebase check | `node scripts/status-cli.js rebase-check --json` |
| Merge order | `node scripts/status-cli.js merge-order --json` |
| Resource check | `node scripts/status-cli.js resources --json` |
| Stale worktrees | `node scripts/status-cli.js stale-worktrees --json` |

## Missing Git Operations (Not Yet in CLI)

| Operation | Needed For | Current Workaround |
|-----------|------------|-------------------|
| View commit history | Archive browsing | Direct `git log` |
| View file diff | Uncommitted changes | Direct `git diff` |
| Stash list | Stash management | Direct `git stash list` |
| Tag list | Archive browsing | Direct `git tag -l` |
| Branch list | Branch switching | Direct `git branch` |
| Remote status | Sync indicator | Direct `git fetch --dry-run` |

## Recommended CLI Additions for TUI

1. **`git-status`** - Comprehensive git status for TUI
   ```json
   {
     "branch": "plan/my-plan",
     "isClean": false,
     "uncommitted": [...files...],
     "staged": [...files...],
     "remote": { "ahead": 2, "behind": 0 }
   }
   ```

2. **`git-log`** - Recent commits with task info
   ```json
   {
     "commits": [
       { "sha": "abc123", "message": "...", "taskId": "1.1" }
     ]
   }
   ```

3. **`git-stash-list`** - List stashes for plan switching
   ```json
   {
     "stashes": [
       { "index": 0, "message": "plan-switch: old → new" }
     ]
   }
   ```
