# Task 2.2: [PARALLEL] Phase Annotation Parsing Analysis

## Summary

The `[PARALLEL]` phase annotation system enables concurrent execution across phase boundaries by marking phases that can run simultaneously. This is complementary to the `[SEQUENTIAL]` task-level constraint - while `[SEQUENTIAL]` forces tasks to run one-at-a-time, `[PARALLEL]` enables phases to overlap.

## Annotation Syntax

### Pattern
```markdown
**Execution Note:** Phases X-Y are [PARALLEL] - reason
```

### Supported Range Formats

| Format | Example | Expanded Result |
|--------|---------|-----------------|
| Range | `Phases 1-3` | [1, 2, 3] |
| Comma-separated | `Phases 1, 2, 3` | [1, 2, 3] |
| Mixed | `Phases 1-3, 5` | [1, 2, 3, 5] |
| Single | `Phase 1-2 is` | [1, 2] |

### Multiple Annotations
Multiple `[PARALLEL]` annotations can appear in a single plan:
```markdown
**Execution Note:** Phases 1-2 are [PARALLEL] - frontend work
**Execution Note:** Phases 4-5 are [PARALLEL] - deployment
```

## Implementation Details

### Regex Pattern (`scripts/lib/plan-status.js:1278`)

```javascript
const parallelPattern = /\*\*Execution Note:\*\*\s*Phases?\s+([\d,\s-]+)\s+(?:are|is)\s+\[PARALLEL\]\s*[-–—]?\s*(.+?)(?:\n|$)/gi;
```

**Pattern breakdown:**
- `\*\*Execution Note:\*\*` - Matches the bold marker
- `\s*Phases?\s+` - "Phase" or "Phases" with flexible whitespace
- `([\d,\s-]+)` - Captures phase range/list (digits, commas, spaces, dashes)
- `(?:are|is)` - Matches "are" or "is" (singular/plural)
- `\[PARALLEL\]` - The literal annotation tag
- `[-–—]?` - Optional separator (hyphen, en-dash, or em-dash)
- `(.+?)(?:\n|$)` - Captures reason until end of line

### Range Expansion Function (`expandPhaseRange()`)

Located at `scripts/lib/plan-status.js:1363-1398`:

```javascript
function expandPhaseRange(rangeStr) {
  const result = new Set();
  const parts = rangeStr.split(/,\s*/);

  for (const part of parts) {
    // Handle range: "1-3"
    const rangeMatch = part.match(/^(\d+)\s*-\s*(\d+)$/);
    if (rangeMatch) {
      for (let i = start; i <= end; i++) {
        result.add(i);
      }
      continue;
    }
    // Handle single number
    const numMatch = part.match(/^(\d+)$/);
    if (numMatch) {
      result.add(parseInt(numMatch[1]));
    }
  }
  return Array.from(result).sort((a, b) => a - b);
}
```

### Parser Function (`parseExecutionNotes()`)

Located at `scripts/lib/plan-status.js:1232-1352`, this function parses all execution notes and returns an object with:

```javascript
{
  sequential: [...],        // [SEQUENTIAL] task constraints
  parallel: [               // [PARALLEL] phase constraints
    {
      phaseRange: "1-3",    // Original string
      phaseIds: [1, 2, 3],  // Expanded phase numbers
      reason: "independent modules"
    }
  ],
  nonBlockingVerify: [...], // Non-blocking VERIFY phases
  pipelineStart: [...]      // Pipeline-start triggers
}
```

**Backward Compatibility:** Returns an array-like object where the array items are the sequential constraints (for legacy code).

## Data Flow: Plan to status.json

1. **Initialization** (`initializePlanStatus()`):
   - Parses plan content with `parseExecutionNotes()`
   - Does NOT store parallel groups in status.json (currently)
   - Parallel info is parsed on-demand when needed

2. **Query Time** (`cmdNext()` in status-cli.js):
   - Parses plan file fresh to get constraints
   - Builds `parallelPhaseSet` from `.parallel` groups
   - Tasks from parallel phases get `parallelPhase: true` flag

3. **Output Format** (next command JSON):
   ```json
   {
     "count": 5,
     "tasks": [...],
     "parallelPhases": [
       { "phases": [1, 2, 3], "reason": "independent modules" }
     ]
   }
   ```

## API Functions

### `getParallelPhases(planPath)` (`plan-status.js:1814-1908`)

Returns comprehensive parallel phase information including conflict detection:

```javascript
{
  parallelGroups: [{ phaseIds: number[], reason: string }],
  allParallelPhases: number[],
  hasConflicts: boolean,
  conflicts: [{ file: string, phases: number[] }]
}
```

**Conflict detection:** Automatically checks if tasks in parallel phases reference the same files, warning about potential race conditions.

### CLI Access

The `next` command exposes parallel phase info:
```bash
node scripts/status-cli.js next --format=json
```

Output includes:
- `tasks[].parallelPhase: true` for tasks in parallel phases
- `parallelPhases: [{phases, reason}]` groups

## Parallel Phase Execution Behavior

1. **Phase Independence:** Tasks from parallel phases can be returned together by `next` command
2. **File Conflict Warning:** If parallel phases modify same files, `hasConflicts` is set
3. **Sequential Respected:** `[SEQUENTIAL]` annotations within parallel phases are still enforced
4. **Cross-Phase Tasks:** When tasks from multiple phases are ready, output includes `crossPhaseExecution: true`

## TUI Display Opportunities

### Visual Indicators

| Element | Current State | TUI Opportunity |
|---------|---------------|-----------------|
| Parallel phase badge | None | Phase headers with "⟷" indicator |
| Phase grouping | Text-only in JSON | Visual swimlanes |
| Conflict warnings | JSON property | Warning badge with tooltip |
| Active parallel execution | Hidden | Split-view showing parallel progress |

### Data Already Available for TUI

1. **`parallelPhases`** - Groups and reasons for parallel execution
2. **`hasConflicts`** - Boolean for conflict warning display
3. **`conflicts`** - Specific file/phase conflict details
4. **`crossPhaseExecution`** - Indicator when multi-phase parallelism active

### Recommended TUI Enhancements

1. **Parallel Phase Indicator:**
   - Mark phase headers with visual indicator (e.g., `[⟷ Phases 1-3]`)
   - Tooltip showing reason for parallelism

2. **Swimlane View:**
   - Display parallel phases side-by-side
   - Show real-time progress in each lane
   - Connect with dependency arrows

3. **Conflict Warning Panel:**
   - Red warning icon when `hasConflicts: true`
   - Expandable list showing file-to-phase mapping
   - "Override" button for manual parallel execution despite conflicts

4. **Parallel Execution Dashboard:**
   - Live task counters per parallel phase
   - Progress bars for each phase in parallel group
   - "Effective parallelism" metric showing concurrent task count

## Test Coverage

Tests located at `scripts/tests/test-parallel-phases.js`:
- 53 tests passing
- Covers range parsing, multiple annotations, conflict detection
- Em-dash and en-dash separator support

## Comparison with [SEQUENTIAL]

| Aspect | [SEQUENTIAL] | [PARALLEL] |
|--------|--------------|------------|
| Scope | Task-level (within phase) | Phase-level (across phases) |
| Effect | Forces serial execution | Enables concurrent execution |
| Conflict detection | Implicit (tasks share file) | Explicit (warns about files) |
| Status.json storage | `sequentialGroups` array | Parsed on-demand |
| Task flag | `executionConstraints` | `parallelPhase: true` |
