# Task 6.3: Planned Git Worktree Integration Analysis

## Summary

This analysis documents the planned git worktree integration from `git-workflow-phase5-worktrees.md`, which enables true parallel plan execution with full isolation.

## Worktree Architecture

### Directory Structure (Planned)
```
repo/
├── .git/                              # Shared git data
├── main/                              # Primary worktree (main branch)
└── worktrees/
    ├── plan-feature-auth/             # Worktree for plan/feature-auth
    │   ├── .claude-context/
    │   │   └── current-plan.txt
    │   ├── docs/
    │   └── src/
    ├── plan-api-refactor/             # Worktree for plan/api-refactor
    └── plan-perf-optimization/        # Worktree for plan/perf-optimization
```

### Implementation Status

**Plan:** `docs/plans/git-workflow-phase5-worktrees.md`
**Status:** 12 phases, 12 top-level tasks (not yet started)

### Key Phases

| Phase | Focus | Tasks |
|-------|-------|-------|
| 1 | `/plan:worktree` command | create, list, remove, switch |
| 2 | Worktree context system | `.claude-context/`, path resolution |
| 3 | Orchestrator worktree support | `--worktree` flag, auto-detection |
| 4 | Multi-orchestrator process mgmt | Registry, daemon mode, IPC |
| 5 | Aggregate status view | `--all-plans`, worktree scanning |
| 6 | Multi-plan TUI interface | Pane layout, plan switcher |
| 7 | Worktree completion workflow | Merge, cleanup |
| 8 | Conflict detection between worktrees | File overlap warnings |
| 9 | Resource management | Concurrent limits, disk monitoring |
| 10 | REST API | `/api/plans/*` endpoints |
| 11 | Frontend integration | OpenAPI spec, WebSocket format |
| 12 | Integration testing | Full workflow tests |

## Path Resolution in Worktree Context

**Implementation** (from `plan-status.js:2377-2448`):

The `detectWorktreeContext()` function handles path resolution:

```javascript
function detectWorktreeContext() {
  const result = {
    inWorktree: false,
    worktreePath: null,
    planPath: null,
    repoRoot: null,
    contextSource: null  // 'env' | 'worktree' | 'repo'
  };

  // Priority 1: CLAUDE_WORKTREE environment variable
  const envWorktree = process.env.CLAUDE_WORKTREE;
  if (envWorktree && fs.existsSync(envWorktree)) {
    // Check for .claude-context/current-plan.txt
    // Set contextSource = 'env'
  }

  // Priority 2: Current directory has .claude-context/
  if (fs.existsSync('.claude-context/current-plan.txt')) {
    // Set contextSource = 'worktree'
  }

  // Priority 3: Fallback to repo root .claude/
  // Set contextSource = 'repo'
}
```

## Worktree-Specific Features

### 1. Worktree Log Files
From `plan_orchestrator.py:230-254`:
```python
def _get_log_file_path(self) -> str:
    """Worktree-specific log file: orchestrator-{plan-name}.log"""
    if plan_name:
        return str(Path(self.working_dir) / f"orchestrator-{plan_name}.log")
```

### 2. Working Directory Resolution
From `plan_orchestrator.py:221-228`:
```python
def _get_working_directory(self) -> str:
    """Returns worktree path if in worktree, otherwise cwd"""
    if self.worktree_path:
        return self.worktree_path
    return str(Path.cwd())
```

### 3. Environment Variable Passing
From `plan_orchestrator.py:449-462`:
```python
env = os.environ.copy()
if self.worktree_path:
    env["CLAUDE_WORKTREE"] = self.worktree_path

result = subprocess.run(
    ["claude", "-p", prompt, "--dangerously-skip-permissions"],
    cwd=self.working_dir,
    env=env,
)
```

## Planned Configuration

**File:** `.claude/git-workflow.json`

```json
{
  "worktrees": {
    "enabled": true,
    "directory": "worktrees",
    "max_concurrent": 3,
    "auto_cleanup": true,
    "stale_days": 14
  },
  "api": {
    "enabled": false,
    "port": 3100,
    "auth_required": true
  }
}
```

## TUI Visualization Opportunities

### 1. Multi-Pane Worktree Layout (Phase 6.1)
```
┌─ Plan: feature-auth ──────┬─ Plan: api-refactor ──────┐
│ Branch: plan/feature-auth │ Branch: plan/api-refactor │
│ [████████░░] 80%          │ [██░░░░░░░░] 20%          │
│                           │                           │
│ ⏳ 1.5 Auth middleware    │ ⏳ 2.1 Refactor routes   │
│ ⏳ 1.6 Session handling   │ ◯ 2.2 Update handlers   │
├─────────────── Activity ──┼─────────── Activity ──────┤
│ ✓ 1.4 completed (2m ago)  │ ✓ 2.0 completed (5m ago) │
└───────────────────────────┴───────────────────────────┘
```

### 2. Plan Switcher Panel
Quick navigation between worktrees:
```
┌─ Plan Switcher ─────────────────────────┐
│ [Tab] to switch, [Space] to focus       │
│                                         │
│ ● plan-feature-auth    [████░░] 80%    │
│ ○ plan-api-refactor    [██░░░░] 20%    │
│ ○ plan-perf-opt        [░░░░░░] 0%     │
└─────────────────────────────────────────┘
```

### 3. Resource Monitor
Track worktree resource usage:
```
┌─ Resource Usage ────────────────────────┐
│ Worktrees: 3/3 (max)                   │
│ Disk: 2.5 GB used                      │
│                                         │
│ Stale worktrees (>14 days):            │
│   ⚠ plan-old-feature (21 days)        │
└─────────────────────────────────────────┘
```

### 4. Cross-Worktree Conflict Detection
```
┌─ File Conflicts ────────────────────────┐
│ ⚠ 2 files modified by multiple plans   │
│                                         │
│ src/api.ts                             │
│   ├─ plan-feature-auth (task 1.5)      │
│   └─ plan-api-refactor (task 2.1)      │
│                                         │
│ Action: [Merge] [Rebase] [View Diff]   │
└─────────────────────────────────────────┘
```

## Implementation Priority for TUI

| Feature | Priority | Depends On |
|---------|----------|------------|
| Multi-pane layout | HIGH | Worktree Phase 2 |
| Plan switcher | HIGH | Worktree Phase 2 |
| Aggregate progress | MEDIUM | Already implemented |
| Resource monitor | MEDIUM | Worktree Phase 9 |
| Conflict detection | LOW | Worktree Phase 8 |
| REST API integration | LOW | Worktree Phase 10 |

## Key Implementation References

| File | Location | Purpose |
|------|----------|---------|
| `git-workflow-phase5-worktrees.md` | Phase 1-12 | Full worktree plan |
| `plan-status.js:2377-2448` | `detectWorktreeContext()` | Context resolution |
| `plan_orchestrator.py:192-228` | Worktree path resolution | Runtime detection |
| `plan_orchestrator.py:743-772` | Status monitor with worktree | TUI integration |
