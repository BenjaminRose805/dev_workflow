# Task 8.2: Orchestration Gap Analysis Review

**Date:** 2025-12-26
**Source:** `docs/plan-outputs/documentation-standards-analysis/findings/orchestration-flow-analysis.md`
**Purpose:** Document `[SEQUENTIAL]` handling gaps and dependency constraint issues for TUI expansion

---

## Executive Summary

The orchestration gap analysis identifies **6 critical gaps** in the orchestration pipeline that prevent reliable autonomous execution. These gaps directly impact TUI integration opportunities - the TUI could provide visual feedback and control surfaces that help users understand and work around these constraints.

---

## Gap Summary Table

| Gap | Component | Issue | TUI Opportunity |
|-----|-----------|-------|-----------------|
| Gap 1 | `status-cli.js next` | No ordering/constraint metadata returned | Show constraint badges on tasks |
| Gap 2 | `_build_prompt()` | Prompt lacks execution notes | Display execution notes in TUI |
| Gap 3 | `/plan:implement` Step 2 | No execution note parsing | Parse and surface annotations |
| Gap 4 | `/plan:implement` Step 4 | Assumes same-phase = parallel | Visualize grouping decisions |
| Gap 5 | Parallel Execution Rules | `[SEQUENTIAL]` not prioritized | Show sequential chains |
| Gap 6 | `status.json` schema | No constraint storage fields | Enable constraint editing |

---

## Gap 1: status-cli.js `next` Command

**Location:** `scripts/status-cli.js:373-473`

**Current Behavior:**
```javascript
next.push({
  id: task.id,
  description: task.description,
  phase: phase.number,
  status: task.status,
  reason: 'pending - ready to implement'
});
```

**Missing Metadata:**
- `sequential: boolean` - Whether task is in a sequential group
- `sequentialGroup: string` - Range like "3.1-3.4"
- `sequentialReason: string` - Why constraint exists
- `conflictsWith: string[]` - File conflict detection

**TUI Opportunity:**
The TUI could display:
- üîó Sequential chain indicator for grouped tasks
- ‚ö†Ô∏è File conflict warnings
- "Why can't these parallelize?" tooltips

---

## Gap 2: Prompt Building (`_build_prompt`)

**Location:** `scripts/plan_orchestrator.py:974-1015`

**Partial Implementation Found:**
The orchestrator now includes a `_build_constraints_section()` method that adds constraint information to prompts when tasks have sequential metadata. However, the constraint metadata must first come from `status-cli.js next` (Gap 1).

```python
def _build_constraints_section(self, tasks: list) -> str:
    """Build the Sequential Constraints section for the prompt."""
    groups = {}
    for task in tasks:
        if task.get("sequential"):
            group = task.get("sequentialGroup", "unknown")
            reason = task.get("sequentialReason", "")
            if group not in groups:
                groups[group] = reason
    # ... builds constraint section
```

**TUI Opportunity:**
- Show the "Sequential Constraints" section that will be sent to Claude
- Let users preview what context Claude will receive
- Allow constraint overrides before execution

---

## Gap 3: `/plan:implement` Task Parsing (Step 2)

**Issue:** Step 2 parses tasks but doesn't extract `**Execution Note:**` blocks.

**Current:** Parses phase headers and checklist items
**Missing:** `**Execution Note:** Tasks X.X-X.X are [SEQUENTIAL]...` parsing

**TUI Opportunity:**
- Display execution notes inline with phase headers
- Highlight tasks affected by execution notes
- Show "bound by constraint" visual grouping

---

## Gap 4: Execution Strategy (Step 4)

**Current Assumption:**
```
Tasks in SAME phase = can run in parallel
Tasks in DIFFERENT phases = must run sequentially
```

**Required Logic:**
```
1. Check [SEQUENTIAL] annotation ‚Üí force sequential
2. Detect file conflicts ‚Üí force sequential
3. Only remaining tasks ‚Üí can parallelize
```

**TUI Opportunity:**
- Visualize the execution grouping decision tree
- Show why tasks were grouped a certain way
- Display "Parallel Group 1", "Sequential Group 2" visually

---

## Gap 5: Parallel Execution Rules

**Current Rule Order:**
1. Same phase = parallel OK
2. Different phases = sequential
3. Explicit dependencies
4. Shared files = sequential

**Required Rule Order:**
1. **[SEQUENTIAL] annotation = ALWAYS sequential** (highest priority)
2. Same file = sequential
3. Same phase = parallel OK (fallback)

**TUI Opportunity:**
- Show rule evaluation order in a debug panel
- Highlight which rule caused sequential grouping
- "Task held back because:" explanation

---

## Gap 6: status.json Schema

**Current Task Schema:**
```json
{
  "id": "string",
  "description": "string",
  "status": "enum",
  "phase": "string"
}
```

**Proposed Extensions:**
```json
{
  "executionConstraints": {
    "sequential": true,
    "sequentialGroup": "3.1-3.4",
    "conflictsWith": ["3.2", "3.3"],
    "reason": "all modify orchestrator-system.md"
  }
}
```

**TUI Opportunity:**
- Store user constraint overrides
- Persist "run anyway" decisions
- Enable constraint editing UI

---

## Implementation Status Assessment

| Gap | Status | Evidence |
|-----|--------|----------|
| Gap 1 | Partially addressed | `sequential`, `sequentialGroup`, `sequentialReason` fields exist but not fully populated |
| Gap 2 | Addressed | `_build_constraints_section()` exists in orchestrator |
| Gap 3 | Not addressed | implement.md doesn't parse execution notes |
| Gap 4 | Partially addressed | `_filter_sequential_tasks()` filters by group |
| Gap 5 | Partially addressed | Orchestrator filters, but implement.md doesn't |
| Gap 6 | Not addressed | Schema doesn't have constraint fields |

---

## TUI Expansion Recommendations from Gap Analysis

### High Priority (Addresses Gaps 1, 4, 5)

1. **Sequential Chain Visualization Panel**
   - Show tasks linked in sequential chains
   - Display "held back" tasks with reason
   - Use box-drawing characters to show flow

2. **Constraint Badge System**
   - üîó Sequential group badge
   - ‚ö†Ô∏è File conflict badge
   - üìã Dependency badge

### Medium Priority (Addresses Gaps 2, 3)

3. **Execution Notes Display**
   - Show execution notes from phase headers
   - Inline with phase progress bars
   - Expandable detail view

4. **Claude Context Preview**
   - Show what constraints Claude will receive
   - Pre-flight check before execution
   - "View prompt" modal

### Lower Priority (Addresses Gap 6)

5. **Constraint Editor Panel**
   - Override sequential constraints
   - Add custom file conflict rules
   - Persisted in status.json

---

## Related Files

- `scripts/status-cli.js` - Task selection and metadata
- `scripts/plan_orchestrator.py` - Orchestration loop
- `.claude/commands/plan/implement.md` - Task execution instructions
- `scripts/lib/plan-status.js` - Plan file parsing

---

**End of Analysis**
