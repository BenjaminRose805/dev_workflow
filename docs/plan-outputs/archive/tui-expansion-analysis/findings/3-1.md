# Task 3.1: File Reference Extraction Algorithm Analysis

## Summary

The `extractFileReferences()` function in `scripts/lib/plan-status.js:1931-1976` extracts file paths from task descriptions using four complementary regex patterns. This enables automatic file conflict detection for parallel task execution.

## Algorithm Overview

**Location:** `scripts/lib/plan-status.js:1931-1976`

**Input:** Task description string (e.g., "Update `src/api.ts` and modify utils.js")

**Output:** Array of unique file paths found (e.g., `["src/api.ts", "utils.js"]`)

**Deduplication:** Uses `Set` to ensure each file appears only once

## Pattern Breakdown

### Pattern 1: Backtick-Quoted Paths

**Regex:** `/`([^`]+\.[a-zA-Z0-9]+)`/g`

**Purpose:** Extract file paths enclosed in markdown backticks

**Matches:**
| Input | Extracted |
|-------|-----------|
| `` Update `src/api.ts` `` | `src/api.ts` |
| `` Modify `scripts/lib/plan-status.js` `` | `scripts/lib/plan-status.js` |
| `` Check `config.json` `` | `config.json` |
| `` The `docs/README.md` file `` | `docs/README.md` |

**Pattern Breakdown:**
- `` ` `` - Opening backtick
- `([^`]+` - Capture anything except backticks
- `\.[a-zA-Z0-9]+)` - Must end with file extension
- `` ` `` - Closing backtick

**Filters Applied:**
```javascript
if (!filePath.includes(' ') && !filePath.includes('(') && !filePath.includes(')')) {
  files.add(filePath);
}
```
This excludes code snippets like `` `function()` `` or `` `console.log(x)` ``.

### Pattern 2: Common Directory Prefixes

**Regex:** `/\b(src|tests|docs|scripts|lib|\.claude)\/[\w./-]+\.[a-zA-Z0-9]+\b/g`

**Purpose:** Extract file paths starting with known directory prefixes, even without backticks

**Supported Prefixes:**
| Prefix | Typical Content |
|--------|-----------------|
| `src/` | Source code |
| `tests/` | Test files |
| `docs/` | Documentation |
| `scripts/` | Utility scripts |
| `lib/` | Library code |
| `.claude/` | Claude configuration |

**Matches:**
| Input | Extracted |
|-------|-----------|
| `Changes to src/lib/auth.ts are needed` | `src/lib/auth.ts` |
| `Add tests/unit/api.test.js` | `tests/unit/api.test.js` |
| `See docs/plans/my-plan.md` | `docs/plans/my-plan.md` |
| `Run scripts/status-cli.js` | `scripts/status-cli.js` |
| `Use lib/utils.js helpers` | `lib/utils.js` |
| `Check .claude/commands/plan.md` | `.claude/commands/plan.md` |

**Pattern Breakdown:**
- `\b` - Word boundary
- `(src|tests|docs|scripts|lib|\.claude)` - Known directory prefixes
- `\/` - Directory separator
- `[\w./-]+` - Path characters (word chars, dots, slashes, hyphens)
- `\.[a-zA-Z0-9]+` - File extension
- `\b` - Word boundary

### Pattern 3: Modify/Update Action Patterns

**Regex:** `/\b(?:modif(?:y|ying)|updat(?:e|ing)|edit(?:ing)?|chang(?:e|ing))\s+[`]?([a-zA-Z0-9_-]+\.[a-zA-Z0-9]+)[`]?\b/gi`

**Purpose:** Extract filenames following action verbs

**Supported Verbs:**
| Verb Form | Matches |
|-----------|---------|
| modify, modifying | `Modify config.json` |
| update, updating | `Updating utils.js` |
| edit, editing | `Edit status-cli.js` |
| change, changing | `Changing api.ts` |

**Matches:**
| Input | Extracted |
|-------|-----------|
| `Modify status-cli.js to add command` | `status-cli.js` |
| `Update plan-status.js with new function` | `plan-status.js` |
| `Editing config.json for settings` | `config.json` |
| `Changing auth.ts for new flow` | `auth.ts` |

**Pattern Breakdown:**
- `\b` - Word boundary
- `(?:modif(?:y|ying)|updat(?:e|ing)|edit(?:ing)?|chang(?:e|ing))` - Action verbs
- `\s+` - Whitespace
- `` [`]? `` - Optional backtick
- `([a-zA-Z0-9_-]+\.[a-zA-Z0-9]+)` - Filename with extension
- `` [`]? `` - Optional backtick
- `\b` - Word boundary
- `gi` - Global, case-insensitive

### Pattern 4: "in <filename>" Pattern

**Regex:** `/\bin\s+[`]?([a-zA-Z0-9_-]+\.(?:js|ts|tsx|jsx|json|md|py|sh))[`]?\b/gi`

**Purpose:** Extract filenames following "in" when referring to file location

**Limited Extensions:** Only matches common code file extensions to avoid false positives like "in package.json" where package is meant.

**Supported Extensions:**
- JavaScript: `.js`, `.jsx`
- TypeScript: `.ts`, `.tsx`
- Data: `.json`
- Documentation: `.md`
- Python: `.py`
- Shell: `.sh`

**Matches:**
| Input | Extracted |
|-------|-----------|
| `Create function in status-cli.js` | `status-cli.js` |
| `Add method in plan-status.js` | `plan-status.js` |
| `Define types in types.ts` | `types.ts` |

**Pattern Breakdown:**
- `\b` - Word boundary
- `in` - Literal "in"
- `\s+` - Whitespace
- `` [`]? `` - Optional backtick
- `([a-zA-Z0-9_-]+\.(?:js|ts|tsx|jsx|json|md|py|sh))` - Filename with specific extensions
- `` [`]? `` - Optional backtick
- `\b` - Word boundary
- `gi` - Global, case-insensitive

## Edge Case Handling

### Handled Correctly

| Scenario | Input | Result |
|----------|-------|--------|
| Null input | `null` | `[]` |
| Undefined input | `undefined` | `[]` |
| Empty string | `""` | `[]` |
| No files | `"No file references"` | `[]` |
| Duplicates | `` `src/api.ts` and src/api.ts `` | `["src/api.ts"]` |
| Mixed patterns | `` `a.ts`, modify b.js, tests/c.js `` | `["a.ts", "b.js", "tests/c.js"]` |
| Deeply nested | `src/lib/utils/helpers/index.ts` | `["src/lib/utils/helpers/index.ts"]` |

### Known Limitations

| Limitation | Example | Behavior |
|------------|---------|----------|
| Unquoted basenames | `Update README.md file` | Not extracted (no prefix) |
| Relative paths | `../parent/file.js` | Not extracted (no pattern) |
| Spaces in paths | `"my file.ts"` | Not extracted (space check) |
| Windows paths | `src\file.ts` | Not extracted (backslash) |
| No extension | `Makefile`, `Dockerfile` | Not extracted (extension required) |
| Unknown prefixes | `app/file.ts` | Not extracted (not in prefix list) |

## Conflict Detection Integration

The `detectFileConflicts()` function uses `extractFileReferences()` to build a file-to-tasks mapping:

**Location:** `scripts/lib/plan-status.js:1993-2036`

**Algorithm:**
1. For each task, call `extractFileReferences(task.description)`
2. Normalize file paths to lowercase for comparison
3. Build `Map<normalizedPath, {originalFile, taskIds[]}>`
4. Return files where `taskIds.length > 1`

**Example:**
```javascript
const tasks = [
  { id: '2.1', description: 'Update `src/api.ts` with endpoint' },
  { id: '2.2', description: 'Modify `src/api.ts` for auth' }
];

detectFileConflicts(tasks);
// Returns: [{ file: 'src/api.ts', taskIds: ['2.1', '2.2'] }]
```

## Usage in Task Selection

The `cmdNext()` function in `status-cli.js` uses conflict detection to:

1. Call `detectFileConflicts()` on pending/in_progress tasks
2. Add `hasFileConflicts: true` flag to conflicting tasks
3. Add `conflictsWith: ["2.2", "2.3"]` array to each conflicting task
4. Include `fileConflicts` array in output for TUI display

## Test Coverage

**Test File:** `scripts/tests/test-file-conflicts.js`

**Test Categories:**
- Backtick-quoted paths (3 tests)
- Common directory prefixes (5 tests)
- Modify/update patterns (3 tests)
- "in <filename>" patterns (2 tests)
- Edge cases (5 tests)
- Mixed patterns (1 test)
- Conflict detection (multiple tests)

**Total:** 31 tests passing

## TUI Display Opportunities

### File Conflict Visualization

| Location | Display | Data Source |
|----------|---------|-------------|
| Task List | `⚠` icon for conflicting tasks | `hasFileConflicts` |
| Task Detail | "Conflicts with: 2.2, 2.3" | `conflictsWith[]` |
| Conflict Panel | File-to-tasks matrix | `fileConflicts[]` |
| Graph View | Shared file nodes | `detectFileConflicts()` |

### Proposed Conflict Panel

```
┌──────────────────────────────────────────┐
│ FILE CONFLICTS                           │
├──────────────────────────────────────────┤
│ src/api.ts                               │
│   ├── 2.1: Add user endpoint             │
│   └── 2.2: Add auth middleware           │
│                                          │
│ scripts/status-cli.js                    │
│   ├── 3.1: Add 'next' command            │
│   ├── 3.2: Add 'deps' command            │
│   └── 3.3: Add 'estimate' command        │
└──────────────────────────────────────────┘
```

## Recommendations for Enhancement

### Add More Directory Prefixes

Current prefixes are limited. Consider adding:
- `app/` - Common in Next.js, Rails
- `components/` - React/Vue components
- `pages/` - Next.js pages
- `api/` - API routes
- `utils/` - Utilities
- `config/` - Configuration

**Implementation:**
```javascript
const dirPattern = /\b(src|tests|docs|scripts|lib|\.claude|app|components|pages|api|utils|config)\/[\w./-]+\.[a-zA-Z0-9]+\b/g;
```

### Add More Extensions to "in" Pattern

Current extensions are limited. Consider adding:
- `.yml`, `.yaml` - Configuration
- `.toml` - Cargo, pyproject
- `.css`, `.scss`, `.less` - Styles
- `.html` - Templates

### Handle Unquoted Basenames

Add a pattern for common file types mentioned by name:
```javascript
// Pattern 5: Common unquoted filenames
const basenamePattern = /\b(README|CHANGELOG|package|tsconfig|jest\.config|\.gitignore)\b\.?\w*/gi;
```

### Report Extraction Statistics

For debugging and TUI display:
```javascript
function extractFileReferencesWithStats(description) {
  const result = {
    files: [],
    stats: { backtick: 0, prefix: 0, action: 0, inFile: 0 }
  };
  // ... track which pattern extracted each file
  return result;
}
```
