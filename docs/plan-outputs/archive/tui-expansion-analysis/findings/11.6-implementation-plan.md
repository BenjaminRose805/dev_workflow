# Task 11.6: Implementation Plan for TUI Workflow Expansion

**Date:** 2025-12-26
**Purpose:** Create ready-to-execute implementation plan(s) based on HYBRID decision
**Inputs:** Tasks 11.1-11.5 (priority, quick wins, integration points, roadmap, architecture)

---

## Executive Summary

Based on the analysis in tasks 11.1-11.5, this document provides:

1. **Amendment PR** for `tui-integration-implementation.md` - Adding quick wins and compatible panels
2. **New Plan** `tui-workflow-expansion.md` - For architectural features requiring new infrastructure

**Decision:** HYBRID approach (as recommended in 11.3)
- **AMEND:** 13 new tasks (3 top-level, 22 subtasks) to existing plan
- **NEW PLAN:** 33 tasks across 6 phases for infrastructure features

---

## Part 1: Amendment to tui-integration-implementation.md

### 1.1 Changes Summary

| Section | Change Type | Tasks Added |
|---------|-------------|-------------|
| Phase 2.3 | Enhancement | +2 subtasks |
| Phase 2.4 | Enhancement | +3 subtasks |
| Phase 2.7 | New Task | +4 subtasks |
| Phase 4.6 | New Task | +5 subtasks |
| Phase 4.7 | New Task | +5 subtasks |
| Phase 5.6 | New Task | +4 subtasks |

### 1.2 Specific Amendments

#### Phase 2.3 Enhancement (Retry History Indicator)

Add to existing task 2.3:

```markdown
- [ ] 2.3 Implement Retry History Indicator (Gap G3) in `scripts/lib/tui.py`
  - [ ] 2.3.1 Read `retryCount` from task objects in status.json
  - [ ] 2.3.2 Display `[Retry N/3]` suffix for retried tasks
  - [ ] 2.3.3 Color-code based on retry count (yellow→orange→red)
  - [ ] 2.3.4 Show last error message on selection (expandable)
  + [ ] 2.3.5 Add orchestrator state badge to header (Running/Paused/Stopped)
  + [ ] 2.3.6 Add iteration count to header (Iteration: 12/50)
```

#### Phase 2.4 Enhancement (Inline Blockers Display)

Add to existing task 2.4:

```markdown
- [ ] 2.4 Implement Inline Blockers Display (Gap B1 partial) in `scripts/lib/tui.py`
  - [ ] 2.4.1 Query blockers via plan-orchestrator.js check
  - [ ] 2.4.2 Display `[Blocked by: X.Y]` indicator on tasks
  - [ ] 2.4.3 Dim tasks that cannot start due to dependencies
  + [ ] 2.4.4 Add sequential chain icon (⛓) to [SEQUENTIAL] tasks
  + [ ] 2.4.5 Add conflict badge (⚠) to tasks with file conflicts
  + [ ] 2.4.6 Show sequential group range [3.1-3.4] on affected tasks
```

#### Phase 2.7 (New - Git Quick Wins)

Add new task after 2.6:

```markdown
- [ ] 2.7 Implement Git Status Quick Wins in `scripts/lib/tui.py`
  - [ ] 2.7.1 Add current branch badge to header panel
  - [ ] 2.7.2 Add branch validation icon (✓/⚠) based on naming convention
  - [ ] 2.7.3 Add uncommitted changes count to footer stats
  - [ ] 2.7.4 Add "commits ahead of main" indicator to header
```

#### Phase 4.6 (New - Task Constraint Panel)

Add new task to Phase 4:

```markdown
- [ ] 4.6 Implement Task Constraint Panel in `scripts/tui/panels.py`
  - [ ] 4.6.1 Create `TaskConstraintPanel` class with collapsed/expanded states
  - [ ] 4.6.2 Load constraint data from `cmdNext()` output (sequentialGroups, fileConflicts)
  - [ ] 4.6.3 Render collapsed summary (e.g., "2 chains, 1 conflict")
  - [ ] 4.6.4 Render expanded view with sequential chains and file conflict details
  - [ ] 4.6.5 Add keyboard handling (`c` key to toggle)
```

#### Phase 4.7 (New - Batch Execution Panel)

Add new task to Phase 4:

```markdown
- [ ] 4.7 Implement Batch Execution Panel in `scripts/tui/panels.py`
  - [ ] 4.7.1 Create `BatchExecutionPanel` class with collapsed/expanded states
  - [ ] 4.7.2 Load current batch from status.json `in_progress` tasks
  - [ ] 4.7.3 Render collapsed view (e.g., "Batch: 3 tasks running")
  - [ ] 4.7.4 Render expanded view with batch composition and "Why this batch?" explainer
  - [ ] 4.7.5 Add keyboard handling (`b` key to toggle)
```

#### Phase 5.6 (New - Git Status Panel)

Add new task to Phase 5:

```markdown
- [ ] 5.6 Implement Git Status Panel in `scripts/tui/panels.py`
  - [ ] 5.6.1 Create `GitStatusPanel` class with collapsed/expanded states
  - [ ] 5.6.2 Implement collapsed single-line view (branch, uncommitted, ahead)
  - [ ] 5.6.3 Implement expanded view with diff preview, recent commits
  - [ ] 5.6.4 Add keyboard handling (`g` key to toggle)
```

### 1.3 Updated Phase Execution Notes

Update Phase 2 execution note:

```markdown
**Execution Note:** Tasks 2.1-2.7 are [SEQUENTIAL] - all modify TUI layout in `scripts/tui/` and `scripts/lib/tui.py` and must be integrated one at a time to avoid layout conflicts
```

Update Phase 4 execution note:

```markdown
**Execution Note:** Tasks 4.1-4.7 are [SEQUENTIAL] - all add visualization panels to TUI layout and must be integrated one at a time
```

---

## Part 2: New Plan - tui-workflow-expansion.md

Below is the complete new plan for architectural TUI features:

```markdown
# Implementation Plan: TUI Workflow Expansion

## Overview

- **Objective:** Add orchestrator control, event streaming, parallel execution dashboard, and multi-plan support to TUI
- **Priority:** P1 (High Value, requires infrastructure)
- **Created:** 2025-12-26
- **Output:** `docs/plan-outputs/tui-workflow-expansion/`
- **Analysis Reference:** `docs/plan-outputs/tui-expansion-analysis/`

> This plan implements the architectural features identified in the TUI Expansion Analysis. These features require new infrastructure (IPC, EventBus) and cannot be added as simple amendments to the existing TUI plan.

---

## Dependencies

### Upstream (Required)
- `tui-integration-implementation.md` - Phases 1-3 must be complete
  - Keyboard foundation
  - Panel toggle system
  - Basic command integration

### External Tools
- Python 3.8+
- Rich library (existing)
- Node.js for status-cli.js integration

---

## Phase 1: IPC Infrastructure

**Objective:** Enable bidirectional communication between TUI and orchestrator

**Effort:** ~16 hours | **Value:** Foundation for control features

- [ ] 1.1 Design IPC Protocol in `scripts/lib/ipc_protocol.py`
  - [ ] 1.1.1 Define `IPCCommand` dataclass with command, payload, id, timestamp
  - [ ] 1.1.2 Define `IPCResponse` dataclass with success, data, error fields
  - [ ] 1.1.3 Define command types enum (STATUS, PAUSE, RESUME, SET_BATCH_SIZE, RETRY, SKIP)
  - [ ] 1.1.4 Document protocol in `docs/standards/IPC-PROTOCOL.md`

- [ ] 1.2 Implement IPC Client in `scripts/lib/ipc_client.py`
  - [ ] 1.2.1 Create `IPCClient` class with file-based IPC
  - [ ] 1.2.2 Implement `send()` method with timeout handling
  - [ ] 1.2.3 Implement `is_connected()` health check
  - [ ] 1.2.4 Add cleanup for orphaned command/response files

- [ ] 1.3 Add IPC Server to Orchestrator in `scripts/plan_orchestrator.py`
  - [ ] 1.3.1 Create `IPCServer` class with command file watcher
  - [ ] 1.3.2 Implement command dispatcher to handler methods
  - [ ] 1.3.3 Add response file writer
  - [ ] 1.3.4 Integrate server start/stop with orchestrator lifecycle

- [ ] 1.4 Implement IPC Command Handlers in `scripts/plan_orchestrator.py`
  - [ ] 1.4.1 Implement STATUS handler - return current state
  - [ ] 1.4.2 Implement PAUSE handler - set pause flag, wait for current tasks
  - [ ] 1.4.3 Implement RESUME handler - clear pause flag
  - [ ] 1.4.4 Implement SET_BATCH_SIZE handler - update batch_size config
  - [ ] 1.4.5 Implement RETRY_TASK handler - reset task status
  - [ ] 1.4.6 Implement SKIP_TASK handler - mark task skipped

- [ ] **VERIFY 1:** IPC round-trip <100ms, all commands work, orchestrator responds

---

## Phase 2: Orchestrator Control Panel

**Objective:** Full runtime control of orchestrator from TUI

**Effort:** ~36 hours | **Value:** Production-essential

**Execution Note:** Tasks 2.1-2.7 are [SEQUENTIAL] - all modify control panel and require previous task state

- [ ] 2.1 Create Control Panel Class in `scripts/tui/control_panel.py`
  - [ ] 2.1.1 Create `OrchestratorControlPanel` class
  - [ ] 2.1.2 Add `OrchestratorState` enum (RUNNING, PAUSED, PAUSING, STOPPED)
  - [ ] 2.1.3 Inject IPCClient dependency
  - [ ] 2.1.4 Add expanded/collapsed state toggle

- [ ] 2.2 Implement Collapsed Control Bar in `scripts/tui/control_panel.py`
  - [ ] 2.2.1 Render single-line status (● RUNNING │ Iter: 12/50 │ Batch: 5)
  - [ ] 2.2.2 Show state with color-coded symbol
  - [ ] 2.2.3 Show keyboard hints ([P]ause [R]esume [+/-]Size)

- [ ] 2.3 Implement Execution State Section in `scripts/tui/control_panel.py`
  - [ ] 2.3.1 Create state section panel
  - [ ] 2.3.2 Display current state, iteration, elapsed time
  - [ ] 2.3.3 List active tasks with IDs
  - [ ] 2.3.4 Add pause/resume/quit controls

- [ ] 2.4 Implement Batch Size Control in `scripts/tui/control_panel.py`
  - [ ] 2.4.1 Create batch size section panel
  - [ ] 2.4.2 Render visual slider (1-10 range)
  - [ ] 2.4.3 Add +/- key handlers
  - [ ] 2.4.4 Send SET_BATCH_SIZE on change

- [ ] 2.5 Implement Failed Task Actions in `scripts/tui/control_panel.py`
  - [ ] 2.5.1 Create failed tasks section panel
  - [ ] 2.5.2 List failed tasks with retry count
  - [ ] 2.5.3 Add retry (r), skip (s), error detail (e) actions
  - [ ] 2.5.4 Send RETRY_TASK or SKIP_TASK via IPC

- [ ] 2.6 Implement Stuck Detection Section in `scripts/tui/control_panel.py`
  - [ ] 2.6.1 Create stuck detection panel
  - [ ] 2.6.2 Display stuck task with time info
  - [ ] 2.6.3 Add extend (x), skip (k), retry (r) actions
  - [ ] 2.6.4 Show auto-action countdown

- [ ] 2.7 Integrate Control Panel with TUI in `scripts/lib/tui.py`
  - [ ] 2.7.1 Add control panel to layout
  - [ ] 2.7.2 Add `Ctrl+O` toggle keybinding
  - [ ] 2.7.3 Connect keyboard events to control panel
  - [ ] 2.7.4 Refresh control panel state each cycle

- [ ] **VERIFY 2:** Pause/resume works, batch size changes, retry/skip from TUI

---

## Phase 3: Event Bus Infrastructure

**Objective:** Create event bus for real-time updates

**Effort:** ~18 hours | **Value:** Foundation for event streaming

- [ ] 3.1 Create EventBus Class in `scripts/lib/event_bus.py`
  - [ ] 3.1.1 Create `EventBus` class with thread-safe history
  - [ ] 3.1.2 Implement `emit()` method with subscriber notification
  - [ ] 3.1.3 Implement `subscribe()` and `unsubscribe()` methods
  - [ ] 3.1.4 Add circular buffer for history (max 1000 events)

- [ ] 3.2 Define Event Types in `scripts/lib/event_types.py`
  - [ ] 3.2.1 Create `EventType` enum (task.*, git.*, agent.*, phase.*, etc.)
  - [ ] 3.2.2 Create `Event` dataclass with type, timestamp, data, id
  - [ ] 3.2.3 Define event data schemas for each type
  - [ ] 3.2.4 Document event types in `docs/standards/EVENT-TYPES.md`

- [ ] 3.3 Integrate Event Emission in Orchestrator in `scripts/plan_orchestrator.py`
  - [ ] 3.3.1 Add EventBus instance to orchestrator
  - [ ] 3.3.2 Emit task.started, task.completed, task.failed events
  - [ ] 3.3.3 Emit phase.completed events
  - [ ] 3.3.4 Emit iteration.start, iteration.complete events

- [ ] 3.4 Integrate Event Emission in Claude Runner in `scripts/lib/claude_runner.py`
  - [ ] 3.4.1 Emit agent.spawn, agent.complete events
  - [ ] 3.4.2 Emit tool.start, tool.end events (throttled)
  - [ ] 3.4.3 Pass EventBus through callback chain

- [ ] 3.5 Add Event Persistence in `scripts/lib/event_persistence.py`
  - [ ] 3.5.1 Create `EventPersistence` class with file append
  - [ ] 3.5.2 Implement `load_recent()` for TUI startup
  - [ ] 3.5.3 Add rotation for large event files

- [ ] **VERIFY 3:** Events emitted, history accessible, persistence works

---

## Phase 4: Real-time Event Stream Panel

**Objective:** Real-time event visualization in TUI

**Effort:** ~34 hours | **Value:** Monitoring and debugging

**Execution Note:** Tasks 4.1-4.5 are [SEQUENTIAL] - all modify event stream panel incrementally

- [ ] 4.1 Create Event Stream Panel Class in `scripts/tui/event_stream.py`
  - [ ] 4.1.1 Create `EventStreamPanel` class
  - [ ] 4.1.2 Subscribe to EventBus for real-time updates
  - [ ] 4.1.3 Add expanded/collapsed state toggle
  - [ ] 4.1.4 Add paused state for freezing stream

- [ ] 4.2 Implement Collapsed Stream View in `scripts/tui/event_stream.py`
  - [ ] 4.2.1 Render compact 8-line event list
  - [ ] 4.2.2 Format events with timestamp, icon, message
  - [ ] 4.2.3 Show (paused) indicator when frozen

- [ ] 4.3 Implement Expanded View with Cards in `scripts/tui/event_stream.py`
  - [ ] 4.3.1 Render full event cards with details
  - [ ] 4.3.2 Add selection highlighting
  - [ ] 4.3.3 Add scroll with j/k navigation
  - [ ] 4.3.4 Show event-specific details

- [ ] 4.4 Implement Event Type Cards in `scripts/tui/event_stream.py`
  - [ ] 4.4.1 Design task.started card
  - [ ] 4.4.2 Design task.completed card with duration
  - [ ] 4.4.3 Design task.failed card with error
  - [ ] 4.4.4 Design git.commit card
  - [ ] 4.4.5 Design agent.spawn/complete cards
  - [ ] 4.4.6 Design constraint.applied card
  - [ ] 4.4.7 Design phase.completed card

- [ ] 4.5 Implement Filter Bar in `scripts/tui/event_stream.py`
  - [ ] 4.5.1 Add filter toggles for event categories
  - [ ] 4.5.2 Implement `f` key to cycle filters
  - [ ] 4.5.3 Show active filter state

- [ ] 4.6 Integrate Event Stream with TUI in `scripts/lib/tui.py`
  - [ ] 4.6.1 Add event stream panel to layout
  - [ ] 4.6.2 Add `Ctrl+E` toggle keybinding
  - [ ] 4.6.3 Add `p` key for pause/resume stream
  - [ ] 4.6.4 Add `c` key for clear history

- [ ] **VERIFY 4:** Events stream in real-time, filters work, cards render correctly

---

## Phase 5: Parallel Execution Dashboard

**Objective:** Comprehensive parallel execution visibility

**Effort:** ~20 hours | **Value:** Key for parallel plan management

- [ ] 5.1 Create Parallel Dashboard Class in `scripts/tui/parallel_dashboard.py`
  - [ ] 5.1.1 Create `ParallelExecutionDashboard` class
  - [ ] 5.1.2 Add expanded/collapsed state toggle
  - [ ] 5.1.3 Implement data refresh with caching

- [ ] 5.2 Implement Active Sessions Section in `scripts/tui/parallel_dashboard.py`
  - [ ] 5.2.1 Show task/agent count bars
  - [ ] 5.2.2 List running tasks with elapsed time
  - [ ] 5.2.3 Track peak concurrency

- [ ] 5.3 Implement Constraints Section in `scripts/tui/parallel_dashboard.py`
  - [ ] 5.3.1 Show [PARALLEL]/[SEQUENTIAL] mode
  - [ ] 5.3.2 Display sequential chains
  - [ ] 5.3.3 Display file conflicts

- [ ] 5.4 Implement Commit Queue Section in `scripts/tui/parallel_dashboard.py`
  - [ ] 5.4.1 Show queue status (processing, pending)
  - [ ] 5.4.2 List pending commits
  - [ ] 5.4.3 Show commit stats

- [ ] 5.5 Integrate Dashboard with TUI in `scripts/lib/tui.py`
  - [ ] 5.5.1 Add dashboard to layout
  - [ ] 5.5.2 Add `p` key toggle (non-conflicting)
  - [ ] 5.5.3 Refresh on each cycle

- [ ] **VERIFY 5:** Dashboard shows all parallel state, updates correctly

---

## Phase 6: Multi-Plan View

**Objective:** Manage multiple plans from single TUI

**Effort:** ~33 hours | **Value:** Power user feature

- [ ] 6.1 Create Plan Registry Class in `scripts/lib/plan_registry.py`
  - [ ] 6.1.1 Create `PlanRegistry` class
  - [ ] 6.1.2 Scan for active plans in docs/plans/
  - [ ] 6.1.3 Load status.json for each plan
  - [ ] 6.1.4 Track plan metadata (branch, worktree)

- [ ] 6.2 Create Multi-Plan View Class in `scripts/tui/multi_plan_view.py`
  - [ ] 6.2.1 Create `MultiPlanView` class
  - [ ] 6.2.2 Add plan list with progress summary
  - [ ] 6.2.3 Add plan selection highlighting

- [ ] 6.3 Implement Plan Selector Modal in `scripts/tui/multi_plan_view.py`
  - [ ] 6.3.1 Create plan picker popup
  - [ ] 6.3.2 Show plan name, progress, branch
  - [ ] 6.3.3 Navigate with j/k, select with Enter

- [ ] 6.4 Implement Dashboard View in `scripts/tui/multi_plan_view.py`
  - [ ] 6.4.1 Create side-by-side progress view
  - [ ] 6.4.2 Show active task for each plan
  - [ ] 6.4.3 Color-code by health (green/yellow/red)

- [ ] 6.5 Implement Plan Switching in `scripts/lib/tui.py`
  - [ ] 6.5.1 Update current-plan.txt on switch
  - [ ] 6.5.2 Reload all panels with new plan context
  - [ ] 6.5.3 Show switch confirmation

- [ ] 6.6 Integrate Multi-Plan View with TUI in `scripts/lib/tui.py`
  - [ ] 6.6.1 Add `Ctrl+P` to open plan selector
  - [ ] 6.6.2 Add multi-plan dashboard as optional panel
  - [ ] 6.6.3 Show current plan in header

- [ ] **VERIFY 6:** Plan switching works, dashboard shows all plans, no data cross-contamination

---

## Success Criteria

### Functional Requirements
- [ ] Pause/resume orchestrator from TUI
- [ ] Adjust batch size during execution
- [ ] Retry/skip failed tasks from TUI
- [ ] Real-time event stream visible
- [ ] Multiple plans manageable from single TUI
- [ ] Parallel execution state fully visible

### Quality Requirements
- [ ] IPC round-trip <100ms
- [ ] Event display latency <200ms
- [ ] No memory leaks from event history
- [ ] TUI refresh <100ms with all panels

### Compatibility Requirements
- [ ] Works on Linux, macOS, WSL2
- [ ] Graceful degradation if orchestrator unreachable
- [ ] Backward compatible with non-orchestrated usage

---

## Risks and Mitigations

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| IPC complexity | HIGH | HIGH | Start with file-based IPC |
| Event volume overwhelming | MEDIUM | MEDIUM | Throttle, filter, limit display |
| Race conditions in IPC | HIGH | LOW | Timeouts, atomic operations |
| Memory growth | MEDIUM | MEDIUM | Circular buffers, max sizes |
| Multi-plan state confusion | MEDIUM | LOW | Clear current plan indicators |

---

## Related Documents

- Analysis: `docs/plan-outputs/tui-expansion-analysis/findings/`
- Architecture: `findings/11.5-architectural-considerations.md`
- Roadmap: `findings/11.4-implementation-roadmap.md`
- Integration: `findings/11.3-integration-points.md`
- Existing TUI Plan: `docs/plans/tui-integration-implementation.md`
```

---

## Part 3: Implementation Files Created

### 3.1 Files Created

| File | Purpose |
|------|---------|
| This document (11.6-implementation-plan.md) | Complete implementation guide |
| Amendment details above | Changes to tui-integration-implementation.md |
| New plan above | tui-workflow-expansion.md full content |

### 3.2 Next Steps

1. **Apply Amendments** - Update tui-integration-implementation.md with changes from Part 1
2. **Create New Plan** - Create tui-workflow-expansion.md with content from Part 2
3. **Initialize Output Directories** - Run `node scripts/status-cli.js init` for new plan
4. **Begin Phase 1** - Start with Quick Wins (Bundle 1-3)

---

## Summary

This implementation plan provides:

| Deliverable | Tasks | Effort | Priority |
|-------------|-------|--------|----------|
| Amendment to existing TUI plan | 3 new top-level + 22 subtasks | ~54 hours | P0 |
| New tui-workflow-expansion.md | 33 tasks, 6 phases | ~151 hours | P1 |
| **Total** | **58 tasks** | **~205 hours** | - |

The HYBRID approach allows:
- Immediate progress on quick wins without blocking on infrastructure
- Parallel development of infrastructure features
- Clear separation of concerns between plans
- Easier tracking and verification

---

**End of Implementation Plan**
