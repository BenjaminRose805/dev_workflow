# Script Caller Analysis

This document identifies all callers of each script in the orchestrator system, which is critical for understanding the impact of changes during the simplification process.

## 1. plan-runner.sh Callers

| Caller | Location | Usage |
|--------|----------|-------|
| `plan_orchestrator.py` | Line 58, 816 | Main entry point; calls `status` and other commands |
| `.claude/commands/plan/orchestrate.md` | Line 27, 49 | Documentation; shows `status` and `next` commands |
| Test suite | `scripts/tests/test-plan-runner-sh.js` | Unit tests |

**Summary:** `plan-runner.sh` is primarily called by `plan_orchestrator.py` (Python TUI) and the orchestrate command documentation.

---

## 2. plan-orchestrator.js Callers

| Caller | Location | Usage |
|--------|----------|-------|
| `plan-runner.sh` | Lines 33, 38, 47, 51 | Delegates `status`, `next`, `check`, `phases` |
| `scripts/tests/test-orchestrator-e2e.py` | Lines 151-152, 174, 268 | E2E tests |
| Test suite | `scripts/tests/test-plan-orchestrator.js` | Unit tests |

**Summary:** `plan-orchestrator.js` is primarily called by `plan-runner.sh`, which acts as a thin bash wrapper.

---

## 3. status-cli.js Callers

### From Python Code

| Caller | Location | Usage |
|--------|----------|-------|
| `plan_orchestrator.py` | Line 862 | `retryable` command |
| `plan_orchestrator.py` | Line 880 | `increment-retry` command |
| `plan_orchestrator.py` | Line 897 | `mark-started` command |
| `plan_orchestrator.py` | Line 911 | `detect-stuck` command |
| `plan_orchestrator.py` | Lines 1255-1310 | Prompt instructions for Claude (mark-started, mark-complete, mark-failed, progress) |
| `switch_plan.py` | Line 238 | Documentation display |

### From Claude Commands

| Caller | Location | Usage |
|--------|----------|-------|
| `.claude/commands/plan/create.md` | Line 107 | `init` command |
| `.claude/commands/plan/migrate.md` | Lines 115, 137-138 | `status`, `mark-complete` commands |
| `.claude/commands/plan/set.md` | Line 30 | `init` command |
| `.claude/commands/plan/orchestrate.md` | Lines 83, 88, 92 | `mark-started`, `mark-complete`, `mark-failed` |
| `.claude/commands/plan/_common/status-tracking.md` | Lines 110-121 | Multiple commands documented |

### From Tests

| Caller | Location | Usage |
|--------|----------|-------|
| `test-status-cli.js` | Throughout | All command unit tests |
| `test-recovery.js` | Line 50 | Recovery scenario tests |
| `test-parallel-updates.js` | Lines 131-132 | Parallel update tests |
| `test-orchestrator-e2e.py` | Lines 198, 215, 239, 264-265 | E2E tests |
| `test-lib-modules.js` | Throughout | Library tests |

### From Other Scripts

| Caller | Location | Usage |
|--------|----------|-------|
| (None directly - only via subprocess) | | |

**Summary:** `status-cli.js` is the most widely used script, called from:
- Python orchestrator (4+ direct subprocess calls)
- Claude commands (5 command files)
- All test suites

---

## 4. status-manager.js Callers

| Caller | Location | Usage |
|--------|----------|-------|
| `status-cli.js` | Line 41 | Imports `initializePlanStatus` |
| `scripts/tests/test-lib-modules.js` | Line 133 | Unit tests |

**Summary:** `status-manager.js` is only directly called by `status-cli.js` for initialization. All other functionality is accessed via `status-cli.js` commands.

---

## 5. plan-output-utils.js Callers

| Caller | Location | Usage |
|--------|----------|-------|
| `status-cli.js` | Line 60 | Imports many functions |
| `status-manager.js` | Lines 9-24 | Imports core functions |
| `plan-orchestrator.js` | Lines 33, 38 | References OUTPUT_BASE constant pattern |
| `scripts/tests/test-lib-modules.js` | Line 215 | Unit tests |

**Exports used by status-cli.js:**
- `loadStatus`, `saveStatus`, `updateTaskStatus`
- `getStatusPath`, `getProgress`, `startRun`, `completeRun`
- `writeFindings`, `readFindings`, `recalculateSummary`
- `validateSummary`, `ensureSummaryKeys`
- `getOutputDir`, `getFindingsDir`, `getTimestampsDir`
- `getRetryableTasks`, `getExhaustedTasks`, `incrementRetryCount`
- `detectAndMarkStuckTasks`, `STUCK_TASK_THRESHOLD_MS`

**Summary:** `plan-output-utils.js` is the core library with 20+ exports, primarily consumed by `status-cli.js` and `status-manager.js`.

---

## 6. plan-pointer.js Callers

| Caller | Location | Usage |
|--------|----------|-------|
| `status-cli.js` | Line 40 | Imports `getActivePlanPath` |
| `plan-orchestrator.js` | Line 31 | Imports `getActivePlanPath` |
| `scripts/tests/test-lib-modules.js` | Line 101 | Unit tests |

**Summary:** `plan-pointer.js` is imported by both `status-cli.js` and `plan-orchestrator.js` for plan path resolution.

---

## Dependency Graph Summary

```
                    ┌──────────────────┐
                    │ plan_orchestrator│
                    │     .py          │
                    └────────┬─────────┘
                             │
          ┌──────────────────┼──────────────────┐
          │                  │                  │
          ▼                  ▼                  ▼
  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐
  │ plan-runner.sh│  │ status-cli.js │  │ Claude CLI    │
  └───────┬───────┘  └───────┬───────┘  │ (prompts)     │
          │                  │          └───────────────┘
          ▼                  │
  ┌───────────────┐          │
  │plan-orchestr- │          │
  │   ator.js     │          │
  └───────┬───────┘          │
          │                  │
          └────────┬─────────┘
                   │
                   ▼
          ┌───────────────┐
          │  plan-pointer │
          │     .js       │
          └───────────────┘
                   │
                   ▼
          ┌───────────────┐
          │ status-manager│
          │     .js       │
          └───────────────┘
                   │
                   ▼
          ┌───────────────┐
          │plan-output-   │
          │   utils.js    │
          └───────────────┘
```

---

## Impact Analysis for Simplification

### Phase 1: Remove plan-runner.sh
**Impact:**
- Update `plan_orchestrator.py` line 58 to call `node scripts/plan-orchestrator.js` directly
- Update `plan_orchestrator.py` line 816 similarly
- Update `.claude/commands/plan/orchestrate.md` documentation

### Phase 2: Consolidate Libraries
**Impact:**
- Update `status-cli.js` imports (line 41, 60)
- Update `plan-orchestrator.js` imports (line 31)
- Update tests

### Phase 3: Merge plan-orchestrator.js into status-cli.js
**Impact:**
- Update `plan-runner.sh` → No longer needed after Phase 1
- Update `plan_orchestrator.py` to call `status-cli.js` for `status`, `next`, `check`, `phases`
- Update tests

### Phase 4: Standardize Path Resolution
**Impact:**
- Remove `.claude/current-plan-output.txt` pointer
- Update all path derivation to use plan name
- No external caller changes needed

---

## Call Frequency (Estimated)

| Script | Calls per Orchestration Run |
|--------|----------------------------|
| `status-cli.js` | 5-50+ (mark-started/complete per task) |
| `plan-orchestrator.js` | 2-10 (status queries) |
| `plan-runner.sh` | 2-10 (delegates to plan-orchestrator.js) |
| `status-manager.js` | 1 (initialization) |
| `plan-output-utils.js` | 10-100+ (via status-cli.js) |
| `plan-pointer.js` | 10-100+ (via status-cli.js/plan-orchestrator.js) |

---

## Conclusion

The analysis confirms the simplification plan's approach:
1. `plan-runner.sh` is an unnecessary bash wrapper - can be eliminated
2. `plan-orchestrator.js` and `status-cli.js` have overlapping query functionality
3. Libraries have clear layering: `plan-pointer.js` → `status-manager.js` → `plan-output-utils.js`
4. `status-cli.js` is the primary interface for all status operations
