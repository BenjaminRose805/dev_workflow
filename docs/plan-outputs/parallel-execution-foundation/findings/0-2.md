# Task 0.2: Review Current Argument Parsing Extension Points

## Analysis Summary

Reviewed `scripts/status-cli.js` to understand how to add `--plan` argument support.

## Current Architecture

### Entry Point: `main()` (lines 955-1057)

```javascript
function main() {
  const args = process.argv.slice(2);
  
  if (args.length === 0 || args[0] === '--help' || args[0] === '-h') {
    showHelp();
    process.exit(0);
  }
  
  const parsed = parseArgs(args);
  const { command, positional, options } = parsed;
  
  // Plan path always comes from current-plan.txt
  const planPath = getActivePlanPath();
  if (!planPath) {
    exitWithError('No active plan set. Use /plan:set to choose a plan first.');
  }
  
  // Dispatch to command handler
  switch (command) {
    case 'status': cmdStatus(planPath); break;
    // ... other commands
  }
}
```

### Argument Parser: `parseArgs()` (lines 93-120)

```javascript
function parseArgs(args) {
  const result = {
    command: args[0],
    positional: [],
    options: {}
  };
  
  let i = 1;
  while (i < args.length) {
    const arg = args[i];
    if (arg.startsWith('--')) {
      const key = arg.slice(2);
      // Check if next arg is a value or another flag
      if (i + 1 < args.length && !args[i + 1].startsWith('--')) {
        result.options[key] = args[i + 1];
        i += 2;
      } else {
        result.options[key] = true;
        i += 1;
      }
    } else {
      result.positional.push(arg);
      i += 1;
    }
  }
  
  return result;
}
```

## Identified Extension Points

### 1. Pre-parse `--plan` in `main()` (Recommended)

The cleanest approach is to extract `--plan <path>` from args BEFORE calling `parseArgs()`:

```javascript
function main() {
  let args = process.argv.slice(2);
  
  // Extract --plan argument first
  let explicitPlanPath = null;
  const planIndex = args.indexOf('--plan');
  if (planIndex !== -1 && planIndex + 1 < args.length) {
    explicitPlanPath = args[planIndex + 1];
    args = [...args.slice(0, planIndex), ...args.slice(planIndex + 2)];
  }
  
  // ... rest of parsing ...
  
  // Use explicit plan or fall back to current-plan.txt
  const planPath = explicitPlanPath || getActivePlanPath();
}
```

### 2. Add helper function in `plan-status.js`

Create `getPlanPathFromArgs(args)` that:
- Checks for `--plan` argument in args
- Falls back to `getActivePlanPath()` if not provided  
- Validates plan file exists
- Returns `{ planPath, args }` (cleaned args with --plan removed)

### 3. Command Handler Pattern

All command handlers already receive `planPath` as first parameter:

```javascript
function cmdStatus(planPath) { ... }
function cmdMarkStarted(planPath, taskId) { ... }
function cmdNext(planPath, countStr) { ... }
```

This means NO changes are needed to individual command handlers.

## Recommended Implementation Strategy

1. **Add to `plan-status.js`:**
   - New function `getPlanPathFromArgs(args)` that handles extraction and validation
   
2. **Modify `status-cli.js` `main()`:**
   - Call `getPlanPathFromArgs()` early
   - Use returned plan path for all commands
   
3. **Update `showHelp()`:**
   - Document `--plan <path>` option

## Files to Modify

| File | Change |
|------|--------|
| `scripts/lib/plan-status.js` | Add `getPlanPathFromArgs()` helper |
| `scripts/status-cli.js` | Modify `main()` to use helper |
| `scripts/status-cli.js` | Update `showHelp()` output |

## No Breaking Changes

- `--plan` is optional; absence falls back to `current-plan.txt`
- All existing command syntax remains unchanged
- Command handlers don't need modification
