# Task 10.3: Test Cleanup Commands

## Test Objective

Verify that the `/plan:cleanup` command works correctly for:
- Listing stale plan branches
- Listing expired archive tags
- Deleting stale branches (local and remote)
- Archive mode (create tags before deletion)
- Archive retention and cleanup
- Confirmation prompts and safety features

## Test Cases

### TC-10.3.1: Cleanup Command Exists

**Action:** Verify `/plan:cleanup` command file exists

**Command:**
```bash
test -f .claude/commands/plan/cleanup.md && echo "EXISTS" || echo "NOT FOUND"
```

**Result:** PASS
- File exists at `.claude/commands/plan/cleanup.md`
- 617 lines of comprehensive documentation

### TC-10.3.2: Command Usage Documentation

**Action:** Verify usage section documents all options

**Expected Options:**
- `--delete` - Delete stale branches and archives
- `--archive` - Create archive tag before deletion
- `--yes` - Skip confirmation prompts
- `--days N` - Custom age threshold
- `--keep-archives` - Skip archive tag cleanup

**Result:** PASS
- All options documented in Usage section (lines 8-14)
- Argument table in section 1 (lines 20-28)

### TC-10.3.3: Configuration Loading

**Action:** Verify cleanup reads configuration from git-workflow.json

**Configuration Options Used:**
- `cleanup_age_days` (default: 30) - line 50-51
- `archive_branches` (default: true) - line 54
- `archive_retention_days` (default: 90) - line 57-58

**Result:** PASS
- Configuration loading documented in section 2 (lines 40-69)
- Defaults provided when config file missing
- Command-line `--days` flag overrides config

### TC-10.3.4: Stale Branch Detection

**Action:** Verify stale branch detection logic

**Verification Points:**
1. Lists local plan branches: `git branch --list 'plan/*'` (line 83)
2. Gets last commit date per branch (line 88)
3. Calculates age in days (line 92)
4. Includes remote-only branches (lines 103-121)

**Result:** PASS
- Complete stale branch detection in section 3
- Both local and remote-only branches detected
- Age calculated from last commit timestamp

### TC-10.3.5: Branch Display Format

**Action:** Verify stale branches are displayed with useful info

**Expected Format:**
```
Branch                              Age    Last Commit
─────────────────────────────────────────────────────────
plan/old-feature                    45d    abc1234 Add feature X
```

**Result:** PASS
- Display format documented in section 4 (lines 124-147)
- Shows branch name, age in days, commit hash and message
- "(remote-only)" indicator for remote-only branches

### TC-10.3.6: Delete Mode with Confirmation

**Action:** Verify delete mode requires confirmation

**Verification Points:**
1. Lists branches to be deleted (lines 159-167)
2. Confirmation prompt using AskUserQuestion (lines 173-185)
3. Warning text before confirmation (lines 188-196)
4. Cancel option exits gracefully (lines 199-201)

**Result:** PASS
- Delete confirmation implemented in section 5
- Clear warning about irreversibility
- Cancel option available

### TC-10.3.7: --yes Flag Skips Confirmation

**Action:** Verify `--yes` flag skips confirmation prompt

**Verification Points:**
1. Flag documented in argument table (line 26)
2. "If `--yes` flag is passed, skip directly to Step 3" (line 169)

**Result:** PASS
- `--yes` flag properly skips confirmation
- Enables non-interactive deletion for scripts

### TC-10.3.8: Branch Type Handling

**Action:** Verify all branch types are handled correctly

**Branch Types:**
| Type | Detection | Action |
|------|-----------|--------|
| Local + Remote | Has local AND remote tracking | Delete both |
| Local only | Has local, no remote | Delete local only |
| Remote only | No local, has origin/ | Delete remote only |

**Result:** PASS
- Branch type table documented (lines 213-217)
- Deletion logic handles all three scenarios (lines 218-259)
- Separate output for each deletion action

### TC-10.3.9: Archive Mode

**Action:** Verify `--archive` creates tags before deletion

**Verification Points:**
1. Runs BEFORE deletion (line 279)
2. Tag format: `archive/plan/{branch-name}` (line 300)
3. Annotated tag with metadata (lines 309-317)
4. Duplicate handling (lines 303-306)

**Result:** PASS
- Archive mode documented in section 6 (lines 275-331)
- Proper tag format and annotation
- Handles both local and remote-only branches
- Skips if tag already exists

### TC-10.3.10: Expired Archive Tag Detection

**Action:** Verify expired archive tags are identified

**Verification Points:**
1. Respects `--keep-archives` flag (lines 335-338)
2. Lists tags matching `archive/plan/*` (line 352)
3. Calculates age from tag creation date (lines 355-358)
4. Falls back to commit date for lightweight tags (lines 360-361)

**Result:** PASS
- Archive tag detection in section 7 (lines 333-395)
- Uses configurable retention period
- Handles edge cases (no date, lightweight tags)

### TC-10.3.11: Archive Tag Deletion

**Action:** Verify expired archive tags can be deleted

**Verification Points:**
1. Confirmation required (lines 416-426)
2. Deletes local tags (line 438)
3. Deletes remote tags if they exist (lines 444-450)
4. Output shows deletion status

**Result:** PASS
- Archive tag deletion in section 8 (lines 397-466)
- Both local and remote tags handled
- Graceful failure handling

### TC-10.3.12: Summary Report

**Action:** Verify summary report is generated

**Report Includes:**
- List mode: Count of stale branches and expired tags, suggested commands
- Delete mode: Deleted counts, archived counts, warnings

**Result:** PASS
- Comprehensive summary in section 9 (lines 468-530)
- Different formats for list vs delete mode
- Includes any warnings/failures

### TC-10.3.13: Safety Features

**Action:** Verify safety features are in place

**Safety Notes (lines 582-588):**
1. Never deletes currently checked-out branch
2. Never deletes branch for active plan
3. Confirmation required (unless --yes)
4. Archive option available
5. Graceful failure handling

**Result:** PASS
- All safety features documented
- Protection against accidental deletion

### TC-10.3.14: Archive Retention Policy

**Action:** Verify archive retention policy is documented

**Documentation (lines 551-581):**
1. Phase 1: Branch archiving (immediate)
2. Phase 2: Archive cleanup (after retention period)
3. Recommended retention periods by team size
4. How to preserve archives indefinitely

**Result:** PASS
- Two-phase cleanup approach documented
- Configurable retention periods
- Options for permanent preservation

### TC-10.3.15: Example Commands

**Action:** Verify comprehensive examples exist

**Examples (lines 590-616):**
- List mode: `/plan:cleanup`
- Delete with confirmation: `/plan:cleanup --delete`
- Archive first: `/plan:cleanup --delete --archive`
- Keep archives: `/plan:cleanup --delete --keep-archives`
- Non-interactive: `/plan:cleanup --delete --yes`
- Custom age: `/plan:cleanup --days 60`
- Combined options

**Result:** PASS
- All common use cases covered
- Clear examples for each scenario

## Summary

| Test Case | Status |
|-----------|--------|
| TC-10.3.1 | PASS |
| TC-10.3.2 | PASS |
| TC-10.3.3 | PASS |
| TC-10.3.4 | PASS |
| TC-10.3.5 | PASS |
| TC-10.3.6 | PASS |
| TC-10.3.7 | PASS |
| TC-10.3.8 | PASS |
| TC-10.3.9 | PASS |
| TC-10.3.10 | PASS |
| TC-10.3.11 | PASS |
| TC-10.3.12 | PASS |
| TC-10.3.13 | PASS |
| TC-10.3.14 | PASS |
| TC-10.3.15 | PASS |

**Overall Result:** PASS (15/15 test cases passed)

The `/plan:cleanup` command is fully implemented with:
- Stale branch detection (local and remote)
- Expired archive tag detection
- Safe deletion with confirmation
- Archive mode for branch preservation
- Configurable age thresholds
- Comprehensive safety features
- Clear documentation and examples
