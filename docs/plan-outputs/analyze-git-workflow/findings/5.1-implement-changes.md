# Task 5.1: Map Changes Needed in /plan:implement

## Executive Summary

**Current State:** The `/plan:implement` command documents a commit-per-task workflow (Section 6.1, lines 430-481) but does not enforce it. Branch validation is absent, and git state tracking in status.json is incomplete.

**Recommended Changes:** Implement branch validation, enforce commit-per-task, enhance commit messages with metadata, and integrate git state into status.json.

**Estimated Total Effort:** 12-18 hours for MVP, 8-12 hours for Phase 2 enhancements.

---

## 1. Branch Validation

### Current State

- No branch validation exists
- Tasks execute on whatever branch is currently active
- Risk: Committing to `main` instead of plan branch

### Required Changes

**Add new section: "1.6 Branch Validation"**

Before executing tasks, ensure we're on the correct plan branch:

```javascript
const planName = path.basename(planPath, '.md');
const expectedBranch = `plan/${planName}`;
const currentBranch = execSync('git rev-parse --abbrev-ref HEAD').toString().trim();
```

**Handle scenarios:**

| Current Branch | Status.json Branch | Action |
|----------------|-------------------|--------|
| `main` | Not set | Create branch |
| `main` | Set to `plan/X` | Switch to `plan/X` |
| `plan/X` | Same as current | Continue |
| `plan/Y` | Different plan | Error - wrong plan |
| Not a git repo | N/A | Skip git operations |

**Skip branch validation when:**
- Not a git repository
- `--no-git` flag provided
- Environment variable `PLAN_SKIP_GIT=1`

**Priority:** MVP - Critical for branch-per-plan strategy
**Estimated Effort:** 2-3 hours

---

## 2. Commit Enforcement

### Current State

- Section 6.1 (lines 430-481) documents commit workflow
- Uses imperative language ("commit the changes") not enforcement
- Commit is described but not required in the workflow

### Required Changes

**Replace Section 6.1 with enforced version:**

```markdown
### 6.1. Commit Changes After Task Completion

**REQUIRED:** After marking a task complete or failed, you MUST commit changes to git (unless skip conditions apply).

**Commit enforcement workflow:**

1. Check git repository status
2. Check for uncommitted changes
3. Stage all changes: `git add -A`
4. Create commit with enhanced metadata
5. Capture commit SHA: `git rev-parse HEAD`
6. Update status.json with commit SHA
7. Handle commit failures gracefully
```

**Enhanced commit message format:**
```
task(1.1): Create authentication middleware

Plan: implement-authentication
Phase: Phase 1: Core Implementation
Duration: 45s
Files: 3 changed
Type: feat

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

**Skip commits when:**
- Not a git repository
- No file changes (analysis tasks)
- `--dry-run` mode enabled
- `--no-git` flag provided

**Do NOT skip commits for:**
- Failed tasks (commit with failed status for debugging)
- Partial changes (commit what exists)

**Priority:** MVP - Foundation for rollback and history
**Estimated Effort:** 3-4 hours

---

## 3. Commit Message Enhancement

### Current State

```
task {id}: {description}

Plan: {plan-name}
Phase: {phase-name}
```

### Recommended Additions

| Field | Source | Format |
|-------|--------|--------|
| Duration | `task.startedAt` to `task.completedAt` | `45s` or `2m 15s` |
| Files | `git diff --stat HEAD~1` | `3 changed` |
| Type | Infer from description | `feat\|fix\|refactor\|test\|docs\|chore` |
| Commit SHA | `git rev-parse HEAD` | Store in status.json |

**Type inference function:**
```javascript
function inferTaskType(description) {
  const desc = description.toLowerCase();
  if (/\b(add|implement|create|introduce)\b/.test(desc)) return 'feat';
  if (/\b(fix|correct|resolve|repair)\b/.test(desc)) return 'fix';
  if (/\b(refactor|restructure|reorganize)\b/.test(desc)) return 'refactor';
  if (/\b(test|spec|coverage)\b/.test(desc)) return 'test';
  if (/\b(document|doc|readme)\b/.test(desc)) return 'docs';
  return 'chore';
}
```

**Priority:** Phase 2 (MVP uses simpler format)
**Estimated Effort:** 2-3 hours

---

## 4. Error Handling

### Git-Specific Errors to Handle

**Branch doesn't exist:**
- Offer to create branch
- Error if user declines

**Uncommitted changes before task starts:**
- Warn user
- Offer: Commit, Stash, or Ignore

**Commit hook rejects commit:**
- Log warning but continue
- Task succeeds, commit pending manual fix

**Merge conflict in staging:**
- Error and halt (shouldn't happen on isolated branch)

**Priority:** Phase 2
**Estimated Effort:** 2-3 hours

---

## 5. Status Integration

### status.json Schema Additions

**Plan-level git state:**
```json
{
  "gitBranch": "plan/my-plan",
  "gitBaseBranch": "main",
  "gitRemote": null
}
```

**Task-level git tracking:**
```json
{
  "id": "1.1",
  "status": "completed",
  "commitSha": "abc123def456",
  "commitMessage": "task(1.1): Create auth middleware",
  "committedAt": "2025-12-24T10:05:00Z"
}
```

### Rollback Lookup Utility

```javascript
function getCommitForTask(planPath, taskId) {
  const status = loadStatus(planPath);
  const task = status.tasks.find(t => t.id === taskId);
  return task?.commitSha || null;
}
```

**Priority:** MVP - Essential for rollback lookup
**Estimated Effort:** 2-3 hours

---

## 6. Implementation Priority

### MVP (Phase 1) - 10-14 hours

| Component | Change | Effort |
|-----------|--------|--------|
| Section 1.6 (new) | Branch validation | 2-3h |
| Section 6.1 | Enforce commits | 3-4h |
| plan-status.js | Add git fields to schema | 2-3h |
| Section 6 | Update status with SHA | 1h |
| Testing | Test scenarios | 2-3h |

**Deliverables:**
- Branch created on first task execution
- Each task commits with basic message
- Commit SHA stored in status.json
- Branch tracked in status.json

### Phase 2 Enhancements - 7-11 hours

| Component | Change | Effort |
|-----------|--------|--------|
| Commit messages | Enhanced metadata | 2-3h |
| Error handling | Git-specific errors | 2-3h |
| plan-status.js | Rollback utilities | 1-2h |
| Edge cases | Uncommitted changes | 2-3h |

---

## 7. File Locations Reference

| File | Changes Needed |
|------|----------------|
| `.claude/commands/plan/implement.md` | Add 1.6, modify 6.1 |
| `scripts/lib/plan-status.js` | Extend schema (lines 649-660), add functions |

---

## 8. Success Criteria

- [ ] 100% of tasks create commits (unless analysis-only)
- [ ] All commits have task ID in message
- [ ] All commits have SHA in status.json
- [ ] Branch name persisted in status.json
- [ ] Zero commits to main branch
- [ ] Git errors handled gracefully
