# Task 3.4: Commit Message Format Design

## Overview

This analysis designs a commit message format for the plan orchestration system that balances machine parseability with human readability. The format must support task ID linking, rollback operations, changelog generation, and status tracking.

## Executive Summary

**Current State:**
- Documented format: `task {id}: {description}` with plan/phase in body
- Reality: Inconsistent implementation

**Recommendation:**
- **PRIMARY FORMAT:** Task-Type Hybrid (Option C)
- **PHASE COMMITS:** Structured summaries with task lists
- **PLAN COMMITS:** Squashed summaries with phase breakdown
- **PARSING:** Simple regex patterns for task ID extraction

---

## 1. Conventional Commits Review

### Standard Format
```
<type>[optional scope]: <description>

[optional body]

[optional footer(s)]
```

### Common Types
| Type | Purpose |
|------|---------|
| `feat` | New feature |
| `fix` | Bug fix |
| `docs` | Documentation |
| `refactor` | Code restructuring |
| `test` | Tests |
| `chore` | Maintenance |

### Applicability to Orchestrator

**Conflicts:**
- Task IDs don't map to conventional types
- Plans span multiple types (feat + test + docs)

**Useful concepts to borrow:**
- Type prefix for categorization
- Footer format for metadata
- Breaking change indicator

---

## 2. Task ID Linking Requirements

### Extractability
```bash
# Extract task ID
git log --grep="task 1.1:" --oneline

# Regex pattern
^task\((\d+\.\d+)\): (.+)$
```

### Plan/Phase Context
```
Plan: implement-authentication
Phase: Phase 1: Core Implementation
```

---

## 3. Proposed Commit Message Formats

### Option A: Task-Prefixed (Current)
```
task 1.1: Create authentication middleware

Plan: implement-auth
Phase: Phase 1: Core Implementation
Duration: 45s
```

**Score: 7.5/10**

### Option B: Conventional + Task
```
feat(auth): create authentication middleware

Task: 1.1
Plan: implement-auth
```

**Score: 7.25/10** (Task ID not in subject)

### Option C: Hybrid (RECOMMENDED)
```
task(1.1): Create authentication middleware

Plan: implement-auth
Phase: Phase 1: Core Implementation
Duration: 45s
Type: feat

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

**Score: 8.25/10**

### Option D: Machine-First
```
[PLAN:auth][TASK:1.1] Create authentication middleware
```

**Score: 4.75/10** (Poor human readability)

---

## 4. Body Format Specification

### Required Fields
```
Plan: {plan-name}
Phase: {phase-name}
```

### Optional Fields
```
Duration: {seconds}s
Type: {feat|fix|refactor|test|docs|chore}
Files: {count} changed
```

### Footer Format
```
ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

---

## 5. Phase/Plan Commit Formats

### Phase Completion
```
phase(1): Complete Core Implementation

Plan: implement-auth
Tasks: 1.1, 1.2, 1.3, 1.4, 1.5
Duration: 23m 45s

Task summary:
- 1.1: Create authentication middleware
- 1.2: Add user model
- 1.3: Implement login endpoint

Verification: All tests passing
```

### Plan Completion (Squash Merge)
```
plan: implement-auth (18 tasks across 4 phases)

Duration: 2h 15m 34s

Phases:
- Phase 1: Core Implementation (5 tasks)
- Phase 2: User Management (6 tasks)
- Phase 3: Testing (5 tasks)
- Phase 4: Documentation (2 tasks)

Granular history: git log archive/plan-implement-auth
```

---

## 6. Machine Parsing Requirements

### Regex Patterns

**Task ID from subject:**
```regex
^task\((\d+\.\d+)\):
```

**Plan from body:**
```regex
^Plan: (.+)$
```

**Phase from body:**
```regex
^Phase: (.+)$
```

### Git Log Filtering
```bash
# Find task commit
git log --grep="^task(1.1):" -1 --format="%H"

# Find all plan commits
git log --grep="^Plan: implement-auth$" --oneline

# Find by type
git log --all-match --grep="^task" --grep="^Type: feat$"
```

---

## 7. Human Readability

### Scanability in `git log --oneline`

**Option C (Recommended):**
```
abc123 task(1.5): Add logout endpoint
def456 task(1.4): Implement refresh tokens
ghi789 task(1.3): Create JWT middleware
```

- Task IDs immediately visible
- Clean, conventional-ish format
- Scannable prefix pattern

### GitHub/GitLab UI Best Practices
- Subject under 50 characters
- Use imperative mood ("Add" not "Added")
- Blank lines between sections in body

---

## 8. Recommendations

### 8.1 Primary Format: Task Commits

```
task({id}): {imperative description}

Plan: {plan-name}
Phase: {phase-name}
Duration: {time}
Type: {feat|fix|refactor|test|docs|chore}

{optional detailed explanation}

ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
Co-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>
```

### 8.2 Type Inference
```javascript
function inferTaskType(description) {
  if (/\b(add|implement|create)\b/i.test(description)) return 'feat';
  if (/\b(fix|correct|resolve)\b/i.test(description)) return 'fix';
  if (/\b(refactor|restructure)\b/i.test(description)) return 'refactor';
  if (/\b(test|spec)\b/i.test(description)) return 'test';
  if (/\b(document|doc)\b/i.test(description)) return 'docs';
  return 'chore';
}
```

### 8.3 Validation Hook
```bash
#!/bin/bash
# .git/hooks/commit-msg

SUBJECT=$(head -1 "$1")

if [[ $SUBJECT =~ ^task\([0-9]+\.[0-9]+\): ]]; then
  # Check subject length
  if [ ${#SUBJECT} -gt 72 ]; then
    echo "ERROR: Subject too long"
    exit 1
  fi

  # Check required fields
  if ! grep -q "^Plan:" "$1"; then
    echo "ERROR: Missing 'Plan:' field"
    exit 1
  fi
fi
```

---

## 9. Format Comparison

| Aspect | Option A | Option B | Option C | Option D |
|--------|----------|----------|----------|----------|
| Task ID in subject | Yes | No | Yes | Yes |
| Conventional-ish | No | Yes | Partial | No |
| Parsing complexity | Low | Medium | Low | Very Low |
| Tooling support | Low | High | Medium | None |
| Human readability | High | High | High | Low |
| **Overall** | 7.5/10 | 7.25/10 | **8.25/10** | 4.75/10 |

**Winner: Option C (Hybrid)**

---

## 10. Implementation Priority

**Phase 1 (Immediate):**
- Update `/plan:implement` to use Option C format
- Add Duration and Type fields
- Update documentation

**Phase 2 (Near-term):**
- Add commit validation hook
- Implement commit parser library
- Create `/plan:complete` with squash format

**Phase 3 (Future):**
- Changelog generation scripts
- Conventional commit tooling integration

---

## 11. Success Criteria

- [ ] All task commits follow `task({id}): {description}` format
- [ ] Task ID extraction works reliably
- [ ] Plan/phase context preserved in body
- [ ] Rollback can locate commits by task ID
- [ ] Git log remains human-readable
- [ ] Status.json tracks commit SHAs
