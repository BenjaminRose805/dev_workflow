# Task 4.2: Merge Trigger Design

## Overview

This design establishes **merge triggers** - automated and manual mechanisms for integrating plan branches back to main. Three trigger types are defined with safety checks, user confirmation flows, and failure handling.

---

## 1. Plan Completion Trigger

### Activation

User invokes `/plan:complete` command after all tasks are marked complete.

### Pre-Merge Checks

| Condition | Pass Criteria | Failure Action |
|-----------|---------------|----------------|
| All tasks complete | `pending == 0 && in_progress == 0` | Error: list pending tasks |
| On plan branch | Branch starts with `plan/` | Error: run /plan:set first |
| No uncommitted changes | `git status --porcelain` empty | Prompt to commit |
| Tests passing (optional) | Exit code 0 | Warning: merge anyway? |

### Workflow

```
/plan:complete
    ↓
Pre-checks (all must pass)
    ↓
Verification (/plan:verify all)
    ↓
User confirmation (summary + proceed?)
    ↓
Create archive tag (safety)
    ↓
Switch to main
    ↓
Squash merge
    ↓
Commit with metadata
    ↓
Run tests on merged state
    ↓
Push to origin
    ↓
Cleanup (delete branch, update status)
```

### Post-Merge Actions

1. Update status.json: `status: "merged"`
2. Delete local plan branch
3. Delete remote plan branch
4. Push merge commit to main
5. Create completion tag: `plan/{name}/complete`

---

## 2. Phase Completion Trigger

### Two Strategies

#### Strategy A: Accumulate (RECOMMENDED DEFAULT)

```json
{
  "phase_merge_strategy": "accumulate"
}
```

**Behavior:**
- VERIFY passes → Tag phase boundary, continue on same branch
- All phases accumulate until `/plan:complete`
- Main branch receives one squashed commit at end

**Advantages:**
- Clean main history (1 commit per plan)
- Atomic plan integration
- Simpler workflow

#### Strategy B: Incremental Merge

```json
{
  "phase_merge_strategy": "incremental"
}
```

**Behavior:**
- VERIFY passes → Merge phase to main immediately
- Each phase becomes separate merge commit
- Plan completion just closes tracking

**Use When:**
- Plans span weeks/months
- Each phase delivers independent value
- Need continuous integration to main

### Phase Workflow (Accumulate)

```bash
# After phase 1 VERIFY passes
git tag "plan/$PLAN_NAME/phase-1-complete"
echo "Phase 1 complete. Continuing on branch..."

# All phases accumulate
# Merge only on /plan:complete
```

---

## 3. Manual Trigger

### Use Cases

| Scenario | Command | Outcome |
|----------|---------|---------|
| Emergency hotfix | `/plan:merge --partial --urgent` | Merge completed tasks only |
| Partial value delivery | `/plan:merge --completed-only` | Merge what's done |
| Pause long plan | `/plan:merge --checkpoint` | Save progress |
| Salvage work | `/plan:merge --salvage` | Merge good work, discard failed |

### Safety Checks (Stricter than completion)

- Explicit confirmation required
- Must acknowledge incomplete tasks
- Test status required
- No in-progress tasks allowed

### Command Interface

```bash
# Emergency partial merge
/plan:merge --partial --confirm

# Checkpoint (save progress, keep plan active)
/plan:merge --checkpoint --message "WIP: Middleware complete"

# Force merge (DANGEROUS)
/plan:merge --force --confirm --i-know-what-im-doing
```

---

## Failure Handling

### Merge Conflicts

```bash
# Detection before merge
git merge-tree $(git merge-base HEAD main) HEAD main > /tmp/preview
if grep -q "<<<<<" /tmp/preview; then
  echo "CONFLICT DETECTED"
  # Options: resolve, rebase, abort
fi
```

### Recovery

```bash
# Abort and restore
git merge --abort

# If already committed, revert
git revert HEAD --no-edit
```

---

## Configuration

```json
{
  "merge_triggers": {
    "plan_completion": {
      "enabled": true,
      "strategy": "squash",
      "require_verification": true,
      "run_tests": true,
      "auto_cleanup": true
    },
    "phase_completion": {
      "enabled": false,
      "strategy": "accumulate",
      "prompt_user": true
    },
    "manual": {
      "enabled": true,
      "require_confirmation": true,
      "safety_checks": "strict"
    }
  }
}
```

---

## Summary

| Trigger | When to Use | Merge Strategy | Risk Level |
|---------|-------------|----------------|------------|
| Plan Completion | All tasks done | Squash | Low |
| Phase Completion (Accumulate) | VERIFY pass | Tag only | Low |
| Phase Completion (Incremental) | VERIFY pass | Per-phase merge | Medium |
| Manual (Partial) | Emergency | Selective | High |
