# Task 6.5: Pre-Commit Hook Integration Evaluation

## Executive Summary

Pre-commit hooks present both opportunities and challenges for the plan orchestration system. This analysis evaluates integration strategies, identifies potential conflicts with autonomous execution, and recommends a **hook-aware execution model** that respects existing hooks while preventing CI/orchestrator failures.

**Key Recommendation:** Implement hook bypass for trusted autonomous contexts (`--no-verify` in CI/orchestrator) while maintaining strict hook enforcement for manual commits.

---

## 1. Pre-Commit Hook Overview

### 1.1 Git Hooks Relevant to Orchestrator

| Hook | Trigger | Purpose | Risk Level |
|------|---------|---------|------------|
| `pre-commit` | Before commit | Lint, format, test | HIGH |
| `commit-msg` | After message entered | Validate format | MEDIUM |
| `prepare-commit-msg` | Before editor opens | Template messages | LOW |
| `pre-push` | Before push | Remote validation | MEDIUM |
| `post-commit` | After commit | Notifications, logs | LOW |

### 1.2 Common Pre-Commit Tools

```bash
# Husky (npm)
npm install husky --save-dev
npx husky install

# pre-commit (Python)
pip install pre-commit
pre-commit install

# lefthook (Go)
lefthook install

# Native git hooks
.git/hooks/pre-commit
```

### 1.3 Typical Pre-Commit Actions

| Action | Time Impact | Failure Risk |
|--------|-------------|--------------|
| Linting (ESLint/Prettier) | 2-10s | MEDIUM |
| Type checking (tsc) | 5-30s | MEDIUM |
| Unit tests | 10-60s | HIGH |
| Secrets detection | 1-5s | LOW |
| File size limits | <1s | LOW |
| Code formatting | 2-10s | LOW (auto-fix) |

---

## 2. Orchestrator Integration Scenarios

### 2.1 Scenario: Hooks Present, Autonomous Mode

**Problem:** Pre-commit hooks run on every `git commit`, even in autonomous mode.

```
/plan:implement 1.1 1.2 --autonomous
       │
       ▼
┌──────────────────┐
│ Claude writes    │
│ code changes     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ git commit       │ ◀── Pre-commit hook runs!
└────────┬─────────┘
         │
         ▼ (if hook fails)
┌──────────────────┐
│ Commit rejected  │ ◀── Task marked FAILED
└──────────────────┘
```

**Issue:** Hook failures block autonomous execution even for valid code changes.

### 2.2 Scenario: Hook Auto-Fixes Code

```
Claude writes:   const x = "hello"  (no semicolon)
Prettier fixes:  const x = "hello"; (semicolon added)
Hook exits:      0 (success)
Commit:          Includes Prettier's fix
```

**Issue:** Claude's code differs from committed code. Generally acceptable, but can confuse Claude on re-read.

### 2.3 Scenario: Hook Detects AI-Generated Patterns

Some security hooks flag:
- Large file additions
- Unusual code patterns
- Missing license headers
- Credential-like strings

**Issue:** AI-generated code may trigger false positives.

---

## 3. Integration Options

### Option A: Hook Bypass in Autonomous Mode

**Implementation:**

```bash
# In /plan:implement commit logic
if [ "$AUTONOMOUS_MODE" == "true" ]; then
    git commit --no-verify -m "task(1.1): ..."
else
    git commit -m "task(1.1): ..."
fi
```

**Pros:**
- Fast, predictable execution
- No hook failures blocking progress
- Simpler orchestrator logic

**Cons:**
- Bypasses security checks
- May accumulate lint errors
- "Dirty" commits possible

**Score: 6/10**

### Option B: Hook Enforcement (Current Behavior)

**Implementation:**

```bash
# Always run hooks
git commit -m "task(1.1): ..."
# If hook fails, task fails
```

**Pros:**
- Consistent code quality
- Security checks enforced
- Same behavior as manual work

**Cons:**
- Hooks can block valid work
- Slow execution (hooks run every commit)
- Unpredictable in CI environments

**Score: 5/10**

### Option C: Selective Hook Execution (RECOMMENDED)

**Implementation:**

```bash
# Detect hook configuration
HOOKS_ENABLED=$(git config --get core.hooksPath || echo ".git/hooks")

# Quick hooks only in autonomous mode
if [ "$AUTONOMOUS_MODE" == "true" ]; then
    # Run only fast, non-blocking hooks
    export SKIP=eslint,test   # pre-commit framework
    git commit -m "task(1.1): ..."
else
    git commit -m "task(1.1): ..."
fi
```

**Pros:**
- Preserves essential checks (secrets, commit-msg)
- Skips slow/flaky checks (tests, full lint)
- Configurable per project

**Cons:**
- Requires hook framework support
- More complex configuration
- May not work with native hooks

**Score: 8/10**

### Option D: Phase-End Hook Execution

**Implementation:**

```
task 1.1 commit → --no-verify
task 1.2 commit → --no-verify
task 1.3 commit → --no-verify
VERIFY 1 commit → full hooks + lint --fix
```

**Pros:**
- Fast task execution
- Quality gates at phase boundaries
- Batch fix reduces noise

**Cons:**
- Deferred quality issues
- Large fix commits possible
- Complex verification logic

**Score: 7/10**

---

## 4. Hook Framework Support

### 4.1 Husky (npm)

```bash
# Skip specific hooks
HUSKY=0 git commit -m "..."

# .husky/pre-commit
#!/bin/sh
if [ "$ORCHESTRATOR_MODE" = "1" ]; then
    exit 0  # Skip in orchestrator mode
fi
npm test
```

### 4.2 pre-commit (Python)

```yaml
# .pre-commit-config.yaml
repos:
  - repo: local
    hooks:
      - id: eslint
        stages: [commit]
        # SKIP=eslint git commit skips this

# Skip syntax
SKIP=eslint,pytest git commit -m "..."
```

### 4.3 lefthook

```yaml
# lefthook.yml
pre-commit:
  commands:
    lint:
      skip:
        - ref: LEFTHOOK_ORCHESTRATOR
      run: npm run lint
```

### 4.4 Native Git Hooks

```bash
#!/bin/bash
# .git/hooks/pre-commit

# Check for orchestrator bypass flag
if [ "$ORCHESTRATOR_NO_HOOKS" = "1" ]; then
    echo "Skipping pre-commit hooks (orchestrator mode)"
    exit 0
fi

# Normal hook logic
npm run lint
npm test
```

---

## 5. Claude Code Hook Integration

### 5.1 Claude Code's Hook System

Claude Code has its own hook system via `CLAUDE.md`:

```markdown
<!-- In CLAUDE.md -->
## Hooks

user-prompt-submit-hook: npm run validate-prompt
tool-call-hook: npm run log-tool-call
```

**Important:** These are DIFFERENT from git hooks. They run within Claude Code, not git.

### 5.2 Potential Conflicts

| Claude Code Hook | Git Hook | Conflict? |
|-----------------|----------|-----------|
| pre-tool-call | - | No |
| post-tool-call | - | No |
| - | pre-commit | Yes (timing) |
| - | commit-msg | Yes (format) |

### 5.3 Coordination Strategy

```
Claude Code Session
       │
       ▼
  tool-call-hook  ◀── Claude Code hook (before git)
       │
       ▼
  git commit      ◀── Git pre-commit hook (inside git)
       │
       ▼
  post-tool-call  ◀── Claude Code hook (after git)
```

**Recommendation:** Log hook execution for debugging:

```bash
# In CLAUDE.md
tool-call-hook: |
  echo "[HOOK] $(date) tool-call: $TOOL_NAME" >> orchestrator.log
```

---

## 6. Commit Message Hook (commit-msg)

### 6.1 Format Validation Hook

From task 3.4, the recommended format is `task({id}): {description}`.

```bash
#!/bin/bash
# .git/hooks/commit-msg

SUBJECT=$(head -1 "$1")

# Allow orchestrator commits
if [[ $SUBJECT =~ ^task\([0-9]+\.[0-9]+\): ]]; then
    # Validate task format
    if [ ${#SUBJECT} -gt 72 ]; then
        echo "ERROR: Subject too long (${#SUBJECT} > 72)"
        exit 1
    fi
    exit 0
fi

# Allow phase/plan commits
if [[ $SUBJECT =~ ^(phase|plan)\([0-9]+\): ]]; then
    exit 0
fi

# Allow WIP commits
if [[ $SUBJECT =~ ^WIP: ]]; then
    exit 0
fi

# Reject unknown format (optional strictness)
echo "WARNING: Non-standard commit format"
echo "Expected: task(X.X): description"
exit 0  # Exit 0 to allow, exit 1 to reject
```

### 6.2 Integration with Orchestrator

The orchestrator's commit messages are already formatted correctly:

```javascript
// From /plan:implement
const commitMessage = `task(${taskId}): ${description}

Plan: ${planName}
Phase: ${phaseName}
`;
```

**Hook Behavior:** Should PASS for orchestrator commits, WARN for manual commits.

---

## 7. Recommended Configuration

### 7.1 Environment Variables

```bash
# Set by orchestrator
export ORCHESTRATOR_MODE=1
export ORCHESTRATOR_NO_HOOKS=0    # 0=respect hooks, 1=bypass all
export ORCHESTRATOR_SKIP_HOOKS="eslint,test"  # Specific hooks to skip
```

### 7.2 Hook Detection

```javascript
function detectHookConfiguration() {
    // Check for hook frameworks
    const hasHusky = fs.existsSync('.husky');
    const hasPreCommit = fs.existsSync('.pre-commit-config.yaml');
    const hasLefthook = fs.existsSync('lefthook.yml');
    const hasNativeHooks = fs.readdirSync('.git/hooks')
        .some(f => !f.endsWith('.sample'));

    return {
        framework: hasHusky ? 'husky' :
                   hasPreCommit ? 'pre-commit' :
                   hasLefthook ? 'lefthook' :
                   hasNativeHooks ? 'native' : null,
        hasHooks: hasHusky || hasPreCommit || hasLefthook || hasNativeHooks
    };
}
```

### 7.3 Project Configuration

```yaml
# orchestrator.config.yaml (proposed)
git:
  hooks:
    mode: selective  # bypass | enforce | selective
    skip:
      - eslint       # Skip in autonomous mode
      - test         # Skip in autonomous mode
    always_run:
      - commit-msg   # Always validate format
      - secrets      # Always check for secrets
```

---

## 8. Error Handling

### 8.1 Hook Failure Recovery

```
Pre-commit hook failed!
Exit code: 1
Output:
  ESLint found 3 errors in src/auth.ts

Options:
  [R] Retry after fixing (Claude attempts fix)
  [S] Skip hook (--no-verify)
  [A] Abort task
```

### 8.2 Automatic Fix Strategy

```javascript
async function handleHookFailure(error, files) {
    if (error.includes('ESLint') || error.includes('Prettier')) {
        // Attempt auto-fix
        await exec('npx eslint --fix ' + files.join(' '));
        await exec('npx prettier --write ' + files.join(' '));

        // Retry commit
        return retryCommit();
    }

    if (error.includes('test failed')) {
        // Cannot auto-fix, task fails
        return { status: 'failed', reason: 'Test failure' };
    }
}
```

### 8.3 Logging Hook Execution

```
2025-12-24 15:30:45 [GIT] Running pre-commit hook
2025-12-24 15:30:48 [GIT] Hook: eslint (3.2s) - PASSED
2025-12-24 15:30:49 [GIT] Hook: prettier (1.1s) - PASSED (auto-fixed)
2025-12-24 15:30:50 [GIT] Hook: secrets (0.3s) - PASSED
2025-12-24 15:30:50 [GIT] Pre-commit complete (4.6s total)
```

---

## 9. Security Considerations

### 9.1 Hooks to NEVER Bypass

| Hook Type | Reason |
|-----------|--------|
| Secrets detection | Prevent credential leaks |
| License headers | Legal compliance |
| Signed commits | Authentication |
| Branch protection | Policy enforcement |

### 9.2 CI Environment Handling

```bash
# In CI, hooks may not be installed
if [ "$CI" == "true" ]; then
    # Skip hook management, CI has its own checks
    git commit --no-verify -m "..."
fi
```

### 9.3 Malicious Hook Protection

- Never execute hooks from untrusted repositories
- Validate hook content before execution
- Log all hook executions for audit

---

## 10. Implementation Recommendations

### 10.1 Immediate (Phase 1)

1. **Add hook detection** to `/plan:set`
   - Report hook configuration
   - Warn if slow hooks detected

2. **Add environment variable support** to `/plan:implement`
   - `ORCHESTRATOR_MODE=1` for hook-aware behavior
   - Respect `SKIP` for pre-commit framework

3. **Update commit logic**
   - Try with hooks first
   - On failure, offer options (retry/skip/abort)

### 10.2 Near-term (Phase 2)

4. **Add commit-msg hook template**
   - Validate task format
   - Allow WIP/phase/plan formats

5. **Add hook configuration file**
   - `orchestrator.config.yaml` with hook preferences
   - Per-project customization

### 10.3 Future (Phase 3)

6. **Add hook execution logging**
   - Duration tracking
   - Failure rate metrics

7. **Add auto-fix integration**
   - Retry with `--fix` flags
   - Report auto-fixes to user

---

## 11. Summary

### Key Decisions

| Decision | Choice | Rationale |
|----------|--------|-----------|
| Hook handling mode | Selective (Option C) | Balance speed and quality |
| Commit-msg hook | Always enforce | Maintains commit format |
| Secrets hook | Always enforce | Security critical |
| Lint/test hooks | Skip in autonomous | Speed, handled by verification phases |
| Auto-fix on failure | Yes, for formatters | Reduce manual intervention |

### Implementation Priority

1. **HIGH:** Hook detection and reporting
2. **HIGH:** Environment variable support for skip
3. **MEDIUM:** Commit-msg hook template
4. **MEDIUM:** Auto-fix retry logic
5. **LOW:** Configuration file support
6. **LOW:** Execution logging/metrics

### Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Hook blocks valid work | MEDIUM | HIGH | Selective skip, retry logic |
| Security hook bypassed | LOW | CRITICAL | Never bypass secrets detection |
| Slow execution | MEDIUM | MEDIUM | Skip slow hooks in autonomous |
| Inconsistent formatting | LOW | LOW | Format at phase boundaries |

**Estimated Implementation Effort:** 6-8 hours total.
