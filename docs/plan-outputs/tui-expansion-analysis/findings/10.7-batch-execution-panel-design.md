# Task 10.7: Batch Execution Panel Design

**Date:** 2025-12-26
**Purpose:** Design TUI panel for visualizing batch composition and controls
**Scope:** Current batch composition, "Why batched this way" explainer, batch size controls

---

## Executive Summary

The Batch Execution Panel is a **medium-effort, high-value** expansion that provides visibility into how tasks are grouped for execution and why. This design builds on analysis from tasks 7.1-7.5 and focuses on practical batch visualization, constraint explanation, and optional runtime controls.

**Estimated Effort:** 16-20 hours (Medium)
**Priority:** P1 (High Value for understanding orchestrator decisions)

---

## 1. Panel Overview

### 1.1 Purpose

Provide clear answers to user questions:
- "What tasks are running together right now?"
- "Why can't task X run with the current batch?"
- "What's causing these tasks to be held back?"
- "How do I adjust batch size during execution?"

### 1.2 Data Sources

| Data | Source | Update Frequency |
|------|--------|------------------|
| Current batch | status.json `in_progress` tasks | 500ms polling |
| Requested batch size | Orchestrator state | Static per run |
| Effective batch size | `_filter_sequential_tasks()` | Per iteration |
| Filtered tasks | cmdNext() output | Per iteration |
| Sequential constraints | Plan annotations | Startup |
| File conflicts | cmdNext() `fileConflicts` | Per iteration |
| Held back tasks | Orchestrator filtering | Per iteration |
| Batch history | status.json `runs` | Per iteration |

---

## 2. Visual Design

### 2.1 Collapsed State (Default)

Single-line summary integrated into header or footer:

```
â”Œâ”€ Batch â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Batch 5: 3 tasks (2 held) â”‚ Size: 5 â”‚ Sequential: 3.1-3.4 â”‚ â³ 5:23   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Elements:**
| Element | Display | Style |
|---------|---------|-------|
| Batch number | `Batch 5:` | Cyan |
| Active count | `3 tasks` | Green |
| Held back | `(2 held)` | Yellow if >0 |
| Batch size | `Size: 5` | Dim |
| Sequential indicator | `Sequential: 3.1-3.4` | Yellow if constrained |
| Elapsed time | `â³ 5:23` | Dim |

### 2.2 Expanded State (Toggle with `b` key)

Full panel showing batch composition and explanation:

```
â”Œâ”€ Batch Execution Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  â”Œâ”€ Current Batch (#5) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Requested: 5 tasks  â”‚  Effective: 3 tasks  â”‚  Running: 5:23     â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Active Tasks:                                                   â”‚  â”‚
â”‚  â”‚    â³ 3.1 Merge ORCHESTRATOR.md          [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 82%  4:45  â”‚  â”‚
â”‚  â”‚    â³ 4.1 Add git status panel           [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] 40%  2:11  â”‚  â”‚
â”‚  â”‚    â³ 4.2 Implement phase progress       [â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 25%  0:38  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Held Back (2):                                                  â”‚  â”‚
â”‚  â”‚    â¸ 3.2 (sequential with 3.1 - same file)                      â”‚  â”‚
â”‚  â”‚    â¸ 3.3 (sequential with 3.1 - annotation)                     â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ Why This Batch? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Batch Composition Explanation:                                  â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  âœ“ 3.1 - First task in [SEQUENTIAL] group 3.1-3.4               â”‚  â”‚
â”‚  â”‚  âœ“ 4.1 - Independent phase, no file conflicts                   â”‚  â”‚
â”‚  â”‚  âœ“ 4.2 - Same phase as 4.1, parallel OK                         â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Excluded from batch:                                            â”‚  â”‚
â”‚  â”‚  â¸ 3.2 - Waiting for 3.1 ([SEQUENTIAL] annotation)              â”‚  â”‚
â”‚  â”‚  â¸ 3.3 - Waiting for 3.2 (chain: 3.1â†’3.2â†’3.3)                   â”‚  â”‚
â”‚  â”‚  ðŸš« 5.1 - Depends on 4.3 (pending)                               â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ Batch Size Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Current: 5 tasks per batch                                      â”‚  â”‚
â”‚  â”‚  [â—„â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º]                                         â”‚  â”‚
â”‚  â”‚   1         5         10                                         â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  [-] Decrease  [+] Increase  [Enter] Apply                       â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  [h] History  [?] Constraint details  [b] Collapse                   â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Current Batch Section

```
â”Œâ”€ Current Batch (#5) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  Metrics:                                                              â”‚
â”‚    Requested: 5 tasks                                                  â”‚
â”‚    Effective: 3 tasks (2 filtered by constraints)                      â”‚
â”‚    Elapsed: 5:23                                                       â”‚
â”‚                                                                        â”‚
â”‚  Active Tasks:                                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ Status â”‚ Task                           â”‚ Progress   â”‚ Time   â”‚    â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¤    â”‚
â”‚  â”‚   â³   â”‚ 3.1 Merge ORCHESTRATOR.md      â”‚ [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘] 82% â”‚ 4:45 â”‚    â”‚
â”‚  â”‚   â³   â”‚ 4.1 Add git status panel       â”‚ [â–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘] 40% â”‚ 2:11 â”‚    â”‚
â”‚  â”‚   â³   â”‚ 4.2 Implement phase progress   â”‚ [â–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 25% â”‚ 0:38 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                        â”‚
â”‚  Held Back:                                                            â”‚
â”‚    â¸ 3.2 Merge ARCHITECTURE.md (waiting for 3.1)                      â”‚
â”‚    â¸ 3.3 Create redirect file (waiting for 3.2)                       â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 Batch Composition Explainer

```
â”Œâ”€ Why This Batch? â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  Selection Algorithm:                                                  â”‚
â”‚                                                                        â”‚
â”‚  1. Requested 5 tasks from status-cli.js next                         â”‚
â”‚  2. Received: 3.1, 3.2, 3.3, 4.1, 4.2                                 â”‚
â”‚  3. Applied sequential filter:                                        â”‚
â”‚     - 3.1, 3.2, 3.3 share group "3.1-3.4" â†’ kept only 3.1             â”‚
â”‚  4. Effective batch: 3.1, 4.1, 4.2 (3 tasks)                          â”‚
â”‚                                                                        â”‚
â”‚  Constraint Details:                                                   â”‚
â”‚                                                                        â”‚
â”‚  â›“ Sequential Group: 3.1-3.4                                         â”‚
â”‚     Source: **Execution Note:** in Phase 3                            â”‚
â”‚     Reason: "All modify orchestrator-system.md"                       â”‚
â”‚     Impact: Tasks run one at a time (3.1 â†’ 3.2 â†’ 3.3 â†’ 3.4)           â”‚
â”‚                                                                        â”‚
â”‚  File Conflicts: None detected                                         â”‚
â”‚                                                                        â”‚
â”‚  Dependencies: 5.1 blocked by 4.3 (pending)                            â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.5 Batch Size Control

```
â”Œâ”€ Batch Size Control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  Current: 5 tasks per batch                                            â”‚
â”‚                                                                        â”‚
â”‚     1   2   3   4   5   6   7   8   9  10                             â”‚
â”‚    [â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º]                              â”‚
â”‚                 â–²                                                      â”‚
â”‚           Current setting                                              â”‚
â”‚                                                                        â”‚
â”‚  Impact Preview:                                                       â”‚
â”‚    â€¢ 12 pending tasks â†’ ~3 more batches                               â”‚
â”‚    â€¢ Current constraints reduce parallelism to ~3.5 avg               â”‚
â”‚    â€¢ Estimated remaining: ~45 min                                      â”‚
â”‚                                                                        â”‚
â”‚  Recommendation: Current (5) is optimal for this plan                  â”‚
â”‚    Reason: Sequential constraints already limit parallelism           â”‚
â”‚                                                                        â”‚
â”‚  [-] Decrease (4)  [+] Increase (6)  [Enter] Apply  [Esc] Cancel      â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.6 Batch History Modal

```
â”Œâ”€ Batch History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  Recent Batches:                                                       â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  #  â”‚ Time    â”‚ Requested â”‚ Effective â”‚ Result      â”‚ Duration â”‚  â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
â”‚  â”‚  5  â”‚ 14:32   â”‚     5     â”‚     3     â”‚ â³ Running  â”‚ 5:23+    â”‚  â”‚
â”‚  â”‚  4  â”‚ 14:26   â”‚     5     â”‚     5     â”‚ âœ“âœ“âœ“âœ“âœ“       â”‚ 6:12     â”‚  â”‚
â”‚  â”‚  3  â”‚ 14:20   â”‚     5     â”‚     4     â”‚ âœ“âœ“âœ“âœ“        â”‚ 5:45     â”‚  â”‚
â”‚  â”‚  2  â”‚ 14:14   â”‚     5     â”‚     3     â”‚ âœ“âœ“âœ“         â”‚ 3:28     â”‚  â”‚
â”‚  â”‚  1  â”‚ 14:10   â”‚     5     â”‚     5     â”‚ âœ“âœ“âœ“âœ“âœ“       â”‚ 4:02     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  Statistics:                                                           â”‚
â”‚    Average requested: 5.0 tasks/batch                                  â”‚
â”‚    Average effective: 4.0 tasks/batch                                  â”‚
â”‚    Average duration: 4:47                                              â”‚
â”‚    Constraint reduction: 20%                                           â”‚
â”‚    Success rate: 100% (17/17 tasks)                                    â”‚
â”‚                                                                        â”‚
â”‚  [Enter] View batch details  [Esc] Close                              â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Implementation Specification

### 3.1 New Python Classes

#### BatchExecutionPanel

```python
from dataclasses import dataclass
from typing import List, Optional, Dict
from datetime import datetime

@dataclass
class BatchTask:
    """A task in the current batch."""
    id: str
    description: str
    status: str  # 'active', 'held'
    progress: Optional[float] = None  # 0-100
    elapsed: Optional[int] = None  # seconds
    hold_reason: Optional[str] = None

@dataclass
class BatchInfo:
    """Information about a batch."""
    number: int
    requested_size: int
    effective_size: int
    tasks: List[BatchTask]
    held_back: List[BatchTask]
    start_time: datetime
    end_time: Optional[datetime] = None
    sequential_groups: List[Dict] = None
    file_conflicts: List[Dict] = None


class BatchExecutionPanel:
    """Batch execution panel for TUI."""

    def __init__(self, config: Optional[Dict] = None):
        self.config = config or {}
        self.expanded = False
        self.show_history = False

        # State
        self.current_batch: Optional[BatchInfo] = None
        self.batch_history: List[BatchInfo] = []
        self.batch_size: int = 5
        self.pending_batch_size: Optional[int] = None

        # Selection
        self.selected_section = 'tasks'  # 'tasks', 'held', 'control'
        self.selected_index = 0

        # Refresh
        self.last_refresh: Optional[float] = None

    def refresh(self, force: bool = False) -> None:
        """Refresh batch data from multiple sources."""
        if not force and self.last_refresh:
            if time.time() - self.last_refresh < 1.0:
                return

        self._load_current_batch()
        self._load_batch_history()
        self.last_refresh = time.time()

    def _load_current_batch(self) -> None:
        """Load current batch info from status and orchestrator."""
        # Get in-progress tasks from status
        status = self._load_status()
        in_progress = [t for t in status.get('tasks', [])
                       if t.get('status') == 'in_progress']

        # Get constraint data from cmdNext
        next_data = self._get_next_tasks_data()

        # Build batch info
        active_tasks = []
        for task in in_progress:
            active_tasks.append(BatchTask(
                id=task['id'],
                description=task.get('description', ''),
                status='active',
                progress=self._estimate_progress(task),
                elapsed=self._calculate_elapsed(task.get('startedAt'))
            ))

        # Get held back tasks from next_data
        held_back = []
        for task in next_data.get('heldBack', []):
            held_back.append(BatchTask(
                id=task['id'],
                description=task.get('description', ''),
                status='held',
                hold_reason=task.get('reason', 'constraint')
            ))

        # Calculate batch number from runs
        runs = status.get('runs', [])
        batch_num = len(runs) + 1

        self.current_batch = BatchInfo(
            number=batch_num,
            requested_size=self.batch_size,
            effective_size=len(active_tasks),
            tasks=active_tasks,
            held_back=held_back,
            start_time=datetime.now(),  # Should come from status
            sequential_groups=next_data.get('sequentialGroups', []),
            file_conflicts=next_data.get('fileConflicts', [])
        )

    def _get_next_tasks_data(self) -> Dict:
        """Get data from cmdNext including constraint info."""
        import subprocess
        result = subprocess.run(
            ['node', 'scripts/status-cli.js', 'next', '10', '--json'],
            capture_output=True, text=True
        )
        if result.returncode == 0:
            return json.loads(result.stdout)
        return {}

    def _estimate_progress(self, task: Dict) -> float:
        """Estimate task progress (placeholder - would use activity tracking)."""
        # In reality, this would come from activity tracking
        elapsed = self._calculate_elapsed(task.get('startedAt'))
        if elapsed:
            # Rough estimate: assume 5-10 minutes average
            return min(100, (elapsed / 300) * 100)
        return 0

    def _calculate_elapsed(self, started_at: Optional[str]) -> Optional[int]:
        """Calculate elapsed seconds since task started."""
        if not started_at:
            return None
        try:
            start = datetime.fromisoformat(started_at.replace('Z', '+00:00'))
            return int((datetime.now(start.tzinfo) - start).total_seconds())
        except:
            return None

    def render_collapsed(self) -> Text:
        """Render collapsed single-line summary."""
        if not self.current_batch:
            return Text("Batch: No active batch", style="dim")

        b = self.current_batch
        text = Text()

        # Batch number
        text.append(f"Batch {b.number}: ", style="cyan")

        # Active tasks
        text.append(f"{b.effective_size} tasks", style="green")

        # Held back
        if b.held_back:
            text.append(f" ({len(b.held_back)} held)", style="yellow")

        text.append("  â”‚  ", style="dim")

        # Size
        text.append(f"Size: {b.requested_size}", style="dim")

        text.append("  â”‚  ", style="dim")

        # Sequential indicator
        if b.sequential_groups:
            groups = b.sequential_groups[0] if b.sequential_groups else {}
            text.append(f"Sequential: {groups.get('taskRange', 'active')}", style="yellow")
        else:
            text.append("Parallel OK", style="dim green")

        text.append("  â”‚  ", style="dim")

        # Elapsed
        if b.tasks:
            max_elapsed = max(t.elapsed or 0 for t in b.tasks)
            mins, secs = divmod(max_elapsed, 60)
            text.append(f"â³ {mins}:{secs:02d}", style="dim")

        return text

    def render_expanded(self) -> Panel:
        """Render full batch execution panel."""
        if not self.current_batch:
            return Panel(
                Text("No active batch", style="dim"),
                title="Batch Execution",
                border_style="dim"
            )

        layout = Layout()
        layout.split(
            Layout(name="current", size=12),
            Layout(name="explainer", size=10),
            Layout(name="control", size=6)
        )

        layout["current"].update(self._render_current_batch())
        layout["explainer"].update(self._render_explainer())
        layout["control"].update(self._render_batch_control())

        # Controls
        controls = Text()
        controls.append("[h] History  ", style="dim cyan")
        controls.append("[?] Constraint details  ", style="dim cyan")
        controls.append("[+/-] Batch size  ", style="dim cyan")
        controls.append("[b] Collapse", style="dim cyan")

        content = Table(show_header=False, box=None, expand=True)
        content.add_column()
        content.add_row(layout)
        content.add_row("")
        content.add_row(controls)

        return Panel(content, title="Batch Execution Panel", border_style="cyan")

    def _render_current_batch(self) -> Panel:
        """Render current batch section."""
        b = self.current_batch
        table = Table(show_header=False, box=None, expand=True)
        table.add_column("Label", width=12, style="dim")
        table.add_column("Value")

        # Metrics
        table.add_row("Requested:", f"{b.requested_size} tasks")
        table.add_row("Effective:", f"{b.effective_size} tasks")
        if b.requested_size != b.effective_size:
            filtered = b.requested_size - b.effective_size
            table.add_row("", Text(f"({filtered} filtered by constraints)", style="yellow"))

        table.add_row("", "")

        # Active tasks
        table.add_row("Active:", "")
        for task in b.tasks[:4]:
            progress_bar = self._mini_progress_bar(task.progress or 0)
            elapsed_str = f"{task.elapsed // 60}:{task.elapsed % 60:02d}" if task.elapsed else "0:00"
            table.add_row(
                "",
                Text(f"  â³ {task.id} {task.description[:30]}  {progress_bar} {elapsed_str}")
            )

        if len(b.tasks) > 4:
            table.add_row("", Text(f"  ... and {len(b.tasks) - 4} more", style="dim"))

        # Held back
        if b.held_back:
            table.add_row("", "")
            table.add_row("Held:", "")
            for task in b.held_back[:3]:
                reason = task.hold_reason or "constraint"
                table.add_row("", Text(f"  â¸ {task.id} ({reason})", style="yellow"))

        return Panel(table, title=f"Current Batch (#{b.number})", border_style="green")

    def _render_explainer(self) -> Panel:
        """Render batch composition explainer."""
        b = self.current_batch
        table = Table(show_header=False, box=None, expand=True)
        table.add_column()

        # Included tasks
        table.add_row(Text("Included in batch:", style="bold"))
        for task in b.tasks:
            reason = self._get_inclusion_reason(task)
            table.add_row(Text(f"  âœ“ {task.id} - {reason}", style="green"))

        table.add_row("")

        # Excluded tasks
        if b.held_back:
            table.add_row(Text("Excluded from batch:", style="bold"))
            for task in b.held_back:
                reason = task.hold_reason or "constraint"
                icon = "â¸" if "sequential" in reason.lower() else "ðŸš«"
                table.add_row(Text(f"  {icon} {task.id} - {reason}", style="yellow"))

        # Constraints summary
        if b.sequential_groups:
            table.add_row("")
            table.add_row(Text("Active Constraints:", style="bold"))
            for group in b.sequential_groups[:2]:
                table.add_row(Text(f"  â›“ Sequential: {group.get('taskRange', 'N/A')}", style="yellow"))
                if group.get('reason'):
                    table.add_row(Text(f"      Reason: {group['reason']}", style="dim"))

        return Panel(table, title="Why This Batch?", border_style="blue")

    def _render_batch_control(self) -> Panel:
        """Render batch size control."""
        content = []

        # Current size
        content.append(f"Current: {self.batch_size} tasks per batch\n")

        # Visual slider
        slider = "["
        for i in range(1, 11):
            if i == self.batch_size:
                slider += "â—"
            else:
                slider += "â”€"
        slider += "]"
        content.append(f"  1 {slider} 10\n")

        # Controls
        content.append("\n[-] Decrease  [+] Increase  [Enter] Apply")

        return Panel(
            Text("".join(content)),
            title="Batch Size",
            border_style="dim"
        )

    def _get_inclusion_reason(self, task: BatchTask) -> str:
        """Get reason why task is included in batch."""
        b = self.current_batch

        # Check if first in sequential group
        if b.sequential_groups:
            for group in b.sequential_groups:
                task_ids = group.get('taskIds', [])
                if task.id in task_ids and task_ids.index(task.id) == 0:
                    return f"First task in [SEQUENTIAL] group {group.get('taskRange', '')}"

        # Default reasons
        return "No constraints, parallel OK"

    def _mini_progress_bar(self, percent: float, width: int = 10) -> str:
        """Create a mini progress bar."""
        filled = int((percent / 100) * width)
        return "[" + "â–ˆ" * filled + "â–‘" * (width - filled) + "]"

    def handle_key(self, key: str) -> bool:
        """Handle keyboard input."""
        if key == '+':
            self.batch_size = min(10, self.batch_size + 1)
            return True
        elif key == '-':
            self.batch_size = max(1, self.batch_size - 1)
            return True
        elif key == 'h':
            self.show_history = not self.show_history
            return True
        elif key == 'b':
            self.expanded = False
            return True
        elif key == 'escape':
            if self.show_history:
                self.show_history = False
            else:
                self.expanded = False
            return True
        return False

    def toggle(self) -> None:
        """Toggle expanded/collapsed state."""
        self.expanded = not self.expanded
        if self.expanded:
            self.refresh(force=True)
```

### 3.2 Keyboard Mappings

| Key | Context | Action |
|-----|---------|--------|
| `b` | Global | Toggle batch panel expand/collapse |
| `+` | Batch panel | Increase batch size |
| `-` | Batch panel | Decrease batch size |
| `h` | Batch panel expanded | Show batch history |
| `?` | Batch panel expanded | Show constraint details |
| `Enter` | Batch size adjusted | Apply new batch size |
| `Esc` | Batch panel | Close/collapse |

---

## 4. Data Contract

### 4.1 Batch Info Object

```typescript
interface BatchInfo {
  number: number;
  requestedSize: number;
  effectiveSize: number;
  startTime: string;  // ISO
  endTime?: string;

  tasks: Array<{
    id: string;
    description: string;
    status: 'active' | 'completed';
    progress: number;  // 0-100
    elapsed: number;   // seconds
    agents?: string[];
  }>;

  heldBack: Array<{
    id: string;
    description: string;
    holdReason: string;
    holdType: 'sequential' | 'file_conflict' | 'dependency';
    waitingFor?: string;  // Task ID
  }>;

  constraints: {
    sequentialGroups: Array<{
      taskRange: string;
      taskIds: string[];
      reason: string;
      source: string;  // 'annotation' | 'file_conflict'
    }>;
    fileConflicts: Array<{
      file: string;
      taskIds: string[];
    }>;
    dependencies: Array<{
      taskId: string;
      blockedBy: string[];
    }>;
  };
}
```

### 4.2 Batch History Object

```typescript
interface BatchHistoryEntry {
  number: number;
  timestamp: string;
  requestedSize: number;
  effectiveSize: number;
  completed: number;
  failed: number;
  duration: number;  // seconds
  constraintReduction: number;  // Percentage
}

interface BatchHistory {
  entries: BatchHistoryEntry[];
  averageRequested: number;
  averageEffective: number;
  averageDuration: number;
  successRate: number;
}
```

---

## 5. Effort Estimate

### 5.1 Implementation Breakdown

| Component | Effort | Priority |
|-----------|--------|----------|
| BatchExecutionPanel class | 4 hours | P0 |
| Collapsed view render | 2 hours | P0 |
| Current batch section | 3 hours | P0 |
| Batch explainer section | 3 hours | P0 |
| Batch size control | 2 hours | P0 |
| Layout integration | 1 hour | P0 |
| Keyboard handling | 1 hour | P0 |
| **Subtotal Core:** | **16 hours** | - |
| Batch history modal | 3 hours | P1 |
| Impact preview | 2 hours | P2 |
| Constraint details modal | 2 hours | P2 |
| **Subtotal Enhanced:** | **7 hours** | - |
| **Total:** | **23 hours** | - |

### 5.2 Recommended Implementation

**MVP (Core):** 16 hours
- Collapsed single-line summary
- Expanded panel with 3 sections
- Current batch with task list
- Batch composition explainer
- Batch size +/- controls
- Toggle with `b` key

**Full Feature:** 23 hours
- All MVP features
- Batch history modal
- Impact preview for size changes
- Constraint detail drill-down

---

## 6. Integration with Existing TUI Plan

### 6.1 Layout Placement

The Batch Execution Panel should integrate with existing TUI layout:

| Option | Location | Impact |
|--------|----------|--------|
| **Collapsed** | Footer row (replaces part of status) | Minimal |
| **Expanded** | Replace or overlay activity panel | Moderate |
| **Modal** | Full overlay (like findings browser) | Minimal layout impact |

**Recommendation:** Collapsed in footer, expanded as overlay.

### 6.2 Relationship to Existing Panels

| Existing Panel | Relationship |
|----------------|--------------|
| In Progress Panel | Batch panel shows WHY these tasks are running |
| Upcoming Panel | Batch panel shows WHY other tasks are held |
| Dependency Graph | Batch panel explains constraint-based ordering |
| Agent Tracker | Could share agent data for per-task tracking |

### 6.3 Data Sharing

- Uses same `status.json` as other panels
- Uses same `cmdNext()` data as dependency panels
- Batch history from `runs` array in status.json

---

## 7. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Data source latency | MEDIUM | LOW | Cache with stale indicator |
| Constraint explanation incomplete | MEDIUM | LOW | Show "unknown" fallback |
| Batch size change not applied | MEDIUM | MEDIUM | Require IPC for runtime changes |
| Layout overflow | LOW | LOW | Scroll for long lists |

---

## 8. Success Criteria

### 8.1 Functional Requirements

- [ ] Collapsed view shows batch summary
- [ ] Expanded view shows current batch tasks
- [ ] Held back tasks listed with reasons
- [ ] Batch composition explained
- [ ] Batch size adjustable
- [ ] History modal shows past batches
- [ ] `b` key toggles panel

### 8.2 Quality Requirements

- [ ] Data refreshes in <100ms
- [ ] No flicker on refresh
- [ ] Handles 10+ task batches
- [ ] Works with 0 held tasks (all parallel)

### 8.3 Integration Requirements

- [ ] Uses existing cmdNext() output
- [ ] Uses existing status.json format
- [ ] Fits in TUI layout
- [ ] Keyboard mappings don't conflict

---

## 9. Related Documents

- Task 7.1: Batch size configuration analysis
- Task 7.2: Task selection for batches
- Task 7.5: Batching system TUI mapping
- Task 10.2: Parallel Execution Dashboard
- Task 10.3: Task Constraint Panel

---

**End of Design**
