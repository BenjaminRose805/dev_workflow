# Task 3.2: Conflict Detection Algorithm Analysis

## Summary

The `detectFileConflicts()` function in `scripts/lib/plan-status.js:1993-2036` implements a file-to-task mapping algorithm that identifies when multiple tasks reference the same files, enabling automatic conflict detection for parallel task execution.

## Algorithm Overview

**Location:** `scripts/lib/plan-status.js:1993-2036`

**Input:** Array of task objects with `id` and `description` fields

**Output:** Array of conflict objects: `[{ file: string, taskIds: string[] }]`

**Dependencies:** Uses `extractFileReferences()` (analyzed in task 3.1)

## Algorithm Specification

### Step 1: Build File-to-Tasks Mapping

```javascript
const fileToTasks = new Map();

for (const task of tasks) {
  const files = extractFileReferences(task.description);
  for (const file of files) {
    const normalizedFile = file.toLowerCase();

    if (!fileToTasks.has(normalizedFile)) {
      fileToTasks.set(normalizedFile, {
        originalFile: file,  // Preserve original casing
        taskIds: []
      });
    }
    fileToTasks.get(normalizedFile).taskIds.push(task.id);
  }
}
```

**Key Features:**
- **Case-insensitive matching:** File paths are normalized to lowercase for comparison
- **Original preservation:** Original file path casing is preserved for display
- **Deduplication:** Each task ID appears once per file (from Set behavior in extraction)

### Step 2: Identify Conflicts

```javascript
const conflicts = [];
for (const [normalizedFile, data] of fileToTasks) {
  if (data.taskIds.length > 1) {
    conflicts.push({
      file: data.originalFile,
      taskIds: data.taskIds
    });
  }
}
```

**Conflict Definition:** A file is considered conflicting when `taskIds.length > 1`

### Step 3: Sort for Consistent Output

```javascript
conflicts.sort((a, b) => a.file.localeCompare(b.file));
```

**Purpose:** Ensures deterministic ordering for testing and comparison

## Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────┐
│                      Input Tasks                             │
│  [                                                          │
│    { id: '2.1', description: 'Update `src/api.ts`' },       │
│    { id: '2.2', description: 'Modify `src/api.ts`' },       │
│    { id: '2.3', description: 'Create `src/utils.ts`' }      │
│  ]                                                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              extractFileReferences() per task                │
│  Task 2.1 → ["src/api.ts"]                                  │
│  Task 2.2 → ["src/api.ts"]                                  │
│  Task 2.3 → ["src/utils.ts"]                                │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                  fileToTasks Map (normalized)                │
│  {                                                          │
│    "src/api.ts": { original: "src/api.ts", tasks: [2.1,2.2]}│
│    "src/utils.ts": { original: "src/utils.ts", tasks: [2.3]}│
│  }                                                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Filter: taskIds.length > 1                      │
│  [{ file: "src/api.ts", taskIds: ["2.1", "2.2"] }]         │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Output Conflicts                         │
│  [{ file: "src/api.ts", taskIds: ["2.1", "2.2"] }]         │
└─────────────────────────────────────────────────────────────┘
```

## Example Scenarios

### Scenario 1: Simple Conflict

**Input:**
```javascript
const tasks = [
  { id: '2.1', description: 'Update `src/api.ts` with new endpoint' },
  { id: '2.2', description: 'Modify `src/api.ts` for authentication' }
];
```

**Output:**
```javascript
[{ file: 'src/api.ts', taskIds: ['2.1', '2.2'] }]
```

### Scenario 2: Multiple Conflicts

**Input:**
```javascript
const tasks = [
  { id: '3.1', description: 'Add function to scripts/status-cli.js' },
  { id: '3.2', description: 'Modify scripts/status-cli.js for deps' },
  { id: '3.3', description: 'Update scripts/status-cli.js for export' },
  { id: '3.4', description: 'Create scripts/lib/helpers.js' }
];
```

**Output:**
```javascript
[{ file: 'scripts/status-cli.js', taskIds: ['3.1', '3.2', '3.3'] }]
// scripts/lib/helpers.js not included - only 1 task references it
```

### Scenario 3: No Conflicts (Independent Tasks)

**Input:**
```javascript
const tasks = [
  { id: '1.1', description: 'Create `src/auth.ts`' },
  { id: '1.2', description: 'Create `src/api.ts`' },
  { id: '1.3', description: 'Create `src/utils.ts`' }
];
```

**Output:**
```javascript
[]  // Empty - each file referenced by only one task
```

### Scenario 4: Case Insensitivity

**Input:**
```javascript
const tasks = [
  { id: '4.1', description: 'Update `SRC/Api.ts`' },
  { id: '4.2', description: 'Modify `src/api.ts`' }
];
```

**Output:**
```javascript
[{ file: 'SRC/Api.ts', taskIds: ['4.1', '4.2'] }]
// Note: Original casing from first occurrence preserved
```

## Algorithm Complexity

| Operation | Complexity | Notes |
|-----------|------------|-------|
| Task iteration | O(n) | n = number of tasks |
| File extraction | O(m) | m = description length (per task) |
| Map lookups | O(1) | Hash-based Map |
| Conflict filtering | O(f) | f = unique files |
| Sorting | O(f log f) | Alphabetical sort |
| **Total** | O(n * m + f log f) | Typically linear in practice |

## Input Validation

The function handles edge cases gracefully:

```javascript
if (!tasks || !Array.isArray(tasks)) {
  return [];
}

// Per-task validation
if (!task || !task.id || !task.description) {
  continue;  // Skip invalid tasks
}
```

## Integration Points

### Used By

1. **`cmdNext()` in status-cli.js:783, 894**
   - Detects conflicts among in-progress tasks
   - Detects conflicts among next recommended tasks
   - Adds `fileConflict`, `conflictsWith`, `conflictingFiles` to output

2. **`getParallelPhases()` in plan-status.js:1869-1898**
   - Detects conflicts between tasks in parallel phases
   - Returns `hasConflicts` flag and `conflicts` array

### Output Consumption

| Consumer | Field Used | Purpose |
|----------|------------|---------|
| TUI task list | `fileConflict: true` | Show warning icon |
| TUI task detail | `conflictsWith[]` | List conflicting tasks |
| TUI conflict panel | `conflicts[]` | File-to-tasks matrix |
| Orchestrator | `hasConflicts` | Decide sequential execution |

## TUI Visualization Opportunities

### Conflict Badge on Tasks

```
┌────────────────────────────────────────┐
│ PENDING TASKS                          │
├────────────────────────────────────────┤
│ ◯ 2.1 Update API endpoint              │
│   ⚠ Conflicts: src/api.ts              │
│                                         │
│ ◯ 2.2 Add auth middleware        ⚠    │
│   ⚠ Conflicts: src/api.ts              │
│                                         │
│ ◯ 2.3 Create utility helpers           │
└────────────────────────────────────────┘
```

### Conflict Matrix Panel

```
┌──────────────────────────────────────────┐
│ FILE CONFLICTS                           │
├──────────────────────────────────────────┤
│                   2.1  2.2  2.3  3.1     │
│ src/api.ts        ●    ●    ·    ·      │
│ status-cli.js     ·    ·    ·    ●      │
│                                          │
│ Legend: ● = references file              │
└──────────────────────────────────────────┘
```

### Conflict Explanation

```
┌──────────────────────────────────────────┐
│ WHY THESE TASKS CONFLICT                 │
├──────────────────────────────────────────┤
│ Tasks 2.1 and 2.2 both modify:          │
│   • src/api.ts                          │
│                                          │
│ Running them in parallel may cause:     │
│   • Merge conflicts in git              │
│   • Race conditions in file writes      │
│   • Inconsistent final state            │
│                                          │
│ Recommendation: Run sequentially        │
└──────────────────────────────────────────┘
```

## Recommendations for Enhancement

### 1. Weighted Conflict Scoring

Not all conflicts are equal. Consider scoring by:
- Number of shared files (more = higher priority)
- Type of operation (create vs modify)
- File criticality (config files vs source)

```javascript
function calculateConflictSeverity(conflict) {
  let severity = conflict.taskIds.length - 1; // Base score

  // Critical files get higher weight
  if (conflict.file.match(/config|env|package\.json/)) {
    severity += 2;
  }

  return severity;
}
```

### 2. Conflict Groups

Group related conflicts for easier visualization:

```javascript
function groupConflicts(conflicts) {
  // Group tasks that share multiple files
  const groups = [];
  // ... implementation
  return groups;
}
```

### 3. Smart Sequential Ordering

When conflicts exist, suggest optimal execution order:

```javascript
function suggestExecutionOrder(conflictingTasks) {
  // Use task dependencies + file conflicts to suggest order
  // Earlier phases first, then by task ID
}
```

## Test Coverage

**Test File:** `scripts/tests/test-file-conflicts.js`

| Test Category | Count | Status |
|---------------|-------|--------|
| Simple conflicts | 3 | ✓ |
| Multiple conflicts | 2 | ✓ |
| No conflicts | 2 | ✓ |
| Case sensitivity | 2 | ✓ |
| Edge cases | 4 | ✓ |
| Integration | 2 | ✓ |
| **Total** | 15 | ✓ |
