# Task 2.1: Analyze `[SEQUENTIAL]` Annotation Parsing

## Summary

Deep analysis of the `[SEQUENTIAL]` annotation parsing system in `scripts/lib/plan-status.js` and how it flows through the orchestration pipeline.

## Source Files

| File | Function | Purpose |
|------|----------|---------|
| `scripts/lib/plan-status.js` | `parseExecutionNotes()` | Parse annotations from plan markdown |
| `scripts/lib/plan-status.js` | `expandTaskRange()` | Expand "3.1-3.4" to ["3.1", "3.2", "3.3", "3.4"] |
| `scripts/lib/plan-status.js` | `getTaskConstraints()` | Get constraint info for specific task |
| `scripts/lib/constraint-types.js` | Constraint type definitions | Data structure specs |
| `scripts/plan_orchestrator.py` | `_filter_sequential_tasks()` | Apply constraints during batching |

## Annotation Syntax Specification

### Pattern Format

```markdown
**Execution Note:** Tasks X.Y-X.Z are [SEQUENTIAL] - reason text
```

### Regex Pattern (from plan-status.js:1250)

```javascript
/\*\*Execution Note:\*\*\s*Tasks?\s+([\d.,\s-]+)\s+(?:are|is)\s+\[SEQUENTIAL\]\s*[-–—]?\s*(.+?)(?:\n|$)/gi
```

### Capture Groups

| Group | Captures | Example |
|-------|----------|---------|
| Group 1 | Task range string | `3.1-3.4` or `2.1-2.3 and 3.1-3.4` |
| Group 2 | Reason text | `all modify the same config file` |

### Supported Syntax Variants

| Variant | Example | Parsed? |
|---------|---------|---------|
| Standard range | `Tasks 3.1-3.4 are [SEQUENTIAL]` | ✓ |
| Singular | `Task 1.1-1.2 is [SEQUENTIAL]` | ✓ |
| Multiple ranges | `Tasks 2.1-2.3 and 3.1-3.4 are [SEQUENTIAL]` | ✓ |
| Comma-separated | `Tasks 2.1, 2.2, 2.3 are [SEQUENTIAL]` | ✓ |
| Em dash reason | `Tasks 2.1-2.3 are [SEQUENTIAL] – reason` | ✓ |
| Long dash reason | `Tasks 2.1-2.3 are [SEQUENTIAL] — reason` | ✓ |
| Hyphen reason | `Tasks 2.1-2.3 are [SEQUENTIAL] - reason` | ✓ |

## Task Range Expansion

### Function: `expandTaskRange()` (lines 1172-1210)

**Handles three formats:**

1. **Range format:** `3.1-3.4` → `["3.1", "3.2", "3.3", "3.4"]`
2. **Comma-separated:** `3.1,3.3,3.5` → `["3.1", "3.3", "3.5"]`
3. **Single task:** `3.1` → `["3.1"]`

**Range Regex:**
```javascript
/^(\d+)\.(\d+)-(\d+)\.(\d+)$/
```

**Capture Groups for Range:**
| Group | Captures | Example |
|-------|----------|---------|
| Group 1 | Start phase | `3` |
| Group 2 | Start task | `1` |
| Group 3 | End phase | `3` |
| Group 4 | End task | `4` |

**Expansion Logic:**
```javascript
// Only expand if same phase and valid range
if (startPhase === endPhase && start <= end) {
  for (let i = start; i <= end; i++) {
    tasks.push(`${phase}.${i}`);
  }
}
```

**Cross-Phase Behavior:**
- If `startPhase !== endPhase`, returns only start and end: `["3.1", "4.4"]`
- Does NOT expand across phases

## Data Structures

### Sequential Constraint Object

```typescript
interface SequentialConstraint {
  taskRange: string;       // Original range string: "3.1-3.4"
  taskIds: string[];       // Expanded: ["3.1", "3.2", "3.3", "3.4"]
  reason: string;          // "all modify same file"
}
```

### Task Execution Constraints (from constraint-types.js)

```typescript
interface ExecutionConstraints {
  sequential: boolean;            // true if in sequential group
  sequentialGroup?: string;       // "3.1-3.4" group identifier
  sequentialReason?: string;      // Why sequential
}
```

### parseExecutionNotes() Return Value

```typescript
interface ParsedConstraints {
  // Array-like for backward compatibility
  [index: number]: SequentialConstraint;
  length: number;

  // Named properties
  sequential: SequentialConstraint[];
  parallel: ParallelConstraint[];
  nonBlockingVerify: { phase: number }[];
  pipelineStart: { phase: number, triggerTaskId: string }[];
}
```

## Constraint Flow Through Pipeline

### 1. Plan File → parseExecutionNotes()

```
Plan markdown:
  **Execution Note:** Tasks 3.1-3.4 are [SEQUENTIAL] - all modify same file
                    ↓
parseExecutionNotes(content)
                    ↓
{
  sequential: [{
    taskRange: "3.1-3.4",
    taskIds: ["3.1", "3.2", "3.3", "3.4"],
    reason: "all modify same file"
  }],
  parallel: [],
  ...
}
```

### 2. parseExecutionNotes() → Status.json

During `initializePlanStatus()`:
```javascript
const constraints = parseExecutionNotes(content);
// Build constraint map
const constraintMap = new Map();
for (const constraint of constraints) {
  for (const taskId of constraint.taskIds) {
    constraintMap.set(taskId, {
      sequential: true,
      sequentialGroup: constraint.taskRange,
      sequentialReason: constraint.reason
    });
  }
}

// Apply to task objects in status.json
for (const task of status.tasks) {
  const constraint = constraintMap.get(task.id);
  if (constraint) {
    task.constraints = constraint;
  }
}
```

### 3. Status.json → Orchestrator

Via `status-cli.js next` command:
```json
{
  "tasks": [
    {
      "id": "3.1",
      "constraints": {
        "sequential": true,
        "sequentialGroup": "3.1-3.4",
        "sequentialReason": "all modify same file"
      }
    }
  ]
}
```

### 4. Orchestrator → Task Filtering

In `plan_orchestrator.py`:
```python
def _filter_sequential_tasks(self, tasks):
    """Only batch one task per sequential group."""
    seen_groups = set()
    filtered = []

    for task in tasks:
        if task.get('sequential'):
            group = task.get('sequentialGroup')
            if group in seen_groups:
                # Hold back - already have one from this group
                self.log(f"Task {task['id']} held back (sequential with ...)")
                continue
            seen_groups.add(group)

        filtered.append(task)

    return filtered
```

## TUI Visualization Opportunities

### 1. Sequential Group Indicator

**In task list:**
```
┌─ In Progress ───────────────────────────────────┐
│ ⏳ 3.1: First sequential task    [SEQ 1/4]      │
│ ◯ 3.2: Second sequential task   [SEQ 2/4]      │
│ ◯ 3.3: Third sequential task    [SEQ 3/4]      │
│ ◯ 3.4: Fourth sequential task   [SEQ 4/4]      │
└─────────────────────────────────────────────────┘
```

### 2. Constraint Reason Tooltip

**On hover/selection:**
```
Task 3.1 is [SEQUENTIAL]
Reason: all modify same file
Group: 3.1-3.4 (4 tasks)
Position: 1 of 4
```

### 3. Execution Queue Visualization

```
Execution Queue:
├── ⏳ 1.1 (parallel)
├── ⏳ 1.2 (parallel)
├── ⏳ 3.1 (sequential 1/4)  ← Only one from group runs
│   └── ◯ 3.2, 3.3, 3.4 (waiting)
└── ⏳ 4.1 (parallel)
```

### 4. Held Back Tasks Panel

```
┌─ Held Back (Sequential) ────────────────────────┐
│ 3.2 held back (sequential with 3.1)             │
│ 3.3 held back (sequential with 3.1)             │
│ 3.4 held back (sequential with 3.1)             │
└─────────────────────────────────────────────────┘
```

## Edge Cases Documented

### 1. Cross-Phase Ranges

- `Tasks 2.1-3.4 are [SEQUENTIAL]` → Only captures start/end, not full expansion
- Recommendation: Keep sequential groups within same phase

### 2. Multiple Sequential Groups

```markdown
**Execution Note:** Tasks 2.1-2.3 are [SEQUENTIAL] - config changes
**Execution Note:** Tasks 3.1-3.4 are [SEQUENTIAL] - file dependencies
```
- Both groups parsed correctly
- Orchestrator handles each group independently

### 3. Overlapping Ranges

- Not explicitly handled
- Tasks can only belong to one sequential group (first match wins)

### 4. Empty Reason

```markdown
**Execution Note:** Tasks 2.1-2.3 are [SEQUENTIAL]
```
- Parses successfully with empty reason string

## Data Contract for TUI

### Input: status-cli.js `next` Command

```json
{
  "tasks": [
    {
      "id": "3.1",
      "description": "First task",
      "status": "pending",
      "constraints": {
        "sequential": true,
        "sequentialGroup": "3.1-3.4",
        "sequentialReason": "all modify same file"
      }
    }
  ],
  "heldBack": [
    {
      "id": "3.2",
      "reason": "sequential with 3.1",
      "group": "3.1-3.4"
    }
  ]
}
```

### Recommended CLI Addition

`node scripts/status-cli.js constraints --format=json`:
```json
{
  "sequential": [
    {
      "group": "3.1-3.4",
      "taskIds": ["3.1", "3.2", "3.3", "3.4"],
      "reason": "all modify same file",
      "completed": 1,
      "remaining": 3,
      "currentTask": "3.2"
    }
  ],
  "parallel": [],
  "nonBlockingVerify": [],
  "pipelineStart": []
}
```

## Files Modified by Annotation System

| File | What's Stored |
|------|---------------|
| Plan markdown | Original annotations (read-only) |
| status.json | Parsed constraints per task |
| orchestrator logs | "held back" messages |
| TUI display | Visual indicators (proposed) |
