# Task 8.4: Stuck Detection and Recovery Analysis

**Date:** 2025-12-26
**Source:** `scripts/lib/plan-output-utils.js`, `scripts/plan_orchestrator.py`
**Purpose:** Document stuck task detection mechanism and recovery options for TUI integration

---

## Executive Summary

The stuck detection system uses a **30-minute threshold** to identify tasks that have been `in_progress` too long. When detected, stuck tasks are automatically marked as failed and become eligible for retry. The TUI could provide real-time stuck warnings and manual intervention options.

---

## Stuck Detection Mechanism

### Configuration

| Parameter | Value | Source |
|-----------|-------|--------|
| `STUCK_TASK_THRESHOLD_MS` | 30 minutes (1,800,000ms) | `plan-output-utils.js:999` |
| `MAX_RETRIES` | 2 | `plan-output-utils.js:994` |
| Detection trigger | Each orchestrator iteration | `plan_orchestrator.py:854` |

### Detection Algorithm

**Source:** `scripts/lib/plan-output-utils.js:1107-1145`

```javascript
function detectAndMarkStuckTasks(planPath, thresholdMs = STUCK_TASK_THRESHOLD_MS) {
  const now = new Date();
  const stuckTasks = [];

  for (const task of status.tasks) {
    if (task.status === 'in_progress' && task.startedAt) {
      const startedAt = new Date(task.startedAt);
      const elapsedMs = now - startedAt;

      if (elapsedMs > thresholdMs) {
        // Mark as stuck/failed
        task.status = 'failed';
        task.completedAt = now.toISOString();
        task.duration = elapsedMs;
        task.lastError = `Task stuck: in_progress for ${Math.round(elapsedMs / 60000)} minutes`;
        task.lastErrorAt = now.toISOString();
        task.stuckDetected = true;

        stuckTasks.push({
          id: task.id,
          description: task.description,
          phase: task.phase,
          startedAt: task.startedAt,
          elapsedMinutes: Math.round(elapsedMs / 60000)
        });
      }
    }
  }

  return stuckTasks;
}
```

### Read-Only Detection

**Source:** `scripts/lib/plan-output-utils.js:1153-1180`

There's also a read-only version that doesn't mark tasks:

```javascript
function getStuckTasks(planPath, thresholdMs = STUCK_TASK_THRESHOLD_MS) {
  // Returns list of potentially stuck tasks without modifying status
}
```

---

## Orchestrator Integration

### Detection Loop

**Source:** `scripts/plan_orchestrator.py:854-861`

```python
# Check for stuck tasks and mark them as failed
stuck_tasks = self.detect_stuck_tasks()
if stuck_tasks:
    if self.use_tui:
        self.tui.set_status(f"Detected {len(stuck_tasks)} stuck task(s), marking as failed")
    else:
        self.logger.warning(f"Detected {len(stuck_tasks)} stuck task(s)")
    for task in stuck_tasks:
        self.logger.info(f"  Stuck: {task.get('id')} (in_progress for {task.get('elapsedMinutes', '?')} min)")
```

### Recovery Flow

After stuck detection, the orchestrator handles recovery:

```python
# Check if blocked - but first try to retry failed tasks
if status.is_blocked:
    retryable = self.get_retryable_tasks()
    if retryable:
        # Reset retryable tasks to pending
        for task in retryable[:self.batch_size]:
            self.reset_task_for_retry(task_id)
```

---

## Recovery Options

### Automatic Recovery

| Option | Condition | Action |
|--------|-----------|--------|
| Auto-retry | `retryCount < MAX_RETRIES` (2) | Reset task to `pending` |
| Mark exhausted | `retryCount >= MAX_RETRIES` | Leave as `failed` |
| Continue others | Always | Process remaining tasks |

### Manual Recovery (CLI)

| Command | Action |
|---------|--------|
| `status-cli.js retryable` | List tasks eligible for retry |
| `status-cli.js exhausted` | List tasks with no retries left |
| `status-cli.js mark-started <id>` | Reset task to try again |
| `status-cli.js mark-skipped <id>` | Skip the task entirely |

---

## Stuck Task Data Model

When a task is marked stuck, it gains these fields:

```json
{
  "id": "3.2",
  "status": "failed",
  "startedAt": "2025-12-26T10:00:00Z",
  "completedAt": "2025-12-26T10:35:00Z",
  "duration": 2100000,
  "lastError": "Task stuck: in_progress for 35 minutes (threshold: 30 minutes)",
  "lastErrorAt": "2025-12-26T10:35:00Z",
  "stuckDetected": true,
  "retryCount": 0
}
```

---

## TUI Integration Opportunities

### 1. Real-Time Stuck Warning Panel

**Concept:** Show warning before threshold is reached

```
â”Œâ”€ Stuck Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ âš  Task 3.2: 25 minutes (30 min limit)â”‚
â”‚   [Extend] [Skip] [Abort]            â”‚
â”‚ âš  Task 3.4: 18 minutes               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Implementation:**
- Poll `getStuckTasks()` with lower threshold (e.g., 20 min = 66%)
- Show countdown timer per task
- Provide intervention buttons

### 2. Stuck History Panel

**Concept:** Show tasks that were stuck and their recovery

```
â”Œâ”€ Stuck History â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.2: Stuck 35m â†’ Retry #1 â†’ âœ“        â”‚
â”‚ 4.1: Stuck 31m â†’ Retry #1 â†’ Retry #2 â”‚
â”‚ 2.5: Stuck 45m â†’ Skipped             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3. Intervention Controls

**Manual Actions:**
| Key | Action |
|-----|--------|
| `E` | Extend threshold for selected task |
| `S` | Skip task (mark as skipped) |
| `R` | Force immediate retry |
| `A` | Abort task (mark failed, no retry) |
| `?` | Show task details / last error |

### 4. Threshold Configuration

**Dynamic Adjustment:**
- Allow per-task threshold overrides
- Show "time remaining" instead of "time elapsed"
- Different thresholds for analysis vs implementation tasks

### 5. Stuck Notification Events

**New Events for TUI:**
```python
# Proposed events
"task.approaching_stuck" â†’ When task reaches 80% of threshold
"task.stuck_detected" â†’ When task marked stuck
"task.stuck_recovered" â†’ When retry succeeds after stuck
```

---

## Edge Cases and Considerations

### 1. False Positives

**Scenario:** Long-running but valid task (e.g., large codebase search)

**Mitigations:**
- Allow threshold extension via TUI
- Tag certain task types as "long-running expected"
- Show Claude activity heartbeat

### 2. Session Interruption

**Scenario:** Claude session crashes, task stays `in_progress`

**Current Behavior:** Detected after threshold, marked failed
**TUI Opportunity:** Show "No activity for X minutes" warning earlier

### 3. Multiple Stuck Tasks

**Scenario:** Several tasks stuck simultaneously

**Current Behavior:** All detected and marked in same iteration
**TUI Opportunity:** Show batch recovery options

### 4. Threshold Too Short

**Scenario:** Complex tasks legitimately take >30 minutes

**TUI Opportunity:**
- Historical analysis of task durations
- Suggest threshold adjustments
- Per-phase threshold configuration

---

## CLI Commands for TUI Integration

### Existing Commands

```bash
# Detect and mark stuck tasks
node scripts/status-cli.js detect-stuck

# Get retryable failed tasks
node scripts/status-cli.js retryable

# Get exhausted (no retries left) tasks
node scripts/status-cli.js exhausted

# Increment retry count
node scripts/status-cli.js increment-retry <task-id> --error "message"
```

### Output Formats

**detect-stuck Output:**
```json
{
  "thresholdMinutes": 30,
  "stuckCount": 2,
  "stuckTasks": [
    {
      "id": "3.2",
      "description": "...",
      "phase": "3",
      "startedAt": "...",
      "elapsedMinutes": 35
    }
  ]
}
```

**retryable Output:**
```json
{
  "tasks": [
    {
      "id": "3.2",
      "description": "...",
      "retryCount": 1,
      "lastError": "Task stuck...",
      "lastErrorAt": "..."
    }
  ]
}
```

---

## Proposed TUI Panel Design

```
â”Œâ”€ Stuck Detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                    â”‚
â”‚  Active Tasks:                                                     â”‚
â”‚  â”œâ”€ 3.2: Merge docs into single file     ğŸ• 28:45 / 30:00  [!]   â”‚
â”‚  â””â”€ 4.1: Create redirect files           ğŸ• 15:23 / 30:00  [OK]  â”‚
â”‚                                                                    â”‚
â”‚  Recent Recovery:                                                  â”‚
â”‚  â”œâ”€ 2.5: Stuck â†’ Retry #1 â†’ âœ“ Success                             â”‚
â”‚  â””â”€ 1.3: Stuck â†’ Retry #2 â†’ âœ— Exhausted â†’ Skipped                 â”‚
â”‚                                                                    â”‚
â”‚  Controls: [E]xtend  [S]kip  [R]etry  [?]Details                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Implementation Recommendations

### High Priority

1. **Early warning display** - Show tasks approaching threshold in TUI
2. **Manual skip control** - Allow TUI-based skip without CLI
3. **Retry history visualization** - Show recovery attempts

### Medium Priority

4. **Threshold extension UI** - Allow extending per-task
5. **Stuck event streaming** - New event types for TUI

### Lower Priority

6. **Historical analysis** - Track typical task durations
7. **Threshold suggestions** - ML-based threshold recommendations

---

## Related Files

- `scripts/lib/plan-output-utils.js` - Stuck detection functions
- `scripts/status-cli.js` - CLI commands
- `scripts/plan_orchestrator.py` - Detection loop integration
- `scripts/lib/tui.py` - TUI display components

---

**End of Analysis**
