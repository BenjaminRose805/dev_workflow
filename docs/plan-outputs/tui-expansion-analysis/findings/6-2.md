# Task 6.2: Plan Isolation Mechanisms Analysis

## Summary

This analysis documents how multiple plans are isolated from each other, enabling concurrent execution without interference.

## Isolation Mechanisms

### 1. Separate status.json Per Plan

**Location Pattern:** `docs/plan-outputs/{plan-name}/status.json`

Each plan has its own status tracking file derived from the plan filename:
- `docs/plans/my-feature.md` → `docs/plan-outputs/my-feature/status.json`
- `docs/plans/tui-expansion-analysis.md` → `docs/plan-outputs/tui-expansion-analysis/status.json`

**Implementation** (from `plan-status.js:213-225`):
```javascript
function getOutputDirName(planPath) {
  return path.basename(planPath, '.md');
}

function getOutputDir(planPath) {
  const dirName = getOutputDirName(planPath);
  return resolvePath(OUTPUT_BASE, dirName);  // docs/plan-outputs/{name}/
}

function getStatusPath(planPath) {
  return path.join(getOutputDir(planPath), 'status.json');
}
```

### 2. Separate Output Directories Per Plan

**Directory Structure:**
```
docs/plan-outputs/
├── plan-a/
│   ├── status.json
│   ├── findings/
│   │   ├── 1-1.md
│   │   └── 1-2.md
│   └── timestamps/
├── plan-b/
│   ├── status.json
│   ├── findings/
│   └── timestamps/
```

**Isolation benefits:**
- Findings files are namespaced by plan
- Timestamps are per-plan
- No risk of cross-plan file conflicts

### 3. Git State Sharing (Current Limitation)

**Current behavior:** All plans in the main repo share the same git state:
- Same working directory
- Same branch (unless manually switched)
- Same uncommitted changes

**Isolation via worktrees (planned):**
When git worktrees are implemented (Phase 5), each plan will have:
- Separate working directory: `worktrees/plan-{name}/`
- Separate git branch: `plan/{name}`
- Isolated file modifications
- Independent commit history

### 4. Plan Pointer Isolation

**Main repo pointer:** `.claude/current-plan.txt`
**Worktree pointer:** `.claude-context/current-plan.txt`

Resolution priority (from `plan-status.js:98-127`):
1. `CLAUDE_WORKTREE` environment variable
2. `.claude-context/current-plan.txt` (worktree-specific)
3. `.claude/current-plan.txt` (main repo fallback)

### 5. Orchestrator Registry Per-Plan Tracking

**Location:** `.claude/orchestrator-registry.json`

The registry tracks which plans have active orchestrators:
```json
{
  "instances": [
    {
      "id": "orch-1703649123456",
      "pid": 12345,
      "plan_path": "docs/plans/plan-a.md",
      "worktree_path": null,
      "status": "running",
      "last_heartbeat": "2024-12-26T10:30:00Z"
    }
  ]
}
```

**Duplicate prevention** (from `orchestrator_registry.py:218-229`):
```python
def register(self, instance: OrchestratorInstance):
    # Check for duplicate plan
    for existing in data["instances"]:
        if inst.plan_path == instance.plan_path and inst.status == "running":
            if inst.is_alive() and not inst.is_stale():
                raise DuplicatePlanError(
                    f"Plan '{instance.plan_path}' is already running"
                )
```

## Isolation Matrix

| Aspect | Current State | With Worktrees |
|--------|--------------|----------------|
| status.json | ✅ Isolated | ✅ Isolated |
| Output directories | ✅ Isolated | ✅ Isolated |
| Git working tree | ❌ Shared | ✅ Isolated |
| Git branch | ❌ Shared | ✅ Isolated |
| Uncommitted changes | ❌ Shared | ✅ Isolated |
| Plan pointer | ✅ Isolated* | ✅ Isolated |
| Orchestrator tracking | ✅ Isolated | ✅ Isolated |

*Plan pointer is isolated only if in worktree context

## TUI Visualization Opportunities

### 1. Plan Isolation Status Panel
Display isolation level for each plan:
- Icon indicating isolation type (worktree vs shared)
- Warning if plans share git state
- Conflict indicator if both modify same files

### 2. Multi-Plan Dashboard
Show all active plans with isolation status:
```
┌─ Active Plans ─────────────────────────────────────────┐
│ ⚙ plan-a (worktree) [████████░░] 80% - isolated       │
│ ⚙ plan-b (main)     [██░░░░░░░░] 20% - shared git     │
│ ⚡ plan-c (worktree) [██████████] 100% - complete     │
└────────────────────────────────────────────────────────┘
```

### 3. Isolation Warning Banner
When multiple plans share git state:
```
⚠ Plans share git working directory - file conflicts possible
  plan-a and plan-b both modify: src/api.ts, src/utils.ts
```

### 4. Integration Points
- `status-cli.js all-plans` provides aggregate data
- `orchestrator-registry.json` provides running instance info
- Can poll both for real-time TUI updates

## Key Implementation References

| File | Function | Purpose |
|------|----------|---------|
| `plan-status.js:204-225` | `getOutputDir()` | Plan-specific output paths |
| `plan-status.js:98-127` | `getActivePlanPath()` | Worktree-aware plan resolution |
| `orchestrator_registry.py:209-244` | `register()` | Duplicate plan prevention |
| `status-cli.js:1872-2019` | `cmdAllPlans()` | Aggregate status across plans |
