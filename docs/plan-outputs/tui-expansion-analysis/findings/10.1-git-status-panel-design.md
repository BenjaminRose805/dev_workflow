# Task 10.1: Git Status Panel Expansion Design

**Date:** 2025-12-26
**Purpose:** Design concrete TUI expansion for Git Status Panel
**Scope:** Current branch, uncommitted changes, archive tag history, branch switch controls, stash management

---

## Executive Summary

The Git Status Panel is a **high-value, medium-effort** expansion that provides essential git context within the TUI. This design specifies a collapsible panel with branch status, uncommitted changes, and optional controls for branch switching and stash management.

**Estimated Effort:** 12-16 hours (Medium)
**Priority:** P1 (High Value)

---

## 1. Panel Overview

### 1.1 Purpose

Provide at-a-glance git status without leaving the TUI:
- Current branch and validation state
- Uncommitted changes count and details
- Commit history context
- Optional: Branch switching and stash controls

### 1.2 Data Sources

| Data | Source | Update Frequency |
|------|--------|------------------|
| Current branch | `git branch --show-current` | On demand / 5s |
| Expected branch | `.claude/git-workflow.json` | Startup |
| Uncommitted count | `git status --porcelain \| wc -l` | On demand / 5s |
| Uncommitted files | `git status --porcelain` | On expand |
| Commits ahead | `git rev-list --count HEAD ^main` | On demand / 30s |
| Last commit | `git log -1 --format="%h %s"` | On demand / 30s |
| Stash list | `git stash list` | On expand |
| Archive tags | `git tag -l "archive/*"` | On expand |

---

## 2. Visual Design

### 2.1 Collapsed State (Default)

Single-line summary in header or below progress bar:

```
┌─ Git ─────────────────────────────────────────────────────────────────┐
│ ⚡ plan/my-feature ✓  │  2 uncommitted  │  5 ahead  │  abc1234 [...]  │
└───────────────────────────────────────────────────────────────────────┘
```

**Elements:**
| Element | Display | Style |
|---------|---------|-------|
| Branch icon | `⚡` | White |
| Branch name | `plan/my-feature` | Cyan |
| Validation | `✓` / `⚠` / `✗` | Green / Yellow / Red |
| Uncommitted | `2 uncommitted` | Yellow if >0, dim if 0 |
| Ahead count | `5 ahead` | Cyan |
| Last commit | `abc1234 [...]` | Dim |

### 2.2 Expanded State (Toggle with `g` key)

Full panel showing detailed git information:

```
┌─ Git Status ──────────────────────────────────────────────────────────┐
│                                                                        │
│  Branch: plan/tui-expansion-analysis ✓                                 │
│  Remote: origin/plan/tui-expansion-analysis (up to date)               │
│                                                                        │
│  Uncommitted Changes (2):                                              │
│    M  docs/plan-outputs/tui-expansion-analysis/status.json             │
│    ??  docs/plan-outputs/tui-expansion-analysis/findings/10.1.md       │
│                                                                        │
│  Recent Commits:                                                       │
│    abc1234  [tui] task 9.5: Categorized gaps                           │
│    def5678  [tui] task 9.4: Identified orchestrator gaps               │
│    ghi9012  [tui] task 9.3: Identified parallel gaps                   │
│                                                                        │
│  [b] Switch branch  [s] Stash  [c] Commit  [g] Collapse                │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Branch Switch Modal (Future Enhancement)

Triggered by `b` key from expanded panel:

```
┌─ Switch Branch ───────────────────────────────────────────────────────┐
│                                                                        │
│  Current: plan/tui-expansion-analysis                                  │
│                                                                        │
│  Available Plan Branches:                                              │
│    ● plan/tui-expansion-analysis (current)                             │
│    ○ plan/git-workflow-phase5-worktrees                                │
│    ○ plan/parallel-execution-foundation                                │
│                                                                        │
│  Other Branches:                                                       │
│    ○ main                                                              │
│    ○ feature/other-work                                                │
│                                                                        │
│  [↑/↓] Navigate  [Enter] Switch  [Esc] Cancel                         │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

### 2.4 Stash Management Modal (Future Enhancement)

Triggered by `s` key from expanded panel:

```
┌─ Stash Management ────────────────────────────────────────────────────┐
│                                                                        │
│  Stashes (2):                                                          │
│    0: WIP on plan/my-feature: abc1234 Work in progress                 │
│    1: On plan/other-plan: def5678 Experimental changes                 │
│                                                                        │
│  Actions:                                                              │
│    [a] Apply selected stash                                            │
│    [p] Pop selected stash                                              │
│    [d] Drop selected stash                                             │
│    [n] Create new stash                                                │
│                                                                        │
│  [↑/↓] Navigate  [Enter] Apply  [Esc] Cancel                          │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Implementation Specification

### 3.1 New Python Classes

#### GitStatusPanel

```python
class GitStatusPanel:
    """Git status panel for TUI."""

    def __init__(self, config: Optional[Dict] = None):
        self.config = config or {}
        self.expanded = False
        self.branch = None
        self.expected_branch = None
        self.uncommitted = []
        self.commits_ahead = 0
        self.last_commits = []
        self.stashes = []
        self.last_refresh = None

    def refresh(self, force: bool = False) -> None:
        """Refresh git data."""
        if not force and self.last_refresh:
            if time.time() - self.last_refresh < 5:
                return

        self.branch = self._get_current_branch()
        self.expected_branch = self._get_expected_branch()
        self.uncommitted = self._get_uncommitted_files()
        self.commits_ahead = self._get_commits_ahead()
        self.last_commits = self._get_recent_commits(3)
        self.last_refresh = time.time()

    def _get_current_branch(self) -> str:
        """Get current git branch."""
        result = subprocess.run(
            ['git', 'branch', '--show-current'],
            capture_output=True, text=True
        )
        return result.stdout.strip() if result.returncode == 0 else None

    def _get_expected_branch(self) -> Optional[str]:
        """Get expected branch from config."""
        config_path = '.claude/git-workflow.json'
        if not os.path.exists(config_path):
            return None
        with open(config_path) as f:
            config = json.load(f)
        prefix = config.get('branch_prefix', 'plan/')
        plan_name = self._get_plan_name()
        return f"{prefix}{plan_name}" if plan_name else None

    def _get_uncommitted_files(self) -> List[Dict]:
        """Get list of uncommitted files."""
        result = subprocess.run(
            ['git', 'status', '--porcelain'],
            capture_output=True, text=True
        )
        if result.returncode != 0:
            return []
        files = []
        for line in result.stdout.strip().split('\n'):
            if line:
                status = line[:2]
                path = line[3:]
                files.append({'status': status.strip(), 'path': path})
        return files

    def _get_commits_ahead(self) -> int:
        """Get number of commits ahead of main."""
        result = subprocess.run(
            ['git', 'rev-list', '--count', 'HEAD', '^main'],
            capture_output=True, text=True
        )
        return int(result.stdout.strip()) if result.returncode == 0 else 0

    def _get_recent_commits(self, count: int) -> List[Dict]:
        """Get recent commits."""
        result = subprocess.run(
            ['git', 'log', f'-{count}', '--format=%h %s'],
            capture_output=True, text=True
        )
        if result.returncode != 0:
            return []
        return [
            {'hash': line.split(' ', 1)[0], 'message': line.split(' ', 1)[1] if ' ' in line else ''}
            for line in result.stdout.strip().split('\n') if line
        ]

    def render_collapsed(self) -> Text:
        """Render collapsed single-line view."""
        text = Text()

        # Branch with validation
        text.append("⚡ ", style="white")
        text.append(self.branch or "detached", style="cyan")
        text.append(" ")

        if self.branch == self.expected_branch:
            text.append("✓", style="green")
        elif self.expected_branch:
            text.append("⚠", style="yellow")
        else:
            text.append("◯", style="dim")

        text.append("  │  ", style="dim")

        # Uncommitted
        count = len(self.uncommitted)
        if count > 0:
            text.append(f"{count} uncommitted", style="yellow")
        else:
            text.append("clean", style="dim green")

        text.append("  │  ", style="dim")

        # Ahead count
        if self.commits_ahead > 0:
            text.append(f"{self.commits_ahead} ahead", style="cyan")
        else:
            text.append("synced", style="dim")

        text.append("  │  ", style="dim")

        # Last commit
        if self.last_commits:
            commit = self.last_commits[0]
            text.append(f"{commit['hash']} ", style="dim")
            msg = commit['message'][:30] + "..." if len(commit['message']) > 30 else commit['message']
            text.append(msg, style="dim")

        return text

    def render_expanded(self) -> Panel:
        """Render expanded panel view."""
        content = Table(show_header=False, box=None, expand=True, padding=(0, 1))
        content.add_column("Label", style="dim", width=20)
        content.add_column("Value", overflow="fold")

        # Branch info
        branch_text = Text()
        branch_text.append(self.branch or "detached", style="cyan")
        if self.branch == self.expected_branch:
            branch_text.append(" ✓", style="green")
        elif self.expected_branch:
            branch_text.append(f" ⚠ expected: {self.expected_branch}", style="yellow")
        content.add_row("Branch:", branch_text)

        content.add_row("", "")

        # Uncommitted files
        if self.uncommitted:
            content.add_row(f"Uncommitted ({len(self.uncommitted)}):", "")
            for file in self.uncommitted[:5]:
                status_style = "yellow" if file['status'] in ('M', 'A') else "red"
                content.add_row("", Text(f"  {file['status']}  {file['path']}", style=status_style))
            if len(self.uncommitted) > 5:
                content.add_row("", Text(f"  ... and {len(self.uncommitted) - 5} more", style="dim"))
        else:
            content.add_row("Status:", Text("Working tree clean", style="green"))

        content.add_row("", "")

        # Recent commits
        content.add_row("Recent Commits:", "")
        for commit in self.last_commits:
            content.add_row("", Text(f"  {commit['hash']}  {commit['message'][:50]}", style="dim"))

        content.add_row("", "")

        # Controls
        controls = Text()
        controls.append("[b] Switch branch  ", style="dim cyan")
        controls.append("[s] Stash  ", style="dim cyan")
        controls.append("[c] Commit  ", style="dim cyan")
        controls.append("[g] Collapse", style="dim cyan")
        content.add_row("", controls)

        return Panel(content, title="Git Status", border_style="blue")

    def toggle(self) -> None:
        """Toggle expanded/collapsed state."""
        self.expanded = not self.expanded
        if self.expanded:
            self.refresh(force=True)
```

### 3.2 Integration into RichTUIManager

```python
class RichTUIManager:
    def __init__(self, plan_name: str):
        # ... existing init ...
        self.git_panel = GitStatusPanel()
        self.git_panel.refresh()

    def _create_layout(self) -> Layout:
        """Create the TUI layout structure."""
        layout = Layout()

        layout.split(
            Layout(name="header", size=5),
            Layout(name="git", size=3 if not self.git_panel.expanded else 12),  # NEW
            Layout(name="progress", size=3),
            Layout(name="activity", size=10),
            Layout(name="tasks", size=8),
            Layout(name="footer", size=2)
        )

        # ... existing task split ...
        return layout

    def _render_git(self) -> Union[Text, Panel]:
        """Render git status panel."""
        if self.git_panel.expanded:
            return self.git_panel.render_expanded()
        else:
            return Panel(
                self.git_panel.render_collapsed(),
                title="Git",
                border_style="dim"
            )

    def handle_key(self, key: str) -> bool:
        """Handle keyboard input."""
        if key == 'g':
            self.git_panel.toggle()
            return True
        if key == 'b' and self.git_panel.expanded:
            self._show_branch_modal()
            return True
        if key == 's' and self.git_panel.expanded:
            self._show_stash_modal()
            return True
        return False
```

### 3.3 Keyboard Mappings

| Key | Context | Action |
|-----|---------|--------|
| `g` | Global | Toggle git panel expand/collapse |
| `b` | Git panel expanded | Open branch switch modal |
| `s` | Git panel expanded | Open stash management modal |
| `c` | Git panel expanded | Trigger commit (if uncommitted changes) |
| `r` | Git panel | Refresh git status |

---

## 4. Data Contract

### 4.1 Git Status Data Object

```typescript
interface GitStatus {
  available: boolean;
  branch: string | null;
  expectedBranch: string | null;
  branchValid: boolean;
  uncommitted: {
    count: number;
    files: Array<{
      status: string;  // "M", "A", "D", "??"
      path: string;
    }>;
  };
  remote: {
    configured: boolean;
    ahead: number;
    behind: number;
    tracking: string | null;
  };
  lastCommit: {
    hash: string;
    message: string;
    author: string;
    timestamp: string;
  } | null;
  stashes: Array<{
    index: number;
    message: string;
    branch: string;
  }>;
  archiveTags: Array<{
    name: string;
    planName: string;
    timestamp: string;
  }>;
}
```

### 4.2 Branch Modal Data

```typescript
interface BranchList {
  current: string;
  planBranches: Array<{
    name: string;
    planName: string;
    isActive: boolean;  // Has associated active plan
  }>;
  otherBranches: Array<{
    name: string;
    lastCommit: string;
  }>;
}
```

---

## 5. Effort Estimate

### 5.1 Implementation Breakdown

| Component | Effort | Priority |
|-----------|--------|----------|
| GitStatusPanel class | 4 hours | P0 |
| Collapsed view render | 2 hours | P0 |
| Expanded view render | 3 hours | P0 |
| Layout integration | 2 hours | P0 |
| Keyboard handling | 1 hour | P0 |
| **Subtotal Core:** | **12 hours** | - |
| Branch switch modal | 4 hours | P1 |
| Stash management modal | 4 hours | P2 |
| Archive browser | 6 hours | P3 |
| **Subtotal Enhanced:** | **14 hours** | - |
| **Total:** | **26 hours** | - |

### 5.2 Phase Breakdown

| Phase | Features | Effort |
|-------|----------|--------|
| **Phase A: Core Panel** | Collapsed + Expanded views | 12 hours |
| **Phase B: Branch Controls** | Branch switch modal | 4 hours |
| **Phase C: Stash Controls** | Stash management | 4 hours |
| **Phase D: Archive** | Archive browser | 6 hours |

### 5.3 Recommended Implementation

**MVP (Phase A):** 12 hours
- Git status data collection
- Collapsed single-line view
- Expanded panel with full info
- Toggle with `g` key
- Auto-refresh every 5 seconds

**Full Feature (Phases A+B+C):** 20 hours
- All MVP features
- Branch switch modal
- Stash management modal

---

## 6. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Git command failures | MEDIUM | LOW | Graceful fallback to "unavailable" |
| Performance on large repos | LOW | MEDIUM | Cache data, limit file list |
| Branch switch with uncommitted | MEDIUM | HIGH | Warn user, offer stash |
| Stash conflicts | LOW | MEDIUM | Show conflict message |

---

## 7. Success Criteria

### 7.1 Functional Requirements

- [ ] Collapsed view shows branch, uncommitted count, ahead count
- [ ] Expanded view shows full git status with file list
- [ ] `g` key toggles between collapsed/expanded
- [ ] Branch validation shows ✓/⚠ based on expected branch
- [ ] Data refreshes automatically every 5 seconds
- [ ] No git = graceful degradation (show "Git: unavailable")

### 7.2 Quality Requirements

- [ ] Git commands execute in <500ms
- [ ] Panel renders without flicker
- [ ] Handles repositories with 100+ uncommitted files
- [ ] Works on Linux, macOS, WSL2

### 7.3 Integration Requirements

- [ ] Fits in existing TUI layout without breaking other panels
- [ ] Keyboard mappings don't conflict with existing bindings
- [ ] Panel state persists across refreshes

---

## 8. Related Documents

- Task 1.4: Git feature to TUI mapping
- Task 9.2: Git workflow gaps analysis
- Task 9.5: Complexity categorization (Medium Effort)

---

**End of Design**
