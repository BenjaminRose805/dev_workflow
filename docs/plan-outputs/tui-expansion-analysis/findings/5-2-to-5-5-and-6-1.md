# Phase 5-6: Git Commit Queue, Serialization & Multi-Plan Analysis

**Analysis Plan:** TUI Workflow Expansion Analysis
**Tasks Covered:** 5.2, 5.3, 5.4, 5.5, 6.1
**Date:** 2025-12-26

---

## 5.2 Queue Status Reporting Analysis

### getQueueStatus() Output Format

The `getQueueStatus()` function in `scripts/lib/git-queue.js:394-414` returns a comprehensive status object:

```javascript
{
  pendingCount: number,        // Count of commits waiting in queue
  isProcessing: boolean,       // Whether a commit is currently being processed
  lockAcquiredAt: string|null, // ISO timestamp when lock was acquired
  pending: [                   // Array of pending commit details
    {
      id: string,              // Unique commit ID (e.g., "commit-1703544123456-abc123def")
      message: string,         // Commit message
      files: string[],         // Files to stage (empty = all)
      queuedAt: string,        // ISO timestamp when queued
      position: number         // Position in queue (0-indexed)
    }
  ],
  lastCommitAt: string|null,   // ISO timestamp of last successful commit
  lastCommitHash: string|null, // Git hash of last commit
  totalCommits: number,        // Total commits processed since queue started
  failedCommits: number,       // Count of failed commit attempts
  lastError: string|null       // Error message from most recent failure
}
```

### Queue Status Integration in status-cli.js

The queue status is integrated in two places:

1. **JSON Output Mode** (`status-cli.js:1316-1328`):
   - Added to `progress --json` output as `gitQueue` field
   - Only included when `pendingCount > 0`
   - Shows `pending` count and `isProcessing` state

2. **Human-Readable Output** (`status-cli.js:1598-1611`):
   - Displayed after git information in `progress` command
   - Shows pending count and processing indicator
   - Uses `⟳` spinner symbol when processing

### Queue Status Persistence

Status is persisted to `docs/plan-outputs/.git-queue-status.json`:
- Written atomically (temp file + rename) - `git-queue.js:112-131`
- Updated after each queue operation via `syncQueueStatus()` - `git-queue.js:136-151`
- Contains: pending commits, last commit timestamp, total/failed counts

---

## 5.3 Race Condition Prevention Patterns

### Pattern 1: Read-Only Agent Pattern

**Location:** `.claude/commands/plan/implement.md:600-602`

**Description:** Agents return content instead of writing files directly. The main conversation handles all file writes.

**Implementation:**
```
IMPORTANT: Do NOT write files directly. Instead:
1. Analyze the task requirements
2. Generate the complete code/content
3. Return your output in this format:
   FILE: <path>
   ```<language>
   <content>
   ```
4. The main conversation will handle file writing
```

**Benefits:**
- Eliminates concurrent write conflicts between parallel agents
- Provides a checkpoint for review before changes are committed
- Avoids permission issues
- Centralizes file writing for consistent error handling

### Pattern 2: Atomic File Writes (Temp + Rename)

**Location:** `scripts/lib/plan-status.js:297-318`

**Implementation:**
```javascript
function writeFileAtomic(filePath, content) {
  const tempPath = filePath + '.tmp.' + process.pid;
  fs.writeFileSync(tempPath, content, 'utf8');
  fs.renameSync(tempPath, filePath);
  return true;
}
```

**Properties:**
- Process ID in temp file name prevents collisions between concurrent writers
- Rename is atomic on POSIX systems (all-or-nothing)
- Prevents partial writes from corrupting files

### Pattern 3: Optimistic Locking for status.json

**Documented in:** `docs/plan-outputs/parallel-execution-architecture/findings/6-recommendations.md:333-349`

**Proposed Implementation:**
```javascript
function updateStatusWithVersion(planPath, updateFn) {
  const current = loadStatus(planPath);
  const expectedVersion = current.version || 0;

  const updated = updateFn(current);
  updated.version = expectedVersion + 1;

  // Verify version hasn't changed
  const recheck = loadStatus(planPath);
  if ((recheck.version || 0) !== expectedVersion) {
    throw new Error('Status.json modified concurrently, retry required');
  }

  writeStatusAtomic(planPath, updated);
}
```

**Current State:** The version field is documented but not yet fully implemented. Atomic writes provide the primary protection.

### Pattern 4: Lock Timeout for Stale Locks

**Location:** `scripts/lib/git-queue.js:280-287`

**Implementation:**
```javascript
// Check for stale lock
if (lockAcquiredAt) {
  const lockAge = Date.now() - new Date(lockAcquiredAt).getTime();
  if (lockAge > LOCK_TIMEOUT_MS) {  // LOCK_TIMEOUT_MS = 60000 (1 minute)
    console.warn('Git queue lock timed out, releasing...');
    isProcessing = false;
    lockAcquiredAt = null;
  }
}
```

**Purpose:** Prevents permanent deadlock if a process crashes while holding the lock.

---

## 5.4 Commit Serialization in Parallel Execution

### Queue Mechanism

**Data Structure:** In-memory array with Promise-based resolution (`git-queue.js:52-59`)

```javascript
const commitQueue = [];       // FIFO queue of pending commits
let isProcessing = false;     // Lock to prevent concurrent processing
let lockAcquiredAt = null;    // Timestamp for timeout detection
const drainCallbacks = [];    // Callbacks waiting for queue to empty
```

### Queue Processing Flow

1. **Queueing a Commit** (`queueCommit()` - lines 246-267):
   - Creates unique ID using timestamp + random string
   - Wraps in Promise for async/await support
   - Adds to queue and triggers processing

2. **Processing Loop** (`processQueue()` - lines 273-364):
   - Exits if already processing (single-threaded execution)
   - Checks for stale locks (>60 second timeout)
   - Processes one commit at a time:
     - Stage files
     - Create commit
     - Update status file
     - Resolve/reject Promise
   - Small delay (100ms) between commits prevents rapid-fire issues
   - Notifies drain callbacks when queue empties

### Commit Message Preservation

**Format:** `[plan-name] task {id}: {description}`

**Implementation in implement.md:**
```bash
git commit -m "$(cat <<EOF
[$PLAN_NAME] task $TASK_ID: $BRIEF_DESCRIPTION

Plan: $PLAN_NAME
Phase: $PHASE_NUM - $PHASE_NAME
Task: $TASK_ID
EOF
)"
```

**Metadata preserved:**
- Plan name in subject line
- Task ID for traceability
- Phase context in body
- Full task description

### Error Handling

**Graceful degradation:**
- Commit failures don't fail the task (`implement.md:759-761`)
- Queue continues processing remaining commits
- Failed commits increment `failedCommits` counter
- Last error stored in `lastError` field

### Queue Bypass Option

**`--noQueue` flag** (`git-queue.js:374-388`):
- Bypasses queue for direct commit
- Returns `{ queued: false }` to indicate bypass
- Useful for manual operations that shouldn't wait

---

## 5.5 Serialization System to TUI Visualization Mapping

### TUI Panel Opportunities

| Component | Data Source | Visualization Approach |
|-----------|-------------|----------------------|
| **Commit Queue Panel** | `getQueueStatus()` | List of pending commits with position indicators |
| **Processing Indicator** | `isProcessing` field | Spinner/animation when commit in progress |
| **Queue Length Badge** | `pendingCount` | Badge on panel header showing count |
| **Commit History Stream** | `lastCommitHash`, `lastCommitAt` | Real-time log of completed commits |
| **Error Display** | `lastError`, `failedCommits` | Error badge with expandable details |

### Commit Queue Panel Design

```
┌─ Git Commit Queue ────────────────────┐
│ ⟳ Processing: [plan] task 2.1...      │
│                                       │
│ Pending:                              │
│   1. [plan] task 2.2: Add tests       │
│   2. [plan] task 2.3: Update docs     │
│                                       │
│ Stats: 15 total │ 0 failed            │
└───────────────────────────────────────┘
```

### Real-Time Updates

**File-based monitoring:**
- TUI can watch `docs/plan-outputs/.git-queue-status.json`
- File is updated after each queue operation
- Atomic writes ensure consistent reads

**In-memory integration:**
- If TUI runs in same process, can access `getQueueStatus()` directly
- Use `waitForDrain()` for synchronization with queue completion

### "Waiting for Git" Indicator

**Task state extension:**
```javascript
{
  id: "2.3",
  status: "in_progress",
  gitStatus: "queued"  // New field: "queued" | "committing" | "committed" | null
}
```

**TUI display:**
```
✓ 2.1 Create auth service      [committed 5s ago]
⟳ 2.2 Add validation logic     [committing...]
◐ 2.3 Write integration tests  [waiting for git]
⏳ 2.4 Update documentation    [pending]
```

### Queue Management Controls

**Potential TUI actions:**
1. **View queue details** - Expand to see full commit messages
2. **Clear queue** - Emergency queue flush (with warning)
3. **Reorder** - Drag/drop to change commit order (advanced)
4. **Cancel pending** - Remove specific pending commit
5. **Retry failed** - Re-queue failed commits

---

## 6.1 `--plan` Argument Implementation Analysis

### Argument Parsing

**Location:** `scripts/lib/plan-status.js:155-197`

**Function:** `getPlanPathFromArgs(args)`

**Supported formats:**
- `--plan docs/plans/my-plan.md` (space-separated)
- `--plan=docs/plans/my-plan.md` (equals-separated)

**Return value:**
```javascript
{
  planPath: string | null,    // Resolved plan path
  error: string | null,       // Error message if validation failed
  remainingArgs: string[]     // Args with --plan removed
}
```

### Validation Logic

1. **Extract --plan argument:**
   - Check for `--plan` followed by value
   - Check for `--plan=` prefix

2. **Validate path if provided:**
   - Convert relative to absolute path
   - Check file exists
   - Return error if not found: `"Plan file not found: {path}"`

3. **Fallback behavior:**
   - If no `--plan` provided, call `getActivePlanPath()`
   - Returns from `current-plan.txt` (main repo or worktree)
   - Returns error if no active plan: `"No active plan set. Use --plan <path> or /plan:set to choose a plan first."`

### Integration in status-cli.js

**Location:** `scripts/status-cli.js:3631-3634`

```javascript
const rawArgs = process.argv.slice(2);
const { planPath, error, remainingArgs } = getPlanPathFromArgs(rawArgs);
```

**Usage:**
- All commands receive the resolved `planPath`
- Commands use `remainingArgs` for their own options
- Error displayed and process exits if `planPath` is null and command needs it

### Multi-Plan Support Implications

**Enabled capabilities:**
1. **Concurrent sessions:** Multiple terminals can run different plans
2. **CI/CD integration:** Scripts can specify explicit plan paths
3. **Scripting:** Batch operations across multiple plans
4. **Testing:** Test commands against specific plan files

**Example usage:**
```bash
# Check status for a specific plan
node scripts/status-cli.js --plan docs/plans/my-plan.md status

# Get next tasks from a specific plan
node scripts/status-cli.js --plan docs/plans/my-plan.md next 3

# Progress for specific plan
node scripts/status-cli.js --plan docs/plans/auth-feature.md progress
```

### TUI Integration Points

| Feature | TUI Implementation |
|---------|-------------------|
| **Plan Selector** | Dropdown/list of available plans with `--plan` integration |
| **Multi-Plan Dashboard** | Each plan widget uses explicit `--plan` for status queries |
| **Plan Switcher** | Updates TUI state without changing `current-plan.txt` |
| **Quick Switch** | Keyboard shortcut to cycle through recent plans |

---

## Summary: TUI Expansion Opportunities

### High-Priority Visualizations

1. **Commit Queue Panel**
   - Shows pending commits
   - Processing indicator
   - Queue length badge
   - Error notifications

2. **Git Status Integration**
   - Current queue state in status bar
   - "Waiting for git" indicators on tasks
   - Commit history stream

3. **Multi-Plan Support**
   - Plan selector using `--plan` argument
   - Side-by-side plan comparison
   - Cross-plan progress overview

### Implementation Considerations

| Consideration | Recommendation |
|---------------|----------------|
| **Data refresh** | Watch queue status file for changes |
| **Race conditions** | Read-only pattern already handles this |
| **Error display** | Show `lastError` prominently with retry option |
| **Performance** | Queue status file is small, frequent reads OK |

### Verification Criteria

- [x] 5.2: Queue status output format documented (`getQueueStatus()` fields)
- [x] 5.2: `pendingCount`, `isProcessing`, queue contents documented
- [x] 5.3: Read-only agent pattern documented
- [x] 5.3: Atomic file writes (temp + rename) documented
- [x] 5.3: Optimistic locking approach documented
- [x] 5.4: Commit queueing mechanism documented
- [x] 5.4: Commit message preservation format documented
- [x] 5.4: Error handling for failed commits documented
- [x] 5.5: Commit queue panel design proposed
- [x] 5.5: "Waiting for git" indicator design proposed
- [x] 5.5: Queue management controls identified
- [x] 6.1: `--plan` argument parsing documented (`getPlanPathFromArgs()`)
- [x] 6.1: Fallback to `current-plan.txt` behavior documented
- [x] 6.1: TUI integration points identified
