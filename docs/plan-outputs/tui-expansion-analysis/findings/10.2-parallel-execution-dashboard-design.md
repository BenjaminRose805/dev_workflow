# Task 10.2: Parallel Execution Dashboard Design

**Date:** 2025-12-26
**Purpose:** Design TUI panel for parallel execution visibility
**Scope:** Active sessions, file conflicts, commit queue, concurrent plans, constraint visualization

---

## Executive Summary

The Parallel Execution Dashboard is a **high-value, medium-effort** expansion that provides real-time visibility into parallel task execution. This design specifies a multi-section panel with session status, conflict warnings, commit queue visualization, and constraint indicators.

**Estimated Effort:** 20-28 hours (Medium-High)
**Priority:** P1 (High Value)

---

## 1. Panel Overview

### 1.1 Purpose

Provide comprehensive visibility into parallel execution state:
- How many tasks/agents are running concurrently
- File conflicts preventing parallelization
- Git commit queue status
- [SEQUENTIAL]/[PARALLEL] constraint enforcement
- Cross-plan execution state (if multiple plans active)

### 1.2 Data Sources

| Data | Source | Update Frequency |
|------|--------|------------------|
| Active tasks | status.json `in_progress` | 500ms polling |
| Active agents | ActivityTracker spawn count | Real-time |
| Commit queue | `.git-queue-status.json` | On demand / 1s |
| File conflicts | `cmdNext()` output | Per iteration |
| Sequential groups | Plan file annotations | Startup / plan change |
| Parallel phases | Plan file annotations | Startup / plan change |
| Concurrent plans | orchestrator-registry.json | 5s polling |

---

## 2. Visual Design

### 2.1 Collapsed State (Default)

Single-line summary in header or dedicated row:

```
┌─ Parallel Execution ──────────────────────────────────────────────────┐
│ ⚡ 3 tasks │ 4 agents │ 2 queued commits │ ⚠ 1 conflict │ [PARALLEL]  │
└───────────────────────────────────────────────────────────────────────┘
```

**Elements:**
| Element | Display | Style |
|---------|---------|-------|
| Tasks count | `3 tasks` | Cyan |
| Agents count | `4 agents` | Green |
| Commit queue | `2 queued commits` | Yellow if >0, dim if 0 |
| Conflicts | `⚠ 1 conflict` | Red if >0, hidden if 0 |
| Mode indicator | `[PARALLEL]` or `[SEQUENTIAL]` | Cyan/Yellow |

### 2.2 Expanded State (Toggle with `p` key)

Full dashboard with detailed sections:

```
┌─ Parallel Execution Dashboard ────────────────────────────────────────┐
│                                                                        │
│  ┌─ Active Sessions ───────────────────────────────────────────────┐  │
│  │  Tasks Running: ████████░░  3/10                                │  │
│  │  Agents Active: ██████████  5/10                                │  │
│  │  Peak: 5 tasks / 8 agents (12:34:56)                            │  │
│  │                                                                  │  │
│  │  3.1: Merge ORCHESTRATOR.md    [Agent 1, Agent 2]   ⏳ 5:23    │  │
│  │  3.2: Merge ARCHITECTURE.md    [Agent 3]            ✓ Done     │  │
│  │  4.1: Add git status panel     [Agent 4, Agent 5]   ⏳ 2:11    │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│  ┌─ Constraints Active ──────────────┬─ Commit Queue ───────────────┐  │
│  │  [PARALLEL] Phases 3-4 enabled    │  ⟳ Processing: task 3.1...   │  │
│  │                                   │                               │  │
│  │  Sequential Chain:                │  Pending:                     │  │
│  │  [3.1] → [3.3] → [3.4]           │    1. [plan] task 3.2         │  │
│  │  └─ All modify orchestrator.md   │    2. [plan] task 4.1         │  │
│  │                                   │                               │  │
│  │  File Conflicts:                  │  Stats: 15 total │ 0 failed  │  │
│  │  ⚠ tui.py: 5.1, 5.3 (held)       │                               │  │
│  └───────────────────────────────────┴───────────────────────────────┘  │
│                                                                        │
│  [t] Task detail  [c] Commit queue  [f] Conflicts  [p] Collapse       │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

### 2.3 Active Sessions Section

Real-time view of running tasks and their agents:

```
┌─ Active Sessions ───────────────────────────────────────────────────────┐
│                                                                          │
│  Concurrency:                                                            │
│    Tasks:  [████████░░░░░░░░░░░░] 3/10 (batch limit: 5)                 │
│    Agents: [██████████░░░░░░░░░░] 5/10                                  │
│    Tools:  [████████████░░░░░░░░] 12 active                             │
│                                                                          │
│  Running Tasks:                                                          │
│  ┌──────┬────────────────────────────┬─────────────┬────────────────┐   │
│  │ ID   │ Description                │ Agents      │ Time / Status  │   │
│  ├──────┼────────────────────────────┼─────────────┼────────────────┤   │
│  │ 3.1  │ Merge ORCHESTRATOR.md      │ Agent 1,2   │ ⏳ 5:23        │   │
│  │ 3.2  │ Merge ARCHITECTURE.md      │ Agent 3     │ ✓ Complete     │   │
│  │ 4.1  │ Add git status panel       │ Agent 4,5   │ ⏳ 2:11        │   │
│  └──────┴────────────────────────────┴─────────────┴────────────────┘   │
│                                                                          │
│  Peak Concurrency: 5 tasks / 8 agents at 12:34:56                       │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 2.4 File Conflict Warning Section

Prominent display when conflicts exist:

```
┌─ ⚠ File Conflicts ──────────────────────────────────────────────────────┐
│                                                                          │
│  Conflicts detected - tasks running sequentially:                        │
│                                                                          │
│  orchestrator.md:                                                        │
│    ├─ ⏳ 3.1 Merge ORCHESTRATOR.md (running)                            │
│    ├─ ⏸ 3.3 Create redirect file (waiting)                             │
│    └─ ⏸ 3.4 Remove duplicate section (waiting)                         │
│                                                                          │
│  tui.py:                                                                 │
│    ├─ ⏳ 5.1 Add parallelism indicator (running)                        │
│    └─ ⏸ 5.3 Update layout (waiting)                                    │
│                                                                          │
│  Impact: 4 tasks held back, estimated delay +12 min                      │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 2.5 Commit Queue Section

```
┌─ Git Commit Queue ──────────────────────────────────────────────────────┐
│                                                                          │
│  Status: ⟳ Processing commit...                                         │
│                                                                          │
│  Current:                                                                │
│    [plan] task 3.1: Merge ORCHESTRATOR.md                               │
│                                                                          │
│  Pending (2):                                                            │
│    1. [plan] task 3.2: Merge ARCHITECTURE.md                            │
│    2. [plan] task 4.1: Add git status panel                             │
│                                                                          │
│  History:                                                                │
│    abc1234 ✓ [plan] task 2.1: Update API (2s ago)                       │
│    def5678 ✓ [plan] task 2.2: Add tests (15s ago)                       │
│                                                                          │
│  Stats: 15 commits today │ 0 failed │ Avg: 1.2s                         │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

### 2.6 Sequential/Parallel Constraint Visualization

```
┌─ Execution Constraints ─────────────────────────────────────────────────┐
│                                                                          │
│  Mode: [PARALLEL] - Phases 3, 4, 5 can run concurrently                 │
│                                                                          │
│  Sequential Chains:                                                      │
│                                                                          │
│  Chain 1 (orchestrator.md):                                              │
│    ⏳ 3.1 ──→ ⏸ 3.3 ──→ ⏸ 3.4                                         │
│    └─ Annotation: [SEQUENTIAL] in Phase 3                               │
│                                                                          │
│  Chain 2 (auto-detected):                                                │
│    ⏳ 5.1 ──→ ⏸ 5.3                                                     │
│    └─ Reason: Both modify tui.py                                        │
│                                                                          │
│  Ready for Parallel:                                                     │
│    4.2, 4.3, 4.4 (no conflicts)                                         │
│                                                                          │
└──────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Implementation Specification

### 3.1 New Python Classes

#### ParallelExecutionDashboard

```python
class ParallelExecutionDashboard:
    """Parallel execution dashboard for TUI."""

    def __init__(self, config: Optional[Dict] = None):
        self.config = config or {}
        self.expanded = False

        # Session tracking
        self.active_tasks: List[Dict] = []
        self.active_agents: List[Dict] = []
        self.peak_tasks = 0
        self.peak_agents = 0
        self.peak_time: Optional[datetime] = None

        # Constraint tracking
        self.sequential_chains: List[Dict] = []
        self.parallel_phases: List[int] = []
        self.file_conflicts: List[Dict] = []

        # Commit queue
        self.commit_queue: Dict = {}

        # Refresh
        self.last_refresh: Optional[float] = None

    def refresh(self, force: bool = False) -> None:
        """Refresh all dashboard data."""
        if not force and self.last_refresh:
            if time.time() - self.last_refresh < 1.0:
                return

        self._refresh_active_sessions()
        self._refresh_constraints()
        self._refresh_commit_queue()
        self._update_peaks()
        self.last_refresh = time.time()

    def _refresh_active_sessions(self) -> None:
        """Get active tasks and agents from status."""
        status = self._load_status()
        self.active_tasks = [
            t for t in status.get('tasks', [])
            if t.get('status') == 'in_progress'
        ]
        # Agent count from activity tracker (injected)
        if hasattr(self, 'activity_tracker'):
            self.active_agents = self.activity_tracker.get_active_agents()

    def _refresh_constraints(self) -> None:
        """Get constraint info from cmdNext output."""
        # Call status-cli.js next to get constraint metadata
        result = subprocess.run(
            ['node', 'scripts/status-cli.js', 'next', '10', '--json'],
            capture_output=True, text=True
        )
        if result.returncode == 0:
            data = json.loads(result.stdout)
            self.sequential_chains = data.get('sequentialGroups', [])
            self.file_conflicts = data.get('fileConflicts', [])
            self.parallel_phases = data.get('parallelPhases', [])

    def _refresh_commit_queue(self) -> None:
        """Get commit queue status."""
        queue_file = 'docs/plan-outputs/.git-queue-status.json'
        if os.path.exists(queue_file):
            with open(queue_file) as f:
                self.commit_queue = json.load(f)
        else:
            self.commit_queue = {'pendingCount': 0, 'isProcessing': False}

    def _update_peaks(self) -> None:
        """Update peak concurrency tracking."""
        current_tasks = len(self.active_tasks)
        current_agents = len(self.active_agents)
        if current_tasks > self.peak_tasks or current_agents > self.peak_agents:
            self.peak_tasks = max(self.peak_tasks, current_tasks)
            self.peak_agents = max(self.peak_agents, current_agents)
            self.peak_time = datetime.now()

    def render_collapsed(self) -> Text:
        """Render collapsed single-line summary."""
        text = Text()

        # Tasks
        task_count = len(self.active_tasks)
        text.append(f"⚡ {task_count} tasks", style="cyan")
        text.append("  │  ", style="dim")

        # Agents
        agent_count = len(self.active_agents)
        text.append(f"{agent_count} agents", style="green")
        text.append("  │  ", style="dim")

        # Commit queue
        queue_count = self.commit_queue.get('pendingCount', 0)
        if queue_count > 0:
            text.append(f"{queue_count} queued commits", style="yellow")
        elif self.commit_queue.get('isProcessing'):
            text.append("committing...", style="yellow")
        else:
            text.append("commits synced", style="dim")
        text.append("  │  ", style="dim")

        # Conflicts
        conflict_count = len(self.file_conflicts)
        if conflict_count > 0:
            text.append(f"⚠ {conflict_count} conflict{'s' if conflict_count > 1 else ''}", style="red")
            text.append("  │  ", style="dim")

        # Mode
        if self.parallel_phases:
            text.append("[PARALLEL]", style="cyan")
        else:
            text.append("[SEQUENTIAL]", style="yellow")

        return text

    def render_expanded(self) -> Panel:
        """Render full expanded dashboard."""
        layout = Layout()

        # Split into sections
        layout.split(
            Layout(name="sessions", size=10),
            Layout(name="bottom", size=8)
        )
        layout["bottom"].split_row(
            Layout(name="constraints"),
            Layout(name="queue")
        )

        layout["sessions"].update(self._render_sessions())
        layout["constraints"].update(self._render_constraints())
        layout["queue"].update(self._render_queue())

        # Wrap in main panel with controls
        controls = Text()
        controls.append("[t] Task detail  ", style="dim cyan")
        controls.append("[c] Commit queue  ", style="dim cyan")
        controls.append("[f] Conflicts  ", style="dim cyan")
        controls.append("[p] Collapse", style="dim cyan")

        content = Table(show_header=False, box=None, expand=True)
        content.add_column()
        content.add_row(layout)
        content.add_row("")
        content.add_row(controls)

        return Panel(content, title="Parallel Execution Dashboard", border_style="cyan")

    def _render_sessions(self) -> Panel:
        """Render active sessions section."""
        table = Table(show_header=False, box=None, expand=True)
        table.add_column("Label", width=15, style="dim")
        table.add_column("Bar", width=25)
        table.add_column("Stats", width=20)

        # Task bar
        task_count = len(self.active_tasks)
        batch_limit = self.config.get('batch_size', 10)
        task_bar = self._progress_bar(task_count, batch_limit)
        table.add_row("Tasks Running:", task_bar, f"{task_count}/{batch_limit}")

        # Agent bar
        agent_count = len(self.active_agents)
        max_agents = 10
        agent_bar = self._progress_bar(agent_count, max_agents)
        table.add_row("Agents Active:", agent_bar, f"{agent_count}/{max_agents}")

        table.add_row("", "", "")

        # Running tasks list
        for task in self.active_tasks[:4]:
            elapsed = self._format_elapsed(task.get('startedAt'))
            agents = task.get('agents', [])
            agent_str = ', '.join(agents[:2]) if agents else 'main'
            table.add_row(
                f"  {task['id']}:",
                Text(task.get('description', '')[:30], overflow="ellipsis"),
                f"⏳ {elapsed}"
            )

        if len(self.active_tasks) > 4:
            table.add_row("", f"... and {len(self.active_tasks) - 4} more", "")

        # Peak info
        if self.peak_time:
            peak_str = f"Peak: {self.peak_tasks} tasks / {self.peak_agents} agents"
            table.add_row("", "", Text(peak_str, style="dim"))

        return Panel(table, title="Active Sessions", border_style="green")

    def _render_constraints(self) -> Panel:
        """Render constraints section."""
        table = Table(show_header=False, box=None, expand=True)
        table.add_column("Content")

        # Mode
        if self.parallel_phases:
            phases_str = ", ".join(str(p) for p in self.parallel_phases)
            table.add_row(Text(f"[PARALLEL] Phases {phases_str}", style="cyan"))
        else:
            table.add_row(Text("[SEQUENTIAL] Mode", style="yellow"))

        table.add_row("")

        # Sequential chains
        if self.sequential_chains:
            table.add_row(Text("Sequential Chains:", style="bold"))
            for chain in self.sequential_chains[:2]:
                ids = " → ".join(chain.get('taskIds', []))
                table.add_row(f"  {ids}")
                reason = chain.get('reason', 'annotation')
                table.add_row(Text(f"  └─ {reason}", style="dim"))
        else:
            table.add_row(Text("No sequential constraints", style="dim"))

        table.add_row("")

        # File conflicts
        if self.file_conflicts:
            table.add_row(Text("⚠ File Conflicts:", style="red"))
            for conflict in self.file_conflicts[:2]:
                file_name = os.path.basename(conflict.get('file', ''))
                tasks = ", ".join(conflict.get('taskIds', []))
                table.add_row(Text(f"  {file_name}: {tasks}", style="yellow"))
        else:
            table.add_row(Text("No file conflicts", style="dim green"))

        return Panel(table, title="Constraints", border_style="blue")

    def _render_queue(self) -> Panel:
        """Render commit queue section."""
        table = Table(show_header=False, box=None, expand=True)
        table.add_column("Content")

        # Status
        if self.commit_queue.get('isProcessing'):
            table.add_row(Text("⟳ Processing commit...", style="yellow"))
        else:
            table.add_row(Text("● Queue idle", style="dim"))

        table.add_row("")

        # Pending
        pending = self.commit_queue.get('pending', [])
        if pending:
            table.add_row(Text(f"Pending ({len(pending)}):", style="bold"))
            for i, commit in enumerate(pending[:3]):
                msg = commit.get('message', '')[:40]
                table.add_row(f"  {i+1}. {msg}")
            if len(pending) > 3:
                table.add_row(Text(f"  ... and {len(pending) - 3} more", style="dim"))
        else:
            table.add_row(Text("No pending commits", style="dim"))

        table.add_row("")

        # Stats
        total = self.commit_queue.get('totalCommits', 0)
        failed = self.commit_queue.get('failedCommits', 0)
        table.add_row(Text(f"Total: {total} │ Failed: {failed}", style="dim"))

        return Panel(table, title="Commit Queue", border_style="yellow")

    def _progress_bar(self, current: int, maximum: int) -> Text:
        """Create a mini progress bar."""
        width = 20
        filled = int((current / maximum) * width) if maximum > 0 else 0
        bar = "█" * filled + "░" * (width - filled)
        return Text(f"[{bar}]")

    def _format_elapsed(self, started_at: Optional[str]) -> str:
        """Format elapsed time since task started."""
        if not started_at:
            return "0:00"
        try:
            start = datetime.fromisoformat(started_at.replace('Z', '+00:00'))
            elapsed = datetime.now(start.tzinfo) - start
            minutes = int(elapsed.total_seconds() // 60)
            seconds = int(elapsed.total_seconds() % 60)
            return f"{minutes}:{seconds:02d}"
        except:
            return "?"

    def toggle(self) -> None:
        """Toggle expanded/collapsed state."""
        self.expanded = not self.expanded
        if self.expanded:
            self.refresh(force=True)
```

### 3.2 Integration into RichTUIManager

```python
class RichTUIManager:
    def __init__(self, plan_name: str):
        # ... existing init ...
        self.parallel_dashboard = ParallelExecutionDashboard()
        self.parallel_dashboard.activity_tracker = self.activity_tracker

    def _create_layout(self) -> Layout:
        """Create the TUI layout structure."""
        layout = Layout()

        if self.parallel_dashboard.expanded:
            layout.split(
                Layout(name="header", size=5),
                Layout(name="parallel", size=20),  # Expanded dashboard
                Layout(name="progress", size=3),
                Layout(name="footer", size=2)
            )
        else:
            layout.split(
                Layout(name="header", size=5),
                Layout(name="parallel", size=3),  # Collapsed single line
                Layout(name="progress", size=3),
                Layout(name="activity", size=10),
                Layout(name="tasks", size=8),
                Layout(name="footer", size=2)
            )

        return layout

    def _render_parallel(self) -> Union[Text, Panel]:
        """Render parallel execution dashboard."""
        self.parallel_dashboard.refresh()
        if self.parallel_dashboard.expanded:
            return self.parallel_dashboard.render_expanded()
        else:
            return Panel(
                self.parallel_dashboard.render_collapsed(),
                title="Parallel",
                border_style="dim"
            )

    def handle_key(self, key: str) -> bool:
        """Handle keyboard input."""
        if key == 'p':
            self.parallel_dashboard.toggle()
            return True
        return False
```

### 3.3 Keyboard Mappings

| Key | Context | Action |
|-----|---------|--------|
| `p` | Global | Toggle parallel dashboard expand/collapse |
| `t` | Dashboard expanded | Focus on task detail |
| `c` | Dashboard expanded | Focus on commit queue |
| `f` | Dashboard expanded | Focus on file conflicts |
| `r` | Dashboard | Force refresh |

---

## 4. Data Contract

### 4.1 Parallel Execution Data Object

```typescript
interface ParallelExecutionStatus {
  activeTasks: Array<{
    id: string;
    description: string;
    status: 'in_progress';
    startedAt: string;
    agents: string[];
    progress?: number;  // 0-100
  }>;
  activeAgents: Array<{
    id: string;
    taskId: string;
    description: string;
    startedAt: string;
  }>;
  peakConcurrency: {
    tasks: number;
    agents: number;
    timestamp: string;
  };
  constraints: {
    mode: 'parallel' | 'sequential';
    parallelPhases: number[];
    sequentialChains: Array<{
      taskIds: string[];
      reason: string;
      annotation?: string;
    }>;
  };
  fileConflicts: Array<{
    file: string;
    taskIds: string[];
    runningTask?: string;
    waitingTasks: string[];
  }>;
  commitQueue: {
    isProcessing: boolean;
    pendingCount: number;
    pending: Array<{
      message: string;
      taskId: string;
      queuedAt: string;
    }>;
    totalCommits: number;
    failedCommits: number;
    lastCommitHash?: string;
    lastError?: string;
  };
}
```

---

## 5. Effort Estimate

### 5.1 Implementation Breakdown

| Component | Effort | Priority |
|-----------|--------|----------|
| ParallelExecutionDashboard class | 6 hours | P0 |
| Collapsed view render | 2 hours | P0 |
| Active sessions section | 3 hours | P0 |
| Constraints section | 3 hours | P0 |
| Commit queue section | 3 hours | P0 |
| Layout integration | 2 hours | P0 |
| Keyboard handling | 1 hour | P0 |
| **Subtotal Core:** | **20 hours** | - |
| Peak tracking | 2 hours | P1 |
| Task detail modal | 4 hours | P2 |
| Conflict detail modal | 3 hours | P2 |
| **Subtotal Enhanced:** | **9 hours** | - |
| **Total:** | **29 hours** | - |

### 5.2 Recommended Implementation

**MVP (Core):** 20 hours
- Collapsed single-line summary
- Expanded dashboard with 3 sections
- Active sessions with task list
- Constraints with sequential chains
- Commit queue status
- Toggle with `p` key

**Full Feature:** 29 hours
- All MVP features
- Peak concurrency tracking
- Task detail drill-down
- Conflict detail drill-down

---

## 6. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Data source latency | MEDIUM | LOW | Cache with stale indicator |
| Too much information | MEDIUM | MEDIUM | Smart collapse/expand |
| Layout overflow | LOW | MEDIUM | Responsive sections |
| Performance overhead | LOW | LOW | Lazy refresh, debounce |

---

## 7. Success Criteria

### 7.1 Functional Requirements

- [ ] Collapsed view shows task/agent/commit/conflict counts
- [ ] Expanded view shows three detailed sections
- [ ] Active sessions shows running tasks with elapsed time
- [ ] Constraints shows sequential chains and file conflicts
- [ ] Commit queue shows pending and processing state
- [ ] `p` key toggles between collapsed/expanded
- [ ] Data refreshes automatically every 1 second

### 7.2 Quality Requirements

- [ ] Render complete in <100ms
- [ ] No flicker on refresh
- [ ] Handles 10+ concurrent tasks gracefully
- [ ] Works with zero active tasks (empty state)

### 7.3 Integration Requirements

- [ ] Fits in existing TUI layout
- [ ] Keyboard mappings don't conflict
- [ ] Data sources already available (no new commands needed)

---

## 8. Related Documents

- Task 5.5: Serialization TUI mapping
- Task 7.5: Batch system TUI mapping
- Task 9.3: Parallel/sequential gaps analysis
- Task 10.1: Git Status Panel design

---

**End of Design**
