# Task 3.3: Conflict Detection Edge Cases

## Summary

This analysis documents edge case behaviors for the file conflict detection system, including partial path matching, case sensitivity, glob patterns, and other boundary conditions. All documented behaviors are verified against the existing test suite (31 tests passing).

## Test Suite Coverage

**Test File:** `scripts/tests/test-file-conflicts.js`

| Category | Tests | Status |
|----------|-------|--------|
| Backtick-quoted paths | 3 | ✓ |
| Directory prefix paths | 5 | ✓ |
| Modify/update patterns | 3 | ✓ |
| "in filename" patterns | 2 | ✓ |
| Edge cases | 5 | ✓ |
| Mixed patterns | 1 | ✓ |
| Conflict detection | 7 | ✓ |
| Case handling | 1 | ✓ |
| Real-world patterns | 1 | ✓ |
| **Total** | **31** | ✓ |

## Edge Case Analysis

### 1. Partial Path Matching

**Behavior:** Exact file path matching, no partial/directory matching

| Input | Extracted | Conflict? |
|-------|-----------|-----------|
| Task A: `src/lib/` | Not extracted (no extension) | N/A |
| Task B: `src/lib/tui.py` | `src/lib/tui.py` | N/A |
| Task A: `src/lib/tui.py`, Task B: `src/lib/tui.py` | Both extracted | **Yes** |
| Task A: `src/lib/tui.py`, Task B: `src/lib/api.py` | Both extracted | No |

**Key Finding:** The system matches complete file paths only, not directories or partial paths. This prevents false positives from tasks that work on the same directory but different files.

**Example Test:**
```javascript
const tasks = [
  { id: '1.1', description: 'Modify files in src/lib/' },         // No extraction
  { id: '1.2', description: 'Update `src/lib/tui.py` with fixes' } // Extracts src/lib/tui.py
];
detectFileConflicts(tasks); // Returns: [] (no conflict)
```

**Implication:** Directory references don't trigger conflicts. This is intentional—working in the same directory doesn't necessarily mean file conflicts.

### 2. Case Sensitivity Behavior

**Behavior:** Case-insensitive matching for conflict detection

| Task A | Task B | Same File? |
|--------|--------|------------|
| `src/API.ts` | `src/api.ts` | **Yes** |
| `SRC/api.ts` | `src/API.ts` | **Yes** |
| `README.md` | `readme.md` | **Yes** |

**Implementation:**
```javascript
// From plan-status.js:2008-2009
const normalizedFile = file.toLowerCase();
```

**Original Casing Preserved:**
```javascript
// From plan-status.js:2011-2014
fileToTasks.set(normalizedFile, {
  originalFile: file,  // First occurrence preserved
  taskIds: []
});
```

**Test Coverage:**
```javascript
// From test-file-conflicts.js:329-338
const tasks6 = [
  { id: '1.1', description: 'Update `src/API.ts` with endpoint' },
  { id: '1.2', description: 'Modify `src/api.ts` for auth' }
];
const conflicts9 = detectFileConflicts(tasks6);
// ✓ Detects conflicts with case-insensitive matching (1 conflict)
```

### 3. Glob Patterns in Task Descriptions

**Behavior:** Glob patterns are NOT specially handled; treated as literal text

| Description | Extracted | Notes |
|-------------|-----------|-------|
| `Update *.ts files` | Not extracted | `*` not in valid filename chars |
| `Modify src/**/*.js` | Not extracted | `**` invalid |
| `Update src/api.ts` | `src/api.ts` | Normal extraction |

**Why No Glob Support:**
1. Regex pattern `[\w./-]+` excludes `*` and `?`
2. Task descriptions typically reference specific files
3. Globs in descriptions are usually informational, not action targets

**Edge Case:**
```javascript
extractFileReferences('Update all src/*.ts files');
// Returns: [] - no files extracted (asterisk blocks pattern)
```

**Potential Enhancement:**
Could add glob expansion if needed, but would require:
- Actual filesystem scanning
- Significantly more complexity
- Potential false positives from informational globs

### 4. Files Without Extensions

**Behavior:** Files without extensions are NOT extracted

| File Reference | Extracted? | Reason |
|----------------|------------|--------|
| `Makefile` | No | No extension pattern match |
| `Dockerfile` | No | No extension pattern match |
| `.gitignore` | No | No extension pattern match |
| `.env` | No | No extension pattern match |
| `package.json` | **Yes** | Has `.json` extension |

**Implementation Reason:**
```javascript
// Pattern requires extension: \.[a-zA-Z0-9]+
const backtickPattern = /`([^`]+\.[a-zA-Z0-9]+)`/g;
```

**Workaround:** These files rarely need conflict detection since they're usually singleton files with clear ownership.

### 5. Relative Paths and Parent References

**Behavior:** `../` paths are NOT extracted

| Path | Extracted? | Reason |
|------|------------|--------|
| `../parent/file.js` | No | `..` not in prefix pattern |
| `./local/file.js` | No | `.` not in prefix pattern |
| `src/../lib/file.js` | No (partial) | `..` breaks matching |

**Implementation:** Directory prefix pattern requires known prefixes:
```javascript
const dirPattern = /\b(src|tests|docs|scripts|lib|\.claude)\/[\w./-]+\.[a-zA-Z0-9]+\b/g;
```

### 6. Duplicate File References

**Behavior:** Duplicates within a single task are deduplicated

```javascript
const result = extractFileReferences(
  'Update `src/api.ts` and also reference src/api.ts again'
);
// Returns: ["src/api.ts"] - single entry, not two
```

**Implementation:** Uses `Set` for deduplication:
```javascript
const files = new Set();
// ... pattern matching adds to Set
return Array.from(files);
```

### 7. Windows-Style Paths

**Behavior:** Backslash paths are NOT extracted

| Path Style | Extracted? |
|------------|------------|
| `src\api.ts` | No |
| `src\\api.ts` | No |
| `src/api.ts` | Yes |

**Implication:** System is Unix/POSIX-centric. Windows paths would require additional pattern support.

### 8. Spaces in Paths

**Behavior:** Paths with spaces are filtered out

```javascript
// From plan-status.js:1944-1946
if (!filePath.includes(' ') && !filePath.includes('(') && !filePath.includes(')')) {
  files.add(filePath);
}
```

**Purpose:** Prevents extracting code snippets like:
- `function foo()`
- `console.log(x)`
- `import { foo }`

### 9. File Path vs Code Snippet Disambiguation

**Behavior:** Heuristics filter likely code snippets

| Backtick Content | Extracted? | Reason |
|------------------|------------|--------|
| `src/api.ts` | Yes | Valid path |
| `function()` | No | Contains `()` |
| `console.log` | No | No extension |
| `import { x }` | No | Contains spaces and `{}` |
| `file.ts:123` | Partial | Matches as `file.ts` |

### 10. Multi-File Tasks

**Behavior:** All files in a single task description are extracted

```javascript
const result = extractFileReferences(
  'Update `src/api.ts`, `src/utils.ts`, and tests/api.test.js'
);
// Returns: ["src/api.ts", "src/utils.ts", "tests/api.test.js"]
```

**Conflict Detection:**
If two tasks each reference 3 files with 1 overlap, only the overlapping file creates a conflict:

```javascript
const tasks = [
  { id: '1.1', description: 'Update `a.ts`, `b.ts`, `c.ts`' },
  { id: '1.2', description: 'Modify `c.ts`, `d.ts`, `e.ts`' }
];
detectFileConflicts(tasks);
// Returns: [{ file: 'c.ts', taskIds: ['1.1', '1.2'] }]
```

### 11. Empty and Invalid Inputs

**Behavior:** Graceful handling of edge cases

| Input | Result |
|-------|--------|
| `null` | `[]` |
| `undefined` | `[]` |
| `""` (empty string) | `[]` |
| `[]` (empty array) | `[]` |
| Task without description | Skipped |
| Task without id | Skipped |

**Test Coverage:**
```javascript
// From test-file-conflicts.js:154-180
const result14 = extractFileReferences(null);
// ✓ Handles null input: []

const result15 = extractFileReferences(undefined);
// ✓ Handles undefined input: []

const result16 = extractFileReferences('');
// ✓ Handles empty string: []
```

### 12. Very Long Paths

**Behavior:** No explicit length limit in extraction

```javascript
const longPath = 'src/very/deeply/nested/directory/structure/file.ts';
extractFileReferences(`Update \`${longPath}\``);
// Returns: ["src/very/deeply/nested/directory/structure/file.ts"]
```

### 13. Special Characters in Filenames

**Behavior:** Limited special character support

| Filename | Extracted? | Notes |
|----------|------------|-------|
| `file-name.ts` | Yes | Hyphen allowed |
| `file_name.ts` | Yes | Underscore allowed |
| `file.test.ts` | Yes | Multiple dots allowed |
| `file@name.ts` | No | `@` not in word chars |
| `file#name.ts` | No | `#` not in word chars |
| `file name.ts` | No | Space filtered |

### 14. Number-Only Filenames

**Behavior:** Numeric filenames extracted if they have extensions

```javascript
extractFileReferences('Check `123.js` for config');
// Returns: ["123.js"]

extractFileReferences('Check `0.ts` for init');
// Returns: ["0.ts"]
```

## TUI Implications for Edge Cases

### Visual Feedback for Uncertain Extractions

When the TUI displays conflict warnings, edge cases may cause confusion:

| Scenario | TUI Display Recommendation |
|----------|---------------------------|
| Directory reference not extracted | Show tooltip: "Only file paths (not directories) trigger conflicts" |
| Case mismatch in paths | Show canonical path: "`src/api.ts` (matched case-insensitively)" |
| No files extracted from task | Show: "No file references detected" |
| Many files in single task | Show count: "Modifies 5 files" |

### Conflict Explanation Panel

For edge cases, the TUI could provide explanations:

```
┌──────────────────────────────────────────┐
│ CONFLICT DETECTION NOTES                 │
├──────────────────────────────────────────┤
│ ℹ Tasks 2.1 and 2.2 conflict on:         │
│   • src/api.ts                           │
│                                          │
│ Detection rules:                         │
│   ✓ Case-insensitive (SRC = src)        │
│   ✓ Exact path matching required         │
│   ✗ Directories not matched              │
│   ✗ Glob patterns not expanded           │
└──────────────────────────────────────────┘
```

## Recommendations

### Short-Term Improvements

1. **Add extensionless file support** for `Makefile`, `Dockerfile`, etc.
2. **Add more directory prefixes** (`app/`, `components/`, `pages/`)
3. **Warn on potential missed conflicts** when directories are mentioned

### Long-Term Enhancements

1. **Glob pattern expansion** (optional, requires filesystem access)
2. **Windows path support** (if cross-platform needed)
3. **Semantic conflict detection** (imports, exports, type dependencies)

## Verification Commands

```bash
# Run the full test suite
node scripts/tests/test-file-conflicts.js

# Test specific extraction patterns
node -e "const { extractFileReferences } = require('./scripts/lib/plan-status.js'); console.log(extractFileReferences('your test string here'));"

# Test conflict detection
node -e "const { detectFileConflicts } = require('./scripts/lib/plan-status.js'); console.log(detectFileConflicts([{id:'1',description:'`a.ts`'},{id:'2',description:'`a.ts`'}]));"
```
