# Task 10.6: Real-time Event Stream Panel Design

**Date:** 2025-12-26
**Purpose:** Design TUI panel for streaming orchestrator events
**Scope:** Git commits, agent spawns, phase transitions, constraint violations, conflict detections, filterable event types

---

## Executive Summary

The Real-time Event Stream Panel is an **architectural-level** expansion that provides a live feed of all orchestrator events. This design specifies an event streaming architecture with filterable event types, detailed event cards, and integration with existing TUI components.

**Estimated Effort:** 32-44 hours (High - requires event bus infrastructure)
**Priority:** P2 (High Value for monitoring and debugging)

---

## 1. Panel Overview

### 1.1 Purpose

Provide a real-time feed of orchestrator activity:
- Git commits as they happen
- Agent spawn and completion events
- Phase transitions and milestones
- Constraint violations and warnings
- Conflict detections
- Task state changes
- Filterable by event type

### 1.2 Event Sources

| Event Type | Source | Detection Method |
|------------|--------|------------------|
| Git commit | git-queue.js | Queue status updates |
| Agent spawn | Claude runner | Tool_use parsing (Task tool) |
| Agent complete | Claude runner | Tool_result parsing |
| Tool invocation | Claude runner | Existing callbacks |
| Phase transition | status.json | Phase field change |
| Task started | status.json | Status â†’ in_progress |
| Task completed | status.json | Status â†’ completed |
| Task failed | status.json | Status â†’ failed |
| Constraint applied | cmdNext() | sequentialGroups field |
| File conflict | cmdNext() | fileConflicts field |
| IPC command | orchestrator_ipc | Command received |
| Stuck detected | detect-stuck | Threshold exceeded |

---

## 2. Visual Design

### 2.1 Collapsed View (Activity Stream)

Compact single-panel view showing recent events:

```
â”Œâ”€ Event Stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  14:32:45  âœ“  Task 3.2 completed (2m 34s)                             â”‚
â”‚  14:32:44  ðŸ“ Commit: [tui] task 3.2: Merge ARCHITECTURE.md           â”‚
â”‚  14:32:20  ðŸ¤– Agent 3 completed (task 3.2)                            â”‚
â”‚  14:31:45  ðŸ¤– Agent 3 spawned for task 3.2                            â”‚
â”‚  14:31:12  â–¶  Task 3.2 started                                        â”‚
â”‚  14:31:10  â›“  Sequential constraint: 3.2 waiting for 3.1             â”‚
â”‚  14:30:45  âœ“  Task 3.1 completed (5m 12s)                             â”‚
â”‚                                                                        â”‚
â”‚  [f] Filter  [p] Pause  [c] Clear  [e] Expand                         â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Expanded View (Full Event Detail)

Detailed view with event cards:

```
â”Œâ”€ Real-time Event Stream â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  Filter: [All] [Tasks] [Git] [Agents] [Constraints] [Errors]          â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ 14:32:45 â”€ Task Completed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  âœ“ Task 3.2: Merge ARCHITECTURE.md                               â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Duration: 2m 34s                                                â”‚  â”‚
â”‚  â”‚  Phase: 3 - Documentation Consolidation                          â”‚  â”‚
â”‚  â”‚  Agent: Agent 3                                                  â”‚  â”‚
â”‚  â”‚  Findings: docs/plan-outputs/.../findings/3.2.md                 â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  [v] View findings  [d] Dependencies                             â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ 14:32:44 â”€ Git Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  ðŸ“ Committed: abc1234                                           â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Message: [tui-expansion-analysis] task 3.2: Merge docs          â”‚  â”‚
â”‚  â”‚  Files: 2 changed (+45, -12)                                     â”‚  â”‚
â”‚  â”‚  Branch: plan/tui-expansion-analysis                             â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  [s] Show diff  [o] Open in editor                               â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  â”Œâ”€ 14:32:20 â”€ Agent Complete â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  ðŸ¤– Agent 3 completed                                            â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â”‚  Task: 3.2 Merge ARCHITECTURE.md                                 â”‚  â”‚
â”‚  â”‚  Duration: 1m 08s                                                â”‚  â”‚
â”‚  â”‚  Output: 156 lines generated                                     â”‚  â”‚
â”‚  â”‚  Tools used: Read (5), Edit (3), Grep (2)                        â”‚  â”‚
â”‚  â”‚                                                                  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                        â”‚
â”‚  [â†‘/â†“] Navigate  [Enter] Details  [f] Filter  [Esc] Collapse          â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 Event Type Cards

#### Task Started

```
â”Œâ”€ 14:31:12 â”€ Task Started â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  â–¶ Task 3.2: Merge ARCHITECTURE.md                                     â”‚
â”‚                                                                         â”‚
â”‚  Phase: 3 - Documentation Consolidation                                 â”‚
â”‚  Dependencies: 3.1 âœ“                                                    â”‚
â”‚  Constraints: Sequential (after 3.1)                                    â”‚
â”‚                                                                         â”‚
â”‚  Expected duration: ~2-5 min (based on similar tasks)                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Task Completed

```
â”Œâ”€ 14:32:45 â”€ Task Completed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  âœ“ Task 3.2: Merge ARCHITECTURE.md                                     â”‚
â”‚                                                                         â”‚
â”‚  Duration: 2m 34s                                                       â”‚
â”‚  Result: Success                                                        â”‚
â”‚  Changes: 2 files modified                                              â”‚
â”‚  Findings: Generated (1.2 KB)                                           â”‚
â”‚                                                                         â”‚
â”‚  Next in sequence: 3.3 (now unblocked)                                  â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Task Failed

```
â”Œâ”€ 14:35:12 â”€ Task Failed â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ âš  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  âœ— Task 4.3: Add error handling                                        â”‚
â”‚                                                                         â”‚
â”‚  Duration: 5m 12s                                                       â”‚
â”‚  Retry: 1 of 3                                                          â”‚
â”‚                                                                         â”‚
â”‚  Error:                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ TypeScript compilation failed:                                   â”‚   â”‚
â”‚  â”‚   src/lib/errors.ts:45:12                                       â”‚   â”‚
â”‚  â”‚   Property 'message' is missing in type 'CustomError'           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                         â”‚
â”‚  [r] Retry now  [s] Skip  [e] Full error                               â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Git Commit

```
â”Œâ”€ 14:32:44 â”€ Git Commit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  ðŸ“ Committed: abc1234def567                                            â”‚
â”‚                                                                         â”‚
â”‚  Plan: tui-expansion-analysis                                           â”‚
â”‚  Task: 3.2                                                              â”‚
â”‚  Message: Merge ARCHITECTURE.md content into orchestrator-system.md     â”‚
â”‚                                                                         â”‚
â”‚  Files changed:                                                         â”‚
â”‚    M  docs/standards/orchestrator-system.md  (+45, -12)                â”‚
â”‚    D  docs/standards/ARCHITECTURE.md                                    â”‚
â”‚                                                                         â”‚
â”‚  [s] Show diff  [u] Undo (revert)  [p] Push                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Agent Spawn

```
â”Œâ”€ 14:31:45 â”€ Agent Spawned â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  ðŸ¤– Agent 3 spawned                                                     â”‚
â”‚                                                                         â”‚
â”‚  Task: 3.2 Merge ARCHITECTURE.md                                        â”‚
â”‚  Description: "Merge documentation content"                             â”‚
â”‚  Type: general-purpose                                                  â”‚
â”‚                                                                         â”‚
â”‚  Parallel agents: 3 active (limit: 5)                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Constraint Applied

```
â”Œâ”€ 14:31:10 â”€ Constraint Applied â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â›“ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  â›“ Sequential constraint enforced                                      â”‚
â”‚                                                                         â”‚
â”‚  Type: [SEQUENTIAL] annotation                                          â”‚
â”‚  Source: Phase 3 Execution Note                                         â”‚
â”‚                                                                         â”‚
â”‚  Affected tasks:                                                        â”‚
â”‚    â¸ 3.2 - Waiting for 3.1                                             â”‚
â”‚    â¸ 3.3 - Waiting for 3.2                                             â”‚
â”‚    â¸ 3.4 - Waiting for 3.3                                             â”‚
â”‚                                                                         â”‚
â”‚  Reason: All modify orchestrator-system.md                              â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### File Conflict Detected

```
â”Œâ”€ 14:30:45 â”€ Conflict Detected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ âš  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  âš  File conflict detected                                              â”‚
â”‚                                                                         â”‚
â”‚  File: scripts/lib/tui.py                                               â”‚
â”‚  Detection: Automatic (file reference extraction)                       â”‚
â”‚                                                                         â”‚
â”‚  Conflicting tasks:                                                     â”‚
â”‚    5.1 Add parallelism indicator                                        â”‚
â”‚    5.3 Update layout structure                                          â”‚
â”‚                                                                         â”‚
â”‚  Action: Tasks will run sequentially                                    â”‚
â”‚                                                                         â”‚
â”‚  [o] Override  [i] Ignore file                                         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Phase Transition

```
â”Œâ”€ 14:45:00 â”€ Phase Transition â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ðŸŽ‰ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  ðŸŽ‰ Phase 3 completed!                                                  â”‚
â”‚                                                                         â”‚
â”‚  Phase: Documentation Consolidation                                     â”‚
â”‚  Tasks: 8/8 completed                                                   â”‚
â”‚  Duration: 45m 23s                                                      â”‚
â”‚                                                                         â”‚
â”‚  Next: Phase 4 - Git Status Panel (5 tasks)                            â”‚
â”‚                                                                         â”‚
â”‚  Overall progress: [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘] 52%     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Stuck Detection

```
â”Œâ”€ 14:50:00 â”€ Stuck Detected â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ âš  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                         â”‚
â”‚  âš  Task may be stuck                                                   â”‚
â”‚                                                                         â”‚
â”‚  Task: 4.2 Implement git panel                                          â”‚
â”‚  Running: 28:45 (threshold: 30:00)                                      â”‚
â”‚  Last activity: 5 min ago                                               â”‚
â”‚                                                                         â”‚
â”‚  Auto-action in: 1:15 (will skip)                                       â”‚
â”‚                                                                         â”‚
â”‚  [x] Extend  [k] Skip now  [r] Retry                                   â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.4 Filter Bar

```
â”Œâ”€ Filters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                        â”‚
â”‚  Show: [â—] All  [ ] Tasks  [ ] Git  [ ] Agents  [ ] Constraints       â”‚
â”‚        [ ] Errors  [ ] Phases                                          â”‚
â”‚                                                                        â”‚
â”‚  Time: [Last 1 hour] â–¼                                                 â”‚
â”‚  Search: [_______________________________________________]             â”‚
â”‚                                                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Implementation Specification

### 3.1 Event Bus Architecture

```python
from enum import Enum
from dataclasses import dataclass
from typing import Callable, Dict, List, Optional, Any
from datetime import datetime
import threading
import queue

class EventType(Enum):
    # Task events
    TASK_STARTED = "task.started"
    TASK_COMPLETED = "task.completed"
    TASK_FAILED = "task.failed"
    TASK_SKIPPED = "task.skipped"

    # Git events
    GIT_COMMIT = "git.commit"
    GIT_PUSH = "git.push"
    GIT_QUEUE_UPDATED = "git.queue_updated"

    # Agent events
    AGENT_SPAWN = "agent.spawn"
    AGENT_COMPLETE = "agent.complete"
    AGENT_ERROR = "agent.error"

    # Tool events
    TOOL_START = "tool.start"
    TOOL_END = "tool.end"

    # Constraint events
    CONSTRAINT_APPLIED = "constraint.applied"
    CONFLICT_DETECTED = "conflict.detected"

    # Phase events
    PHASE_STARTED = "phase.started"
    PHASE_COMPLETED = "phase.completed"
    PHASE_THRESHOLD = "phase.threshold"

    # Orchestrator events
    ITERATION_START = "iteration.start"
    ITERATION_COMPLETE = "iteration.complete"
    STUCK_DETECTED = "stuck.detected"
    IPC_COMMAND = "ipc.command"
    SHUTDOWN = "shutdown"


@dataclass
class Event:
    """A single event in the stream."""
    type: EventType
    timestamp: datetime
    data: Dict[str, Any]
    id: str = None

    def __post_init__(self):
        if self.id is None:
            self.id = f"{self.type.value}-{self.timestamp.timestamp()}"

    @property
    def category(self) -> str:
        """Get event category for filtering."""
        prefix = self.type.value.split('.')[0]
        return prefix


class EventBus:
    """Central event bus for orchestrator events."""

    def __init__(self, max_history: int = 1000):
        self.max_history = max_history
        self.history: List[Event] = []
        self.subscribers: Dict[str, List[Callable]] = {}
        self.lock = threading.Lock()

    def emit(self, event_type: EventType, data: Dict[str, Any]) -> Event:
        """Emit an event to all subscribers."""
        event = Event(
            type=event_type,
            timestamp=datetime.now(),
            data=data
        )

        with self.lock:
            # Add to history
            self.history.append(event)
            if len(self.history) > self.max_history:
                self.history.pop(0)

        # Notify subscribers
        self._notify(event)

        return event

    def subscribe(self, event_type: str, callback: Callable[[Event], None]) -> None:
        """Subscribe to events by type or category."""
        with self.lock:
            if event_type not in self.subscribers:
                self.subscribers[event_type] = []
            self.subscribers[event_type].append(callback)

    def unsubscribe(self, event_type: str, callback: Callable) -> None:
        """Unsubscribe from events."""
        with self.lock:
            if event_type in self.subscribers:
                self.subscribers[event_type].remove(callback)

    def _notify(self, event: Event) -> None:
        """Notify relevant subscribers of an event."""
        callbacks = []

        with self.lock:
            # Exact type match
            if event.type.value in self.subscribers:
                callbacks.extend(self.subscribers[event.type.value])

            # Category match (e.g., "task" for "task.completed")
            if event.category in self.subscribers:
                callbacks.extend(self.subscribers[event.category])

            # Wildcard subscribers
            if "*" in self.subscribers:
                callbacks.extend(self.subscribers["*"])

        for callback in callbacks:
            try:
                callback(event)
            except Exception as e:
                print(f"Event callback error: {e}")

    def get_history(
        self,
        event_types: Optional[List[EventType]] = None,
        since: Optional[datetime] = None,
        limit: int = 100
    ) -> List[Event]:
        """Get event history with optional filtering."""
        with self.lock:
            events = list(self.history)

        if since:
            events = [e for e in events if e.timestamp >= since]

        if event_types:
            type_set = set(event_types)
            events = [e for e in events if e.type in type_set]

        return events[-limit:]
```

### 3.2 Event Stream Panel

```python
class EventStreamPanel:
    """Real-time event stream panel for TUI."""

    def __init__(self, event_bus: EventBus, config: Optional[Dict] = None):
        self.event_bus = event_bus
        self.config = config or {}
        self.expanded = False
        self.paused = False

        # Filtering
        self.active_filters: set = set()  # Empty = all
        self.search_query: str = ""

        # Display
        self.selected_index = 0
        self.visible_events: List[Event] = []
        self.max_visible = 50

        # Subscribe to all events
        self.event_bus.subscribe("*", self._on_event)

    def _on_event(self, event: Event) -> None:
        """Handle incoming event."""
        if not self.paused:
            self._refresh_visible()

    def _refresh_visible(self) -> None:
        """Refresh visible events based on filters."""
        events = self.event_bus.get_history(limit=self.max_visible)

        # Apply type filter
        if self.active_filters:
            events = [e for e in events if e.category in self.active_filters]

        # Apply search filter
        if self.search_query:
            query = self.search_query.lower()
            events = [e for e in events if query in str(e.data).lower()]

        self.visible_events = events

    def render_collapsed(self) -> Panel:
        """Render compact event stream."""
        self._refresh_visible()

        table = Table(show_header=False, box=None, expand=True)
        table.add_column("Time", width=10, style="dim")
        table.add_column("Icon", width=3)
        table.add_column("Message")

        for event in reversed(self.visible_events[-8:]):
            time_str = event.timestamp.strftime("%H:%M:%S")
            icon, style = self._get_event_display(event)
            message = self._get_event_message(event)

            table.add_row(
                time_str,
                Text(icon, style=style),
                Text(message[:60], overflow="ellipsis")
            )

        # Controls
        table.add_row("", "", "")
        controls = "[f] Filter  [p] Pause  [c] Clear  [e] Expand"
        table.add_row("", "", Text(controls, style="dim cyan"))

        status = " (paused)" if self.paused else ""
        return Panel(table, title=f"Event Stream{status}", border_style="cyan")

    def render_expanded(self) -> Panel:
        """Render full event stream with details."""
        self._refresh_visible()

        layout = Layout()
        layout.split(
            Layout(name="filters", size=3),
            Layout(name="events", ratio=1)
        )

        layout["filters"].update(self._render_filters())

        # Event cards
        if self.visible_events:
            event_content = Table(show_header=False, box=None, expand=True)
            event_content.add_column()

            for i, event in enumerate(reversed(self.visible_events[-10:])):
                is_selected = i == self.selected_index
                card = self._render_event_card(event, is_selected)
                event_content.add_row(card)

            layout["events"].update(event_content)
        else:
            layout["events"].update(Panel(Text("No events", style="dim")))

        # Controls
        controls = Text()
        controls.append("[â†‘/â†“] Navigate  ", style="dim cyan")
        controls.append("[Enter] Details  ", style="dim cyan")
        controls.append("[f] Filter  ", style="dim cyan")
        controls.append("[p] Pause  ", style="dim cyan")
        controls.append("[Esc] Collapse", style="dim cyan")

        content = Table(show_header=False, box=None, expand=True)
        content.add_column()
        content.add_row(layout)
        content.add_row("")
        content.add_row(controls)

        status = " (paused)" if self.paused else ""
        return Panel(content, title=f"Real-time Event Stream{status}", border_style="cyan")

    def _render_filters(self) -> Panel:
        """Render filter bar."""
        categories = ['all', 'task', 'git', 'agent', 'constraint', 'phase']

        text = Text("Show: ")
        for cat in categories:
            is_active = (cat == 'all' and not self.active_filters) or cat in self.active_filters
            style = "cyan bold" if is_active else "dim"
            marker = "â—" if is_active else "â—‹"
            text.append(f"[{marker}] {cat.title()}  ", style=style)

        return Panel(text, border_style="dim")

    def _render_event_card(self, event: Event, selected: bool = False) -> Panel:
        """Render a single event card."""
        table = Table(show_header=False, box=None, expand=True)
        table.add_column()

        icon, style = self._get_event_display(event)
        message = self._get_event_message(event)

        # Header
        time_str = event.timestamp.strftime("%H:%M:%S")
        header = Text()
        header.append(f"{icon} ", style=style)
        header.append(message)
        table.add_row(header)

        # Details based on event type
        details = self._get_event_details(event)
        for detail in details:
            table.add_row(Text(f"  {detail}", style="dim"))

        border_style = "cyan" if selected else "dim"
        title = f"{time_str} - {event.type.value.replace('.', ' ').title()}"

        return Panel(table, title=title, border_style=border_style)

    def _get_event_display(self, event: Event) -> tuple:
        """Get icon and style for event type."""
        displays = {
            EventType.TASK_STARTED: ("â–¶", "cyan"),
            EventType.TASK_COMPLETED: ("âœ“", "green"),
            EventType.TASK_FAILED: ("âœ—", "red"),
            EventType.TASK_SKIPPED: ("âŠ˜", "yellow"),
            EventType.GIT_COMMIT: ("ðŸ“", "blue"),
            EventType.GIT_PUSH: ("â¬†", "blue"),
            EventType.AGENT_SPAWN: ("ðŸ¤–", "cyan"),
            EventType.AGENT_COMPLETE: ("ðŸ¤–", "green"),
            EventType.AGENT_ERROR: ("ðŸ¤–", "red"),
            EventType.TOOL_START: ("ðŸ”§", "dim"),
            EventType.TOOL_END: ("ðŸ”§", "dim"),
            EventType.CONSTRAINT_APPLIED: ("â›“", "yellow"),
            EventType.CONFLICT_DETECTED: ("âš ", "red"),
            EventType.PHASE_STARTED: ("ðŸ“‹", "cyan"),
            EventType.PHASE_COMPLETED: ("ðŸŽ‰", "green"),
            EventType.STUCK_DETECTED: ("âš ", "red blink"),
        }
        return displays.get(event.type, ("?", "dim"))

    def _get_event_message(self, event: Event) -> str:
        """Get display message for event."""
        data = event.data

        if event.type == EventType.TASK_STARTED:
            return f"Task {data.get('id')} started: {data.get('description', '')[:40]}"
        elif event.type == EventType.TASK_COMPLETED:
            duration = data.get('duration', 'N/A')
            return f"Task {data.get('id')} completed ({duration})"
        elif event.type == EventType.TASK_FAILED:
            return f"Task {data.get('id')} failed: {data.get('error', '')[:40]}"
        elif event.type == EventType.GIT_COMMIT:
            return f"Commit: {data.get('hash', '')[:7]} {data.get('message', '')[:40]}"
        elif event.type == EventType.AGENT_SPAWN:
            return f"Agent {data.get('id')} spawned for task {data.get('taskId')}"
        elif event.type == EventType.AGENT_COMPLETE:
            return f"Agent {data.get('id')} completed"
        elif event.type == EventType.CONSTRAINT_APPLIED:
            return f"Constraint: {data.get('type')} on tasks {data.get('tasks')}"
        elif event.type == EventType.CONFLICT_DETECTED:
            return f"Conflict: {data.get('file')} ({data.get('tasks')})"
        elif event.type == EventType.PHASE_COMPLETED:
            return f"Phase {data.get('phase')} completed!"
        elif event.type == EventType.STUCK_DETECTED:
            return f"Task {data.get('taskId')} may be stuck ({data.get('elapsed')})"

        return str(data)[:60]

    def _get_event_details(self, event: Event) -> List[str]:
        """Get detail lines for event card."""
        data = event.data
        details = []

        if event.type == EventType.TASK_COMPLETED:
            if 'duration' in data:
                details.append(f"Duration: {data['duration']}")
            if 'phase' in data:
                details.append(f"Phase: {data['phase']}")

        elif event.type == EventType.GIT_COMMIT:
            if 'files' in data:
                details.append(f"Files: {data['files']} changed")
            if 'branch' in data:
                details.append(f"Branch: {data['branch']}")

        elif event.type == EventType.CONFLICT_DETECTED:
            if 'reason' in data:
                details.append(f"Reason: {data['reason']}")
            details.append("Action: Sequential execution")

        return details

    def toggle_filter(self, category: str) -> None:
        """Toggle a filter category."""
        if category == 'all':
            self.active_filters.clear()
        elif category in self.active_filters:
            self.active_filters.remove(category)
        else:
            self.active_filters.add(category)
        self._refresh_visible()

    def handle_key(self, key: str) -> bool:
        """Handle keyboard input."""
        if key in ('j', 'down'):
            self.selected_index = min(self.selected_index + 1, len(self.visible_events) - 1)
            return True
        elif key in ('k', 'up'):
            self.selected_index = max(self.selected_index - 1, 0)
            return True
        elif key == 'p':
            self.paused = not self.paused
            return True
        elif key == 'c':
            self.event_bus.history.clear()
            self._refresh_visible()
            return True
        elif key == 'f':
            # Cycle through filters
            return True
        elif key == 'e':
            self.expanded = True
            return True
        elif key == 'escape':
            self.expanded = False
            return True
        return False

    def toggle(self) -> None:
        """Toggle expanded/collapsed state."""
        self.expanded = not self.expanded
```

### 3.3 Keyboard Mappings

| Key | Context | Action |
|-----|---------|--------|
| `Ctrl+E` | Global | Toggle event stream |
| `â†‘/k` | Stream expanded | Previous event |
| `â†“/j` | Stream expanded | Next event |
| `Enter` | Event selected | Show full details |
| `f` | Stream | Cycle filters |
| `p` | Stream | Pause/resume |
| `c` | Stream | Clear history |
| `e` | Stream collapsed | Expand |
| `Esc` | Stream expanded | Collapse |

---

## 4. Data Contract

### 4.1 Event Data Object

```typescript
interface Event {
  id: string;
  type: EventType;
  timestamp: string;  // ISO
  data: EventData;
}

type EventType =
  | 'task.started' | 'task.completed' | 'task.failed' | 'task.skipped'
  | 'git.commit' | 'git.push' | 'git.queue_updated'
  | 'agent.spawn' | 'agent.complete' | 'agent.error'
  | 'tool.start' | 'tool.end'
  | 'constraint.applied' | 'conflict.detected'
  | 'phase.started' | 'phase.completed' | 'phase.threshold'
  | 'iteration.start' | 'iteration.complete'
  | 'stuck.detected' | 'ipc.command' | 'shutdown';

interface TaskEventData {
  id: string;
  description: string;
  phase?: string;
  duration?: string;
  error?: string;
  retryCount?: number;
}

interface GitEventData {
  hash: string;
  message: string;
  files: number;
  branch: string;
  taskId?: string;
}

interface AgentEventData {
  id: string;
  taskId: string;
  description?: string;
  duration?: string;
  toolCount?: number;
}

interface ConstraintEventData {
  type: 'sequential' | 'file_conflict' | 'dependency';
  tasks: string[];
  reason: string;
  source?: string;
}

interface PhaseEventData {
  phase: number;
  name: string;
  tasksCompleted: number;
  totalTasks: number;
  duration?: string;
}
```

---

## 5. Effort Estimate

### 5.1 Implementation Breakdown

| Component | Effort | Priority |
|-----------|--------|----------|
| EventBus class | 4 hours | P0 |
| Event types enum | 2 hours | P0 |
| Event emission integration | 8 hours | P0 |
| EventStreamPanel class | 6 hours | P0 |
| Collapsed view | 3 hours | P0 |
| Expanded view | 4 hours | P0 |
| Event cards (per type) | 4 hours | P0 |
| Filter bar | 2 hours | P0 |
| Keyboard handling | 1 hour | P0 |
| **Subtotal Core:** | **34 hours** | - |
| Search functionality | 2 hours | P1 |
| Event persistence | 4 hours | P2 |
| Event export | 2 hours | P3 |
| Real-time highlighting | 2 hours | P2 |
| **Subtotal Enhanced:** | **10 hours** | - |
| **Total:** | **44 hours** | - |

### 5.2 Recommended Implementation

**MVP (Core):** 34 hours
- EventBus with subscribe/emit
- Event emission from orchestrator
- Collapsed stream view
- Expanded view with cards
- Category filtering
- Pause/resume/clear

**Full Feature:** 44 hours
- All MVP features
- Search functionality
- Event persistence (survive restart)
- Event export to file
- New event highlighting

---

## 6. Risk Assessment

| Risk | Likelihood | Impact | Mitigation |
|------|------------|--------|------------|
| Event volume overwhelming | MEDIUM | MEDIUM | Buffer, filter, limit display |
| Missed events | LOW | LOW | History replay on expand |
| Memory growth | MEDIUM | LOW | Circular buffer, max size |
| Performance impact | MEDIUM | MEDIUM | Async processing, throttle |

---

## 7. Success Criteria

### 7.1 Functional Requirements

- [ ] All event types captured and displayed
- [ ] Category filtering works
- [ ] Pause/resume stream
- [ ] Event history persists during session
- [ ] Event cards show relevant details
- [ ] Keyboard navigation

### 7.2 Quality Requirements

- [ ] Events display within 100ms of occurrence
- [ ] Handles 100+ events/minute
- [ ] No memory leaks from event accumulation
- [ ] Smooth scrolling and navigation

### 7.3 Integration Requirements

- [ ] EventBus integrated into orchestrator
- [ ] Events emitted from all sources
- [ ] Panel fits in TUI layout
- [ ] Works without orchestrator (shows TUI-only events)

---

## 8. Related Documents

- Task 8.3: Orchestrator events analysis
- Task 10.2: Parallel Execution Dashboard
- Task 10.4: Orchestrator Control Panel
- claude_runner.py: Tool callback events
- plan_orchestrator.py: Event emission points

---

**End of Design**
