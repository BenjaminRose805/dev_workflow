# Task 2.4: Execution Note Block Parsing Analysis

## Summary

The `parseExecutionNotes()` function in `scripts/lib/plan-status.js` parses four types of execution annotations from plan markdown content. This analysis documents the complete syntax specification, regex patterns, and parsing behavior for each annotation type.

## Execution Note Block Types

| Type | Purpose | Scope | Example |
|------|---------|-------|---------|
| `[SEQUENTIAL]` | Force serial execution | Task-level | `Tasks 3.1-3.4 are [SEQUENTIAL]` |
| `[PARALLEL]` | Enable concurrent phases | Phase-level | `Phases 1-3 are [PARALLEL]` |
| `(non-blocking)` | Allow phase overlap | VERIFY tasks | `**VERIFY Phase 1:** (non-blocking)` |
| `pipeline-start` | Trigger early phase start | Cross-phase | `(pipeline-start: when 1.3 completes)` |

## Complete Syntax Specification

### 1. `[SEQUENTIAL]` Task Constraint

**Pattern Location:** `plan-status.js:1250`

```regex
/\*\*Execution Note:\*\*\s*Tasks?\s+([\d.,\s-]+)\s+(?:are|is)\s+\[SEQUENTIAL\]\s*[-–—]?\s*(.+?)(?:\n|$)/gi
```

**Syntax Variants:**

```markdown
# Standard format
**Execution Note:** Tasks 3.1-3.4 are [SEQUENTIAL] - all modify same file

# Single task
**Execution Note:** Task 3.1 is [SEQUENTIAL] - depends on external state

# Multiple ranges with "and"
**Execution Note:** Tasks 2.1-2.3 and 3.1-3.4 are [SEQUENTIAL] - shared config

# Comma-separated ranges
**Execution Note:** Tasks 2.1-2.3, 3.1 are [SEQUENTIAL] - database lock

# Em-dash separator (Unicode U+2014)
**Execution Note:** Tasks 3.1-3.4 are [SEQUENTIAL] — all modify same file

# En-dash separator (Unicode U+2013)
**Execution Note:** Tasks 3.1-3.4 are [SEQUENTIAL] – all modify same file
```

**Parsing Behavior:**

1. Extracts task range string (e.g., "3.1-3.4" or "2.1-2.3 and 3.1-3.4")
2. Splits on ` and ` or `,` followed by digit
3. Calls `expandTaskRange()` on each segment
4. Captures reason text (everything after separator until newline)

**Output:**
```javascript
{
  taskRange: "3.1-3.4",
  taskIds: ["3.1", "3.2", "3.3", "3.4"],
  reason: "all modify same file"
}
```

### 2. `[PARALLEL]` Phase Constraint

**Pattern Location:** `plan-status.js:1278`

```regex
/\*\*Execution Note:\*\*\s*Phases?\s+([\d,\s-]+)\s+(?:are|is)\s+\[PARALLEL\]\s*[-–—]?\s*(.+?)(?:\n|$)/gi
```

**Syntax Variants:**

```markdown
# Range format
**Execution Note:** Phases 1-3 are [PARALLEL] - independent modules

# Single phase (edge case)
**Execution Note:** Phase 1-2 is [PARALLEL] - concurrent work

# Comma-separated list
**Execution Note:** Phases 1, 2, 3 are [PARALLEL] - no dependencies

# Mixed range and list
**Execution Note:** Phases 1-3, 5 are [PARALLEL] - non-overlapping files
```

**Parsing Behavior:**

1. Extracts phase range string (e.g., "1-3" or "1, 2, 3")
2. Calls `expandPhaseRange()` to expand to array of numbers
3. Captures reason text after separator

**Output:**
```javascript
{
  phaseRange: "1-3",
  phaseIds: [1, 2, 3],
  reason: "independent modules"
}
```

### 3. `(non-blocking)` VERIFY Annotation

**Pattern Location:** `plan-status.js:1297`

```regex
/\*\*VERIFY\s+Phase\s+(\d+).*?\(non-blocking\)/gi
```

**Syntax Variants:**

```markdown
# After the verify header
**VERIFY Phase 1:** (non-blocking)

# Inline with description
**VERIFY Phase 1 (non-blocking):** Run tests

# With text between
**VERIFY Phase 1:** Optional validation (non-blocking)
```

**Parsing Behavior:**

1. Matches `**VERIFY Phase N` followed by `(non-blocking)` anywhere in the line
2. Extracts phase number
3. Deduplicates (only one entry per phase)
4. Sorts by phase number

**Output:**
```javascript
{ phase: 1 }
```

### 4. `pipeline-start` Trigger

**Pattern Location:** `plan-status.js:1313, 1330`

**Two Patterns:**

Pattern 1 - Standalone annotation:
```regex
/\*\*pipeline-start:\*\*\s*when\s+(\d+\.\d+(?:\.\d+)?)\s+completes?/gi
```

Pattern 2 - Inline with phase header:
```regex
/##\s+Phase\s+(\d+)[^(\n]*\(pipeline-start:\s*when\s+(\d+\.\d+(?:\.\d+)?)\s+completes?\)/gi
```

**Syntax Variants:**

```markdown
# Standalone annotation (before phase header)
**pipeline-start:** when 1.3 completes

## Phase 2: API Layer
- [ ] 2.1 Create endpoints

# Inline with phase header
## Phase 2: API Layer (pipeline-start: when 1.3 completes)
- [ ] 2.1 Create endpoints

# With "complete" (no 's')
**pipeline-start:** when 1.3 complete
```

**Parsing Behavior:**

Pattern 1:
1. Matches standalone `**pipeline-start:**` annotation
2. Extracts trigger task ID
3. Scans forward to find next `## Phase N` header
4. Associates trigger with that phase

Pattern 2:
1. Matches inline annotation within phase header
2. Extracts both phase number and trigger task ID directly

**Output:**
```javascript
{
  phase: 2,
  triggerTaskId: "1.3"
}
```

## Range Expansion Functions

### `expandTaskRange(rangeStr)`

**Location:** `plan-status.js:1172-1210`

| Input | Output |
|-------|--------|
| `"3.1-3.4"` | `["3.1", "3.2", "3.3", "3.4"]` |
| `"3.1"` | `["3.1"]` |
| `"3.1,3.3,3.5"` | `["3.1", "3.3", "3.5"]` |
| `"1.1-2.3"` | `["1.1", "2.3"]` (cross-phase returns endpoints only) |

**Logic:**
1. Check for comma → split and return list
2. Check for range pattern `X.Y-X.Z` → expand within same phase
3. Check for single task → return as single-element array
4. Different phases in range → return only endpoints (no expansion)

### `expandPhaseRange(rangeStr)`

**Location:** `plan-status.js:1363-1398`

| Input | Output |
|-------|--------|
| `"1-3"` | `[1, 2, 3]` |
| `"1, 2, 3"` | `[1, 2, 3]` |
| `"1-3, 5"` | `[1, 2, 3, 5]` |
| `"3"` | `[3]` |

**Logic:**
1. Split by comma
2. For each part: check for range pattern `N-M` → expand
3. Otherwise parse as single number
4. Use Set to deduplicate, sort ascending

## Propagation to Task Selection

### How Annotations Affect `next` Command

**`[SEQUENTIAL]` Handling (status-cli.js cmdNext):**
1. Parse constraints with `parseExecutionNotes()`
2. Build lookup map: taskId → sequential group info
3. Add to task objects:
   ```javascript
   {
     sequential: true,
     sequentialGroup: "3.1-3.4",
     sequentialReason: "all modify same file"
   }
   ```

**`[PARALLEL]` Handling:**
1. Build `parallelPhaseSet` from `constraints.parallel`
2. For tasks in parallel phases:
   ```javascript
   {
     parallelPhase: true
   }
   ```
3. Include in output:
   ```javascript
   {
     parallelPhases: [{ phases: [1, 2, 3], reason: "..." }]
   }
   ```

**`(non-blocking)` Handling:**
Used in `getReadyTasks()` to allow tasks from next phase to become ready even if VERIFY task is pending.

**`pipeline-start` Handling:**
Used in `getReadyTasks()` to check if trigger task is complete, marking dependent phase tasks as `pipelineTriggered: true`.

## Edge Cases and Limitations

### Handled Edge Cases

1. **Multiple separators:** Hyphen `-`, en-dash `–`, em-dash `—` all work
2. **Case insensitivity:** `are`, `Are`, `ARE` all match
3. **Singular/plural:** `Task/Tasks`, `Phase/Phases`, `is/are` all work
4. **Whitespace flexibility:** Variable spaces around separators
5. **Newline termination:** Reason ends at newline or EOF

### Known Limitations

1. **No nested ranges:** Can't do `"3.1-3.2, 4.1-4.2"` in single SEQUENTIAL (split loses grouping)
2. **Cross-phase task ranges:** `"1.1-2.3"` doesn't expand intermediate tasks
3. **No validation:** Invalid task IDs like `"99.99"` are included without error
4. **Reason parsing:** Reason text includes everything until newline (may capture trailing markdown)
5. **No multiline:** Annotations must be on single line

## TUI Display Opportunities

### Annotation Visualization

| Annotation | Visual Indicator | Implementation |
|------------|------------------|----------------|
| `[SEQUENTIAL]` | Chain icon `⛓` with tooltip | Badge on task row |
| `[PARALLEL]` | Split arrows `⟷` | Phase header badge |
| `(non-blocking)` | Dotted border | VERIFY task styling |
| `pipeline-start` | Trigger arrow `→` | Cross-phase connector line |

### Recommended TUI Features

1. **Constraint Legend:** Panel showing active constraints
2. **Annotation Editor:** Rich text editor for adding/editing annotations
3. **Constraint Preview:** Show expanded task/phase IDs before save
4. **Validation Warnings:** Alert on invalid task IDs in ranges
5. **Dependency Visualization:** Graph showing constraint relationships

## Test Coverage

Tests in `scripts/tests/test-parallel-phases.js` cover:
- Single and multiple SEQUENTIAL annotations
- Range expansion (ranges, lists, mixed)
- PARALLEL phase parsing
- Multiple parallel groups
- Separator variants (hyphen, en-dash, em-dash)
- Case insensitivity
- Singular/plural handling
