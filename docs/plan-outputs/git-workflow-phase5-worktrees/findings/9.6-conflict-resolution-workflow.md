# Conflict Resolution Workflow for Worktrees

This document describes how to detect and resolve merge conflicts when completing plans in a worktree context.

## Overview

When running multiple plans in parallel using git worktrees, conflicts can arise when:

1. **Multiple plans modify the same files** - Two or more plan branches touch the same source files
2. **Main branch has advanced** - Changes were merged to main from another plan after your worktree was created
3. **Rebase/merge in progress** - A previous conflict resolution attempt was interrupted

## Conflict Detection Commands

### Check Current Worktree Status

```bash
# From within a worktree
node scripts/status-cli.js worktree-conflict

# For a specific worktree path
node scripts/status-cli.js worktree-conflict /path/to/worktree

# JSON output for programmatic use
node scripts/status-cli.js worktree-conflict --format=json
```

**Example output (no conflicts):**
```
Worktree Conflict Analysis
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Worktree: /repo/worktrees/plan-feature-auth
Branch: plan/feature-auth
Main Branch: main

Merge Analysis:
  Commits ahead of main: 12
  Commits behind main: 0
  Strategy: fast-forward
  Status: âœ“ Can fast-forward (no conflicts)
```

**Example output (conflicts detected):**
```
Worktree Conflict Analysis
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Worktree: /repo/worktrees/plan-feature-auth
Branch: plan/feature-auth
Main Branch: main

Merge Analysis:
  Commits ahead of main: 12
  Commits behind main: 5
  Strategy: conflict-merge
  Status: âœ— Conflicts detected

  Conflicting files:
    - src/lib/auth.ts
    - src/routes/api.ts

Recommended Resolution (Rebase):
  1. Rebase your branch onto main to incorporate latest changes
  2. Resolve any conflicts that arise during rebase
  3. Continue the rebase after resolving each conflict
  4. Re-run /plan:complete when rebase is successful

Commands:
  cd /repo/worktrees/plan-feature-auth
  git rebase main
  # If conflicts occur:
  #   1. Edit conflicting files to resolve
  #   2. git add <resolved-files>
  #   3. git rebase --continue
  # To abort: git rebase --abort
```

### Check All Plan Branches

```bash
# Check if any plan branches need rebasing
node scripts/status-cli.js rebase-check

# See all conflicts between plan branches
node scripts/status-cli.js conflicts
```

### Get Recommended Merge Order

```bash
# See recommended order for merging plans
node scripts/status-cli.js merge-order
```

## Conflict Resolution Strategies

### Strategy 1: Rebase (Recommended)

Rebasing replays your commits on top of the latest main branch, creating a cleaner linear history.

**When to use:**
- Your plan has relatively few commits
- You want the cleanest history
- The conflicts are straightforward

**Steps:**
```bash
# Navigate to your worktree
cd /repo/worktrees/plan-my-plan

# Start the rebase
git rebase main

# If conflicts occur, you'll see:
# CONFLICT (content): Merge conflict in src/file.ts
# error: could not apply <commit-hash>... <commit-message>

# For each conflict:
# 1. Open the conflicting file and look for conflict markers:
#    <<<<<<< HEAD (main branch version)
#    =======
#    >>>>>>> <your-commit> (your version)

# 2. Edit the file to resolve the conflict
# 3. Remove the conflict markers
# 4. Stage the resolved file
git add <resolved-file>

# 5. Continue the rebase
git rebase --continue

# Repeat for each conflict until rebase completes

# If you need to abort
git rebase --abort
```

### Strategy 2: Merge

Merging creates a merge commit that combines both branches.

**When to use:**
- You want to preserve the exact commit history
- The plan has many commits
- You prefer explicit merge points

**Steps:**
```bash
# Navigate to your worktree
cd /repo/worktrees/plan-my-plan

# Start the merge
git merge main

# If conflicts occur:
# 1. Open conflicting files
# 2. Resolve the conflicts
# 3. Stage resolved files
git add <resolved-file>

# 4. Complete the merge
git commit

# If you need to abort
git merge --abort
```

### Strategy 3: Abort and Review

Sometimes it's better to abort and review the situation before proceeding.

**Steps:**
```bash
# Abort any in-progress operation
node scripts/status-cli.js worktree-conflict --abort

# Or manually:
git merge --abort    # For merge conflicts
git rebase --abort   # For rebase conflicts
git cherry-pick --abort  # For cherry-pick conflicts
```

## Handling Active Conflicts

If a previous operation left the worktree in a conflict state:

### Check Current State

```bash
# Using status-cli
node scripts/status-cli.js worktree-conflict

# Using git directly
git status
```

### Abort the Operation

```bash
# Recommended: Use status-cli
node scripts/status-cli.js worktree-conflict --abort

# Or manually identify and abort
git merge --abort    # If "MERGING" appears in git status
git rebase --abort   # If rebase is in progress
```

### Resume the Operation

If you want to continue resolving:

```bash
# For rebase
git rebase --continue

# For merge (after staging resolved files)
git commit

# For cherry-pick
git cherry-pick --continue
```

## Prevention: Check Before Complete

The `/plan:complete` command automatically checks for conflicts before proceeding:

```bash
/plan:complete
```

If conflicts are detected, you'll see options to:
1. **Rebase onto main (Recommended)** - Automatically start a rebase
2. **Manual resolve** - Exit to resolve conflicts yourself
3. **Abort completion** - Cancel without any changes

## Integration with Multi-Plan Execution

### Conflict Detection Between Plans

When running multiple plans in parallel, check for file conflicts:

```bash
# See which plans modify the same files
node scripts/status-cli.js conflicts
```

**Example output:**
```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘          Worktree Conflict Detection Report                    â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš  Potential Conflicts Between Plans:

  ğŸŸ¡ plan/feature-auth â†” plan/api-refactor
     2 shared file(s): src/lib/auth.ts, src/routes/api.ts

ğŸ“ Files Modified by Multiple Plans:

  src/lib/auth.ts
    Modified by: plan/feature-auth, plan/api-refactor

ğŸ“‹ Recommended Merge Order:

  1. plan/api-refactor
     Few conflicts (5 files)
  2. plan/feature-auth
     Has potential conflicts (12 files)
```

### Recommended Merge Order

Use the merge order recommendation to minimize conflicts:

```bash
node scripts/status-cli.js merge-order
```

Plans with fewer file changes and less overlap should be merged first.

## Troubleshooting

### "Detached HEAD state"

This occurs when the worktree isn't on a branch:

```bash
# Check current state
git branch --show-current

# Checkout the correct branch
git checkout plan/my-plan
```

### "Cannot rebase: You have unstaged changes"

Commit or stash your changes first:

```bash
# Option 1: Commit changes
git add -A
git commit -m "WIP: Changes before rebase"

# Option 2: Stash changes
git stash
git rebase main
git stash pop
```

### "fatal: It seems there is already a rebase-merge directory"

A previous rebase was interrupted. Clean it up:

```bash
# Abort the previous rebase
git rebase --abort

# Or if that fails, manually clean
rm -rf .git/rebase-merge
```

## API Reference

### conflict-detector.js Functions

| Function | Description |
|----------|-------------|
| `detectWorktreeMergeConflicts(path, branch)` | Detect potential merge conflicts |
| `checkWorktreeConflictState(path)` | Check if worktree has active conflicts |
| `abortWorktreeConflict(path)` | Abort any in-progress conflict operation |
| `getConflictResolutionSteps(path, branch, strategy)` | Get resolution instructions |
| `generateWorktreeConflictReport(path, branch)` | Generate full conflict report |

### status-cli.js Commands

| Command | Description |
|---------|-------------|
| `worktree-conflict [path]` | Analyze worktree merge state |
| `worktree-conflict --abort` | Abort in-progress conflict operation |
| `conflicts` | Show all conflicts between plan branches |
| `merge-order` | Get recommended merge order |
| `rebase-check` | Check if branches need rebasing |

## Summary

1. **Before completing a plan**: Run `node scripts/status-cli.js worktree-conflict` to check status
2. **If conflicts detected**: Choose rebase (cleaner) or merge (preserves history)
3. **If stuck in conflict state**: Use `--abort` to reset and try again
4. **For parallel plans**: Check `conflicts` and `merge-order` commands
5. **Plan completion order**: Merge plans with fewer changes and less overlap first
